{"ast":null,"code":"import \"core-js/modules/es.typed-array.to-reversed.js\";\nimport \"core-js/modules/es.typed-array.to-sorted.js\";\nimport \"core-js/modules/es.typed-array.with.js\";\nimport \"core-js/modules/es.array.push.js\";\n/* eslint-disable @typescript-eslint/no-unused-vars */\nimport { EngineStore } from \"./engineStore.js\";\nimport { Effect } from \"../Materials/effect.js\";\nimport { _WarnImport } from \"../Misc/devTools.js\";\nimport { Observable } from \"../Misc/observable.js\";\nimport { DepthCullingState } from \"../States/depthCullingState.js\";\nimport { StencilState } from \"../States/stencilState.js\";\nimport { AlphaState } from \"../States/alphaCullingState.js\";\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture.js\";\nimport { Logger } from \"../Misc/logger.js\";\nimport { IsDocumentAvailable, IsWindowObjectExist } from \"../Misc/domManagement.js\";\nimport { WebGLShaderProcessor } from \"./WebGL/webGLShaderProcessors.js\";\nimport { WebGL2ShaderProcessor } from \"./WebGL/webGL2ShaderProcessors.js\";\nimport { WebGLDataBuffer } from \"../Meshes/WebGL/webGLDataBuffer.js\";\nimport { WebGLPipelineContext } from \"./WebGL/webGLPipelineContext.js\";\nimport { PerformanceConfigurator } from \"./performanceConfigurator.js\";\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture.js\";\nimport { DrawWrapper } from \"../Materials/drawWrapper.js\";\nimport { StencilStateComposer } from \"../States/stencilStateComposer.js\";\nimport { ShaderLanguage } from \"../Materials/shaderLanguage.js\";\nimport { PrecisionDate } from \"../Misc/precisionDate.js\";\n/**\n * Keeps track of all the buffer info used in engine.\n */\nclass BufferPointer {}\n/**\n * The base engine class (root of all engines)\n */\nexport class ThinEngine {\n  /**\n   * Returns the current npm package of the sdk\n   */\n  // Not mixed with Version for tooling purpose.\n  static get NpmPackage() {\n    return \"babylonjs@6.25.1\";\n  }\n  /**\n   * Returns the current version of the framework\n   */\n  static get Version() {\n    return \"6.25.1\";\n  }\n  /**\n   * Returns a string describing the current engine\n   */\n  get description() {\n    let description = this.name + this.webGLVersion;\n    if (this._caps.parallelShaderCompile) {\n      description += \" - Parallel shader compilation\";\n    }\n    return description;\n  }\n  /**\n   * Gets or sets the name of the engine\n   */\n  get name() {\n    return this._name;\n  }\n  set name(value) {\n    this._name = value;\n  }\n  /**\n   * Returns the version of the engine\n   */\n  get version() {\n    return this._webGLVersion;\n  }\n  get isDisposed() {\n    return this._isDisposed;\n  }\n  /**\n   * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\n   */\n  static get ShadersRepository() {\n    return Effect.ShadersRepository;\n  }\n  static set ShadersRepository(value) {\n    Effect.ShadersRepository = value;\n  }\n  /**\n   * @internal\n   */\n  _getShaderProcessor(shaderLanguage) {\n    return this._shaderProcessor;\n  }\n  /**\n   * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\n   * This can provide greater z depth for distant objects.\n   */\n  get useReverseDepthBuffer() {\n    return this._useReverseDepthBuffer;\n  }\n  set useReverseDepthBuffer(useReverse) {\n    if (useReverse === this._useReverseDepthBuffer) {\n      return;\n    }\n    this._useReverseDepthBuffer = useReverse;\n    if (useReverse) {\n      this._depthCullingState.depthFunc = 518;\n    } else {\n      this._depthCullingState.depthFunc = 515;\n    }\n  }\n  /**\n   * Gets the current frame id\n   */\n  get frameId() {\n    return this._frameId;\n  }\n  /**\n   * Gets a boolean indicating that the engine supports uniform buffers\n   * @see https://doc.babylonjs.com/setup/support/webGL2#uniform-buffer-objets\n   */\n  get supportsUniformBuffers() {\n    return this.webGLVersion > 1 && !this.disableUniformBuffers;\n  }\n  /**\n   * Gets the options used for engine creation\n   * @returns EngineOptions object\n   */\n  getCreationOptions() {\n    return this._creationOptions;\n  }\n  /** @internal */\n  get _shouldUseHighPrecisionShader() {\n    return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\n  }\n  /**\n   * Gets a boolean indicating that only power of 2 textures are supported\n   * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\n   */\n  get needPOTTextures() {\n    return this._webGLVersion < 2 || this.forcePOTTextures;\n  }\n  /**\n   * Gets the list of current active render loop functions\n   * @returns an array with the current render loop functions\n   */\n  get activeRenderLoops() {\n    return this._activeRenderLoops;\n  }\n  /**\n   * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\n   * @see https://doc.babylonjs.com/features/featuresDeepDive/scene/optimize_your_scene#handling-webgl-context-lost\n   */\n  get doNotHandleContextLost() {\n    return this._doNotHandleContextLost;\n  }\n  set doNotHandleContextLost(value) {\n    this._doNotHandleContextLost = value;\n  }\n  get _supportsHardwareTextureRescaling() {\n    return false;\n  }\n  /**\n   * sets the object from which width and height will be taken from when getting render width and height\n   * Will fallback to the gl object\n   * @param dimensions the framebuffer width and height that will be used.\n   */\n  set framebufferDimensionsObject(dimensions) {\n    this._framebufferDimensionsObject = dimensions;\n  }\n  /**\n   * Gets the current viewport\n   */\n  get currentViewport() {\n    return this._cachedViewport;\n  }\n  /**\n   * Gets the default empty texture\n   */\n  get emptyTexture() {\n    if (!this._emptyTexture) {\n      this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\n    }\n    return this._emptyTexture;\n  }\n  /**\n   * Gets the default empty 3D texture\n   */\n  get emptyTexture3D() {\n    if (!this._emptyTexture3D) {\n      this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n    }\n    return this._emptyTexture3D;\n  }\n  /**\n   * Gets the default empty 2D array texture\n   */\n  get emptyTexture2DArray() {\n    if (!this._emptyTexture2DArray) {\n      this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n    }\n    return this._emptyTexture2DArray;\n  }\n  /**\n   * Gets the default empty cube texture\n   */\n  get emptyCubeTexture() {\n    if (!this._emptyCubeTexture) {\n      const faceData = new Uint8Array(4);\n      const cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\n      this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\n    }\n    return this._emptyCubeTexture;\n  }\n  /**\n   * Gets a boolean indicating if the engine runs in WebGPU or not.\n   */\n  get isWebGPU() {\n    return this._isWebGPU;\n  }\n  /**\n   * Gets the shader platform name used by the effects.\n   */\n  get shaderPlatformName() {\n    return this._shaderPlatformName;\n  }\n  /**\n   * Enables or disables the snapshot rendering mode\n   * Note that the WebGL engine does not support snapshot rendering so setting the value won't have any effect for this engine\n   */\n  get snapshotRendering() {\n    return false;\n  }\n  set snapshotRendering(activate) {\n    // WebGL engine does not support snapshot rendering\n  }\n  /**\n   * Gets or sets the snapshot rendering mode\n   */\n  get snapshotRenderingMode() {\n    return this._snapshotRenderingMode;\n  }\n  set snapshotRenderingMode(mode) {\n    this._snapshotRenderingMode = mode;\n  }\n  /**\n   * Creates a new snapshot at the next frame using the current snapshotRenderingMode\n   */\n  snapshotRenderingReset() {\n    this.snapshotRendering = false;\n  }\n  static _CreateCanvas(width, height) {\n    if (typeof document === \"undefined\") {\n      return new OffscreenCanvas(width, height);\n    }\n    const canvas = document.createElement(\"canvas\");\n    canvas.width = width;\n    canvas.height = height;\n    return canvas;\n  }\n  /**\n   * Create a canvas. This method is overridden by other engines\n   * @param width width\n   * @param height height\n   * @returns ICanvas interface\n   */\n  createCanvas(width, height) {\n    return ThinEngine._CreateCanvas(width, height);\n  }\n  /**\n   * Create an image to use with canvas\n   * @returns IImage interface\n   */\n  createCanvasImage() {\n    return document.createElement(\"img\");\n  }\n  /**\n   * Creates a new engine\n   * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which already used the WebGL context\n   * @param antialias defines enable antialiasing (default: false)\n   * @param options defines further options to be sent to the getContext() function\n   * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\n   */\n  constructor(canvasOrContext, antialias, options, adaptToDeviceRatio) {\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l;\n    /** @internal */\n    this._name = \"WebGL\";\n    this._isDisposed = false;\n    /**\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\n     */\n    this.forcePOTTextures = false;\n    /**\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\n     */\n    this.isFullscreen = false;\n    /**\n     * Gets or sets a boolean indicating if back faces must be culled. If false, front faces are culled instead (true by default)\n     * If non null, this takes precedence over the value from the material\n     */\n    this.cullBackFaces = null;\n    /**\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foreground\n     */\n    this.renderEvenInBackground = true;\n    /**\n     * Gets or sets a boolean indicating that cache can be kept between frames\n     */\n    this.preventCacheWipeBetweenFrames = false;\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\n    this.validateShaderPrograms = false;\n    this._useReverseDepthBuffer = false;\n    /**\n     * Indicates if the z range in NDC space is 0..1 (value: true) or -1..1 (value: false)\n     */\n    this.isNDCHalfZRange = false;\n    /**\n     * Indicates that the origin of the texture/framebuffer space is the bottom left corner. If false, the origin is top left\n     */\n    this.hasOriginBottomLeft = true;\n    /**\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\n     */\n    this.disableUniformBuffers = false;\n    /**\n     * An event triggered when the engine is disposed.\n     */\n    this.onDisposeObservable = new Observable();\n    this._frameId = 0;\n    /** @internal */\n    this._uniformBuffers = new Array();\n    /** @internal */\n    this._storageBuffers = new Array();\n    /** @internal */\n    this._webGLVersion = 1.0;\n    this._windowIsBackground = false;\n    this._highPrecisionShadersAllowed = true;\n    /** @internal */\n    this._badOS = false;\n    /** @internal */\n    this._badDesktopOS = false;\n    this._renderingQueueLaunched = false;\n    this._activeRenderLoops = new Array();\n    // Lost context\n    /**\n     * Observable signaled when a context lost event is raised\n     */\n    this.onContextLostObservable = new Observable();\n    /**\n     * Observable signaled when a context restored event is raised\n     */\n    this.onContextRestoredObservable = new Observable();\n    this._contextWasLost = false;\n    /** @internal */\n    this._doNotHandleContextLost = false;\n    /**\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\n     */\n    this.disableVertexArrayObjects = false;\n    // States\n    /** @internal */\n    this._colorWrite = true;\n    /** @internal */\n    this._colorWriteChanged = true;\n    /** @internal */\n    this._depthCullingState = new DepthCullingState();\n    /** @internal */\n    this._stencilStateComposer = new StencilStateComposer();\n    /** @internal */\n    this._stencilState = new StencilState();\n    /** @internal */\n    this._alphaState = new AlphaState();\n    /** @internal */\n    this._alphaMode = 1;\n    /** @internal */\n    this._alphaEquation = 0;\n    // Cache\n    /** @internal */\n    this._internalTexturesCache = new Array();\n    /** @internal */\n    this._renderTargetWrapperCache = new Array();\n    /** @internal */\n    this._activeChannel = 0;\n    this._currentTextureChannel = -1;\n    /** @internal */\n    this._boundTexturesCache = {};\n    this._compiledEffects = {};\n    this._vertexAttribArraysEnabled = [];\n    this._uintIndicesCurrentlySet = false;\n    this._currentBoundBuffer = new Array();\n    /** @internal */\n    this._currentFramebuffer = null;\n    /** @internal */\n    this._dummyFramebuffer = null;\n    this._currentBufferPointers = new Array();\n    this._currentInstanceLocations = new Array();\n    this._currentInstanceBuffers = new Array();\n    this._vaoRecordInProgress = false;\n    this._mustWipeVertexAttributes = false;\n    this._nextFreeTextureSlots = new Array();\n    this._maxSimultaneousTextures = 0;\n    this._maxMSAASamplesOverride = null;\n    this._activeRequests = new Array();\n    /**\n     * If set to true zooming in and out in the browser will rescale the hardware-scaling correctly.\n     */\n    this.adaptToDeviceRatio = false;\n    /** @internal */\n    this._lastDevicePixelRatio = 1.0;\n    /** @internal */\n    this._transformTextureUrl = null;\n    /**\n     * Gets information about the current host\n     */\n    this.hostInformation = {\n      isMobile: false\n    };\n    /**\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\n     */\n    this.premultipliedAlpha = true;\n    /**\n     * Observable event triggered before each texture is initialized\n     */\n    this.onBeforeTextureInitObservable = new Observable();\n    /** @internal */\n    this._isWebGPU = false;\n    this._snapshotRenderingMode = 0;\n    this._viewportCached = {\n      x: 0,\n      y: 0,\n      z: 0,\n      w: 0\n    };\n    this._unpackFlipYCached = null;\n    /**\n     * In case you are sharing the context with other applications, it might\n     * be interested to not cache the unpack flip y state to ensure a consistent\n     * value would be set.\n     */\n    this.enableUnpackFlipYCached = true;\n    this._boundUniforms = {};\n    this.startTime = PrecisionDate.Now;\n    let canvas = null;\n    options = options || {};\n    this._creationOptions = options;\n    // Save this off for use in resize().\n    this.adaptToDeviceRatio = adaptToDeviceRatio !== null && adaptToDeviceRatio !== void 0 ? adaptToDeviceRatio : false;\n    this._stencilStateComposer.stencilGlobal = this._stencilState;\n    PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\n    options.antialias = antialias !== null && antialias !== void 0 ? antialias : options.antialias;\n    options.deterministicLockstep = (_a = options.deterministicLockstep) !== null && _a !== void 0 ? _a : false;\n    options.lockstepMaxSteps = (_b = options.lockstepMaxSteps) !== null && _b !== void 0 ? _b : 4;\n    options.timeStep = (_c = options.timeStep) !== null && _c !== void 0 ? _c : 1 / 60;\n    options.audioEngine = (_d = options.audioEngine) !== null && _d !== void 0 ? _d : true;\n    options.stencil = (_e = options.stencil) !== null && _e !== void 0 ? _e : true;\n    this._audioContext = (_g = (_f = options.audioEngineOptions) === null || _f === void 0 ? void 0 : _f.audioContext) !== null && _g !== void 0 ? _g : null;\n    this._audioDestination = (_j = (_h = options.audioEngineOptions) === null || _h === void 0 ? void 0 : _h.audioDestination) !== null && _j !== void 0 ? _j : null;\n    this.premultipliedAlpha = (_k = options.premultipliedAlpha) !== null && _k !== void 0 ? _k : true;\n    this.useExactSrgbConversions = (_l = options.useExactSrgbConversions) !== null && _l !== void 0 ? _l : false;\n    this._doNotHandleContextLost = !!options.doNotHandleContextLost;\n    this._isStencilEnable = options.stencil ? true : false;\n    // Viewport\n    adaptToDeviceRatio = adaptToDeviceRatio || options.adaptToDeviceRatio || false;\n    const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n    const limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\n    this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\n    this._lastDevicePixelRatio = devicePixelRatio;\n    if (!canvasOrContext) {\n      return;\n    }\n    if (canvasOrContext.getContext) {\n      canvas = canvasOrContext;\n      this._renderingCanvas = canvas;\n      if (options.preserveDrawingBuffer === undefined) {\n        options.preserveDrawingBuffer = false;\n      }\n      if (options.xrCompatible === undefined) {\n        options.xrCompatible = true;\n      }\n      // Exceptions\n      if (navigator && navigator.userAgent) {\n        this._setupMobileChecks();\n        const ua = navigator.userAgent;\n        for (const exception of ThinEngine.ExceptionList) {\n          const key = exception.key;\n          const targets = exception.targets;\n          const check = new RegExp(key);\n          if (check.test(ua)) {\n            if (exception.capture && exception.captureConstraint) {\n              const capture = exception.capture;\n              const constraint = exception.captureConstraint;\n              const regex = new RegExp(capture);\n              const matches = regex.exec(ua);\n              if (matches && matches.length > 0) {\n                const capturedValue = parseInt(matches[matches.length - 1]);\n                if (capturedValue >= constraint) {\n                  continue;\n                }\n              }\n            }\n            for (const target of targets) {\n              switch (target) {\n                case \"uniformBuffer\":\n                  this.disableUniformBuffers = true;\n                  break;\n                case \"vao\":\n                  this.disableVertexArrayObjects = true;\n                  break;\n                case \"antialias\":\n                  options.antialias = false;\n                  break;\n                case \"maxMSAASamples\":\n                  this._maxMSAASamplesOverride = 1;\n                  break;\n              }\n            }\n          }\n        }\n      }\n      // Context lost\n      if (!this._doNotHandleContextLost) {\n        this._onContextLost = evt => {\n          evt.preventDefault();\n          this._contextWasLost = true;\n          Logger.Warn(\"WebGL context lost.\");\n          this.onContextLostObservable.notifyObservers(this);\n        };\n        this._onContextRestored = () => {\n          this._restoreEngineAfterContextLost(() => this._initGLContext());\n        };\n        canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\n        canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\n        options.powerPreference = options.powerPreference || \"high-performance\";\n      }\n      // Detect if we are running on a faulty buggy desktop OS.\n      this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n      if (this._badDesktopOS) {\n        options.xrCompatible = false;\n      }\n      // GL\n      if (!options.disableWebGL2Support) {\n        try {\n          this._gl = canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options);\n          if (this._gl) {\n            this._webGLVersion = 2.0;\n            this._shaderPlatformName = \"WEBGL2\";\n            // Prevent weird browsers to lie (yeah that happens!)\n            if (!this._gl.deleteQuery) {\n              this._webGLVersion = 1.0;\n              this._shaderPlatformName = \"WEBGL1\";\n            }\n          }\n        } catch (e) {\n          // Do nothing\n        }\n      }\n      if (!this._gl) {\n        if (!canvas) {\n          throw new Error(\"The provided canvas is null or undefined.\");\n        }\n        try {\n          this._gl = canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options);\n        } catch (e) {\n          throw new Error(\"WebGL not supported\");\n        }\n      }\n      if (!this._gl) {\n        throw new Error(\"WebGL not supported\");\n      }\n    } else {\n      this._gl = canvasOrContext;\n      this._renderingCanvas = this._gl.canvas;\n      if (this._gl.renderbufferStorageMultisample) {\n        this._webGLVersion = 2.0;\n        this._shaderPlatformName = \"WEBGL2\";\n      } else {\n        this._shaderPlatformName = \"WEBGL1\";\n      }\n      const attributes = this._gl.getContextAttributes();\n      if (attributes) {\n        options.stencil = attributes.stencil;\n      }\n    }\n    // Ensures a consistent color space unpacking of textures cross browser.\n    this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n    if (options.useHighPrecisionFloats !== undefined) {\n      this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\n    }\n    this.resize();\n    this._initGLContext();\n    this._initFeatures();\n    // Prepare buffer pointers\n    for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\n      this._currentBufferPointers[i] = new BufferPointer();\n    }\n    // Shader processor\n    this._shaderProcessor = this.webGLVersion > 1 ? new WebGL2ShaderProcessor() : new WebGLShaderProcessor();\n    // Detect if we are running on a faulty buggy OS.\n    this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent);\n    // Starting with iOS 14, we can trust the browser\n    // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\n    // if (matches && matches.length === 2) {\n    //     if (parseInt(matches[1]) >= 14) {\n    //         this._badOS = false;\n    //     }\n    // }\n    const versionToLog = `Babylon.js v${ThinEngine.Version}`;\n    console.log(versionToLog + ` - ${this.description}`);\n    // Check setAttribute in case of workers\n    if (this._renderingCanvas && this._renderingCanvas.setAttribute) {\n      this._renderingCanvas.setAttribute(\"data-engine\", versionToLog);\n    }\n  }\n  _setupMobileChecks() {\n    if (!(navigator && navigator.userAgent)) {\n      return;\n    }\n    // Function to check if running on mobile device\n    this._checkForMobile = () => {\n      const currentUA = navigator.userAgent;\n      this.hostInformation.isMobile = currentUA.indexOf(\"Mobile\") !== -1 ||\n      // Needed for iOS 13+ detection on iPad (inspired by solution from https://stackoverflow.com/questions/9038625/detect-if-device-is-ios)\n      currentUA.indexOf(\"Mac\") !== -1 && IsDocumentAvailable() && \"ontouchend\" in document;\n    };\n    // Set initial isMobile value\n    this._checkForMobile();\n    // Set up event listener to check when window is resized (used to get emulator activation to work properly)\n    if (IsWindowObjectExist()) {\n      window.addEventListener(\"resize\", this._checkForMobile);\n    }\n  }\n  _restoreEngineAfterContextLost(initEngine) {\n    // Adding a timeout to avoid race condition at browser level\n    setTimeout(async () => {\n      var _a;\n      this._dummyFramebuffer = null;\n      const depthTest = this._depthCullingState.depthTest; // backup those values because the call to initEngine / wipeCaches will reset them\n      const depthFunc = this._depthCullingState.depthFunc;\n      const depthMask = this._depthCullingState.depthMask;\n      const stencilTest = this._stencilState.stencilTest;\n      // Rebuild context\n      await initEngine();\n      // Ensure webgl and engine states are matching\n      this.wipeCaches(true);\n      // Rebuild effects\n      this._rebuildEffects();\n      (_a = this._rebuildComputeEffects) === null || _a === void 0 ? void 0 : _a.call(this);\n      // Note:\n      //  The call to _rebuildBuffers must be made before the call to _rebuildInternalTextures because in the process of _rebuildBuffers the buffers used by the post process managers will be rebuilt\n      //  and we may need to use the post process manager of the scene during _rebuildInternalTextures (in WebGL1, non-POT textures are rescaled using a post process + post process manager of the scene)\n      // Rebuild buffers\n      this._rebuildBuffers();\n      // Rebuild textures\n      this._rebuildInternalTextures();\n      // Rebuild textures\n      this._rebuildRenderTargetWrappers();\n      // Reset engine states after all the buffer/textures/... have been rebuilt\n      this.wipeCaches(true);\n      this._depthCullingState.depthTest = depthTest;\n      this._depthCullingState.depthFunc = depthFunc;\n      this._depthCullingState.depthMask = depthMask;\n      this._stencilState.stencilTest = stencilTest;\n      Logger.Warn(this.name + \" context successfully restored.\");\n      this.onContextRestoredObservable.notifyObservers(this);\n      this._contextWasLost = false;\n    }, 0);\n  }\n  /**\n   * Shared initialization across engines types.\n   * @param canvas The canvas associated with this instance of the engine.\n   */\n  _sharedInit(canvas) {\n    this._renderingCanvas = canvas;\n  }\n  /**\n   * @internal\n   */\n  _getShaderProcessingContext(shaderLanguage) {\n    return null;\n  }\n  _rebuildInternalTextures() {\n    const currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\n    for (const internalTexture of currentState) {\n      internalTexture._rebuild();\n    }\n  }\n  _rebuildRenderTargetWrappers() {\n    const currentState = this._renderTargetWrapperCache.slice(); // Do a copy because the rebuild will add proxies\n    for (const renderTargetWrapper of currentState) {\n      renderTargetWrapper._rebuild();\n    }\n  }\n  _rebuildEffects() {\n    for (const key in this._compiledEffects) {\n      const effect = this._compiledEffects[key];\n      effect._pipelineContext = null; // because _prepareEffect will try to dispose this pipeline before recreating it and that would lead to webgl errors\n      effect._wasPreviouslyReady = false;\n      effect._prepareEffect();\n    }\n    Effect.ResetCache();\n  }\n  /**\n   * Gets a boolean indicating if all created effects are ready\n   * @returns true if all effects are ready\n   */\n  areAllEffectsReady() {\n    for (const key in this._compiledEffects) {\n      const effect = this._compiledEffects[key];\n      if (!effect.isReady()) {\n        return false;\n      }\n    }\n    return true;\n  }\n  _rebuildBuffers() {\n    // Uniforms\n    for (const uniformBuffer of this._uniformBuffers) {\n      uniformBuffer._rebuild();\n    }\n    // Storage buffers\n    for (const storageBuffer of this._storageBuffers) {\n      storageBuffer._rebuild();\n    }\n  }\n  _initGLContext() {\n    var _a;\n    // Caps\n    this._caps = {\n      maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\n      maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\n      maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\n      maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\n      maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\n      maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\n      maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\n      maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\n      maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\n      maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\n      maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\n      parallelShaderCompile: this._gl.getExtension(\"KHR_parallel_shader_compile\") || undefined,\n      standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension(\"OES_standard_derivatives\") !== null,\n      maxAnisotropy: 1,\n      astc: this._gl.getExtension(\"WEBGL_compressed_texture_astc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_astc\"),\n      bptc: this._gl.getExtension(\"EXT_texture_compression_bptc\") || this._gl.getExtension(\"WEBKIT_EXT_texture_compression_bptc\"),\n      s3tc: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc\"),\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      s3tc_srgb: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc_srgb\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc_srgb\"),\n      pvrtc: this._gl.getExtension(\"WEBGL_compressed_texture_pvrtc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_pvrtc\"),\n      etc1: this._gl.getExtension(\"WEBGL_compressed_texture_etc1\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc1\"),\n      etc2: this._gl.getExtension(\"WEBGL_compressed_texture_etc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc\") || this._gl.getExtension(\"WEBGL_compressed_texture_es3_0\"),\n      textureAnisotropicFilterExtension: this._gl.getExtension(\"EXT_texture_filter_anisotropic\") || this._gl.getExtension(\"WEBKIT_EXT_texture_filter_anisotropic\") || this._gl.getExtension(\"MOZ_EXT_texture_filter_anisotropic\"),\n      uintIndices: this._webGLVersion > 1 || this._gl.getExtension(\"OES_element_index_uint\") !== null,\n      fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_frag_depth\") !== null,\n      highPrecisionShaderSupported: false,\n      timerQuery: this._gl.getExtension(\"EXT_disjoint_timer_query_webgl2\") || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\n      supportOcclusionQuery: this._webGLVersion > 1,\n      canUseTimestampForTimerQuery: false,\n      drawBuffersExtension: false,\n      maxMSAASamples: 1,\n      colorBufferFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_float\")),\n      colorBufferHalfFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_half_float\")),\n      textureFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_float\") ? true : false,\n      textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_half_float\") ? true : false,\n      textureHalfFloatRender: false,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloatLinearFiltering: false,\n      vertexArrayObject: false,\n      instancedArrays: false,\n      textureLOD: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_shader_texture_lod\") ? true : false,\n      texelFetch: this._webGLVersion !== 1,\n      blendMinMax: false,\n      multiview: this._gl.getExtension(\"OVR_multiview2\"),\n      oculusMultiview: this._gl.getExtension(\"OCULUS_multiview\"),\n      depthTextureExtension: false,\n      canUseGLInstanceID: this._webGLVersion > 1,\n      canUseGLVertexID: this._webGLVersion > 1,\n      supportComputeShaders: false,\n      supportSRGBBuffers: false,\n      supportTransformFeedbacks: this._webGLVersion > 1,\n      textureMaxLevel: this._webGLVersion > 1,\n      texture2DArrayMaxLayerCount: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS) : 128,\n      disableMorphTargetTexture: false\n    };\n    // Infos\n    this._glVersion = this._gl.getParameter(this._gl.VERSION);\n    const rendererInfo = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\n    if (rendererInfo != null) {\n      this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\n      this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\n    }\n    if (!this._glVendor) {\n      this._glVendor = this._gl.getParameter(this._gl.VENDOR) || \"Unknown vendor\";\n    }\n    if (!this._glRenderer) {\n      this._glRenderer = this._gl.getParameter(this._gl.RENDERER) || \"Unknown renderer\";\n    }\n    // Constants\n    if (this._gl.HALF_FLOAT_OES !== 0x8d61) {\n      this._gl.HALF_FLOAT_OES = 0x8d61; // Half floating-point type (16-bit).\n    }\n\n    if (this._gl.RGBA16F !== 0x881a) {\n      this._gl.RGBA16F = 0x881a; // RGBA 16-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.RGBA32F !== 0x8814) {\n      this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.DEPTH24_STENCIL8 !== 35056) {\n      this._gl.DEPTH24_STENCIL8 = 35056;\n    }\n    // Extensions\n    if (this._caps.timerQuery) {\n      if (this._webGLVersion === 1) {\n        this._gl.getQuery = this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery);\n      }\n      // WebGLQuery casted to number to avoid TS error\n      this._caps.canUseTimestampForTimerQuery = ((_a = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)) !== null && _a !== void 0 ? _a : 0) > 0;\n    }\n    this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\n    this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension(\"OES_texture_float_linear\") ? true : false;\n    this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\n    this._caps.textureHalfFloatLinearFiltering = this._webGLVersion > 1 || this._caps.textureHalfFloat && this._gl.getExtension(\"OES_texture_half_float_linear\") ? true : false;\n    // Compressed formats\n    if (this._caps.astc) {\n      this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR = this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\n    }\n    if (this._caps.bptc) {\n      this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT = this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\n    }\n    if (this._caps.s3tc_srgb) {\n      this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT;\n      this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\n      this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\n    }\n    if (this._caps.etc2) {\n      this._gl.COMPRESSED_SRGB8_ETC2 = this._caps.etc2.COMPRESSED_SRGB8_ETC2;\n      this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC = this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;\n    }\n    // Checks if some of the format renders first to allow the use of webgl inspector.\n    if (this._webGLVersion > 1) {\n      if (this._gl.HALF_FLOAT_OES !== 0x140b) {\n        this._gl.HALF_FLOAT_OES = 0x140b;\n      }\n    }\n    this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer();\n    // Draw buffers\n    if (this._webGLVersion > 1) {\n      this._caps.drawBuffersExtension = true;\n      this._caps.maxMSAASamples = this._maxMSAASamplesOverride !== null ? this._maxMSAASamplesOverride : this._gl.getParameter(this._gl.MAX_SAMPLES);\n    } else {\n      const drawBuffersExtension = this._gl.getExtension(\"WEBGL_draw_buffers\");\n      if (drawBuffersExtension !== null) {\n        this._caps.drawBuffersExtension = true;\n        this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\n        this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\n        for (let i = 0; i < 16; i++) {\n          this._gl[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = drawBuffersExtension[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\n        }\n      }\n    }\n    // Depth Texture\n    if (this._webGLVersion > 1) {\n      this._caps.depthTextureExtension = true;\n    } else {\n      const depthTextureExtension = this._gl.getExtension(\"WEBGL_depth_texture\");\n      if (depthTextureExtension != null) {\n        this._caps.depthTextureExtension = true;\n        this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\n      }\n    }\n    // Vertex array object\n    if (this.disableVertexArrayObjects) {\n      this._caps.vertexArrayObject = false;\n    } else if (this._webGLVersion > 1) {\n      this._caps.vertexArrayObject = true;\n    } else {\n      const vertexArrayObjectExtension = this._gl.getExtension(\"OES_vertex_array_object\");\n      if (vertexArrayObjectExtension != null) {\n        this._caps.vertexArrayObject = true;\n        this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\n      }\n    }\n    // Instances count\n    if (this._webGLVersion > 1) {\n      this._caps.instancedArrays = true;\n    } else {\n      const instanceExtension = this._gl.getExtension(\"ANGLE_instanced_arrays\");\n      if (instanceExtension != null) {\n        this._caps.instancedArrays = true;\n        this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\n        this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\n        this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\n      } else {\n        this._caps.instancedArrays = false;\n      }\n    }\n    if (this._gl.getShaderPrecisionFormat) {\n      const vertexhighp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\n      const fragmenthighp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\n      if (vertexhighp && fragmenthighp) {\n        this._caps.highPrecisionShaderSupported = vertexhighp.precision !== 0 && fragmenthighp.precision !== 0;\n      }\n    }\n    if (this._webGLVersion > 1) {\n      this._caps.blendMinMax = true;\n    } else {\n      const blendMinMaxExtension = this._gl.getExtension(\"EXT_blend_minmax\");\n      if (blendMinMaxExtension != null) {\n        this._caps.blendMinMax = true;\n        this._gl.MAX = blendMinMaxExtension.MAX_EXT;\n        this._gl.MIN = blendMinMaxExtension.MIN_EXT;\n      }\n    }\n    // sRGB buffers\n    // only run this if not already set to true (in the constructor, for example)\n    if (!this._caps.supportSRGBBuffers) {\n      if (this._webGLVersion > 1) {\n        this._caps.supportSRGBBuffers = true;\n        this._glSRGBExtensionValues = {\n          SRGB: WebGL2RenderingContext.SRGB,\n          SRGB8: WebGL2RenderingContext.SRGB8,\n          SRGB8_ALPHA8: WebGL2RenderingContext.SRGB8_ALPHA8\n        };\n      } else {\n        const sRGBExtension = this._gl.getExtension(\"EXT_sRGB\");\n        if (sRGBExtension != null) {\n          this._caps.supportSRGBBuffers = true;\n          this._glSRGBExtensionValues = {\n            SRGB: sRGBExtension.SRGB_EXT,\n            SRGB8: sRGBExtension.SRGB_ALPHA_EXT,\n            SRGB8_ALPHA8: sRGBExtension.SRGB_ALPHA_EXT\n          };\n        }\n      }\n      // take into account the forced state that was provided in options\n      // When the issue in angle/chrome is fixed the flag should be taken into account only when it is explicitly defined\n      this._caps.supportSRGBBuffers = this._caps.supportSRGBBuffers && !!(this._creationOptions && this._creationOptions.forceSRGBBufferSupportState);\n    }\n    // Depth buffer\n    this._depthCullingState.depthTest = true;\n    this._depthCullingState.depthFunc = this._gl.LEQUAL;\n    this._depthCullingState.depthMask = true;\n    // Texture maps\n    this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\n    for (let slot = 0; slot < this._maxSimultaneousTextures; slot++) {\n      this._nextFreeTextureSlots.push(slot);\n    }\n    if (this._glRenderer === \"Mali-G72\") {\n      // Overcome a bug when using a texture to store morph targets on Mali-G72\n      this._caps.disableMorphTargetTexture = true;\n    }\n  }\n  _initFeatures() {\n    this._features = {\n      forceBitmapOverHTMLImageElement: false,\n      supportRenderAndCopyToLodForFloatTextures: this._webGLVersion !== 1,\n      supportDepthStencilTexture: this._webGLVersion !== 1,\n      supportShadowSamplers: this._webGLVersion !== 1,\n      uniformBufferHardCheckMatrix: false,\n      allowTexturePrefiltering: this._webGLVersion !== 1,\n      trackUbosInFrame: false,\n      checkUbosContentBeforeUpload: false,\n      supportCSM: this._webGLVersion !== 1,\n      basisNeedsPOT: this._webGLVersion === 1,\n      support3DTextures: this._webGLVersion !== 1,\n      needTypeSuffixInShaderConstants: this._webGLVersion !== 1,\n      supportMSAA: this._webGLVersion !== 1,\n      supportSSAO2: this._webGLVersion !== 1,\n      supportExtendedTextureFormats: this._webGLVersion !== 1,\n      supportSwitchCaseInShader: this._webGLVersion !== 1,\n      supportSyncTextureRead: true,\n      needsInvertingBitmap: true,\n      useUBOBindingCache: true,\n      needShaderCodeInlining: false,\n      needToAlwaysBindUniformBuffers: false,\n      supportRenderPasses: false,\n      supportSpriteInstancing: true,\n      forceVertexBufferStrideMultiple4Bytes: false,\n      _collectUbosUpdatedInFrame: false\n    };\n  }\n  /**\n   * Gets version of the current webGL context\n   * Keep it for back compat - use version instead\n   */\n  get webGLVersion() {\n    return this._webGLVersion;\n  }\n  /**\n   * Gets a string identifying the name of the class\n   * @returns \"Engine\" string\n   */\n  getClassName() {\n    return \"ThinEngine\";\n  }\n  /**\n   * Returns true if the stencil buffer has been enabled through the creation option of the context.\n   */\n  get isStencilEnable() {\n    return this._isStencilEnable;\n  }\n  /** @internal */\n  _prepareWorkingCanvas() {\n    if (this._workingCanvas) {\n      return;\n    }\n    this._workingCanvas = this.createCanvas(1, 1);\n    const context = this._workingCanvas.getContext(\"2d\");\n    if (context) {\n      this._workingContext = context;\n    }\n  }\n  /**\n   * Reset the texture cache to empty state\n   */\n  resetTextureCache() {\n    for (const key in this._boundTexturesCache) {\n      if (!Object.prototype.hasOwnProperty.call(this._boundTexturesCache, key)) {\n        continue;\n      }\n      this._boundTexturesCache[key] = null;\n    }\n    this._currentTextureChannel = -1;\n  }\n  /**\n   * Gets an object containing information about the current engine context\n   * @returns an object containing the vendor, the renderer and the version of the current engine context\n   */\n  getInfo() {\n    return this.getGlInfo();\n  }\n  /**\n   * Gets an object containing information about the current webGL context\n   * @returns an object containing the vendor, the renderer and the version of the current webGL context\n   */\n  getGlInfo() {\n    return {\n      vendor: this._glVendor,\n      renderer: this._glRenderer,\n      version: this._glVersion\n    };\n  }\n  /**\n   * Defines the hardware scaling level.\n   * By default the hardware scaling level is computed from the window device ratio.\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\n   * @param level defines the level to use\n   */\n  setHardwareScalingLevel(level) {\n    this._hardwareScalingLevel = level;\n    this.resize();\n  }\n  /**\n   * Gets the current hardware scaling level.\n   * By default the hardware scaling level is computed from the window device ratio.\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\n   * @returns a number indicating the current hardware scaling level\n   */\n  getHardwareScalingLevel() {\n    return this._hardwareScalingLevel;\n  }\n  /**\n   * Gets the list of loaded textures\n   * @returns an array containing all loaded textures\n   */\n  getLoadedTexturesCache() {\n    return this._internalTexturesCache;\n  }\n  /**\n   * Gets the object containing all engine capabilities\n   * @returns the EngineCapabilities object\n   */\n  getCaps() {\n    return this._caps;\n  }\n  /**\n   * stop executing a render loop function and remove it from the execution array\n   * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\n   */\n  stopRenderLoop(renderFunction) {\n    if (!renderFunction) {\n      this._activeRenderLoops.length = 0;\n      this._cancelFrame();\n      return;\n    }\n    const index = this._activeRenderLoops.indexOf(renderFunction);\n    if (index >= 0) {\n      this._activeRenderLoops.splice(index, 1);\n      if (this._activeRenderLoops.length == 0) {\n        this._cancelFrame();\n      }\n    }\n  }\n  _cancelFrame() {\n    if (this._renderingQueueLaunched && this._frameHandler) {\n      this._renderingQueueLaunched = false;\n      if (!IsWindowObjectExist()) {\n        if (typeof cancelAnimationFrame === \"function\") {\n          return cancelAnimationFrame(this._frameHandler);\n        }\n      } else {\n        const {\n          cancelAnimationFrame\n        } = this.getHostWindow() || window;\n        if (typeof cancelAnimationFrame === \"function\") {\n          return cancelAnimationFrame(this._frameHandler);\n        }\n      }\n      return clearTimeout(this._frameHandler);\n    }\n  }\n  /** @internal */\n  _renderLoop() {\n    if (!this._contextWasLost) {\n      let shouldRender = true;\n      if (this._isDisposed || !this.renderEvenInBackground && this._windowIsBackground) {\n        shouldRender = false;\n      }\n      if (shouldRender) {\n        // Start new frame\n        this.beginFrame();\n        for (let index = 0; index < this._activeRenderLoops.length; index++) {\n          const renderFunction = this._activeRenderLoops[index];\n          renderFunction();\n        }\n        // Present\n        this.endFrame();\n      }\n    }\n    if (this._activeRenderLoops.length > 0) {\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    } else {\n      this._renderingQueueLaunched = false;\n    }\n  }\n  /**\n   * Gets the HTML canvas attached with the current webGL context\n   * @returns a HTML canvas\n   */\n  getRenderingCanvas() {\n    return this._renderingCanvas;\n  }\n  /**\n   * Gets the audio context specified in engine initialization options\n   * @returns an Audio Context\n   */\n  getAudioContext() {\n    return this._audioContext;\n  }\n  /**\n   * Gets the audio destination specified in engine initialization options\n   * @returns an audio destination node\n   */\n  getAudioDestination() {\n    return this._audioDestination;\n  }\n  /**\n   * Gets host window\n   * @returns the host window object\n   */\n  getHostWindow() {\n    if (!IsWindowObjectExist()) {\n      return null;\n    }\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\n      return this._renderingCanvas.ownerDocument.defaultView;\n    }\n    return window;\n  }\n  /**\n   * Gets the current render width\n   * @param useScreen defines if screen size must be used (or the current render target if any)\n   * @returns a number defining the current render width\n   */\n  getRenderWidth(useScreen = false) {\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\n  }\n  /**\n   * Gets the current render height\n   * @param useScreen defines if screen size must be used (or the current render target if any)\n   * @returns a number defining the current render height\n   */\n  getRenderHeight(useScreen = false) {\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\n  }\n  /**\n   * Can be used to override the current requestAnimationFrame requester.\n   * @internal\n   */\n  _queueNewFrame(bindedRenderFunction, requester) {\n    return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\n  }\n  /**\n   * Register and execute a render loop. The engine can have more than one render function\n   * @param renderFunction defines the function to continuously execute\n   */\n  runRenderLoop(renderFunction) {\n    if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\n      return;\n    }\n    this._activeRenderLoops.push(renderFunction);\n    if (!this._renderingQueueLaunched) {\n      this._renderingQueueLaunched = true;\n      this._boundRenderFunction = () => this._renderLoop();\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    }\n  }\n  /**\n   * Clear the current render buffer or the current render target (if any is set up)\n   * @param color defines the color to use\n   * @param backBuffer defines if the back buffer must be cleared\n   * @param depth defines if the depth buffer must be cleared\n   * @param stencil defines if the stencil buffer must be cleared\n   */\n  clear(color, backBuffer, depth, stencil = false) {\n    var _a, _b;\n    const useStencilGlobalOnly = this.stencilStateComposer.useStencilGlobalOnly;\n    this.stencilStateComposer.useStencilGlobalOnly = true; // make sure the stencil mask is coming from the global stencil and not from a material (effect) which would currently be in effect\n    this.applyStates();\n    this.stencilStateComposer.useStencilGlobalOnly = useStencilGlobalOnly;\n    let mode = 0;\n    if (backBuffer && color) {\n      let setBackBufferColor = true;\n      if (this._currentRenderTarget) {\n        const textureFormat = (_a = this._currentRenderTarget.texture) === null || _a === void 0 ? void 0 : _a.format;\n        if (textureFormat === 8 || textureFormat === 9 || textureFormat === 10 || textureFormat === 11) {\n          const textureType = (_b = this._currentRenderTarget.texture) === null || _b === void 0 ? void 0 : _b.type;\n          if (textureType === 7 || textureType === 5) {\n            ThinEngine._TempClearColorUint32[0] = color.r * 255;\n            ThinEngine._TempClearColorUint32[1] = color.g * 255;\n            ThinEngine._TempClearColorUint32[2] = color.b * 255;\n            ThinEngine._TempClearColorUint32[3] = color.a * 255;\n            this._gl.clearBufferuiv(this._gl.COLOR, 0, ThinEngine._TempClearColorUint32);\n            setBackBufferColor = false;\n          } else {\n            ThinEngine._TempClearColorInt32[0] = color.r * 255;\n            ThinEngine._TempClearColorInt32[1] = color.g * 255;\n            ThinEngine._TempClearColorInt32[2] = color.b * 255;\n            ThinEngine._TempClearColorInt32[3] = color.a * 255;\n            this._gl.clearBufferiv(this._gl.COLOR, 0, ThinEngine._TempClearColorInt32);\n            setBackBufferColor = false;\n          }\n        }\n      }\n      if (setBackBufferColor) {\n        this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\n        mode |= this._gl.COLOR_BUFFER_BIT;\n      }\n    }\n    if (depth) {\n      if (this.useReverseDepthBuffer) {\n        this._depthCullingState.depthFunc = this._gl.GEQUAL;\n        this._gl.clearDepth(0.0);\n      } else {\n        this._gl.clearDepth(1.0);\n      }\n      mode |= this._gl.DEPTH_BUFFER_BIT;\n    }\n    if (stencil) {\n      this._gl.clearStencil(0);\n      mode |= this._gl.STENCIL_BUFFER_BIT;\n    }\n    this._gl.clear(mode);\n  }\n  /**\n   * @internal\n   */\n  _viewport(x, y, width, height) {\n    if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\n      this._viewportCached.x = x;\n      this._viewportCached.y = y;\n      this._viewportCached.z = width;\n      this._viewportCached.w = height;\n      this._gl.viewport(x, y, width, height);\n    }\n  }\n  /**\n   * Set the WebGL's viewport\n   * @param viewport defines the viewport element to be used\n   * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\n   * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\n   */\n  setViewport(viewport, requiredWidth, requiredHeight) {\n    const width = requiredWidth || this.getRenderWidth();\n    const height = requiredHeight || this.getRenderHeight();\n    const x = viewport.x || 0;\n    const y = viewport.y || 0;\n    this._cachedViewport = viewport;\n    this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\n  }\n  /**\n   * Begin a new frame\n   */\n  beginFrame() {}\n  /**\n   * Enf the current frame\n   */\n  endFrame() {\n    // Force a flush in case we are using a bad OS.\n    if (this._badOS) {\n      this.flushFramebuffer();\n    }\n    this._frameId++;\n  }\n  /**\n   * Resize the view according to the canvas' size\n   * @param forceSetSize true to force setting the sizes of the underlying canvas\n   */\n  resize(forceSetSize = false) {\n    let width;\n    let height;\n    // Re-query hardware scaling level to handle zoomed-in resizing.\n    if (this.adaptToDeviceRatio) {\n      const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n      const changeRatio = this._lastDevicePixelRatio / devicePixelRatio;\n      this._lastDevicePixelRatio = devicePixelRatio;\n      this._hardwareScalingLevel *= changeRatio;\n    }\n    if (IsWindowObjectExist() && IsDocumentAvailable()) {\n      // make sure it is a Node object, and is a part of the document.\n      if (this._renderingCanvas) {\n        const boundingRect = this._renderingCanvas.getBoundingClientRect ? this._renderingCanvas.getBoundingClientRect() : {\n          // fallback to last solution in case the function doesn't exist\n          width: this._renderingCanvas.width * this._hardwareScalingLevel,\n          height: this._renderingCanvas.height * this._hardwareScalingLevel\n        };\n        width = this._renderingCanvas.clientWidth || boundingRect.width || this._renderingCanvas.width || 100;\n        height = this._renderingCanvas.clientHeight || boundingRect.height || this._renderingCanvas.height || 100;\n      } else {\n        width = window.innerWidth;\n        height = window.innerHeight;\n      }\n    } else {\n      width = this._renderingCanvas ? this._renderingCanvas.width : 100;\n      height = this._renderingCanvas ? this._renderingCanvas.height : 100;\n    }\n    this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel, forceSetSize);\n  }\n  /**\n   * Force a specific size of the canvas\n   * @param width defines the new canvas' width\n   * @param height defines the new canvas' height\n   * @param forceSetSize true to force setting the sizes of the underlying canvas\n   * @returns true if the size was changed\n   */\n  setSize(width, height, forceSetSize = false) {\n    if (!this._renderingCanvas) {\n      return false;\n    }\n    width = width | 0;\n    height = height | 0;\n    if (!forceSetSize && this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\n      return false;\n    }\n    this._renderingCanvas.width = width;\n    this._renderingCanvas.height = height;\n    return true;\n  }\n  /**\n   * Binds the frame buffer to the specified texture.\n   * @param rtWrapper The render target wrapper to render to\n   * @param faceIndex The face of the texture to render to in case of cube texture and if the render target wrapper is not a multi render target\n   * @param requiredWidth The width of the target to render to\n   * @param requiredHeight The height of the target to render to\n   * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\n   * @param lodLevel Defines the lod level to bind to the frame buffer\n   * @param layer Defines the 2d array index to bind to the frame buffer if the render target wrapper is not a multi render target\n   */\n  bindFramebuffer(rtWrapper, faceIndex = 0, requiredWidth, requiredHeight, forceFullscreenViewport, lodLevel = 0, layer = 0) {\n    var _a, _b, _c, _d, _e, _f;\n    const webglRTWrapper = rtWrapper;\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    }\n    this._currentRenderTarget = rtWrapper;\n    this._bindUnboundFramebuffer(webglRTWrapper._MSAAFramebuffer ? webglRTWrapper._MSAAFramebuffer : webglRTWrapper._framebuffer);\n    const gl = this._gl;\n    if (!rtWrapper.isMulti) {\n      if (rtWrapper.is2DArray) {\n        gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, (_a = rtWrapper.texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource, lodLevel, layer);\n      } else if (rtWrapper.isCube) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, (_b = rtWrapper.texture._hardwareTexture) === null || _b === void 0 ? void 0 : _b.underlyingResource, lodLevel);\n      } else if (webglRTWrapper._currentLOD !== lodLevel) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, (_c = rtWrapper.texture._hardwareTexture) === null || _c === void 0 ? void 0 : _c.underlyingResource, lodLevel);\n        webglRTWrapper._currentLOD = lodLevel;\n      }\n    }\n    const depthStencilTexture = rtWrapper._depthStencilTexture;\n    if (depthStencilTexture) {\n      const attachment = rtWrapper._depthStencilTextureWithStencil ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\n      if (rtWrapper.is2DArray) {\n        gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, (_d = depthStencilTexture._hardwareTexture) === null || _d === void 0 ? void 0 : _d.underlyingResource, lodLevel, layer);\n      } else if (rtWrapper.isCube) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, (_e = depthStencilTexture._hardwareTexture) === null || _e === void 0 ? void 0 : _e.underlyingResource, lodLevel);\n      } else {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, (_f = depthStencilTexture._hardwareTexture) === null || _f === void 0 ? void 0 : _f.underlyingResource, lodLevel);\n      }\n    }\n    if (this._cachedViewport && !forceFullscreenViewport) {\n      this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\n    } else {\n      if (!requiredWidth) {\n        requiredWidth = rtWrapper.width;\n        if (lodLevel) {\n          requiredWidth = requiredWidth / Math.pow(2, lodLevel);\n        }\n      }\n      if (!requiredHeight) {\n        requiredHeight = rtWrapper.height;\n        if (lodLevel) {\n          requiredHeight = requiredHeight / Math.pow(2, lodLevel);\n        }\n      }\n      this._viewport(0, 0, requiredWidth, requiredHeight);\n    }\n    this.wipeCaches();\n  }\n  /**\n   * Set various states to the webGL context\n   * @param culling defines culling state: true to enable culling, false to disable it\n   * @param zOffset defines the value to apply to zOffset (0 by default)\n   * @param force defines if states must be applied even if cache is up to date\n   * @param reverseSide defines if culling must be reversed (CCW if false, CW if true)\n   * @param cullBackFaces true to cull back faces, false to cull front faces (if culling is enabled)\n   * @param stencil stencil states to set\n   * @param zOffsetUnits defines the value to apply to zOffsetUnits (0 by default)\n   */\n  setState(culling, zOffset = 0, force, reverseSide = false, cullBackFaces, stencil, zOffsetUnits = 0) {\n    var _a, _b;\n    // Culling\n    if (this._depthCullingState.cull !== culling || force) {\n      this._depthCullingState.cull = culling;\n    }\n    // Cull face\n    const cullFace = ((_b = (_a = this.cullBackFaces) !== null && _a !== void 0 ? _a : cullBackFaces) !== null && _b !== void 0 ? _b : true) ? this._gl.BACK : this._gl.FRONT;\n    if (this._depthCullingState.cullFace !== cullFace || force) {\n      this._depthCullingState.cullFace = cullFace;\n    }\n    // Z offset\n    this.setZOffset(zOffset);\n    this.setZOffsetUnits(zOffsetUnits);\n    // Front face\n    const frontFace = reverseSide ? this._gl.CW : this._gl.CCW;\n    if (this._depthCullingState.frontFace !== frontFace || force) {\n      this._depthCullingState.frontFace = frontFace;\n    }\n    this._stencilStateComposer.stencilMaterial = stencil;\n  }\n  /**\n   * Gets a boolean indicating if depth testing is enabled\n   * @returns the current state\n   */\n  getDepthBuffer() {\n    return this._depthCullingState.depthTest;\n  }\n  /**\n   * Enable or disable depth buffering\n   * @param enable defines the state to set\n   */\n  setDepthBuffer(enable) {\n    this._depthCullingState.depthTest = enable;\n  }\n  /**\n   * Set the z offset Factor to apply to current rendering\n   * @param value defines the offset to apply\n   */\n  setZOffset(value) {\n    this._depthCullingState.zOffset = this.useReverseDepthBuffer ? -value : value;\n  }\n  /**\n   * Gets the current value of the zOffset Factor\n   * @returns the current zOffset Factor state\n   */\n  getZOffset() {\n    const zOffset = this._depthCullingState.zOffset;\n    return this.useReverseDepthBuffer ? -zOffset : zOffset;\n  }\n  /**\n   * Set the z offset Units to apply to current rendering\n   * @param value defines the offset to apply\n   */\n  setZOffsetUnits(value) {\n    this._depthCullingState.zOffsetUnits = this.useReverseDepthBuffer ? -value : value;\n  }\n  /**\n   * Gets the current value of the zOffset Units\n   * @returns the current zOffset Units state\n   */\n  getZOffsetUnits() {\n    const zOffsetUnits = this._depthCullingState.zOffsetUnits;\n    return this.useReverseDepthBuffer ? -zOffsetUnits : zOffsetUnits;\n  }\n  /**\n   * @internal\n   */\n  _bindUnboundFramebuffer(framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\n      this._currentFramebuffer = framebuffer;\n    }\n  }\n  /** @internal */\n  _currentFrameBufferIsDefaultFrameBuffer() {\n    return this._currentFramebuffer === null;\n  }\n  /**\n   * Generates the mipmaps for a texture\n   * @param texture texture to generate the mipmaps for\n   */\n  generateMipmaps(texture) {\n    this._bindTextureDirectly(this._gl.TEXTURE_2D, texture, true);\n    this._gl.generateMipmap(this._gl.TEXTURE_2D);\n    this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n  }\n  /**\n   * Unbind the current render target texture from the webGL context\n   * @param texture defines the render target wrapper to unbind\n   * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\n   * @param onBeforeUnbind defines a function which will be called before the effective unbind\n   */\n  unBindFramebuffer(texture, disableGenerateMipMaps = false, onBeforeUnbind) {\n    var _a;\n    const webglRTWrapper = texture;\n    this._currentRenderTarget = null;\n    // If MSAA, we need to bitblt back to main texture\n    const gl = this._gl;\n    if (webglRTWrapper._MSAAFramebuffer) {\n      if (texture.isMulti) {\n        // This texture is part of a MRT texture, we need to treat all attachments\n        this.unBindMultiColorAttachmentFramebuffer(texture, disableGenerateMipMaps, onBeforeUnbind);\n        return;\n      }\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, webglRTWrapper._MSAAFramebuffer);\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, webglRTWrapper._framebuffer);\n      gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\n    }\n    if (((_a = texture.texture) === null || _a === void 0 ? void 0 : _a.generateMipMaps) && !disableGenerateMipMaps && !texture.isCube) {\n      this.generateMipmaps(texture.texture);\n    }\n    if (onBeforeUnbind) {\n      if (webglRTWrapper._MSAAFramebuffer) {\n        // Bind the correct framebuffer\n        this._bindUnboundFramebuffer(webglRTWrapper._framebuffer);\n      }\n      onBeforeUnbind();\n    }\n    this._bindUnboundFramebuffer(null);\n  }\n  /**\n   * Force a webGL flush (ie. a flush of all waiting webGL commands)\n   */\n  flushFramebuffer() {\n    this._gl.flush();\n  }\n  /**\n   * Unbind the current render target and bind the default framebuffer\n   */\n  restoreDefaultFramebuffer() {\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    } else {\n      this._bindUnboundFramebuffer(null);\n    }\n    if (this._cachedViewport) {\n      this.setViewport(this._cachedViewport);\n    }\n    this.wipeCaches();\n  }\n  // VBOs\n  /** @internal */\n  _resetVertexBufferBinding() {\n    this.bindArrayBuffer(null);\n    this._cachedVertexBuffers = null;\n  }\n  /**\n   * Creates a vertex buffer\n   * @param data the data for the vertex buffer\n   * @param _updatable whether the buffer should be created as updatable\n   * @param _label defines the label of the buffer (for debug purpose)\n   * @returns the new WebGL static buffer\n   */\n  createVertexBuffer(data, _updatable, _label) {\n    return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\n  }\n  _createVertexBuffer(data, usage) {\n    const vbo = this._gl.createBuffer();\n    if (!vbo) {\n      throw new Error(\"Unable to create vertex buffer\");\n    }\n    const dataBuffer = new WebGLDataBuffer(vbo);\n    this.bindArrayBuffer(dataBuffer);\n    if (data instanceof Array) {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), usage);\n    } else {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, data, usage);\n    }\n    this._resetVertexBufferBinding();\n    dataBuffer.references = 1;\n    return dataBuffer;\n  }\n  /**\n   * Creates a dynamic vertex buffer\n   * @param data the data for the dynamic vertex buffer\n   * @param _label defines the label of the buffer (for debug purpose)\n   * @returns the new WebGL dynamic buffer\n   */\n  createDynamicVertexBuffer(data, _label) {\n    return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\n  }\n  _resetIndexBufferBinding() {\n    this.bindIndexBuffer(null);\n    this._cachedIndexBuffer = null;\n  }\n  /**\n   * Creates a new index buffer\n   * @param indices defines the content of the index buffer\n   * @param updatable defines if the index buffer must be updatable\n   * @param _label defines the label of the buffer (for debug purpose)\n   * @returns a new webGL buffer\n   */\n  createIndexBuffer(indices, updatable, _label) {\n    const vbo = this._gl.createBuffer();\n    const dataBuffer = new WebGLDataBuffer(vbo);\n    if (!vbo) {\n      throw new Error(\"Unable to create index buffer\");\n    }\n    this.bindIndexBuffer(dataBuffer);\n    const data = this._normalizeIndexData(indices);\n    this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\n    this._resetIndexBufferBinding();\n    dataBuffer.references = 1;\n    dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n    return dataBuffer;\n  }\n  _normalizeIndexData(indices) {\n    const bytesPerElement = indices.BYTES_PER_ELEMENT;\n    if (bytesPerElement === 2) {\n      return indices;\n    }\n    // Check 32 bit support\n    if (this._caps.uintIndices) {\n      if (indices instanceof Uint32Array) {\n        return indices;\n      } else {\n        // number[] or Int32Array, check if 32 bit is necessary\n        for (let index = 0; index < indices.length; index++) {\n          if (indices[index] >= 65535) {\n            return new Uint32Array(indices);\n          }\n        }\n        return new Uint16Array(indices);\n      }\n    }\n    // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\n    return new Uint16Array(indices);\n  }\n  /**\n   * Bind a webGL buffer to the webGL context\n   * @param buffer defines the buffer to bind\n   */\n  bindArrayBuffer(buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n    this._bindBuffer(buffer, this._gl.ARRAY_BUFFER);\n  }\n  /**\n   * Bind a specific block at a given index in a specific shader program\n   * @param pipelineContext defines the pipeline context to use\n   * @param blockName defines the block name\n   * @param index defines the index where to bind the block\n   */\n  bindUniformBlock(pipelineContext, blockName, index) {\n    const program = pipelineContext.program;\n    const uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\n    this._gl.uniformBlockBinding(program, uniformLocation, index);\n  }\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  bindIndexBuffer(buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n    this._bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\n  }\n  _bindBuffer(buffer, target) {\n    if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\n      this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\n      this._currentBoundBuffer[target] = buffer;\n    }\n  }\n  /**\n   * update the bound buffer with the given data\n   * @param data defines the data to update\n   */\n  updateArrayBuffer(data) {\n    this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n  }\n  _vertexAttribPointer(buffer, indx, size, type, normalized, stride, offset) {\n    const pointer = this._currentBufferPointers[indx];\n    if (!pointer) {\n      return;\n    }\n    let changed = false;\n    if (!pointer.active) {\n      changed = true;\n      pointer.active = true;\n      pointer.index = indx;\n      pointer.size = size;\n      pointer.type = type;\n      pointer.normalized = normalized;\n      pointer.stride = stride;\n      pointer.offset = offset;\n      pointer.buffer = buffer;\n    } else {\n      if (pointer.buffer !== buffer) {\n        pointer.buffer = buffer;\n        changed = true;\n      }\n      if (pointer.size !== size) {\n        pointer.size = size;\n        changed = true;\n      }\n      if (pointer.type !== type) {\n        pointer.type = type;\n        changed = true;\n      }\n      if (pointer.normalized !== normalized) {\n        pointer.normalized = normalized;\n        changed = true;\n      }\n      if (pointer.stride !== stride) {\n        pointer.stride = stride;\n        changed = true;\n      }\n      if (pointer.offset !== offset) {\n        pointer.offset = offset;\n        changed = true;\n      }\n    }\n    if (changed || this._vaoRecordInProgress) {\n      this.bindArrayBuffer(buffer);\n      if (type === this._gl.UNSIGNED_INT || type === this._gl.INT) {\n        this._gl.vertexAttribIPointer(indx, size, type, stride, offset);\n      } else {\n        this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\n      }\n    }\n  }\n  /**\n   * @internal\n   */\n  _bindIndexBufferWithCache(indexBuffer) {\n    if (indexBuffer == null) {\n      return;\n    }\n    if (this._cachedIndexBuffer !== indexBuffer) {\n      this._cachedIndexBuffer = indexBuffer;\n      this.bindIndexBuffer(indexBuffer);\n      this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\n    }\n  }\n  _bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers) {\n    const attributes = effect.getAttributesNames();\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n    this.unbindAllAttributes();\n    for (let index = 0; index < attributes.length; index++) {\n      const order = effect.getAttributeLocation(index);\n      if (order >= 0) {\n        const ai = attributes[index];\n        let vertexBuffer = null;\n        if (overrideVertexBuffers) {\n          vertexBuffer = overrideVertexBuffers[ai];\n        }\n        if (!vertexBuffer) {\n          vertexBuffer = vertexBuffers[ai];\n        }\n        if (!vertexBuffer) {\n          continue;\n        }\n        this._gl.enableVertexAttribArray(order);\n        if (!this._vaoRecordInProgress) {\n          this._vertexAttribArraysEnabled[order] = true;\n        }\n        const buffer = vertexBuffer.getBuffer();\n        if (buffer) {\n          this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\n          if (vertexBuffer.getIsInstanced()) {\n            this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\n            if (!this._vaoRecordInProgress) {\n              this._currentInstanceLocations.push(order);\n              this._currentInstanceBuffers.push(buffer);\n            }\n          }\n        }\n      }\n    }\n  }\n  /**\n   * Records a vertex array object\n   * @see https://doc.babylonjs.com/setup/support/webGL2#vertex-array-objects\n   * @param vertexBuffers defines the list of vertex buffers to store\n   * @param indexBuffer defines the index buffer to store\n   * @param effect defines the effect to store\n   * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\n   * @returns the new vertex array object\n   */\n  recordVertexArrayObject(vertexBuffers, indexBuffer, effect, overrideVertexBuffers) {\n    const vao = this._gl.createVertexArray();\n    if (!vao) {\n      throw new Error(\"Unable to create VAO\");\n    }\n    this._vaoRecordInProgress = true;\n    this._gl.bindVertexArray(vao);\n    this._mustWipeVertexAttributes = true;\n    this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\n    this.bindIndexBuffer(indexBuffer);\n    this._vaoRecordInProgress = false;\n    this._gl.bindVertexArray(null);\n    return vao;\n  }\n  /**\n   * Bind a specific vertex array object\n   * @see https://doc.babylonjs.com/setup/support/webGL2#vertex-array-objects\n   * @param vertexArrayObject defines the vertex array object to bind\n   * @param indexBuffer defines the index buffer to bind\n   */\n  bindVertexArrayObject(vertexArrayObject, indexBuffer) {\n    if (this._cachedVertexArrayObject !== vertexArrayObject) {\n      this._cachedVertexArrayObject = vertexArrayObject;\n      this._gl.bindVertexArray(vertexArrayObject);\n      this._cachedVertexBuffers = null;\n      this._cachedIndexBuffer = null;\n      this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\n      this._mustWipeVertexAttributes = true;\n    }\n  }\n  /**\n   * Bind webGl buffers directly to the webGL context\n   * @param vertexBuffer defines the vertex buffer to bind\n   * @param indexBuffer defines the index buffer to bind\n   * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\n   * @param vertexStrideSize defines the vertex stride of the vertex buffer\n   * @param effect defines the effect associated with the vertex buffer\n   */\n  bindBuffersDirectly(vertexBuffer, indexBuffer, vertexDeclaration, vertexStrideSize, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffer;\n      this._cachedEffectForVertexBuffers = effect;\n      const attributesCount = effect.getAttributesCount();\n      this._unbindVertexArrayObject();\n      this.unbindAllAttributes();\n      let offset = 0;\n      for (let index = 0; index < attributesCount; index++) {\n        if (index < vertexDeclaration.length) {\n          const order = effect.getAttributeLocation(index);\n          if (order >= 0) {\n            this._gl.enableVertexAttribArray(order);\n            this._vertexAttribArraysEnabled[order] = true;\n            this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\n          }\n          offset += vertexDeclaration[index] * 4;\n        }\n      }\n    }\n    this._bindIndexBufferWithCache(indexBuffer);\n  }\n  _unbindVertexArrayObject() {\n    if (!this._cachedVertexArrayObject) {\n      return;\n    }\n    this._cachedVertexArrayObject = null;\n    this._gl.bindVertexArray(null);\n  }\n  /**\n   * Bind a list of vertex buffers to the webGL context\n   * @param vertexBuffers defines the list of vertex buffers to bind\n   * @param indexBuffer defines the index buffer to bind\n   * @param effect defines the effect associated with the vertex buffers\n   * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\n   */\n  bindBuffers(vertexBuffers, indexBuffer, effect, overrideVertexBuffers) {\n    if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffers;\n      this._cachedEffectForVertexBuffers = effect;\n      this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\n    }\n    this._bindIndexBufferWithCache(indexBuffer);\n  }\n  /**\n   * Unbind all instance attributes\n   */\n  unbindInstanceAttributes() {\n    let boundBuffer;\n    for (let i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\n      const instancesBuffer = this._currentInstanceBuffers[i];\n      if (boundBuffer != instancesBuffer && instancesBuffer.references) {\n        boundBuffer = instancesBuffer;\n        this.bindArrayBuffer(instancesBuffer);\n      }\n      const offsetLocation = this._currentInstanceLocations[i];\n      this._gl.vertexAttribDivisor(offsetLocation, 0);\n    }\n    this._currentInstanceBuffers.length = 0;\n    this._currentInstanceLocations.length = 0;\n  }\n  /**\n   * Release and free the memory of a vertex array object\n   * @param vao defines the vertex array object to delete\n   */\n  releaseVertexArrayObject(vao) {\n    this._gl.deleteVertexArray(vao);\n  }\n  /**\n   * @internal\n   */\n  _releaseBuffer(buffer) {\n    buffer.references--;\n    if (buffer.references === 0) {\n      this._deleteBuffer(buffer);\n      return true;\n    }\n    return false;\n  }\n  _deleteBuffer(buffer) {\n    this._gl.deleteBuffer(buffer.underlyingResource);\n  }\n  /**\n   * Update the content of a webGL buffer used with instantiation and bind it to the webGL context\n   * @param instancesBuffer defines the webGL buffer to update and bind\n   * @param data defines the data to store in the buffer\n   * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\n   */\n  updateAndBindInstancesBuffer(instancesBuffer, data, offsetLocations) {\n    this.bindArrayBuffer(instancesBuffer);\n    if (data) {\n      this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n    }\n    if (offsetLocations[0].index !== undefined) {\n      this.bindInstancesBuffer(instancesBuffer, offsetLocations, true);\n    } else {\n      for (let index = 0; index < 4; index++) {\n        const offsetLocation = offsetLocations[index];\n        if (!this._vertexAttribArraysEnabled[offsetLocation]) {\n          this._gl.enableVertexAttribArray(offsetLocation);\n          this._vertexAttribArraysEnabled[offsetLocation] = true;\n        }\n        this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\n        this._gl.vertexAttribDivisor(offsetLocation, 1);\n        this._currentInstanceLocations.push(offsetLocation);\n        this._currentInstanceBuffers.push(instancesBuffer);\n      }\n    }\n  }\n  /**\n   * Bind the content of a webGL buffer used with instantiation\n   * @param instancesBuffer defines the webGL buffer to bind\n   * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\n   * @param computeStride defines Whether to compute the strides from the info or use the default 0\n   */\n  bindInstancesBuffer(instancesBuffer, attributesInfo, computeStride = true) {\n    this.bindArrayBuffer(instancesBuffer);\n    let stride = 0;\n    if (computeStride) {\n      for (let i = 0; i < attributesInfo.length; i++) {\n        const ai = attributesInfo[i];\n        stride += ai.attributeSize * 4;\n      }\n    }\n    for (let i = 0; i < attributesInfo.length; i++) {\n      const ai = attributesInfo[i];\n      if (ai.index === undefined) {\n        ai.index = this._currentEffect.getAttributeLocationByName(ai.attributeName);\n      }\n      if (ai.index < 0) {\n        continue;\n      }\n      if (!this._vertexAttribArraysEnabled[ai.index]) {\n        this._gl.enableVertexAttribArray(ai.index);\n        this._vertexAttribArraysEnabled[ai.index] = true;\n      }\n      this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\n      this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\n      this._currentInstanceLocations.push(ai.index);\n      this._currentInstanceBuffers.push(instancesBuffer);\n    }\n  }\n  /**\n   * Disable the instance attribute corresponding to the name in parameter\n   * @param name defines the name of the attribute to disable\n   */\n  disableInstanceAttributeByName(name) {\n    if (!this._currentEffect) {\n      return;\n    }\n    const attributeLocation = this._currentEffect.getAttributeLocationByName(name);\n    this.disableInstanceAttribute(attributeLocation);\n  }\n  /**\n   * Disable the instance attribute corresponding to the location in parameter\n   * @param attributeLocation defines the attribute location of the attribute to disable\n   */\n  disableInstanceAttribute(attributeLocation) {\n    let shouldClean = false;\n    let index;\n    while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\n      this._currentInstanceLocations.splice(index, 1);\n      this._currentInstanceBuffers.splice(index, 1);\n      shouldClean = true;\n      index = this._currentInstanceLocations.indexOf(attributeLocation);\n    }\n    if (shouldClean) {\n      this._gl.vertexAttribDivisor(attributeLocation, 0);\n      this.disableAttributeByIndex(attributeLocation);\n    }\n  }\n  /**\n   * Disable the attribute corresponding to the location in parameter\n   * @param attributeLocation defines the attribute location of the attribute to disable\n   */\n  disableAttributeByIndex(attributeLocation) {\n    this._gl.disableVertexAttribArray(attributeLocation);\n    this._vertexAttribArraysEnabled[attributeLocation] = false;\n    this._currentBufferPointers[attributeLocation].active = false;\n  }\n  /**\n   * Send a draw order\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\n   * @param indexStart defines the starting index\n   * @param indexCount defines the number of index to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n  draw(useTriangles, indexStart, indexCount, instancesCount) {\n    this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\n  }\n  /**\n   * Draw a list of points\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n  drawPointClouds(verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\n  }\n  /**\n   * Draw a list of unindexed primitives\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n  drawUnIndexed(useTriangles, verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\n  }\n  /**\n   * Draw a list of indexed primitives\n   * @param fillMode defines the primitive to use\n   * @param indexStart defines the starting index\n   * @param indexCount defines the number of index to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n  drawElementsType(fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n    this._reportDrawCall();\n    // Render\n    const drawMode = this._drawMode(fillMode);\n    const indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    const mult = this._uintIndicesCurrentlySet ? 4 : 2;\n    if (instancesCount) {\n      this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    } else {\n      this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\n    }\n  }\n  /**\n   * Draw a list of unindexed primitives\n   * @param fillMode defines the primitive to use\n   * @param verticesStart defines the index of first vertex to draw\n   * @param verticesCount defines the count of vertices to draw\n   * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\n   */\n  drawArraysType(fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n    this._reportDrawCall();\n    const drawMode = this._drawMode(fillMode);\n    if (instancesCount) {\n      this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    } else {\n      this._gl.drawArrays(drawMode, verticesStart, verticesCount);\n    }\n  }\n  _drawMode(fillMode) {\n    switch (fillMode) {\n      // Triangle views\n      case 0:\n        return this._gl.TRIANGLES;\n      case 2:\n        return this._gl.POINTS;\n      case 1:\n        return this._gl.LINES;\n      // Draw modes\n      case 3:\n        return this._gl.POINTS;\n      case 4:\n        return this._gl.LINES;\n      case 5:\n        return this._gl.LINE_LOOP;\n      case 6:\n        return this._gl.LINE_STRIP;\n      case 7:\n        return this._gl.TRIANGLE_STRIP;\n      case 8:\n        return this._gl.TRIANGLE_FAN;\n      default:\n        return this._gl.TRIANGLES;\n    }\n  }\n  /** @internal */\n  _reportDrawCall() {\n    // Will be implemented by children\n  }\n  // Shaders\n  /**\n   * @internal\n   */\n  _releaseEffect(effect) {\n    if (this._compiledEffects[effect._key]) {\n      delete this._compiledEffects[effect._key];\n    }\n    const pipelineContext = effect.getPipelineContext();\n    if (pipelineContext) {\n      this._deletePipelineContext(pipelineContext);\n    }\n  }\n  /**\n   * @internal\n   */\n  _deletePipelineContext(pipelineContext) {\n    const webGLPipelineContext = pipelineContext;\n    if (webGLPipelineContext && webGLPipelineContext.program) {\n      webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\n      this._gl.deleteProgram(webGLPipelineContext.program);\n    }\n  }\n  /** @internal */\n  _getGlobalDefines(defines) {\n    if (defines) {\n      if (this.isNDCHalfZRange) {\n        defines[\"IS_NDC_HALF_ZRANGE\"] = \"\";\n      } else {\n        delete defines[\"IS_NDC_HALF_ZRANGE\"];\n      }\n      if (this.useReverseDepthBuffer) {\n        defines[\"USE_REVERSE_DEPTHBUFFER\"] = \"\";\n      } else {\n        delete defines[\"USE_REVERSE_DEPTHBUFFER\"];\n      }\n      if (this.useExactSrgbConversions) {\n        defines[\"USE_EXACT_SRGB_CONVERSIONS\"] = \"\";\n      } else {\n        delete defines[\"USE_EXACT_SRGB_CONVERSIONS\"];\n      }\n      return;\n    } else {\n      let s = \"\";\n      if (this.isNDCHalfZRange) {\n        s += \"#define IS_NDC_HALF_ZRANGE\";\n      }\n      if (this.useReverseDepthBuffer) {\n        if (s) {\n          s += \"\\n\";\n        }\n        s += \"#define USE_REVERSE_DEPTHBUFFER\";\n      }\n      if (this.useExactSrgbConversions) {\n        if (s) {\n          s += \"\\n\";\n        }\n        s += \"#define USE_EXACT_SRGB_CONVERSIONS\";\n      }\n      return s;\n    }\n  }\n  /**\n   * Create a new effect (used to store vertex/fragment shaders)\n   * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\n   * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\n   * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\n   * @param samplers defines an array of string used to represent textures\n   * @param defines defines the string containing the defines to use to compile the shaders\n   * @param fallbacks defines the list of potential fallbacks to use if shader compilation fails\n   * @param onCompiled defines a function to call when the effect creation is successful\n   * @param onError defines a function to call when the effect creation has failed\n   * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\n   * @param shaderLanguage the language the shader is written in (default: GLSL)\n   * @returns the new Effect\n   */\n  createEffect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, defines, fallbacks, onCompiled, onError, indexParameters, shaderLanguage = ShaderLanguage.GLSL) {\n    var _a;\n    const vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\n    const fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\n    const globalDefines = this._getGlobalDefines();\n    let fullDefines = (_a = defines !== null && defines !== void 0 ? defines : attributesNamesOrOptions.defines) !== null && _a !== void 0 ? _a : \"\";\n    if (globalDefines) {\n      fullDefines += globalDefines;\n    }\n    const name = vertex + \"+\" + fragment + \"@\" + fullDefines;\n    if (this._compiledEffects[name]) {\n      const compiledEffect = this._compiledEffects[name];\n      if (onCompiled && compiledEffect.isReady()) {\n        onCompiled(compiledEffect);\n      }\n      return compiledEffect;\n    }\n    const effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters, name, shaderLanguage);\n    this._compiledEffects[name] = effect;\n    return effect;\n  }\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  static _ConcatenateShader(source, defines, shaderVersion = \"\") {\n    return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\n  }\n  _compileShader(source, type, defines, shaderVersion) {\n    return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\n  }\n  _compileRawShader(source, type) {\n    const gl = this._gl;\n    const shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\n    if (!shader) {\n      let error = gl.NO_ERROR;\n      let tempError = gl.NO_ERROR;\n      while ((tempError = gl.getError()) !== gl.NO_ERROR) {\n        error = tempError;\n      }\n      throw new Error(`Something went wrong while creating a gl ${type} shader object. gl error=${error}, gl isContextLost=${gl.isContextLost()}, _contextWasLost=${this._contextWasLost}`);\n    }\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    return shader;\n  }\n  /**\n   * @internal\n   */\n  _getShaderSource(shader) {\n    return this._gl.getShaderSource(shader);\n  }\n  /**\n   * Directly creates a webGL program\n   * @param pipelineContext  defines the pipeline context to attach to\n   * @param vertexCode defines the vertex shader code to use\n   * @param fragmentCode defines the fragment shader code to use\n   * @param context defines the webGL context to use (if not set, the current one will be used)\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\n   * @returns the new webGL program\n   */\n  createRawShaderProgram(pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings = null) {\n    context = context || this._gl;\n    const vertexShader = this._compileRawShader(vertexCode, \"vertex\");\n    const fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  }\n  /**\n   * Creates a webGL program\n   * @param pipelineContext  defines the pipeline context to attach to\n   * @param vertexCode  defines the vertex shader code to use\n   * @param fragmentCode defines the fragment shader code to use\n   * @param defines defines the string containing the defines to use to compile the shaders\n   * @param context defines the webGL context to use (if not set, the current one will be used)\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\n   * @returns the new webGL program\n   */\n  createShaderProgram(pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings = null) {\n    context = context || this._gl;\n    const shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\n    const vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\n    const fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  }\n  /**\n   * Inline functions in shader code that are marked to be inlined\n   * @param code code to inline\n   * @returns inlined code\n   */\n  inlineShaderCode(code) {\n    // no inlining needed in the WebGL engine\n    return code;\n  }\n  /**\n   * Creates a new pipeline context\n   * @param shaderProcessingContext defines the shader processing context used during the processing if available\n   * @returns the new pipeline\n   */\n  createPipelineContext(shaderProcessingContext) {\n    const pipelineContext = new WebGLPipelineContext();\n    pipelineContext.engine = this;\n    if (this._caps.parallelShaderCompile) {\n      pipelineContext.isParallelCompiled = true;\n    }\n    return pipelineContext;\n  }\n  /**\n   * Creates a new material context\n   * @returns the new context\n   */\n  createMaterialContext() {\n    return undefined;\n  }\n  /**\n   * Creates a new draw context\n   * @returns the new context\n   */\n  createDrawContext() {\n    return undefined;\n  }\n  _createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings = null) {\n    const shaderProgram = context.createProgram();\n    pipelineContext.program = shaderProgram;\n    if (!shaderProgram) {\n      throw new Error(\"Unable to create program\");\n    }\n    context.attachShader(shaderProgram, vertexShader);\n    context.attachShader(shaderProgram, fragmentShader);\n    context.linkProgram(shaderProgram);\n    pipelineContext.context = context;\n    pipelineContext.vertexShader = vertexShader;\n    pipelineContext.fragmentShader = fragmentShader;\n    if (!pipelineContext.isParallelCompiled) {\n      this._finalizePipelineContext(pipelineContext);\n    }\n    return shaderProgram;\n  }\n  _finalizePipelineContext(pipelineContext) {\n    const context = pipelineContext.context;\n    const vertexShader = pipelineContext.vertexShader;\n    const fragmentShader = pipelineContext.fragmentShader;\n    const program = pipelineContext.program;\n    const linked = context.getProgramParameter(program, context.LINK_STATUS);\n    if (!linked) {\n      // Get more info\n      // Vertex\n      if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\n        const log = this._gl.getShaderInfoLog(vertexShader);\n        if (log) {\n          pipelineContext.vertexCompilationError = log;\n          throw new Error(\"VERTEX SHADER \" + log);\n        }\n      }\n      // Fragment\n      if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\n        const log = this._gl.getShaderInfoLog(fragmentShader);\n        if (log) {\n          pipelineContext.fragmentCompilationError = log;\n          throw new Error(\"FRAGMENT SHADER \" + log);\n        }\n      }\n      const error = context.getProgramInfoLog(program);\n      if (error) {\n        pipelineContext.programLinkError = error;\n        throw new Error(error);\n      }\n    }\n    if (this.validateShaderPrograms) {\n      context.validateProgram(program);\n      const validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\n      if (!validated) {\n        const error = context.getProgramInfoLog(program);\n        if (error) {\n          pipelineContext.programValidationError = error;\n          throw new Error(error);\n        }\n      }\n    }\n    context.deleteShader(vertexShader);\n    context.deleteShader(fragmentShader);\n    pipelineContext.vertexShader = undefined;\n    pipelineContext.fragmentShader = undefined;\n    if (pipelineContext.onCompiled) {\n      pipelineContext.onCompiled();\n      pipelineContext.onCompiled = undefined;\n    }\n  }\n  /**\n   * @internal\n   */\n  _preparePipelineContext(pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rawVertexSourceCode, rawFragmentSourceCode, rebuildRebind, defines, transformFeedbackVaryings, key) {\n    const webGLRenderingState = pipelineContext;\n    if (createAsRaw) {\n      webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n    webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\n  }\n  /**\n   * @internal\n   */\n  _isRenderingStateCompiled(pipelineContext) {\n    const webGLPipelineContext = pipelineContext;\n    if (this._isDisposed || webGLPipelineContext._isDisposed) {\n      return false;\n    }\n    if (this._gl.getProgramParameter(webGLPipelineContext.program, this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)) {\n      this._finalizePipelineContext(webGLPipelineContext);\n      return true;\n    }\n    return false;\n  }\n  /**\n   * @internal\n   */\n  _executeWhenRenderingStateIsCompiled(pipelineContext, action) {\n    const webGLPipelineContext = pipelineContext;\n    if (!webGLPipelineContext.isParallelCompiled) {\n      action();\n      return;\n    }\n    const oldHandler = webGLPipelineContext.onCompiled;\n    if (oldHandler) {\n      webGLPipelineContext.onCompiled = () => {\n        oldHandler();\n        action();\n      };\n    } else {\n      webGLPipelineContext.onCompiled = action;\n    }\n  }\n  /**\n   * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\n   * @param pipelineContext defines the pipeline context to use\n   * @param uniformsNames defines the list of uniform names\n   * @returns an array of webGL uniform locations\n   */\n  getUniforms(pipelineContext, uniformsNames) {\n    const results = new Array();\n    const webGLPipelineContext = pipelineContext;\n    for (let index = 0; index < uniformsNames.length; index++) {\n      results.push(this._gl.getUniformLocation(webGLPipelineContext.program, uniformsNames[index]));\n    }\n    return results;\n  }\n  /**\n   * Gets the list of active attributes for a given webGL program\n   * @param pipelineContext defines the pipeline context to use\n   * @param attributesNames defines the list of attribute names to get\n   * @returns an array of indices indicating the offset of each attribute\n   */\n  getAttributes(pipelineContext, attributesNames) {\n    const results = [];\n    const webGLPipelineContext = pipelineContext;\n    for (let index = 0; index < attributesNames.length; index++) {\n      try {\n        results.push(this._gl.getAttribLocation(webGLPipelineContext.program, attributesNames[index]));\n      } catch (e) {\n        results.push(-1);\n      }\n    }\n    return results;\n  }\n  /**\n   * Activates an effect, making it the current one (ie. the one used for rendering)\n   * @param effect defines the effect to activate\n   */\n  enableEffect(effect) {\n    effect = effect !== null && DrawWrapper.IsWrapper(effect) ? effect.effect : effect; // get only the effect, we don't need a Wrapper in the WebGL engine\n    if (!effect || effect === this._currentEffect) {\n      return;\n    }\n    this._stencilStateComposer.stencilMaterial = undefined;\n    effect = effect;\n    // Use program\n    this.bindSamplers(effect);\n    this._currentEffect = effect;\n    if (effect.onBind) {\n      effect.onBind(effect);\n    }\n    if (effect._onBindObservable) {\n      effect._onBindObservable.notifyObservers(effect);\n    }\n  }\n  /**\n   * Set the value of an uniform to a number (int)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param value defines the int number to store\n   * @returns true if the value was set\n   */\n  setInt(uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform1i(uniform, value);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a int2\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @returns true if the value was set\n   */\n  setInt2(uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform2i(uniform, x, y);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a int3\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @returns true if the value was set\n   */\n  setInt3(uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform3i(uniform, x, y, z);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a int4\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @param w defines the 4th component of the value\n   * @returns true if the value was set\n   */\n  setInt4(uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform4i(uniform, x, y, z, w);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of int32\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n  setIntArray(uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform1iv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n  setIntArray2(uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n    this._gl.uniform2iv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n  setIntArray3(uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n    this._gl.uniform3iv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of int32 (stored as vec4)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of int32 to store\n   * @returns true if the value was set\n   */\n  setIntArray4(uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n    this._gl.uniform4iv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a number (unsigned int)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param value defines the unsigned int number to store\n   * @returns true if the value was set\n   */\n  setUInt(uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform1ui(uniform, value);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a unsigned int2\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @returns true if the value was set\n   */\n  setUInt2(uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform2ui(uniform, x, y);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a unsigned int3\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @returns true if the value was set\n   */\n  setUInt3(uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform3ui(uniform, x, y, z);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a unsigned int4\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @param w defines the 4th component of the value\n   * @returns true if the value was set\n   */\n  setUInt4(uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform4ui(uniform, x, y, z, w);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of unsigned int32\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of unsigned int32 to store\n   * @returns true if the value was set\n   */\n  setUIntArray(uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform1uiv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of unsigned int32 (stored as vec2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of unsigned int32 to store\n   * @returns true if the value was set\n   */\n  setUIntArray2(uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n    this._gl.uniform2uiv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of unsigned int32 (stored as vec3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of unsigned int32 to store\n   * @returns true if the value was set\n   */\n  setUIntArray3(uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n    this._gl.uniform3uiv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of unsigned int32 (stored as vec4)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of unsigned int32 to store\n   * @returns true if the value was set\n   */\n  setUIntArray4(uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n    this._gl.uniform4uiv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of number\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n  setArray(uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n    if (array.length < 1) {\n      return false;\n    }\n    this._gl.uniform1fv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of number (stored as vec2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n  setArray2(uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n    this._gl.uniform2fv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of number (stored as vec3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n  setArray3(uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n    this._gl.uniform3fv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of number (stored as vec4)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param array defines the array of number to store\n   * @returns true if the value was set\n   */\n  setArray4(uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n    this._gl.uniform4fv(uniform, array);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to an array of float32 (stored as matrices)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrices defines the array of float32 to store\n   * @returns true if the value was set\n   */\n  setMatrices(uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniformMatrix4fv(uniform, false, matrices);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a matrix (3x3)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrix defines the Float32Array representing the 3x3 matrix to store\n   * @returns true if the value was set\n   */\n  setMatrix3x3(uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniformMatrix3fv(uniform, false, matrix);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a matrix (2x2)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param matrix defines the Float32Array representing the 2x2 matrix to store\n   * @returns true if the value was set\n   */\n  setMatrix2x2(uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniformMatrix2fv(uniform, false, matrix);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a number (float)\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param value defines the float number to store\n   * @returns true if the value was transferred\n   */\n  setFloat(uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform1f(uniform, value);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a vec2\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @returns true if the value was set\n   */\n  setFloat2(uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform2f(uniform, x, y);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a vec3\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @returns true if the value was set\n   */\n  setFloat3(uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform3f(uniform, x, y, z);\n    return true;\n  }\n  /**\n   * Set the value of an uniform to a vec4\n   * @param uniform defines the webGL uniform location where to store the value\n   * @param x defines the 1st component of the value\n   * @param y defines the 2nd component of the value\n   * @param z defines the 3rd component of the value\n   * @param w defines the 4th component of the value\n   * @returns true if the value was set\n   */\n  setFloat4(uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n    this._gl.uniform4f(uniform, x, y, z, w);\n    return true;\n  }\n  // States\n  /**\n   * Apply all cached states (depth, culling, stencil and alpha)\n   */\n  applyStates() {\n    this._depthCullingState.apply(this._gl);\n    this._stencilStateComposer.apply(this._gl);\n    this._alphaState.apply(this._gl);\n    if (this._colorWriteChanged) {\n      this._colorWriteChanged = false;\n      const enable = this._colorWrite;\n      this._gl.colorMask(enable, enable, enable, enable);\n    }\n  }\n  /**\n   * Enable or disable color writing\n   * @param enable defines the state to set\n   */\n  setColorWrite(enable) {\n    if (enable !== this._colorWrite) {\n      this._colorWriteChanged = true;\n      this._colorWrite = enable;\n    }\n  }\n  /**\n   * Gets a boolean indicating if color writing is enabled\n   * @returns the current color writing state\n   */\n  getColorWrite() {\n    return this._colorWrite;\n  }\n  /**\n   * Gets the depth culling state manager\n   */\n  get depthCullingState() {\n    return this._depthCullingState;\n  }\n  /**\n   * Gets the alpha state manager\n   */\n  get alphaState() {\n    return this._alphaState;\n  }\n  /**\n   * Gets the stencil state manager\n   */\n  get stencilState() {\n    return this._stencilState;\n  }\n  /**\n   * Gets the stencil state composer\n   */\n  get stencilStateComposer() {\n    return this._stencilStateComposer;\n  }\n  // Textures\n  /**\n   * Clears the list of texture accessible through engine.\n   * This can help preventing texture load conflict due to name collision.\n   */\n  clearInternalTexturesCache() {\n    this._internalTexturesCache.length = 0;\n  }\n  /**\n   * Force the entire cache to be cleared\n   * You should not have to use this function unless your engine needs to share the webGL context with another engine\n   * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\n   */\n  wipeCaches(bruteForce) {\n    if (this.preventCacheWipeBetweenFrames && !bruteForce) {\n      return;\n    }\n    this._currentEffect = null;\n    this._viewportCached.x = 0;\n    this._viewportCached.y = 0;\n    this._viewportCached.z = 0;\n    this._viewportCached.w = 0;\n    // Done before in case we clean the attributes\n    this._unbindVertexArrayObject();\n    if (bruteForce) {\n      this._currentProgram = null;\n      this.resetTextureCache();\n      this._stencilStateComposer.reset();\n      this._depthCullingState.reset();\n      this._depthCullingState.depthFunc = this._gl.LEQUAL;\n      this._alphaState.reset();\n      this._alphaMode = 1;\n      this._alphaEquation = 0;\n      this._colorWrite = true;\n      this._colorWriteChanged = true;\n      this._unpackFlipYCached = null;\n      this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n      this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\n      this._mustWipeVertexAttributes = true;\n      this.unbindAllAttributes();\n    }\n    this._resetVertexBufferBinding();\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n    this.bindIndexBuffer(null);\n  }\n  /**\n   * @internal\n   */\n  _getSamplingParameters(samplingMode, generateMipMaps) {\n    const gl = this._gl;\n    let magFilter = gl.NEAREST;\n    let minFilter = gl.NEAREST;\n    switch (samplingMode) {\n      case 11:\n        magFilter = gl.LINEAR;\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n        break;\n      case 3:\n        magFilter = gl.LINEAR;\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n        break;\n      case 8:\n        magFilter = gl.NEAREST;\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n        break;\n      case 4:\n        magFilter = gl.NEAREST;\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n        break;\n      case 5:\n        magFilter = gl.NEAREST;\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n        break;\n      case 6:\n        magFilter = gl.NEAREST;\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n        break;\n      case 7:\n        magFilter = gl.NEAREST;\n        minFilter = gl.LINEAR;\n        break;\n      case 1:\n        magFilter = gl.NEAREST;\n        minFilter = gl.NEAREST;\n        break;\n      case 9:\n        magFilter = gl.LINEAR;\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n        break;\n      case 10:\n        magFilter = gl.LINEAR;\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n        break;\n      case 2:\n        magFilter = gl.LINEAR;\n        minFilter = gl.LINEAR;\n        break;\n      case 12:\n        magFilter = gl.LINEAR;\n        minFilter = gl.NEAREST;\n        break;\n    }\n    return {\n      min: minFilter,\n      mag: magFilter\n    };\n  }\n  /** @internal */\n  _createTexture() {\n    const texture = this._gl.createTexture();\n    if (!texture) {\n      throw new Error(\"Unable to create texture\");\n    }\n    return texture;\n  }\n  /** @internal */\n  _createHardwareTexture() {\n    return new WebGLHardwareTexture(this._createTexture(), this._gl);\n  }\n  /**\n   * Creates an internal texture without binding it to a framebuffer\n   * @internal\n   * @param size defines the size of the texture\n   * @param options defines the options used to create the texture\n   * @param delayGPUTextureCreation true to delay the texture creation the first time it is really needed. false to create it right away\n   * @param source source type of the texture\n   * @returns a new internal texture\n   */\n  _createInternalTexture(size, options, delayGPUTextureCreation = true, source = InternalTextureSource.Unknown) {\n    var _a;\n    let generateMipMaps = false;\n    let type = 0;\n    let samplingMode = 3;\n    let format = 5;\n    let useSRGBBuffer = false;\n    let samples = 1;\n    let label;\n    if (options !== undefined && typeof options === \"object\") {\n      generateMipMaps = !!options.generateMipMaps;\n      type = options.type === undefined ? 0 : options.type;\n      samplingMode = options.samplingMode === undefined ? 3 : options.samplingMode;\n      format = options.format === undefined ? 5 : options.format;\n      useSRGBBuffer = options.useSRGBBuffer === undefined ? false : options.useSRGBBuffer;\n      samples = (_a = options.samples) !== null && _a !== void 0 ? _a : 1;\n      label = options.label;\n    } else {\n      generateMipMaps = !!options;\n    }\n    useSRGBBuffer && (useSRGBBuffer = this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU));\n    if (type === 1 && !this._caps.textureFloatLinearFiltering) {\n      // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\n      samplingMode = 1;\n    } else if (type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\n      // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\n      samplingMode = 1;\n    }\n    if (type === 1 && !this._caps.textureFloat) {\n      type = 0;\n      Logger.Warn(\"Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE\");\n    }\n    const gl = this._gl;\n    const texture = new InternalTexture(this, source);\n    const width = size.width || size;\n    const height = size.height || size;\n    const layers = size.layers || 0;\n    const filters = this._getSamplingParameters(samplingMode, generateMipMaps);\n    const target = layers !== 0 ? gl.TEXTURE_2D_ARRAY : gl.TEXTURE_2D;\n    const sizedFormat = this._getRGBABufferInternalSizedFormat(type, format, useSRGBBuffer);\n    const internalFormat = this._getInternalFormat(format);\n    const textureType = this._getWebGLTextureType(type);\n    // Bind\n    this._bindTextureDirectly(target, texture);\n    if (layers !== 0) {\n      texture.is2DArray = true;\n      gl.texImage3D(target, 0, sizedFormat, width, height, layers, 0, internalFormat, textureType, null);\n    } else {\n      gl.texImage2D(target, 0, sizedFormat, width, height, 0, internalFormat, textureType, null);\n    }\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, filters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    // MipMaps\n    if (generateMipMaps) {\n      this._gl.generateMipmap(target);\n    }\n    this._bindTextureDirectly(target, null);\n    texture._useSRGBBuffer = useSRGBBuffer;\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = width;\n    texture.height = height;\n    texture.depth = layers;\n    texture.isReady = true;\n    texture.samples = samples;\n    texture.generateMipMaps = generateMipMaps;\n    texture.samplingMode = samplingMode;\n    texture.type = type;\n    texture.format = format;\n    texture.label = label;\n    this._internalTexturesCache.push(texture);\n    return texture;\n  }\n  /**\n   * @internal\n   */\n  _getUseSRGBBuffer(useSRGBBuffer, noMipmap) {\n    // Generating mipmaps for sRGB textures is not supported in WebGL1 so we must disable the support if mipmaps is enabled\n    return useSRGBBuffer && this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU || noMipmap);\n  }\n  _createTextureBase(url, noMipmap, invertY, scene, samplingMode = 3, onLoad = null, onError = null, prepareTexture, prepareTextureProcessFunction, buffer = null, fallback = null, format = null, forcedExtension = null, mimeType, loaderOptions, useSRGBBuffer) {\n    url = url || \"\";\n    const fromData = url.substr(0, 5) === \"data:\";\n    const fromBlob = url.substr(0, 5) === \"blob:\";\n    const isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    const texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    if (texture !== fallback) {\n      texture.label = url.substring(0, 60); // default label, can be overriden by the caller\n    }\n\n    const originalUrl = url;\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    }\n    if (originalUrl !== url) {\n      texture._originalUrl = originalUrl;\n    }\n    // establish the file extension, if possible\n    const lastDot = url.lastIndexOf(\".\");\n    let extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    let loader = null;\n    // Remove query string\n    const queryStringIndex = extension.indexOf(\"?\");\n    if (queryStringIndex > -1) {\n      extension = extension.split(\"?\")[0];\n    }\n    for (const availableLoader of ThinEngine._TextureLoaders) {\n      if (availableLoader.canLoad(extension, mimeType)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n    if (scene) {\n      scene.addPendingData(texture);\n    }\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n    texture._useSRGBBuffer = this._getUseSRGBBuffer(!!useSRGBBuffer, noMipmap);\n    if (!this._doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n    let onLoadObserver = null;\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n    const onInternalError = (message, exception) => {\n      if (scene) {\n        scene.removePendingData(texture);\n      }\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n        if (EngineStore.UseFallbackTexture) {\n          this._createTextureBase(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, prepareTexture, prepareTextureProcessFunction, buffer, texture);\n        }\n        message = (message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\");\n        texture.onErrorObservable.notifyObservers({\n          message,\n          exception\n        });\n        if (onError) {\n          onError(message, exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`);\n        this._createTextureBase(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, prepareTexture, prepareTextureProcessFunction, buffer, texture, format, forcedExtension, mimeType, loaderOptions, useSRGBBuffer);\n      }\n    };\n    // processing for non-image formats\n    if (loader) {\n      const callback = data => {\n        loader.loadData(data, texture, (width, height, loadMipmap, isCompressed, done, loadFailed) => {\n          if (loadFailed) {\n            onInternalError(\"TextureLoader failed to load data\");\n          } else {\n            prepareTexture(texture, extension, scene, {\n              width,\n              height\n            }, texture.invertY, !loadMipmap, isCompressed, () => {\n              done();\n              return false;\n            }, samplingMode);\n          }\n        }, loaderOptions);\n      };\n      if (!buffer) {\n        this._loadFile(url, data => callback(new Uint8Array(data)), undefined, scene ? scene.offlineProvider : undefined, true, (request, exception) => {\n          onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n        });\n      } else {\n        if (buffer instanceof ArrayBuffer) {\n          callback(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          callback(buffer);\n        } else {\n          if (onError) {\n            onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\n          }\n        }\n      }\n    } else {\n      const onload = img => {\n        if (fromBlob && !this._doNotHandleContextLost) {\n          // We need to store the image if we need to rebuild the texture\n          // in case of a webgl context lost\n          texture._buffer = img;\n        }\n        prepareTexture(texture, extension, scene, img, texture.invertY, noMipmap, false, prepareTextureProcessFunction, samplingMode);\n      };\n      // According to the WebGL spec section 6.10, ImageBitmaps must be inverted on creation.\n      // So, we pass imageOrientation to _FileToolsLoadImage() as it may create an ImageBitmap.\n      if (!fromData || isBase64) {\n        if (buffer && (typeof buffer.decoding === \"string\" || buffer.close)) {\n          onload(buffer);\n        } else {\n          ThinEngine._FileToolsLoadImage(url, onload, onInternalError, scene ? scene.offlineProvider : null, mimeType, texture.invertY && this._features.needsInvertingBitmap ? {\n            imageOrientation: \"flipY\"\n          } : undefined);\n        }\n      } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\n        ThinEngine._FileToolsLoadImage(buffer, onload, onInternalError, scene ? scene.offlineProvider : null, mimeType, texture.invertY && this._features.needsInvertingBitmap ? {\n          imageOrientation: \"flipY\"\n        } : undefined);\n      } else if (buffer) {\n        onload(buffer);\n      }\n    }\n    return texture;\n  }\n  /**\n   * Usually called from Texture.ts.\n   * Passed information to create a WebGLTexture\n   * @param url defines a value which contains one of the following:\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\n   * @param scene needed for loading to the correct scene\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\n   * @param onLoad optional callback to be called upon successful completion\n   * @param onError optional callback to be called upon failure\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\n   * @param forcedExtension defines the extension to use to pick the right loader\n   * @param mimeType defines an optional mime type\n   * @param loaderOptions options to be passed to the loader\n   * @param creationFlags specific flags to use when creating the texture (1 for storage textures, for eg)\n   * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\n   */\n  createTexture(url, noMipmap, invertY, scene, samplingMode = 3, onLoad = null, onError = null, buffer = null, fallback = null, format = null, forcedExtension = null, mimeType, loaderOptions, creationFlags, useSRGBBuffer) {\n    return this._createTextureBase(url, noMipmap, invertY, scene, samplingMode, onLoad, onError, this._prepareWebGLTexture.bind(this), (potWidth, potHeight, img, extension, texture, continuationCallback) => {\n      const gl = this._gl;\n      const isPot = img.width === potWidth && img.height === potHeight;\n      const tip = this._getTexImageParametersForCreateTexture(format, extension, texture._useSRGBBuffer);\n      if (isPot) {\n        gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, img);\n        return false;\n      }\n      const maxTextureSize = this._caps.maxTextureSize;\n      if (img.width > maxTextureSize || img.height > maxTextureSize || !this._supportsHardwareTextureRescaling) {\n        this._prepareWorkingCanvas();\n        if (!this._workingCanvas || !this._workingContext) {\n          return false;\n        }\n        this._workingCanvas.width = potWidth;\n        this._workingCanvas.height = potHeight;\n        this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\n        gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, this._workingCanvas);\n        texture.width = potWidth;\n        texture.height = potHeight;\n        return false;\n      } else {\n        // Using shaders when possible to rescale because canvas.drawImage is lossy\n        const source = new InternalTexture(this, InternalTextureSource.Temp);\n        this._bindTextureDirectly(gl.TEXTURE_2D, source, true);\n        gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, img);\n        this._rescaleTexture(source, texture, scene, tip.format, () => {\n          this._releaseTexture(source);\n          this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n          continuationCallback();\n        });\n      }\n      return true;\n    }, buffer, fallback, format, forcedExtension, mimeType, loaderOptions, useSRGBBuffer);\n  }\n  /**\n   * Calls to the GL texImage2D and texImage3D functions require three arguments describing the pixel format of the texture.\n   * createTexture derives these from the babylonFormat and useSRGBBuffer arguments and also the file extension of the URL it's working with.\n   * This function encapsulates that derivation for easy unit testing.\n   * @param babylonFormat Babylon's format enum, as specified in ITextureCreationOptions.\n   * @param fileExtension The file extension including the dot, e.g. .jpg.\n   * @param useSRGBBuffer Use SRGB not linear.\n   * @returns The options to pass to texImage2D or texImage3D calls.\n   * @internal\n   */\n  _getTexImageParametersForCreateTexture(babylonFormat, fileExtension, useSRGBBuffer) {\n    if (babylonFormat === undefined || babylonFormat === null) {\n      babylonFormat = fileExtension === \".jpg\" && !useSRGBBuffer ? 4 : 5;\n    }\n    let format, internalFormat;\n    if (this.webGLVersion === 1) {\n      // In WebGL 1, format and internalFormat must be the same and taken from a limited set of values, see https://docs.gl/es2/glTexImage2D.\n      // The SRGB extension (https://developer.mozilla.org/en-US/docs/Web/API/EXT_sRGB) adds some extra values, hence passing useSRGBBuffer\n      // to getInternalFormat.\n      format = this._getInternalFormat(babylonFormat, useSRGBBuffer);\n      internalFormat = format;\n    } else {\n      // In WebGL 2, format has a wider range of values and internal format can be one of the sized formats, see\n      // https://registry.khronos.org/OpenGL-Refpages/es3.0/html/glTexImage2D.xhtml.\n      // SRGB is included in the sized format and should not be passed in \"format\", hence always passing useSRGBBuffer as false.\n      format = this._getInternalFormat(babylonFormat, false);\n      internalFormat = this._getRGBABufferInternalSizedFormat(0, babylonFormat, useSRGBBuffer);\n    }\n    return {\n      internalFormat,\n      format,\n      type: this._gl.UNSIGNED_BYTE\n    };\n  }\n  /**\n   * Loads an image as an HTMLImageElement.\n   * @param input url string, ArrayBuffer, or Blob to load\n   * @param onLoad callback called when the image successfully loads\n   * @param onError callback called when the image fails to load\n   * @param offlineProvider offline provider for caching\n   * @param mimeType optional mime type\n   * @param imageBitmapOptions optional the options to use when creating an ImageBitmap\n   * @returns the HTMLImageElement of the loaded image\n   * @internal\n   */\n  static _FileToolsLoadImage(input, onLoad, onError, offlineProvider, mimeType, imageBitmapOptions) {\n    throw _WarnImport(\"FileTools\");\n  }\n  /**\n   * @internal\n   */\n  _rescaleTexture(source, destination, scene, internalFormat, onComplete) {}\n  /**\n   * Creates a raw texture\n   * @param data defines the data to store in the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param format defines the format of the data\n   * @param generateMipMaps defines if the engine should generate the mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\n   * @param compression defines the compression used (null by default)\n   * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\n   * @param creationFlags specific flags to use when creating the texture (1 for storage textures, for eg)\n   * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\n   * @returns the raw texture inside an InternalTexture\n   */\n  createRawTexture(data, width, height, format, generateMipMaps, invertY, samplingMode, compression = null, type = 0, creationFlags = 0, useSRGBBuffer = false) {\n    throw _WarnImport(\"Engine.RawTexture\");\n  }\n  /**\n   * Creates a new raw cube texture\n   * @param data defines the array of data to use to create each face\n   * @param size defines the size of the textures\n   * @param format defines the format of the data\n   * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\n   * @param generateMipMaps  defines if the engine should generate the mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compression used (null by default)\n   * @returns the cube texture as an InternalTexture\n   */\n  createRawCubeTexture(data, size, format, type, generateMipMaps, invertY, samplingMode, compression = null) {\n    throw _WarnImport(\"Engine.RawTexture\");\n  }\n  /**\n   * Creates a new raw 3D texture\n   * @param data defines the data used to create the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param depth defines the depth of the texture\n   * @param format defines the format of the texture\n   * @param generateMipMaps defines if the engine must generate mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compressed used (can be null)\n   * @param textureType defines the compressed used (can be null)\n   * @returns a new raw 3D texture (stored in an InternalTexture)\n   */\n  createRawTexture3D(data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression = null, textureType = 0) {\n    throw _WarnImport(\"Engine.RawTexture\");\n  }\n  /**\n   * Creates a new raw 2D array texture\n   * @param data defines the data used to create the texture\n   * @param width defines the width of the texture\n   * @param height defines the height of the texture\n   * @param depth defines the number of layers of the texture\n   * @param format defines the format of the texture\n   * @param generateMipMaps defines if the engine must generate mip levels\n   * @param invertY defines if data must be stored with Y axis inverted\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\n   * @param compression defines the compressed used (can be null)\n   * @param textureType defines the compressed used (can be null)\n   * @returns a new raw 2D array texture (stored in an InternalTexture)\n   */\n  createRawTexture2DArray(data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression = null, textureType = 0) {\n    throw _WarnImport(\"Engine.RawTexture\");\n  }\n  /**\n   * @internal\n   */\n  _unpackFlipY(value) {\n    if (this._unpackFlipYCached !== value) {\n      this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\n      if (this.enableUnpackFlipYCached) {\n        this._unpackFlipYCached = value;\n      }\n    }\n  }\n  /** @internal */\n  _getUnpackAlignement() {\n    return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\n  }\n  _getTextureTarget(texture) {\n    if (texture.isCube) {\n      return this._gl.TEXTURE_CUBE_MAP;\n    } else if (texture.is3D) {\n      return this._gl.TEXTURE_3D;\n    } else if (texture.is2DArray || texture.isMultiview) {\n      return this._gl.TEXTURE_2D_ARRAY;\n    }\n    return this._gl.TEXTURE_2D;\n  }\n  /**\n   * Update the sampling mode of a given texture\n   * @param samplingMode defines the required sampling mode\n   * @param texture defines the texture to update\n   * @param generateMipMaps defines whether to generate mipmaps for the texture\n   */\n  updateTextureSamplingMode(samplingMode, texture, generateMipMaps = false) {\n    const target = this._getTextureTarget(texture);\n    const filters = this._getSamplingParameters(samplingMode, texture.useMipMaps || generateMipMaps);\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\n    if (generateMipMaps) {\n      texture.generateMipMaps = true;\n      this._gl.generateMipmap(target);\n    }\n    this._bindTextureDirectly(target, null);\n    texture.samplingMode = samplingMode;\n  }\n  /**\n   * Update the dimensions of a texture\n   * @param texture texture to update\n   * @param width new width of the texture\n   * @param height new height of the texture\n   * @param depth new depth of the texture\n   */\n  updateTextureDimensions(texture, width, height, depth = 1) {}\n  /**\n   * Update the sampling mode of a given texture\n   * @param texture defines the texture to update\n   * @param wrapU defines the texture wrap mode of the u coordinates\n   * @param wrapV defines the texture wrap mode of the v coordinates\n   * @param wrapR defines the texture wrap mode of the r coordinates\n   */\n  updateTextureWrappingMode(texture, wrapU, wrapV = null, wrapR = null) {\n    const target = this._getTextureTarget(texture);\n    if (wrapU !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\n      texture._cachedWrapU = wrapU;\n    }\n    if (wrapV !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\n      texture._cachedWrapV = wrapV;\n    }\n    if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\n      texture._cachedWrapR = wrapR;\n    }\n    this._bindTextureDirectly(target, null);\n  }\n  /**\n   * @internal\n   */\n  _setupDepthStencilTexture(internalTexture, size, generateStencil, bilinearFiltering, comparisonFunction, samples = 1) {\n    const width = size.width || size;\n    const height = size.height || size;\n    const layers = size.layers || 0;\n    internalTexture.baseWidth = width;\n    internalTexture.baseHeight = height;\n    internalTexture.width = width;\n    internalTexture.height = height;\n    internalTexture.is2DArray = layers > 0;\n    internalTexture.depth = layers;\n    internalTexture.isReady = true;\n    internalTexture.samples = samples;\n    internalTexture.generateMipMaps = false;\n    internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\n    internalTexture.type = 0;\n    internalTexture._comparisonFunction = comparisonFunction;\n    const gl = this._gl;\n    const target = this._getTextureTarget(internalTexture);\n    const samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n    // TEXTURE_COMPARE_FUNC/MODE are only availble in WebGL2.\n    if (this.webGLVersion > 1) {\n      if (comparisonFunction === 0) {\n        gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\n        gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\n      } else {\n        gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\n        gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\n      }\n    }\n  }\n  /**\n   * @internal\n   */\n  _uploadCompressedDataToTextureDirectly(texture, internalFormat, width, height, data, faceIndex = 0, lod = 0) {\n    const gl = this._gl;\n    let target = gl.TEXTURE_2D;\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n    if (texture._useSRGBBuffer) {\n      switch (internalFormat) {\n        case 37492:\n        case 36196:\n          // Note, if using ETC1 and sRGB is requested, this will use ETC2 if available.\n          if (this._caps.etc2) {\n            internalFormat = gl.COMPRESSED_SRGB8_ETC2;\n          } else {\n            texture._useSRGBBuffer = false;\n          }\n          break;\n        case 37496:\n          if (this._caps.etc2) {\n            internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;\n          } else {\n            texture._useSRGBBuffer = false;\n          }\n          break;\n        case 36492:\n          internalFormat = gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\n          break;\n        case 37808:\n          internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\n          break;\n        case 33776:\n          if (this._caps.s3tc_srgb) {\n            internalFormat = gl.COMPRESSED_SRGB_S3TC_DXT1_EXT;\n          } else {\n            // S3TC sRGB extension not supported\n            texture._useSRGBBuffer = false;\n          }\n          break;\n        case 33777:\n          if (this._caps.s3tc_srgb) {\n            internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\n          } else {\n            // S3TC sRGB extension not supported\n            texture._useSRGBBuffer = false;\n          }\n          break;\n        case 33779:\n          if (this._caps.s3tc_srgb) {\n            internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\n          } else {\n            // S3TC sRGB extension not supported\n            texture._useSRGBBuffer = false;\n          }\n          break;\n        default:\n          // We don't support a sRGB format corresponding to internalFormat, so revert to non sRGB format\n          texture._useSRGBBuffer = false;\n          break;\n      }\n    }\n    this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, data);\n  }\n  /**\n   * @internal\n   */\n  _uploadDataToTextureDirectly(texture, imageData, faceIndex = 0, lod = 0, babylonInternalFormat, useTextureWidthAndHeight = false) {\n    const gl = this._gl;\n    const textureType = this._getWebGLTextureType(texture.type);\n    const format = this._getInternalFormat(texture.format);\n    const internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format, texture._useSRGBBuffer) : this._getInternalFormat(babylonInternalFormat, texture._useSRGBBuffer);\n    this._unpackFlipY(texture.invertY);\n    let target = gl.TEXTURE_2D;\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n    const lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\n    const lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\n    const width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\n    const height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\n    gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\n  }\n  /**\n   * Update a portion of an internal texture\n   * @param texture defines the texture to update\n   * @param imageData defines the data to store into the texture\n   * @param xOffset defines the x coordinates of the update rectangle\n   * @param yOffset defines the y coordinates of the update rectangle\n   * @param width defines the width of the update rectangle\n   * @param height defines the height of the update rectangle\n   * @param faceIndex defines the face index if texture is a cube (0 by default)\n   * @param lod defines the lod level to update (0 by default)\n   * @param generateMipMaps defines whether to generate mipmaps or not\n   */\n  updateTextureData(texture, imageData, xOffset, yOffset, width, height, faceIndex = 0, lod = 0, generateMipMaps = false) {\n    const gl = this._gl;\n    const textureType = this._getWebGLTextureType(texture.type);\n    const format = this._getInternalFormat(texture.format);\n    this._unpackFlipY(texture.invertY);\n    let targetForBinding = gl.TEXTURE_2D;\n    let target = gl.TEXTURE_2D;\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n      targetForBinding = gl.TEXTURE_CUBE_MAP;\n    }\n    this._bindTextureDirectly(targetForBinding, texture, true);\n    gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\n    if (generateMipMaps) {\n      this._gl.generateMipmap(target);\n    }\n    this._bindTextureDirectly(targetForBinding, null);\n  }\n  /**\n   * @internal\n   */\n  _uploadArrayBufferViewToTexture(texture, imageData, faceIndex = 0, lod = 0) {\n    const gl = this._gl;\n    const bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\n    this._bindTextureDirectly(bindTarget, texture, true);\n    this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\n    this._bindTextureDirectly(bindTarget, null, true);\n  }\n  _prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode) {\n    const gl = this._gl;\n    if (!gl) {\n      return;\n    }\n    const filters = this._getSamplingParameters(samplingMode, !noMipmap);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\n    if (!noMipmap && !isCompressed) {\n      gl.generateMipmap(gl.TEXTURE_2D);\n    }\n    this._bindTextureDirectly(gl.TEXTURE_2D, null);\n    // this.resetTextureCache();\n    if (scene) {\n      scene.removePendingData(texture);\n    }\n    texture.onLoadedObservable.notifyObservers(texture);\n    texture.onLoadedObservable.clear();\n  }\n  _prepareWebGLTexture(texture, extension, scene, img, invertY, noMipmap, isCompressed, processFunction, samplingMode = 3) {\n    const maxTextureSize = this.getCaps().maxTextureSize;\n    const potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.width, maxTextureSize) : img.width);\n    const potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.height, maxTextureSize) : img.height);\n    const gl = this._gl;\n    if (!gl) {\n      return;\n    }\n    if (!texture._hardwareTexture) {\n      //  this.resetTextureCache();\n      if (scene) {\n        scene.removePendingData(texture);\n      }\n      return;\n    }\n    this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n    this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\n    texture.baseWidth = img.width;\n    texture.baseHeight = img.height;\n    texture.width = potWidth;\n    texture.height = potHeight;\n    texture.isReady = true;\n    texture.type = texture.type !== -1 ? texture.type : 0;\n    texture.format = texture.format !== -1 ? texture.format : extension === \".jpg\" && !texture._useSRGBBuffer ? 4 : 5;\n    if (processFunction(potWidth, potHeight, img, extension, texture, () => {\n      this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n    })) {\n      // Returning as texture needs extra async steps\n      return;\n    }\n    this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n  }\n  /**\n   * @internal\n   */\n  _setupFramebufferDepthAttachments(generateStencilBuffer, generateDepthBuffer, width, height, samples = 1) {\n    const gl = this._gl;\n    // Create the depth/stencil buffer\n    if (generateStencilBuffer && generateDepthBuffer) {\n      return this._createRenderBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\n    }\n    if (generateDepthBuffer) {\n      let depthFormat = gl.DEPTH_COMPONENT16;\n      if (this._webGLVersion > 1) {\n        depthFormat = gl.DEPTH_COMPONENT32F;\n      }\n      return this._createRenderBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\n    }\n    if (generateStencilBuffer) {\n      return this._createRenderBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\n    }\n    return null;\n  }\n  /**\n   * @internal\n   */\n  _createRenderBuffer(width, height, samples, internalFormat, msInternalFormat, attachment, unbindBuffer = true) {\n    const gl = this._gl;\n    const renderBuffer = gl.createRenderbuffer();\n    return this._updateRenderBuffer(renderBuffer, width, height, samples, internalFormat, msInternalFormat, attachment, unbindBuffer);\n  }\n  _updateRenderBuffer(renderBuffer, width, height, samples, internalFormat, msInternalFormat, attachment, unbindBuffer = true) {\n    const gl = this._gl;\n    gl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\n    if (samples > 1 && gl.renderbufferStorageMultisample) {\n      gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\n    } else {\n      gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\n    }\n    gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, renderBuffer);\n    if (unbindBuffer) {\n      gl.bindRenderbuffer(gl.RENDERBUFFER, null);\n    }\n    return renderBuffer;\n  }\n  /**\n   * @internal\n   */\n  _releaseTexture(texture) {\n    var _a;\n    this._deleteTexture((_a = texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource);\n    // Unbind channels\n    this.unbindAllTextures();\n    const index = this._internalTexturesCache.indexOf(texture);\n    if (index !== -1) {\n      this._internalTexturesCache.splice(index, 1);\n    }\n    // Integrated fixed lod samplers.\n    if (texture._lodTextureHigh) {\n      texture._lodTextureHigh.dispose();\n    }\n    if (texture._lodTextureMid) {\n      texture._lodTextureMid.dispose();\n    }\n    if (texture._lodTextureLow) {\n      texture._lodTextureLow.dispose();\n    }\n    // Integrated irradiance map.\n    if (texture._irradianceTexture) {\n      texture._irradianceTexture.dispose();\n    }\n  }\n  /**\n   * @internal\n   */\n  _releaseRenderTargetWrapper(rtWrapper) {\n    const index = this._renderTargetWrapperCache.indexOf(rtWrapper);\n    if (index !== -1) {\n      this._renderTargetWrapperCache.splice(index, 1);\n    }\n  }\n  _deleteTexture(texture) {\n    if (texture) {\n      this._gl.deleteTexture(texture);\n    }\n  }\n  _setProgram(program) {\n    if (this._currentProgram !== program) {\n      this._gl.useProgram(program);\n      this._currentProgram = program;\n    }\n  }\n  /**\n   * Binds an effect to the webGL context\n   * @param effect defines the effect to bind\n   */\n  bindSamplers(effect) {\n    const webGLPipelineContext = effect.getPipelineContext();\n    this._setProgram(webGLPipelineContext.program);\n    const samplers = effect.getSamplers();\n    for (let index = 0; index < samplers.length; index++) {\n      const uniform = effect.getUniform(samplers[index]);\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n    this._currentEffect = null;\n  }\n  _activateCurrentTexture() {\n    if (this._currentTextureChannel !== this._activeChannel) {\n      this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\n      this._currentTextureChannel = this._activeChannel;\n    }\n  }\n  /**\n   * @internal\n   */\n  _bindTextureDirectly(target, texture, forTextureDataUpdate = false, force = false) {\n    var _a, _b;\n    let wasPreviouslyBound = false;\n    const isTextureForRendering = texture && texture._associatedChannel > -1;\n    if (forTextureDataUpdate && isTextureForRendering) {\n      this._activeChannel = texture._associatedChannel;\n    }\n    const currentTextureBound = this._boundTexturesCache[this._activeChannel];\n    if (currentTextureBound !== texture || force) {\n      this._activateCurrentTexture();\n      if (texture && texture.isMultiview) {\n        //this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\n        console.error(target, texture);\n        throw \"_bindTextureDirectly called with a multiview texture!\";\n      } else {\n        this._gl.bindTexture(target, (_b = (_a = texture === null || texture === void 0 ? void 0 : texture._hardwareTexture) === null || _a === void 0 ? void 0 : _a.underlyingResource) !== null && _b !== void 0 ? _b : null);\n      }\n      this._boundTexturesCache[this._activeChannel] = texture;\n      if (texture) {\n        texture._associatedChannel = this._activeChannel;\n      }\n    } else if (forTextureDataUpdate) {\n      wasPreviouslyBound = true;\n      this._activateCurrentTexture();\n    }\n    if (isTextureForRendering && !forTextureDataUpdate) {\n      this._bindSamplerUniformToChannel(texture._associatedChannel, this._activeChannel);\n    }\n    return wasPreviouslyBound;\n  }\n  /**\n   * @internal\n   */\n  _bindTexture(channel, texture, name) {\n    if (channel === undefined) {\n      return;\n    }\n    if (texture) {\n      texture._associatedChannel = channel;\n    }\n    this._activeChannel = channel;\n    const target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\n    this._bindTextureDirectly(target, texture);\n  }\n  /**\n   * Unbind all textures from the webGL context\n   */\n  unbindAllTextures() {\n    for (let channel = 0; channel < this._maxSimultaneousTextures; channel++) {\n      this._activeChannel = channel;\n      this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n      this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n      if (this.webGLVersion > 1) {\n        this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n        this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n      }\n    }\n  }\n  /**\n   * Sets a texture to the according uniform.\n   * @param channel The texture channel\n   * @param uniform The uniform to set\n   * @param texture The texture to apply\n   * @param name The name of the uniform in the effect\n   */\n  setTexture(channel, uniform, texture, name) {\n    if (channel === undefined) {\n      return;\n    }\n    if (uniform) {\n      this._boundUniforms[channel] = uniform;\n    }\n    this._setTexture(channel, texture);\n  }\n  _bindSamplerUniformToChannel(sourceSlot, destination) {\n    const uniform = this._boundUniforms[sourceSlot];\n    if (!uniform || uniform._currentState === destination) {\n      return;\n    }\n    this._gl.uniform1i(uniform, destination);\n    uniform._currentState = destination;\n  }\n  _getTextureWrapMode(mode) {\n    switch (mode) {\n      case 1:\n        return this._gl.REPEAT;\n      case 0:\n        return this._gl.CLAMP_TO_EDGE;\n      case 2:\n        return this._gl.MIRRORED_REPEAT;\n    }\n    return this._gl.REPEAT;\n  }\n  _setTexture(channel, texture, isPartOfTextureArray = false, depthStencilTexture = false, name = \"\") {\n    // Not ready?\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n        this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n        if (this.webGLVersion > 1) {\n          this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n          this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n        }\n      }\n      return false;\n    }\n    // Video\n    if (texture.video) {\n      this._activeChannel = channel;\n      const videoInternalTexture = texture.getInternalTexture();\n      if (videoInternalTexture) {\n        videoInternalTexture._associatedChannel = channel;\n      }\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n    let internalTexture;\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n    if (!isPartOfTextureArray && internalTexture) {\n      internalTexture._associatedChannel = channel;\n    }\n    let needToBind = true;\n    if (this._boundTexturesCache[channel] === internalTexture) {\n      if (!isPartOfTextureArray) {\n        this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\n      }\n      needToBind = false;\n    }\n    this._activeChannel = channel;\n    const target = this._getTextureTarget(internalTexture);\n    if (needToBind) {\n      this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\n    }\n    if (internalTexture && !internalTexture.isMultiview) {\n      // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\n      if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\n        internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\n        const textureWrapMode = texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5 ? 1 : 0;\n        texture.wrapU = textureWrapMode;\n        texture.wrapV = textureWrapMode;\n      }\n      if (internalTexture._cachedWrapU !== texture.wrapU) {\n        internalTexture._cachedWrapU = texture.wrapU;\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\n      }\n      if (internalTexture._cachedWrapV !== texture.wrapV) {\n        internalTexture._cachedWrapV = texture.wrapV;\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\n      }\n      if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\n        internalTexture._cachedWrapR = texture.wrapR;\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\n      }\n      this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\n    }\n    return true;\n  }\n  /**\n   * Sets an array of texture to the webGL context\n   * @param channel defines the channel where the texture array must be set\n   * @param uniform defines the associated uniform location\n   * @param textures defines the array of textures to bind\n   * @param name name of the channel\n   */\n  setTextureArray(channel, uniform, textures, name) {\n    if (channel === undefined || !uniform) {\n      return;\n    }\n    if (!this._textureUnits || this._textureUnits.length !== textures.length) {\n      this._textureUnits = new Int32Array(textures.length);\n    }\n    for (let i = 0; i < textures.length; i++) {\n      const texture = textures[i].getInternalTexture();\n      if (texture) {\n        this._textureUnits[i] = channel + i;\n        texture._associatedChannel = channel + i;\n      } else {\n        this._textureUnits[i] = -1;\n      }\n    }\n    this._gl.uniform1iv(uniform, this._textureUnits);\n    for (let index = 0; index < textures.length; index++) {\n      this._setTexture(this._textureUnits[index], textures[index], true);\n    }\n  }\n  /**\n   * @internal\n   */\n  _setAnisotropicLevel(target, internalTexture, anisotropicFilteringLevel) {\n    const anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\n    if (internalTexture.samplingMode !== 11 && internalTexture.samplingMode !== 3 && internalTexture.samplingMode !== 2) {\n      anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\n    }\n\n    if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\n      this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\n      internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\n    }\n  }\n  _setTextureParameterFloat(target, parameter, value, texture) {\n    this._bindTextureDirectly(target, texture, true, true);\n    this._gl.texParameterf(target, parameter, value);\n  }\n  _setTextureParameterInteger(target, parameter, value, texture) {\n    if (texture) {\n      this._bindTextureDirectly(target, texture, true, true);\n    }\n    this._gl.texParameteri(target, parameter, value);\n  }\n  /**\n   * Unbind all vertex attributes from the webGL context\n   */\n  unbindAllAttributes() {\n    if (this._mustWipeVertexAttributes) {\n      this._mustWipeVertexAttributes = false;\n      for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\n        this.disableAttributeByIndex(i);\n      }\n      return;\n    }\n    for (let i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\n      if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\n        continue;\n      }\n      this.disableAttributeByIndex(i);\n    }\n  }\n  /**\n   * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\n   */\n  releaseEffects() {\n    for (const name in this._compiledEffects) {\n      const webGLPipelineContext = this._compiledEffects[name].getPipelineContext();\n      this._deletePipelineContext(webGLPipelineContext);\n    }\n    this._compiledEffects = {};\n  }\n  /**\n   * Dispose and release all associated resources\n   */\n  dispose() {\n    var _a, _b;\n    this._isDisposed = true;\n    this.stopRenderLoop();\n    // Clear observables\n    if (this.onBeforeTextureInitObservable) {\n      this.onBeforeTextureInitObservable.clear();\n    }\n    // Empty texture\n    if (this._emptyTexture) {\n      this._releaseTexture(this._emptyTexture);\n      this._emptyTexture = null;\n    }\n    if (this._emptyCubeTexture) {\n      this._releaseTexture(this._emptyCubeTexture);\n      this._emptyCubeTexture = null;\n    }\n    if (this._dummyFramebuffer) {\n      this._gl.deleteFramebuffer(this._dummyFramebuffer);\n    }\n    // Release effects\n    this.releaseEffects();\n    (_a = this.releaseComputeEffects) === null || _a === void 0 ? void 0 : _a.call(this);\n    // Unbind\n    this.unbindAllAttributes();\n    this._boundUniforms = {};\n    // Events\n    if (IsWindowObjectExist()) {\n      if (this._renderingCanvas) {\n        if (!this._doNotHandleContextLost) {\n          this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\n          this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\n        }\n        window.removeEventListener(\"resize\", this._checkForMobile);\n      }\n    }\n    this._workingCanvas = null;\n    this._workingContext = null;\n    this._currentBufferPointers.length = 0;\n    this._renderingCanvas = null;\n    this._currentProgram = null;\n    this._boundRenderFunction = null;\n    Effect.ResetCache();\n    // Abort active requests\n    for (const request of this._activeRequests) {\n      request.abort();\n    }\n    this.onDisposeObservable.notifyObservers(this);\n    this.onDisposeObservable.clear();\n    if (this._creationOptions.loseContextOnDispose) {\n      (_b = this._gl.getExtension(\"WEBGL_lose_context\")) === null || _b === void 0 ? void 0 : _b.loseContext();\n    }\n  }\n  /**\n   * Attach a new callback raised when context lost event is fired\n   * @param callback defines the callback to call\n   */\n  attachContextLostEvent(callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextlost\", callback, false);\n    }\n  }\n  /**\n   * Attach a new callback raised when context restored event is fired\n   * @param callback defines the callback to call\n   */\n  attachContextRestoredEvent(callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextrestored\", callback, false);\n    }\n  }\n  /**\n   * Get the current error code of the webGL context\n   * @returns the error code\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\n   */\n  getError() {\n    return this._gl.getError();\n  }\n  _canRenderToFloatFramebuffer() {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n    return this._canRenderToFramebuffer(1);\n  }\n  _canRenderToHalfFloatFramebuffer() {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n    return this._canRenderToFramebuffer(2);\n  }\n  // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\n  _canRenderToFramebuffer(type) {\n    const gl = this._gl;\n    //clear existing errors\n    // eslint-disable-next-line no-empty\n    while (gl.getError() !== gl.NO_ERROR) {}\n    let successful = true;\n    const texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n    const fb = gl.createFramebuffer();\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n    const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\n    successful = successful && gl.getError() === gl.NO_ERROR;\n    //try render by clearing frame buffer's color buffer\n    if (successful) {\n      gl.clear(gl.COLOR_BUFFER_BIT);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    }\n    //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\n    if (successful) {\n      //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n      const readFormat = gl.RGBA;\n      const readType = gl.UNSIGNED_BYTE;\n      const buffer = new Uint8Array(4);\n      gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    }\n    //clean up\n    gl.deleteTexture(texture);\n    gl.deleteFramebuffer(fb);\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n    //clear accumulated errors\n    // eslint-disable-next-line no-empty\n    while (!successful && gl.getError() !== gl.NO_ERROR) {}\n    return successful;\n  }\n  /**\n   * @internal\n   */\n  _getWebGLTextureType(type) {\n    if (this._webGLVersion === 1) {\n      switch (type) {\n        case 1:\n          return this._gl.FLOAT;\n        case 2:\n          return this._gl.HALF_FLOAT_OES;\n        case 0:\n          return this._gl.UNSIGNED_BYTE;\n        case 8:\n          return this._gl.UNSIGNED_SHORT_4_4_4_4;\n        case 9:\n          return this._gl.UNSIGNED_SHORT_5_5_5_1;\n        case 10:\n          return this._gl.UNSIGNED_SHORT_5_6_5;\n      }\n      return this._gl.UNSIGNED_BYTE;\n    }\n    switch (type) {\n      case 3:\n        return this._gl.BYTE;\n      case 0:\n        return this._gl.UNSIGNED_BYTE;\n      case 4:\n        return this._gl.SHORT;\n      case 5:\n        return this._gl.UNSIGNED_SHORT;\n      case 6:\n        return this._gl.INT;\n      case 7:\n        // Refers to UNSIGNED_INT\n        return this._gl.UNSIGNED_INT;\n      case 1:\n        return this._gl.FLOAT;\n      case 2:\n        return this._gl.HALF_FLOAT;\n      case 8:\n        return this._gl.UNSIGNED_SHORT_4_4_4_4;\n      case 9:\n        return this._gl.UNSIGNED_SHORT_5_5_5_1;\n      case 10:\n        return this._gl.UNSIGNED_SHORT_5_6_5;\n      case 11:\n        return this._gl.UNSIGNED_INT_2_10_10_10_REV;\n      case 12:\n        return this._gl.UNSIGNED_INT_24_8;\n      case 13:\n        return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\n      case 14:\n        return this._gl.UNSIGNED_INT_5_9_9_9_REV;\n      case 15:\n        return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\n    }\n    return this._gl.UNSIGNED_BYTE;\n  }\n  /**\n   * @internal\n   */\n  _getInternalFormat(format, useSRGBBuffer = false) {\n    let internalFormat = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA;\n    switch (format) {\n      case 0:\n        internalFormat = this._gl.ALPHA;\n        break;\n      case 1:\n        internalFormat = this._gl.LUMINANCE;\n        break;\n      case 2:\n        internalFormat = this._gl.LUMINANCE_ALPHA;\n        break;\n      case 6:\n        internalFormat = this._gl.RED;\n        break;\n      case 7:\n        internalFormat = this._gl.RG;\n        break;\n      case 4:\n        internalFormat = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB : this._gl.RGB;\n        break;\n      case 5:\n        internalFormat = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA;\n        break;\n    }\n    if (this._webGLVersion > 1) {\n      switch (format) {\n        case 8:\n          internalFormat = this._gl.RED_INTEGER;\n          break;\n        case 9:\n          internalFormat = this._gl.RG_INTEGER;\n          break;\n        case 10:\n          internalFormat = this._gl.RGB_INTEGER;\n          break;\n        case 11:\n          internalFormat = this._gl.RGBA_INTEGER;\n          break;\n      }\n    }\n    return internalFormat;\n  }\n  /**\n   * @internal\n   */\n  _getRGBABufferInternalSizedFormat(type, format, useSRGBBuffer = false) {\n    if (this._webGLVersion === 1) {\n      if (format !== undefined) {\n        switch (format) {\n          case 0:\n            return this._gl.ALPHA;\n          case 1:\n            return this._gl.LUMINANCE;\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n          case 4:\n            return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB : this._gl.RGB;\n        }\n      }\n      return this._gl.RGBA;\n    }\n    switch (type) {\n      case 3:\n        switch (format) {\n          case 6:\n            return this._gl.R8_SNORM;\n          case 7:\n            return this._gl.RG8_SNORM;\n          case 4:\n            return this._gl.RGB8_SNORM;\n          case 8:\n            return this._gl.R8I;\n          case 9:\n            return this._gl.RG8I;\n          case 10:\n            return this._gl.RGB8I;\n          case 11:\n            return this._gl.RGBA8I;\n          default:\n            return this._gl.RGBA8_SNORM;\n        }\n      case 0:\n        switch (format) {\n          case 6:\n            return this._gl.R8;\n          case 7:\n            return this._gl.RG8;\n          case 4:\n            return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8 : this._gl.RGB8;\n          // By default. Other possibilities are RGB565, SRGB8.\n          case 5:\n            return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA8;\n          // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\n          case 8:\n            return this._gl.R8UI;\n          case 9:\n            return this._gl.RG8UI;\n          case 10:\n            return this._gl.RGB8UI;\n          case 11:\n            return this._gl.RGBA8UI;\n          case 0:\n            return this._gl.ALPHA;\n          case 1:\n            return this._gl.LUMINANCE;\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n          default:\n            return this._gl.RGBA8;\n        }\n      case 4:\n        switch (format) {\n          case 8:\n            return this._gl.R16I;\n          case 9:\n            return this._gl.RG16I;\n          case 10:\n            return this._gl.RGB16I;\n          case 11:\n            return this._gl.RGBA16I;\n          default:\n            return this._gl.RGBA16I;\n        }\n      case 5:\n        switch (format) {\n          case 8:\n            return this._gl.R16UI;\n          case 9:\n            return this._gl.RG16UI;\n          case 10:\n            return this._gl.RGB16UI;\n          case 11:\n            return this._gl.RGBA16UI;\n          default:\n            return this._gl.RGBA16UI;\n        }\n      case 6:\n        switch (format) {\n          case 8:\n            return this._gl.R32I;\n          case 9:\n            return this._gl.RG32I;\n          case 10:\n            return this._gl.RGB32I;\n          case 11:\n            return this._gl.RGBA32I;\n          default:\n            return this._gl.RGBA32I;\n        }\n      case 7:\n        // Refers to UNSIGNED_INT\n        switch (format) {\n          case 8:\n            return this._gl.R32UI;\n          case 9:\n            return this._gl.RG32UI;\n          case 10:\n            return this._gl.RGB32UI;\n          case 11:\n            return this._gl.RGBA32UI;\n          default:\n            return this._gl.RGBA32UI;\n        }\n      case 1:\n        switch (format) {\n          case 6:\n            return this._gl.R32F;\n          // By default. Other possibility is R16F.\n          case 7:\n            return this._gl.RG32F;\n          // By default. Other possibility is RG16F.\n          case 4:\n            return this._gl.RGB32F;\n          // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\n          case 5:\n            return this._gl.RGBA32F;\n          // By default. Other possibility is RGBA16F.\n          default:\n            return this._gl.RGBA32F;\n        }\n      case 2:\n        switch (format) {\n          case 6:\n            return this._gl.R16F;\n          case 7:\n            return this._gl.RG16F;\n          case 4:\n            return this._gl.RGB16F;\n          // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\n          case 5:\n            return this._gl.RGBA16F;\n          default:\n            return this._gl.RGBA16F;\n        }\n      case 10:\n        return this._gl.RGB565;\n      case 13:\n        return this._gl.R11F_G11F_B10F;\n      case 14:\n        return this._gl.RGB9_E5;\n      case 8:\n        return this._gl.RGBA4;\n      case 9:\n        return this._gl.RGB5_A1;\n      case 11:\n        switch (format) {\n          case 5:\n            return this._gl.RGB10_A2;\n          // By default. Other possibility is RGB5_A1.\n          case 11:\n            return this._gl.RGB10_A2UI;\n          default:\n            return this._gl.RGB10_A2;\n        }\n    }\n    return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA8;\n  }\n  /**\n   * @internal\n   */\n  _getRGBAMultiSampleBufferFormat(type, format = 5) {\n    switch (type) {\n      case 1:\n        switch (format) {\n          case 6:\n            return this._gl.R32F;\n          default:\n            return this._gl.RGBA32F;\n        }\n      case 2:\n        switch (format) {\n          case 6:\n            return this._gl.R16F;\n          default:\n            return this._gl.RGBA16F;\n        }\n    }\n    return this._gl.RGBA8;\n  }\n  /**\n   * @internal\n   */\n  _loadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    const request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\n    this._activeRequests.push(request);\n    request.onCompleteObservable.add(request => {\n      this._activeRequests.splice(this._activeRequests.indexOf(request), 1);\n    });\n    return request;\n  }\n  /**\n   * Loads a file from a url\n   * @param url url to load\n   * @param onSuccess callback called when the file successfully loads\n   * @param onProgress callback called while file is loading (if the server supports this mode)\n   * @param offlineProvider defines the offline provider for caching\n   * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\n   * @param onError callback called when the file fails to load\n   * @returns a file request object\n   * @internal\n   */\n  static _FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    throw _WarnImport(\"FileTools\");\n  }\n  /**\n   * Reads pixels from the current frame buffer. Please note that this function can be slow\n   * @param x defines the x coordinate of the rectangle where pixels must be read\n   * @param y defines the y coordinate of the rectangle where pixels must be read\n   * @param width defines the width of the rectangle where pixels must be read\n   * @param height defines the height of the rectangle where pixels must be read\n   * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\n   * @param flushRenderer true to flush the renderer from the pending commands before reading the pixels\n   * @returns a ArrayBufferView promise (Uint8Array) containing RGBA colors\n   */\n  readPixels(x, y, width, height, hasAlpha = true, flushRenderer = true) {\n    const numChannels = hasAlpha ? 4 : 3;\n    const format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\n    const data = new Uint8Array(height * width * numChannels);\n    if (flushRenderer) {\n      this.flushFramebuffer();\n    }\n    this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\n    return Promise.resolve(data);\n  }\n  /**\n   * Gets a Promise<boolean> indicating if the engine can be instantiated (ie. if a webGL context can be found)\n   */\n  static get IsSupportedAsync() {\n    return Promise.resolve(this.isSupported());\n  }\n  /**\n   * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\n   */\n  static get IsSupported() {\n    return this.isSupported(); // Backward compat\n  }\n  /**\n   * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\n   * @returns true if the engine can be created\n   * @ignorenaming\n   */\n  // eslint-disable-next-line @typescript-eslint/naming-convention\n  static isSupported() {\n    if (this._HasMajorPerformanceCaveat !== null) {\n      return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\n    }\n\n    if (this._IsSupported === null) {\n      try {\n        const tempcanvas = this._CreateCanvas(1, 1);\n        const gl = tempcanvas.getContext(\"webgl\") || tempcanvas.getContext(\"experimental-webgl\");\n        this._IsSupported = gl != null && !!window.WebGLRenderingContext;\n      } catch (e) {\n        this._IsSupported = false;\n      }\n    }\n    return this._IsSupported;\n  }\n  /**\n   * Gets a boolean indicating if the engine can be instantiated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\n   */\n  static get HasMajorPerformanceCaveat() {\n    if (this._HasMajorPerformanceCaveat === null) {\n      try {\n        const tempcanvas = this._CreateCanvas(1, 1);\n        const gl = tempcanvas.getContext(\"webgl\", {\n          failIfMajorPerformanceCaveat: true\n        }) || tempcanvas.getContext(\"experimental-webgl\", {\n          failIfMajorPerformanceCaveat: true\n        });\n        this._HasMajorPerformanceCaveat = !gl;\n      } catch (e) {\n        this._HasMajorPerformanceCaveat = false;\n      }\n    }\n    return this._HasMajorPerformanceCaveat;\n  }\n  /**\n   * Find the next highest power of two.\n   * @param x Number to start search from.\n   * @returns Next highest power of two.\n   */\n  static CeilingPOT(x) {\n    x--;\n    x |= x >> 1;\n    x |= x >> 2;\n    x |= x >> 4;\n    x |= x >> 8;\n    x |= x >> 16;\n    x++;\n    return x;\n  }\n  /**\n   * Find the next lowest power of two.\n   * @param x Number to start search from.\n   * @returns Next lowest power of two.\n   */\n  static FloorPOT(x) {\n    x = x | x >> 1;\n    x = x | x >> 2;\n    x = x | x >> 4;\n    x = x | x >> 8;\n    x = x | x >> 16;\n    return x - (x >> 1);\n  }\n  /**\n   * Find the nearest power of two.\n   * @param x Number to start search from.\n   * @returns Next nearest power of two.\n   */\n  static NearestPOT(x) {\n    const c = ThinEngine.CeilingPOT(x);\n    const f = ThinEngine.FloorPOT(x);\n    return c - x > x - f ? f : c;\n  }\n  /**\n   * Get the closest exponent of two\n   * @param value defines the value to approximate\n   * @param max defines the maximum value to return\n   * @param mode defines how to define the closest value\n   * @returns closest exponent of two of the given value\n   */\n  static GetExponentOfTwo(value, max, mode = 2) {\n    let pot;\n    switch (mode) {\n      case 1:\n        pot = ThinEngine.FloorPOT(value);\n        break;\n      case 2:\n        pot = ThinEngine.NearestPOT(value);\n        break;\n      case 3:\n      default:\n        pot = ThinEngine.CeilingPOT(value);\n        break;\n    }\n    return Math.min(pot, max);\n  }\n  /**\n   * Queue a new function into the requested animation frame pool (ie. this function will be executed by the browser (or the javascript engine) for the next frame)\n   * @param func - the function to be called\n   * @param requester - the object that will request the next frame. Falls back to window.\n   * @returns frame number\n   */\n  static QueueNewFrame(func, requester) {\n    // Note that there is kind of a typing issue here, as `setTimeout` might return something else than a number (NodeJs returns a NodeJS.Timeout object).\n    // Also if the global `requestAnimationFrame`'s returnType is number, `requester.requestPostAnimationFrame` and `requester.requestAnimationFrame` types\n    // are `any`.\n    if (!IsWindowObjectExist()) {\n      if (typeof requestAnimationFrame === \"function\") {\n        return requestAnimationFrame(func);\n      }\n    } else {\n      const {\n        requestAnimationFrame\n      } = requester || window;\n      if (typeof requestAnimationFrame === \"function\") {\n        return requestAnimationFrame(func);\n      }\n    }\n    // fallback to the global `setTimeout`.\n    // In most cases (aka in the browser), `window` is the global object, so instead of calling `window.setTimeout` we could call the global `setTimeout`.\n    return setTimeout(func, 16);\n  }\n  /**\n   * Gets host document\n   * @returns the host document object\n   */\n  getHostDocument() {\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\n      return this._renderingCanvas.ownerDocument;\n    }\n    return IsDocumentAvailable() ? document : null;\n  }\n}\nThinEngine._TempClearColorUint32 = new Uint32Array(4);\nThinEngine._TempClearColorInt32 = new Int32Array(4);\n/** Use this array to turn off some WebGL2 features on known buggy browsers version */\nThinEngine.ExceptionList = [{\n  key: \"Chrome/63.0\",\n  capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\",\n  captureConstraint: 108,\n  targets: [\"uniformBuffer\"]\n}, {\n  key: \"Firefox/58\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"uniformBuffer\"]\n}, {\n  key: \"Firefox/59\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"uniformBuffer\"]\n}, {\n  key: \"Chrome/72.+?Mobile\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"vao\"]\n}, {\n  key: \"Chrome/73.+?Mobile\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"vao\"]\n}, {\n  key: \"Chrome/74.+?Mobile\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"vao\"]\n}, {\n  key: \"Mac OS.+Chrome/71\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"vao\"]\n}, {\n  key: \"Mac OS.+Chrome/72\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"vao\"]\n}, {\n  key: \"Mac OS.+Chrome\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"uniformBuffer\"]\n},\n// desktop osx safari 15.4\n{\n  key: \".*AppleWebKit.*(15.4).*Safari\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"antialias\", \"maxMSAASamples\"]\n},\n// mobile browsers using safari 15.4 on ios\n{\n  key: \".*(15.4).*AppleWebKit.*Safari\",\n  capture: null,\n  captureConstraint: null,\n  targets: [\"antialias\", \"maxMSAASamples\"]\n}];\n/** @internal */\nThinEngine._TextureLoaders = [];\n// Updatable statics so stick with vars here\n/**\n * Gets or sets the epsilon value used by collision engine\n */\nThinEngine.CollisionsEpsilon = 0.001;\n// Statics\nThinEngine._IsSupported = null;\nThinEngine._HasMajorPerformanceCaveat = null;","map":{"version":3,"names":["EngineStore","Effect","_WarnImport","Observable","DepthCullingState","StencilState","AlphaState","InternalTexture","InternalTextureSource","Logger","IsDocumentAvailable","IsWindowObjectExist","WebGLShaderProcessor","WebGL2ShaderProcessor","WebGLDataBuffer","WebGLPipelineContext","PerformanceConfigurator","WebGLHardwareTexture","DrawWrapper","StencilStateComposer","ShaderLanguage","PrecisionDate","BufferPointer","ThinEngine","NpmPackage","Version","description","name","webGLVersion","_caps","parallelShaderCompile","_name","value","version","_webGLVersion","isDisposed","_isDisposed","ShadersRepository","_getShaderProcessor","shaderLanguage","_shaderProcessor","useReverseDepthBuffer","_useReverseDepthBuffer","useReverse","_depthCullingState","depthFunc","frameId","_frameId","supportsUniformBuffers","disableUniformBuffers","getCreationOptions","_creationOptions","_shouldUseHighPrecisionShader","highPrecisionShaderSupported","_highPrecisionShadersAllowed","needPOTTextures","forcePOTTextures","activeRenderLoops","_activeRenderLoops","doNotHandleContextLost","_doNotHandleContextLost","_supportsHardwareTextureRescaling","framebufferDimensionsObject","dimensions","_framebufferDimensionsObject","currentViewport","_cachedViewport","emptyTexture","_emptyTexture","createRawTexture","Uint8Array","emptyTexture3D","_emptyTexture3D","createRawTexture3D","emptyTexture2DArray","_emptyTexture2DArray","createRawTexture2DArray","emptyCubeTexture","_emptyCubeTexture","faceData","cubeData","createRawCubeTexture","isWebGPU","_isWebGPU","shaderPlatformName","_shaderPlatformName","snapshotRendering","activate","snapshotRenderingMode","_snapshotRenderingMode","mode","snapshotRenderingReset","_CreateCanvas","width","height","document","OffscreenCanvas","canvas","createElement","createCanvas","createCanvasImage","constructor","canvasOrContext","antialias","options","adaptToDeviceRatio","isFullscreen","cullBackFaces","renderEvenInBackground","preventCacheWipeBetweenFrames","validateShaderPrograms","isNDCHalfZRange","hasOriginBottomLeft","onDisposeObservable","_uniformBuffers","Array","_storageBuffers","_windowIsBackground","_badOS","_badDesktopOS","_renderingQueueLaunched","onContextLostObservable","onContextRestoredObservable","_contextWasLost","disableVertexArrayObjects","_colorWrite","_colorWriteChanged","_stencilStateComposer","_stencilState","_alphaState","_alphaMode","_alphaEquation","_internalTexturesCache","_renderTargetWrapperCache","_activeChannel","_currentTextureChannel","_boundTexturesCache","_compiledEffects","_vertexAttribArraysEnabled","_uintIndicesCurrentlySet","_currentBoundBuffer","_currentFramebuffer","_dummyFramebuffer","_currentBufferPointers","_currentInstanceLocations","_currentInstanceBuffers","_vaoRecordInProgress","_mustWipeVertexAttributes","_nextFreeTextureSlots","_maxSimultaneousTextures","_maxMSAASamplesOverride","_activeRequests","_lastDevicePixelRatio","_transformTextureUrl","hostInformation","isMobile","premultipliedAlpha","onBeforeTextureInitObservable","_viewportCached","x","y","z","w","_unpackFlipYCached","enableUnpackFlipYCached","_boundUniforms","startTime","Now","stencilGlobal","SetMatrixPrecision","useHighPrecisionMatrix","deterministicLockstep","_a","lockstepMaxSteps","_b","timeStep","_c","audioEngine","_d","stencil","_e","_audioContext","_g","_f","audioEngineOptions","audioContext","_audioDestination","_j","_h","audioDestination","_k","useExactSrgbConversions","_l","_isStencilEnable","devicePixelRatio","window","limitDeviceRatio","_hardwareScalingLevel","Math","min","getContext","_renderingCanvas","preserveDrawingBuffer","undefined","xrCompatible","navigator","userAgent","_setupMobileChecks","ua","exception","ExceptionList","key","targets","check","RegExp","test","capture","captureConstraint","constraint","regex","matches","exec","length","capturedValue","parseInt","target","_onContextLost","evt","preventDefault","Warn","notifyObservers","_onContextRestored","_restoreEngineAfterContextLost","_initGLContext","addEventListener","powerPreference","disableWebGL2Support","_gl","deleteQuery","e","Error","renderbufferStorageMultisample","attributes","getContextAttributes","pixelStorei","UNPACK_COLORSPACE_CONVERSION_WEBGL","NONE","useHighPrecisionFloats","resize","_initFeatures","i","maxVertexAttribs","versionToLog","console","log","setAttribute","_checkForMobile","currentUA","indexOf","initEngine","setTimeout","depthTest","depthMask","stencilTest","wipeCaches","_rebuildEffects","_rebuildComputeEffects","call","_rebuildBuffers","_rebuildInternalTextures","_rebuildRenderTargetWrappers","_sharedInit","_getShaderProcessingContext","currentState","slice","internalTexture","_rebuild","renderTargetWrapper","effect","_pipelineContext","_wasPreviouslyReady","_prepareEffect","ResetCache","areAllEffectsReady","isReady","uniformBuffer","storageBuffer","maxTexturesImageUnits","getParameter","MAX_TEXTURE_IMAGE_UNITS","maxCombinedTexturesImageUnits","MAX_COMBINED_TEXTURE_IMAGE_UNITS","maxVertexTextureImageUnits","MAX_VERTEX_TEXTURE_IMAGE_UNITS","maxTextureSize","MAX_TEXTURE_SIZE","maxSamples","MAX_SAMPLES","maxCubemapTextureSize","MAX_CUBE_MAP_TEXTURE_SIZE","maxRenderTextureSize","MAX_RENDERBUFFER_SIZE","MAX_VERTEX_ATTRIBS","maxVaryingVectors","MAX_VARYING_VECTORS","maxFragmentUniformVectors","MAX_FRAGMENT_UNIFORM_VECTORS","maxVertexUniformVectors","MAX_VERTEX_UNIFORM_VECTORS","getExtension","standardDerivatives","maxAnisotropy","astc","bptc","s3tc","s3tc_srgb","pvrtc","etc1","etc2","textureAnisotropicFilterExtension","uintIndices","fragmentDepthSupported","timerQuery","supportOcclusionQuery","canUseTimestampForTimerQuery","drawBuffersExtension","maxMSAASamples","colorBufferFloat","colorBufferHalfFloat","textureFloat","textureHalfFloat","textureHalfFloatRender","textureFloatLinearFiltering","textureFloatRender","textureHalfFloatLinearFiltering","vertexArrayObject","instancedArrays","textureLOD","texelFetch","blendMinMax","multiview","oculusMultiview","depthTextureExtension","canUseGLInstanceID","canUseGLVertexID","supportComputeShaders","supportSRGBBuffers","supportTransformFeedbacks","textureMaxLevel","texture2DArrayMaxLayerCount","MAX_ARRAY_TEXTURE_LAYERS","disableMorphTargetTexture","_glVersion","VERSION","rendererInfo","_glRenderer","UNMASKED_RENDERER_WEBGL","_glVendor","UNMASKED_VENDOR_WEBGL","VENDOR","RENDERER","HALF_FLOAT_OES","RGBA16F","RGBA32F","DEPTH24_STENCIL8","getQuery","getQueryEXT","bind","TIMESTAMP_EXT","QUERY_COUNTER_BITS_EXT","MAX_TEXTURE_MAX_ANISOTROPY_EXT","_canRenderToFloatFramebuffer","COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR","COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT","COMPRESSED_SRGB_S3TC_DXT1_EXT","COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT","COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT","COMPRESSED_SRGB8_ETC2","COMPRESSED_SRGB8_ALPHA8_ETC2_EAC","_canRenderToHalfFloatFramebuffer","drawBuffers","drawBuffersWEBGL","DRAW_FRAMEBUFFER","FRAMEBUFFER","UNSIGNED_INT_24_8","UNSIGNED_INT_24_8_WEBGL","vertexArrayObjectExtension","createVertexArray","createVertexArrayOES","bindVertexArray","bindVertexArrayOES","deleteVertexArray","deleteVertexArrayOES","instanceExtension","drawArraysInstanced","drawArraysInstancedANGLE","drawElementsInstanced","drawElementsInstancedANGLE","vertexAttribDivisor","vertexAttribDivisorANGLE","getShaderPrecisionFormat","vertexhighp","VERTEX_SHADER","HIGH_FLOAT","fragmenthighp","FRAGMENT_SHADER","precision","blendMinMaxExtension","MAX","MAX_EXT","MIN","MIN_EXT","_glSRGBExtensionValues","SRGB","WebGL2RenderingContext","SRGB8","SRGB8_ALPHA8","sRGBExtension","SRGB_EXT","SRGB_ALPHA_EXT","forceSRGBBufferSupportState","LEQUAL","slot","push","_features","forceBitmapOverHTMLImageElement","supportRenderAndCopyToLodForFloatTextures","supportDepthStencilTexture","supportShadowSamplers","uniformBufferHardCheckMatrix","allowTexturePrefiltering","trackUbosInFrame","checkUbosContentBeforeUpload","supportCSM","basisNeedsPOT","support3DTextures","needTypeSuffixInShaderConstants","supportMSAA","supportSSAO2","supportExtendedTextureFormats","supportSwitchCaseInShader","supportSyncTextureRead","needsInvertingBitmap","useUBOBindingCache","needShaderCodeInlining","needToAlwaysBindUniformBuffers","supportRenderPasses","supportSpriteInstancing","forceVertexBufferStrideMultiple4Bytes","_collectUbosUpdatedInFrame","getClassName","isStencilEnable","_prepareWorkingCanvas","_workingCanvas","context","_workingContext","resetTextureCache","Object","prototype","hasOwnProperty","getInfo","getGlInfo","vendor","renderer","setHardwareScalingLevel","level","getHardwareScalingLevel","getLoadedTexturesCache","getCaps","stopRenderLoop","renderFunction","_cancelFrame","index","splice","_frameHandler","cancelAnimationFrame","getHostWindow","clearTimeout","_renderLoop","shouldRender","beginFrame","endFrame","_queueNewFrame","_boundRenderFunction","getRenderingCanvas","getAudioContext","getAudioDestination","ownerDocument","defaultView","getRenderWidth","useScreen","_currentRenderTarget","framebufferWidth","drawingBufferWidth","getRenderHeight","framebufferHeight","drawingBufferHeight","bindedRenderFunction","requester","QueueNewFrame","runRenderLoop","clear","color","backBuffer","depth","useStencilGlobalOnly","stencilStateComposer","applyStates","setBackBufferColor","textureFormat","texture","format","textureType","type","_TempClearColorUint32","r","g","b","a","clearBufferuiv","COLOR","_TempClearColorInt32","clearBufferiv","clearColor","COLOR_BUFFER_BIT","GEQUAL","clearDepth","DEPTH_BUFFER_BIT","clearStencil","STENCIL_BUFFER_BIT","_viewport","viewport","setViewport","requiredWidth","requiredHeight","flushFramebuffer","forceSetSize","changeRatio","boundingRect","getBoundingClientRect","clientWidth","clientHeight","innerWidth","innerHeight","setSize","bindFramebuffer","rtWrapper","faceIndex","forceFullscreenViewport","lodLevel","layer","webglRTWrapper","unBindFramebuffer","_bindUnboundFramebuffer","_MSAAFramebuffer","_framebuffer","gl","isMulti","is2DArray","framebufferTextureLayer","COLOR_ATTACHMENT0","_hardwareTexture","underlyingResource","isCube","framebufferTexture2D","TEXTURE_CUBE_MAP_POSITIVE_X","_currentLOD","TEXTURE_2D","depthStencilTexture","_depthStencilTexture","attachment","_depthStencilTextureWithStencil","DEPTH_STENCIL_ATTACHMENT","DEPTH_ATTACHMENT","pow","setState","culling","zOffset","force","reverseSide","zOffsetUnits","cull","cullFace","BACK","FRONT","setZOffset","setZOffsetUnits","frontFace","CW","CCW","stencilMaterial","getDepthBuffer","setDepthBuffer","enable","getZOffset","getZOffsetUnits","framebuffer","_currentFrameBufferIsDefaultFrameBuffer","generateMipmaps","_bindTextureDirectly","generateMipmap","disableGenerateMipMaps","onBeforeUnbind","unBindMultiColorAttachmentFramebuffer","READ_FRAMEBUFFER","blitFramebuffer","NEAREST","generateMipMaps","flush","restoreDefaultFramebuffer","_resetVertexBufferBinding","bindArrayBuffer","_cachedVertexBuffers","createVertexBuffer","data","_updatable","_label","_createVertexBuffer","STATIC_DRAW","usage","vbo","createBuffer","dataBuffer","bufferData","ARRAY_BUFFER","Float32Array","references","createDynamicVertexBuffer","DYNAMIC_DRAW","_resetIndexBufferBinding","bindIndexBuffer","_cachedIndexBuffer","createIndexBuffer","indices","updatable","_normalizeIndexData","ELEMENT_ARRAY_BUFFER","is32Bits","BYTES_PER_ELEMENT","bytesPerElement","Uint32Array","Uint16Array","buffer","_unbindVertexArrayObject","_bindBuffer","bindUniformBlock","pipelineContext","blockName","program","uniformLocation","getUniformBlockIndex","uniformBlockBinding","bindBuffer","updateArrayBuffer","bufferSubData","_vertexAttribPointer","indx","size","normalized","stride","offset","pointer","changed","active","UNSIGNED_INT","INT","vertexAttribIPointer","vertexAttribPointer","_bindIndexBufferWithCache","indexBuffer","_bindVertexBuffersAttributes","vertexBuffers","overrideVertexBuffers","getAttributesNames","unbindAllAttributes","order","getAttributeLocation","ai","vertexBuffer","enableVertexAttribArray","getBuffer","getSize","byteStride","byteOffset","getIsInstanced","getInstanceDivisor","recordVertexArrayObject","vao","bindVertexArrayObject","_cachedVertexArrayObject","bindBuffersDirectly","vertexDeclaration","vertexStrideSize","_cachedEffectForVertexBuffers","attributesCount","getAttributesCount","FLOAT","bindBuffers","unbindInstanceAttributes","boundBuffer","ul","instancesBuffer","offsetLocation","releaseVertexArrayObject","_releaseBuffer","_deleteBuffer","deleteBuffer","updateAndBindInstancesBuffer","offsetLocations","bindInstancesBuffer","attributesInfo","computeStride","attributeSize","_currentEffect","getAttributeLocationByName","attributeName","attributeType","divisor","disableInstanceAttributeByName","attributeLocation","disableInstanceAttribute","shouldClean","disableAttributeByIndex","disableVertexAttribArray","draw","useTriangles","indexStart","indexCount","instancesCount","drawElementsType","drawPointClouds","verticesStart","verticesCount","drawArraysType","drawUnIndexed","fillMode","_reportDrawCall","drawMode","_drawMode","indexFormat","UNSIGNED_SHORT","mult","drawElements","drawArrays","TRIANGLES","POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLE_STRIP","TRIANGLE_FAN","_releaseEffect","_key","getPipelineContext","_deletePipelineContext","webGLPipelineContext","__SPECTOR_rebuildProgram","deleteProgram","_getGlobalDefines","defines","s","createEffect","baseName","attributesNamesOrOptions","uniformsNamesOrEngine","samplers","fallbacks","onCompiled","onError","indexParameters","GLSL","vertex","vertexElement","vertexToken","vertexSource","fragment","fragmentElement","fragmentToken","fragmentSource","globalDefines","fullDefines","compiledEffect","_ConcatenateShader","source","shaderVersion","_compileShader","_compileRawShader","shader","createShader","error","NO_ERROR","tempError","getError","isContextLost","shaderSource","compileShader","_getShaderSource","getShaderSource","createRawShaderProgram","vertexCode","fragmentCode","transformFeedbackVaryings","vertexShader","fragmentShader","_createShaderProgram","createShaderProgram","inlineShaderCode","code","createPipelineContext","shaderProcessingContext","engine","isParallelCompiled","createMaterialContext","createDrawContext","shaderProgram","createProgram","attachShader","linkProgram","_finalizePipelineContext","linked","getProgramParameter","LINK_STATUS","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","vertexCompilationError","fragmentCompilationError","getProgramInfoLog","programLinkError","validateProgram","validated","VALIDATE_STATUS","programValidationError","deleteShader","_preparePipelineContext","vertexSourceCode","fragmentSourceCode","createAsRaw","rawVertexSourceCode","rawFragmentSourceCode","rebuildRebind","webGLRenderingState","_isRenderingStateCompiled","COMPLETION_STATUS_KHR","_executeWhenRenderingStateIsCompiled","action","oldHandler","getUniforms","uniformsNames","results","getUniformLocation","getAttributes","attributesNames","getAttribLocation","enableEffect","IsWrapper","bindSamplers","onBind","_onBindObservable","setInt","uniform","uniform1i","setInt2","uniform2i","setInt3","uniform3i","setInt4","uniform4i","setIntArray","array","uniform1iv","setIntArray2","uniform2iv","setIntArray3","uniform3iv","setIntArray4","uniform4iv","setUInt","uniform1ui","setUInt2","uniform2ui","setUInt3","uniform3ui","setUInt4","uniform4ui","setUIntArray","uniform1uiv","setUIntArray2","uniform2uiv","setUIntArray3","uniform3uiv","setUIntArray4","uniform4uiv","setArray","uniform1fv","setArray2","uniform2fv","setArray3","uniform3fv","setArray4","uniform4fv","setMatrices","matrices","uniformMatrix4fv","setMatrix3x3","matrix","uniformMatrix3fv","setMatrix2x2","uniformMatrix2fv","setFloat","uniform1f","setFloat2","uniform2f","setFloat3","uniform3f","setFloat4","uniform4f","apply","colorMask","setColorWrite","getColorWrite","depthCullingState","alphaState","stencilState","clearInternalTexturesCache","bruteForce","_currentProgram","reset","UNPACK_PREMULTIPLY_ALPHA_WEBGL","_getSamplingParameters","samplingMode","magFilter","minFilter","LINEAR","LINEAR_MIPMAP_NEAREST","LINEAR_MIPMAP_LINEAR","NEAREST_MIPMAP_LINEAR","NEAREST_MIPMAP_NEAREST","mag","_createTexture","createTexture","_createHardwareTexture","_createInternalTexture","delayGPUTextureCreation","Unknown","useSRGBBuffer","samples","label","layers","filters","TEXTURE_2D_ARRAY","sizedFormat","_getRGBABufferInternalSizedFormat","internalFormat","_getInternalFormat","_getWebGLTextureType","texImage3D","texImage2D","texParameteri","TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","_useSRGBBuffer","baseWidth","baseHeight","_getUseSRGBBuffer","noMipmap","_createTextureBase","url","invertY","scene","onLoad","prepareTexture","prepareTextureProcessFunction","fallback","forcedExtension","mimeType","loaderOptions","fromData","substr","fromBlob","isBase64","Url","substring","originalUrl","_originalUrl","lastDot","lastIndexOf","extension","toLowerCase","loader","queryStringIndex","split","availableLoader","_TextureLoaders","canLoad","addPendingData","_buffer","onLoadObserver","onLoadedObservable","add","onInternalError","message","removePendingData","remove","UseFallbackTexture","FallbackTexture","onErrorObservable","callback","loadData","loadMipmap","isCompressed","done","loadFailed","_loadFile","offlineProvider","request","responseURL","ArrayBuffer","isView","onload","img","decoding","close","_FileToolsLoadImage","imageOrientation","Blob","creationFlags","_prepareWebGLTexture","potWidth","potHeight","continuationCallback","isPot","tip","_getTexImageParametersForCreateTexture","drawImage","Temp","_rescaleTexture","_releaseTexture","babylonFormat","fileExtension","UNSIGNED_BYTE","input","imageBitmapOptions","destination","onComplete","compression","_unpackFlipY","UNPACK_FLIP_Y_WEBGL","_getUnpackAlignement","UNPACK_ALIGNMENT","_getTextureTarget","TEXTURE_CUBE_MAP","is3D","TEXTURE_3D","isMultiview","updateTextureSamplingMode","useMipMaps","_setTextureParameterInteger","updateTextureDimensions","updateTextureWrappingMode","wrapU","wrapV","wrapR","_getTextureWrapMode","_cachedWrapU","_cachedWrapV","TEXTURE_WRAP_R","_cachedWrapR","_setupDepthStencilTexture","generateStencil","bilinearFiltering","comparisonFunction","_comparisonFunction","samplingParameters","TEXTURE_COMPARE_FUNC","TEXTURE_COMPARE_MODE","COMPARE_REF_TO_TEXTURE","_uploadCompressedDataToTextureDirectly","lod","compressedTexImage2D","_uploadDataToTextureDirectly","imageData","babylonInternalFormat","useTextureWidthAndHeight","lodMaxWidth","round","LOG2E","lodMaxHeight","max","updateTextureData","xOffset","yOffset","targetForBinding","texSubImage2D","_uploadArrayBufferViewToTexture","bindTarget","_prepareWebGLTextureContinuation","processFunction","GetExponentOfTwo","_setupFramebufferDepthAttachments","generateStencilBuffer","generateDepthBuffer","_createRenderBuffer","DEPTH_STENCIL","depthFormat","DEPTH_COMPONENT16","DEPTH_COMPONENT32F","STENCIL_INDEX8","STENCIL_ATTACHMENT","msInternalFormat","unbindBuffer","renderBuffer","createRenderbuffer","_updateRenderBuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorage","framebufferRenderbuffer","_deleteTexture","unbindAllTextures","_lodTextureHigh","dispose","_lodTextureMid","_lodTextureLow","_irradianceTexture","_releaseRenderTargetWrapper","deleteTexture","_setProgram","useProgram","getSamplers","getUniform","_activateCurrentTexture","activeTexture","TEXTURE0","forTextureDataUpdate","wasPreviouslyBound","isTextureForRendering","_associatedChannel","currentTextureBound","bindTexture","_bindSamplerUniformToChannel","_bindTexture","channel","setTexture","_setTexture","sourceSlot","_currentState","REPEAT","MIRRORED_REPEAT","isPartOfTextureArray","video","videoInternalTexture","getInternalTexture","update","delayLoadState","delayLoad","needToBind","_cachedCoordinatesMode","coordinatesMode","textureWrapMode","_setAnisotropicLevel","anisotropicFilteringLevel","setTextureArray","textures","_textureUnits","Int32Array","anisotropicFilterExtension","_cachedAnisotropicFilteringLevel","_setTextureParameterFloat","TEXTURE_MAX_ANISOTROPY_EXT","parameter","texParameterf","releaseEffects","deleteFramebuffer","releaseComputeEffects","removeEventListener","abort","loseContextOnDispose","loseContext","attachContextLostEvent","attachContextRestoredEvent","_canRenderToFramebuffer","successful","RGBA","fb","createFramebuffer","status","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","readFormat","readType","readPixels","UNSIGNED_SHORT_4_4_4_4","UNSIGNED_SHORT_5_5_5_1","UNSIGNED_SHORT_5_6_5","BYTE","SHORT","HALF_FLOAT","UNSIGNED_INT_2_10_10_10_REV","UNSIGNED_INT_10F_11F_11F_REV","UNSIGNED_INT_5_9_9_9_REV","FLOAT_32_UNSIGNED_INT_24_8_REV","ALPHA","LUMINANCE","LUMINANCE_ALPHA","RED","RG","RGB","RED_INTEGER","RG_INTEGER","RGB_INTEGER","RGBA_INTEGER","R8_SNORM","RG8_SNORM","RGB8_SNORM","R8I","RG8I","RGB8I","RGBA8I","RGBA8_SNORM","R8","RG8","RGB8","RGBA8","R8UI","RG8UI","RGB8UI","RGBA8UI","R16I","RG16I","RGB16I","RGBA16I","R16UI","RG16UI","RGB16UI","RGBA16UI","R32I","RG32I","RGB32I","RGBA32I","R32UI","RG32UI","RGB32UI","RGBA32UI","R32F","RG32F","RGB32F","R16F","RG16F","RGB16F","RGB565","R11F_G11F_B10F","RGB9_E5","RGBA4","RGB5_A1","RGB10_A2","RGB10_A2UI","_getRGBAMultiSampleBufferFormat","onSuccess","onProgress","useArrayBuffer","_FileToolsLoadFile","onCompleteObservable","hasAlpha","flushRenderer","numChannels","Promise","resolve","IsSupportedAsync","isSupported","IsSupported","_HasMajorPerformanceCaveat","_IsSupported","tempcanvas","WebGLRenderingContext","HasMajorPerformanceCaveat","failIfMajorPerformanceCaveat","CeilingPOT","FloorPOT","NearestPOT","c","f","pot","func","requestAnimationFrame","getHostDocument","CollisionsEpsilon"],"sources":["../../../../dev/core/src/Engines/thinEngine.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unused-vars */\r\nimport { EngineStore } from \"./engineStore\";\r\nimport type { IInternalTextureLoader } from \"../Materials/Textures/internalTextureLoader\";\r\nimport type { IEffectCreationOptions } from \"../Materials/effect\";\r\nimport { Effect } from \"../Materials/effect\";\r\nimport { _WarnImport } from \"../Misc/devTools\";\r\nimport type { IShaderProcessor } from \"./Processors/iShaderProcessor\";\r\nimport type { ShaderProcessingContext } from \"./Processors/shaderProcessingOptions\";\r\nimport type { UniformBuffer } from \"../Materials/uniformBuffer\";\r\nimport type { Nullable, DataArray, IndicesArray } from \"../types\";\r\nimport type { EngineCapabilities } from \"./engineCapabilities\";\r\nimport type { Observer } from \"../Misc/observable\";\r\nimport { Observable } from \"../Misc/observable\";\r\nimport { DepthCullingState } from \"../States/depthCullingState\";\r\nimport { StencilState } from \"../States/stencilState\";\r\nimport { AlphaState } from \"../States/alphaCullingState\";\r\nimport { Constants } from \"./constants\";\r\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture\";\r\nimport type { IViewportLike, IColor4Like } from \"../Maths/math.like\";\r\nimport type { DataBuffer } from \"../Buffers/dataBuffer\";\r\nimport type { IFileRequest } from \"../Misc/fileRequest\";\r\nimport { Logger } from \"../Misc/logger\";\r\nimport { IsDocumentAvailable, IsWindowObjectExist } from \"../Misc/domManagement\";\r\nimport { WebGLShaderProcessor } from \"./WebGL/webGLShaderProcessors\";\r\nimport { WebGL2ShaderProcessor } from \"./WebGL/webGL2ShaderProcessors\";\r\nimport { WebGLDataBuffer } from \"../Meshes/WebGL/webGLDataBuffer\";\r\nimport type { IPipelineContext } from \"./IPipelineContext\";\r\nimport { WebGLPipelineContext } from \"./WebGL/webGLPipelineContext\";\r\nimport type { VertexBuffer } from \"../Buffers/buffer\";\r\nimport type { InstancingAttributeInfo } from \"./instancingAttributeInfo\";\r\nimport type { ThinTexture } from \"../Materials/Textures/thinTexture\";\r\nimport type { IOfflineProvider } from \"../Offline/IOfflineProvider\";\r\nimport type { IEffectFallbacks } from \"../Materials/iEffectFallbacks\";\r\nimport type { IWebRequest } from \"../Misc/interfaces/iWebRequest\";\r\nimport { PerformanceConfigurator } from \"./performanceConfigurator\";\r\nimport type { EngineFeatures } from \"./engineFeatures\";\r\nimport type { HardwareTextureWrapper } from \"../Materials/Textures/hardwareTextureWrapper\";\r\nimport { WebGLHardwareTexture } from \"./WebGL/webGLHardwareTexture\";\r\nimport { DrawWrapper } from \"../Materials/drawWrapper\";\r\nimport type { IMaterialContext } from \"./IMaterialContext\";\r\nimport type { IDrawContext } from \"./IDrawContext\";\r\nimport type { ICanvas, ICanvasRenderingContext, IImage } from \"./ICanvas\";\r\nimport { StencilStateComposer } from \"../States/stencilStateComposer\";\r\nimport type { StorageBuffer } from \"../Buffers/storageBuffer\";\r\nimport type { IAudioEngineOptions } from \"../Audio/Interfaces/IAudioEngineOptions\";\r\nimport type { IStencilState } from \"../States/IStencilState\";\r\nimport type { InternalTextureCreationOptions, TextureSize } from \"../Materials/Textures/textureCreationOptions\";\r\nimport { ShaderLanguage } from \"../Materials/shaderLanguage\";\r\nimport type { RenderTargetWrapper } from \"./renderTargetWrapper\";\r\nimport type { WebGLRenderTargetWrapper } from \"./WebGL/webGLRenderTargetWrapper\";\r\nimport type { VideoTexture } from \"../Materials/Textures/videoTexture\";\r\nimport type { RenderTargetTexture } from \"../Materials/Textures/renderTargetTexture\";\r\nimport type { WebRequest } from \"../Misc/webRequest\";\r\nimport type { LoadFileError } from \"../Misc/fileTools\";\r\nimport type { Texture } from \"../Materials/Textures/texture\";\r\nimport { PrecisionDate } from \"../Misc/precisionDate\";\r\n\r\n/**\r\n * Defines the interface used by objects working like Scene\r\n * @internal\r\n */\r\nexport interface ISceneLike {\r\n    addPendingData(data: any): void;\r\n    removePendingData(data: any): void;\r\n    offlineProvider: IOfflineProvider;\r\n}\r\n\r\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\r\nclass BufferPointer {\r\n    public active: boolean;\r\n    public index: number;\r\n    public size: number;\r\n    public type: number;\r\n    public normalized: boolean;\r\n    public stride: number;\r\n    public offset: number;\r\n    public buffer: WebGLBuffer;\r\n}\r\n\r\n/**\r\n * Information about the current host\r\n */\r\nexport interface HostInformation {\r\n    /**\r\n     * Defines if the current host is a mobile\r\n     */\r\n    isMobile: boolean;\r\n}\r\n\r\n/** Interface defining initialization parameters for ThinEngine class */\r\nexport interface ThinEngineOptions {\r\n    /**\r\n     * Defines if the engine should no exceed a specified device ratio\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio\r\n     */\r\n    limitDeviceRatio?: number;\r\n    /**\r\n     * Defines if webaudio should be initialized as well\r\n     * @see https://doc.babylonjs.com/features/featuresDeepDive/audio/playingSoundsMusic\r\n     */\r\n    audioEngine?: boolean;\r\n    /**\r\n     * Specifies options for the audio engine\r\n     */\r\n    audioEngineOptions?: IAudioEngineOptions;\r\n\r\n    /**\r\n     * Defines if animations should run using a deterministic lock step\r\n     * @see https://doc.babylonjs.com/features/featuresDeepDive/animation/advanced_animations#deterministic-lockstep\r\n     */\r\n    deterministicLockstep?: boolean;\r\n    /** Defines the maximum steps to use with deterministic lock step mode */\r\n    lockstepMaxSteps?: number;\r\n    /** Defines the seconds between each deterministic lock step */\r\n    timeStep?: number;\r\n    /**\r\n     * Defines that engine should ignore context lost events\r\n     * If this event happens when this parameter is true, you will have to reload the page to restore rendering\r\n     */\r\n    doNotHandleContextLost?: boolean;\r\n    /**\r\n     * Defines that engine should ignore modifying touch action attribute and style\r\n     * If not handle, you might need to set it up on your side for expected touch devices behavior.\r\n     */\r\n    doNotHandleTouchAction?: boolean;\r\n\r\n    /**\r\n     * Make the matrix computations to be performed in 64 bits instead of 32 bits. False by default\r\n     */\r\n    useHighPrecisionMatrix?: boolean;\r\n\r\n    /**\r\n     * Defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    adaptToDeviceRatio?: boolean;\r\n\r\n    /**\r\n     * True if the more expensive but exact conversions should be used for transforming colors to and from linear space within shaders.\r\n     * Otherwise, the default is to use a cheaper approximation.\r\n     */\r\n    useExactSrgbConversions?: boolean;\r\n\r\n    /**\r\n     * Defines whether MSAA is enabled on the canvas.\r\n     */\r\n    antialias?: boolean;\r\n\r\n    /**\r\n     * Defines whether the stencil buffer should be enabled.\r\n     */\r\n    stencil?: boolean;\r\n\r\n    /**\r\n     * Defines whether the canvas should be created in \"premultiplied\" mode (if false, the canvas is created in the \"opaque\" mode) (true by default)\r\n     */\r\n    premultipliedAlpha?: boolean;\r\n}\r\n\r\n/** Interface defining initialization parameters for Engine class */\r\nexport interface EngineOptions extends ThinEngineOptions, WebGLContextAttributes {\r\n    /**\r\n     * Defines if webgl2 should be turned off even if supported\r\n     * @see https://doc.babylonjs.com/setup/support/webGL2\r\n     */\r\n    disableWebGL2Support?: boolean;\r\n\r\n    /**\r\n     * Defines that engine should compile shaders with high precision floats (if supported). True by default\r\n     */\r\n    useHighPrecisionFloats?: boolean;\r\n    /**\r\n     * Make the canvas XR Compatible for XR sessions\r\n     */\r\n    xrCompatible?: boolean;\r\n\r\n    /**\r\n     * Will prevent the system from falling back to software implementation if a hardware device cannot be created\r\n     */\r\n    failIfMajorPerformanceCaveat?: boolean;\r\n\r\n    /**\r\n     * If sRGB Buffer support is not set during construction, use this value to force a specific state\r\n     * This is added due to an issue when processing textures in chrome/edge/firefox\r\n     * This will not influence NativeEngine and WebGPUEngine which set the behavior to true during construction.\r\n     */\r\n    forceSRGBBufferSupportState?: boolean;\r\n\r\n    /**\r\n     * Defines if the gl context should be released.\r\n     * It's false by default for backward compatibility, but you should probably pass true (see https://registry.khronos.org/webgl/extensions/WEBGL_lose_context/)\r\n     */\r\n    loseContextOnDispose?: boolean;\r\n}\r\n\r\n/**\r\n * The base engine class (root of all engines)\r\n */\r\nexport class ThinEngine {\r\n    private static _TempClearColorUint32 = new Uint32Array(4);\r\n    private static _TempClearColorInt32 = new Int32Array(4);\r\n\r\n    /** Use this array to turn off some WebGL2 features on known buggy browsers version */\r\n    public static ExceptionList = [\r\n        { key: \"Chrome/63.0\", capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\", captureConstraint: 108, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox/58\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox/59\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Chrome/72.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome/73.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome/74.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome/71\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome/72\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        // desktop osx safari 15.4\r\n        { key: \".*AppleWebKit.*(15.4).*Safari\", capture: null, captureConstraint: null, targets: [\"antialias\", \"maxMSAASamples\"] },\r\n        // mobile browsers using safari 15.4 on ios\r\n        { key: \".*(15.4).*AppleWebKit.*Safari\", capture: null, captureConstraint: null, targets: [\"antialias\", \"maxMSAASamples\"] },\r\n    ];\r\n\r\n    /** @internal */\r\n    public static _TextureLoaders: IInternalTextureLoader[] = [];\r\n\r\n    /**\r\n     * Returns the current npm package of the sdk\r\n     */\r\n    // Not mixed with Version for tooling purpose.\r\n    public static get NpmPackage(): string {\r\n        return \"babylonjs@6.25.1\";\r\n    }\r\n\r\n    /**\r\n     * Returns the current version of the framework\r\n     */\r\n    public static get Version(): string {\r\n        return \"6.25.1\";\r\n    }\r\n\r\n    /**\r\n     * Returns a string describing the current engine\r\n     */\r\n    public get description(): string {\r\n        let description = this.name + this.webGLVersion;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            description += \" - Parallel shader compilation\";\r\n        }\r\n\r\n        return description;\r\n    }\r\n\r\n    /** @internal */\r\n    protected _name = \"WebGL\";\r\n\r\n    /**\r\n     * Gets or sets the name of the engine\r\n     */\r\n    public get name(): string {\r\n        return this._name;\r\n    }\r\n\r\n    public set name(value: string) {\r\n        this._name = value;\r\n    }\r\n\r\n    /**\r\n     * Returns the version of the engine\r\n     */\r\n    public get version(): number {\r\n        return this._webGLVersion;\r\n    }\r\n\r\n    protected _isDisposed = false;\r\n\r\n    public get isDisposed(): boolean {\r\n        return this._isDisposed;\r\n    }\r\n\r\n    // Updatable statics so stick with vars here\r\n\r\n    /**\r\n     * Gets or sets the epsilon value used by collision engine\r\n     */\r\n    public static CollisionsEpsilon = 0.001;\r\n\r\n    /**\r\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n     */\r\n    public static get ShadersRepository(): string {\r\n        return Effect.ShadersRepository;\r\n    }\r\n    public static set ShadersRepository(value: string) {\r\n        Effect.ShadersRepository = value;\r\n    }\r\n\r\n    protected _shaderProcessor: Nullable<IShaderProcessor>;\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getShaderProcessor(shaderLanguage: ShaderLanguage): Nullable<IShaderProcessor> {\r\n        return this._shaderProcessor;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n     */\r\n    public forcePOTTextures = false;\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n     */\r\n    public isFullscreen = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if back faces must be culled. If false, front faces are culled instead (true by default)\r\n     * If non null, this takes precedence over the value from the material\r\n     */\r\n    public cullBackFaces: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foreground\r\n     */\r\n    public renderEvenInBackground = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that cache can be kept between frames\r\n     */\r\n    public preventCacheWipeBetweenFrames = false;\r\n\r\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\r\n    public validateShaderPrograms = false;\r\n\r\n    private _useReverseDepthBuffer = false;\r\n    /**\r\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n     * This can provide greater z depth for distant objects.\r\n     */\r\n    public get useReverseDepthBuffer(): boolean {\r\n        return this._useReverseDepthBuffer;\r\n    }\r\n\r\n    public set useReverseDepthBuffer(useReverse) {\r\n        if (useReverse === this._useReverseDepthBuffer) {\r\n            return;\r\n        }\r\n\r\n        this._useReverseDepthBuffer = useReverse;\r\n\r\n        if (useReverse) {\r\n            this._depthCullingState.depthFunc = Constants.GEQUAL;\r\n        } else {\r\n            this._depthCullingState.depthFunc = Constants.LEQUAL;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Indicates if the z range in NDC space is 0..1 (value: true) or -1..1 (value: false)\r\n     */\r\n    public readonly isNDCHalfZRange: boolean = false;\r\n\r\n    /**\r\n     * Indicates that the origin of the texture/framebuffer space is the bottom left corner. If false, the origin is top left\r\n     */\r\n    public readonly hasOriginBottomLeft: boolean = true;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n     */\r\n    public disableUniformBuffers = false;\r\n\r\n    /**\r\n     * An event triggered when the engine is disposed.\r\n     */\r\n    public readonly onDisposeObservable = new Observable<ThinEngine>();\r\n\r\n    private _frameId = 0;\r\n    /**\r\n     * Gets the current frame id\r\n     */\r\n    public get frameId(): number {\r\n        return this._frameId;\r\n    }\r\n\r\n    /**\r\n     * The time (in milliseconds elapsed since the current page has been loaded) when the engine was initialized\r\n     */\r\n    public readonly startTime: number;\r\n\r\n    /** @internal */\r\n    public _uniformBuffers = new Array<UniformBuffer>();\r\n    /** @internal */\r\n    public _storageBuffers = new Array<StorageBuffer>();\r\n\r\n    /**\r\n     * Gets a boolean indicating that the engine supports uniform buffers\r\n     * @see https://doc.babylonjs.com/setup/support/webGL2#uniform-buffer-objets\r\n     */\r\n    public get supportsUniformBuffers(): boolean {\r\n        return this.webGLVersion > 1 && !this.disableUniformBuffers;\r\n    }\r\n\r\n    // Private Members\r\n\r\n    /** @internal */\r\n    public _gl: WebGL2RenderingContext;\r\n    /** @internal */\r\n    public _webGLVersion = 1.0;\r\n    protected _renderingCanvas: Nullable<HTMLCanvasElement>;\r\n    protected _windowIsBackground = false;\r\n    protected _creationOptions: EngineOptions;\r\n    protected _audioContext: Nullable<AudioContext>;\r\n    protected _audioDestination: Nullable<AudioDestinationNode | MediaStreamAudioDestinationNode>;\r\n    /** @internal */\r\n    public _glSRGBExtensionValues: {\r\n        SRGB: typeof WebGL2RenderingContext.SRGB;\r\n        SRGB8: typeof WebGL2RenderingContext.SRGB8 | EXT_sRGB[\"SRGB_ALPHA_EXT\"];\r\n        SRGB8_ALPHA8: typeof WebGL2RenderingContext.SRGB8_ALPHA8 | EXT_sRGB[\"SRGB_ALPHA_EXT\"];\r\n    };\r\n    /**\r\n     * Gets the options used for engine creation\r\n     * @returns EngineOptions object\r\n     */\r\n    public getCreationOptions() {\r\n        return this._creationOptions;\r\n    }\r\n\r\n    protected _highPrecisionShadersAllowed = true;\r\n    /** @internal */\r\n    public get _shouldUseHighPrecisionShader(): boolean {\r\n        return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating that only power of 2 textures are supported\r\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n     */\r\n    public get needPOTTextures(): boolean {\r\n        return this._webGLVersion < 2 || this.forcePOTTextures;\r\n    }\r\n\r\n    /** @internal */\r\n    public _badOS = false;\r\n\r\n    /** @internal */\r\n    public _badDesktopOS = false;\r\n\r\n    /** @internal */\r\n    public _hardwareScalingLevel: number;\r\n    /** @internal */\r\n    public _caps: EngineCapabilities;\r\n    /** @internal */\r\n    public _features: EngineFeatures;\r\n    protected _isStencilEnable: boolean;\r\n\r\n    private _glVersion: string;\r\n    private _glRenderer: string;\r\n    private _glVendor: string;\r\n\r\n    /** @internal */\r\n    public _videoTextureSupported: boolean;\r\n\r\n    protected _renderingQueueLaunched = false;\r\n    protected _activeRenderLoops = new Array<() => void>();\r\n\r\n    /**\r\n     * Gets the list of current active render loop functions\r\n     * @returns an array with the current render loop functions\r\n     */\r\n    public get activeRenderLoops(): Array<() => void> {\r\n        return this._activeRenderLoops;\r\n    }\r\n\r\n    // Lost context\r\n    /**\r\n     * Observable signaled when a context lost event is raised\r\n     */\r\n    public onContextLostObservable = new Observable<ThinEngine>();\r\n    /**\r\n     * Observable signaled when a context restored event is raised\r\n     */\r\n    public onContextRestoredObservable = new Observable<ThinEngine>();\r\n    private _onContextLost: (evt: Event) => void;\r\n    private _onContextRestored: (evt: Event) => void;\r\n    protected _contextWasLost = false;\r\n\r\n    /** @internal */\r\n    public _doNotHandleContextLost = false;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n     * @see https://doc.babylonjs.com/features/featuresDeepDive/scene/optimize_your_scene#handling-webgl-context-lost\r\n     */\r\n    public get doNotHandleContextLost(): boolean {\r\n        return this._doNotHandleContextLost;\r\n    }\r\n\r\n    public set doNotHandleContextLost(value: boolean) {\r\n        this._doNotHandleContextLost = value;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n     */\r\n    public disableVertexArrayObjects = false;\r\n\r\n    // States\r\n    /** @internal */\r\n    protected _colorWrite = true;\r\n    /** @internal */\r\n    protected _colorWriteChanged = true;\r\n    /** @internal */\r\n    protected _depthCullingState = new DepthCullingState();\r\n    /** @internal */\r\n    protected _stencilStateComposer = new StencilStateComposer();\r\n    /** @internal */\r\n    protected _stencilState = new StencilState();\r\n    /** @internal */\r\n    public _alphaState = new AlphaState();\r\n    /** @internal */\r\n    public _alphaMode = Constants.ALPHA_ADD;\r\n    /** @internal */\r\n    public _alphaEquation = Constants.ALPHA_DISABLE;\r\n\r\n    // Cache\r\n    /** @internal */\r\n    public _internalTexturesCache = new Array<InternalTexture>();\r\n    /** @internal */\r\n    public _renderTargetWrapperCache = new Array<RenderTargetWrapper>();\r\n    /** @internal */\r\n    protected _activeChannel = 0;\r\n    private _currentTextureChannel = -1;\r\n    /** @internal */\r\n    protected _boundTexturesCache: { [key: string]: Nullable<InternalTexture> } = {};\r\n    protected _currentEffect: Nullable<Effect>;\r\n    /** @internal */\r\n    public _currentDrawContext: IDrawContext;\r\n    /** @internal */\r\n    public _currentMaterialContext: IMaterialContext;\r\n    /** @internal */\r\n    protected _currentProgram: Nullable<WebGLProgram>;\r\n    protected _compiledEffects: { [key: string]: Effect } = {};\r\n    private _vertexAttribArraysEnabled: boolean[] = [];\r\n    /** @internal */\r\n    protected _cachedViewport: Nullable<IViewportLike>;\r\n    private _cachedVertexArrayObject: Nullable<WebGLVertexArrayObject>;\r\n    /** @internal */\r\n    protected _cachedVertexBuffers: any;\r\n    /** @internal */\r\n    protected _cachedIndexBuffer: Nullable<DataBuffer>;\r\n    /** @internal */\r\n    protected _cachedEffectForVertexBuffers: Nullable<Effect>;\r\n\r\n    /** @internal */\r\n    public _currentRenderTarget: Nullable<RenderTargetWrapper>;\r\n    private _uintIndicesCurrentlySet = false;\r\n    protected _currentBoundBuffer = new Array<Nullable<DataBuffer>>();\r\n    /** @internal */\r\n    public _currentFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    /** @internal */\r\n    public _dummyFramebuffer: Nullable<WebGLFramebuffer> = null;\r\n    private _currentBufferPointers = new Array<BufferPointer>();\r\n    private _currentInstanceLocations = new Array<number>();\r\n    private _currentInstanceBuffers = new Array<DataBuffer>();\r\n    private _textureUnits: Int32Array;\r\n\r\n    /** @internal */\r\n    public _workingCanvas: Nullable<ICanvas>;\r\n    /** @internal */\r\n    public _workingContext: Nullable<ICanvasRenderingContext>;\r\n\r\n    /** @internal */\r\n    public _boundRenderFunction: any;\r\n\r\n    private _vaoRecordInProgress = false;\r\n    private _mustWipeVertexAttributes = false;\r\n\r\n    private _emptyTexture: Nullable<InternalTexture>;\r\n    private _emptyCubeTexture: Nullable<InternalTexture>;\r\n    private _emptyTexture3D: Nullable<InternalTexture>;\r\n    private _emptyTexture2DArray: Nullable<InternalTexture>;\r\n\r\n    /** @internal */\r\n    public _frameHandler: number;\r\n\r\n    private _nextFreeTextureSlots = new Array<number>();\r\n    private _maxSimultaneousTextures = 0;\r\n    private _maxMSAASamplesOverride: Nullable<number> = null;\r\n\r\n    private _activeRequests = new Array<IFileRequest>();\r\n\r\n    /**\r\n     * If set to true zooming in and out in the browser will rescale the hardware-scaling correctly.\r\n     */\r\n    public adaptToDeviceRatio: boolean = false;\r\n    /** @internal */\r\n    protected _lastDevicePixelRatio: number = 1.0;\r\n\r\n    /** @internal */\r\n    public _transformTextureUrl: Nullable<(url: string) => string> = null;\r\n\r\n    /**\r\n     * Gets information about the current host\r\n     */\r\n    public hostInformation: HostInformation = {\r\n        isMobile: false,\r\n    };\r\n\r\n    protected get _supportsHardwareTextureRescaling() {\r\n        return false;\r\n    }\r\n\r\n    private _framebufferDimensionsObject: Nullable<{ framebufferWidth: number; framebufferHeight: number }>;\r\n\r\n    /**\r\n     * sets the object from which width and height will be taken from when getting render width and height\r\n     * Will fallback to the gl object\r\n     * @param dimensions the framebuffer width and height that will be used.\r\n     */\r\n    public set framebufferDimensionsObject(dimensions: Nullable<{ framebufferWidth: number; framebufferHeight: number }>) {\r\n        this._framebufferDimensionsObject = dimensions;\r\n    }\r\n\r\n    /**\r\n     * Gets the current viewport\r\n     */\r\n    public get currentViewport(): Nullable<IViewportLike> {\r\n        return this._cachedViewport;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty texture\r\n     */\r\n    public get emptyTexture(): InternalTexture {\r\n        if (!this._emptyTexture) {\r\n            this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, Constants.TEXTUREFORMAT_RGBA, false, false, Constants.TEXTURE_NEAREST_SAMPLINGMODE);\r\n        }\r\n\r\n        return this._emptyTexture;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 3D texture\r\n     */\r\n    public get emptyTexture3D(): InternalTexture {\r\n        if (!this._emptyTexture3D) {\r\n            this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, Constants.TEXTUREFORMAT_RGBA, false, false, Constants.TEXTURE_NEAREST_SAMPLINGMODE);\r\n        }\r\n\r\n        return this._emptyTexture3D;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty 2D array texture\r\n     */\r\n    public get emptyTexture2DArray(): InternalTexture {\r\n        if (!this._emptyTexture2DArray) {\r\n            this._emptyTexture2DArray = this.createRawTexture2DArray(\r\n                new Uint8Array(4),\r\n                1,\r\n                1,\r\n                1,\r\n                Constants.TEXTUREFORMAT_RGBA,\r\n                false,\r\n                false,\r\n                Constants.TEXTURE_NEAREST_SAMPLINGMODE\r\n            );\r\n        }\r\n\r\n        return this._emptyTexture2DArray;\r\n    }\r\n\r\n    /**\r\n     * Gets the default empty cube texture\r\n     */\r\n    public get emptyCubeTexture(): InternalTexture {\r\n        if (!this._emptyCubeTexture) {\r\n            const faceData = new Uint8Array(4);\r\n            const cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\r\n            this._emptyCubeTexture = this.createRawCubeTexture(\r\n                cubeData,\r\n                1,\r\n                Constants.TEXTUREFORMAT_RGBA,\r\n                Constants.TEXTURETYPE_UNSIGNED_INT,\r\n                false,\r\n                false,\r\n                Constants.TEXTURE_NEAREST_SAMPLINGMODE\r\n            );\r\n        }\r\n\r\n        return this._emptyCubeTexture;\r\n    }\r\n\r\n    /**\r\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n     */\r\n    public premultipliedAlpha: boolean = true;\r\n\r\n    /**\r\n     * Observable event triggered before each texture is initialized\r\n     */\r\n    public onBeforeTextureInitObservable = new Observable<Texture>();\r\n\r\n    /** @internal */\r\n    protected _isWebGPU: boolean = false;\r\n    /**\r\n     * Gets a boolean indicating if the engine runs in WebGPU or not.\r\n     */\r\n    public get isWebGPU(): boolean {\r\n        return this._isWebGPU;\r\n    }\r\n\r\n    /** @internal */\r\n    protected _shaderPlatformName: string;\r\n    /**\r\n     * Gets the shader platform name used by the effects.\r\n     */\r\n    public get shaderPlatformName(): string {\r\n        return this._shaderPlatformName;\r\n    }\r\n\r\n    /**\r\n     * Enables or disables the snapshot rendering mode\r\n     * Note that the WebGL engine does not support snapshot rendering so setting the value won't have any effect for this engine\r\n     */\r\n    public get snapshotRendering(): boolean {\r\n        return false;\r\n    }\r\n\r\n    public set snapshotRendering(activate) {\r\n        // WebGL engine does not support snapshot rendering\r\n    }\r\n\r\n    protected _snapshotRenderingMode = Constants.SNAPSHOTRENDERING_STANDARD;\r\n    /**\r\n     * Gets or sets the snapshot rendering mode\r\n     */\r\n    public get snapshotRenderingMode(): number {\r\n        return this._snapshotRenderingMode;\r\n    }\r\n\r\n    public set snapshotRenderingMode(mode: number) {\r\n        this._snapshotRenderingMode = mode;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the exact sRGB conversions or faster approximations are used for converting to and from linear space.\r\n     */\r\n    public readonly useExactSrgbConversions: boolean;\r\n\r\n    /**\r\n     * Creates a new snapshot at the next frame using the current snapshotRenderingMode\r\n     */\r\n    public snapshotRenderingReset(): void {\r\n        this.snapshotRendering = false;\r\n    }\r\n\r\n    private _checkForMobile: () => void;\r\n\r\n    private static _CreateCanvas(width: number, height: number): ICanvas {\r\n        if (typeof document === \"undefined\") {\r\n            return <ICanvas>(<any>new OffscreenCanvas(width, height));\r\n        }\r\n        const canvas = <ICanvas>(<any>document.createElement(\"canvas\"));\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        return canvas;\r\n    }\r\n\r\n    /**\r\n     * Create a canvas. This method is overridden by other engines\r\n     * @param width width\r\n     * @param height height\r\n     * @returns ICanvas interface\r\n     */\r\n    public createCanvas(width: number, height: number): ICanvas {\r\n        return ThinEngine._CreateCanvas(width, height);\r\n    }\r\n\r\n    /**\r\n     * Create an image to use with canvas\r\n     * @returns IImage interface\r\n     */\r\n    public createCanvasImage(): IImage {\r\n        return document.createElement(\"img\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new engine\r\n     * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which already used the WebGL context\r\n     * @param antialias defines enable antialiasing (default: false)\r\n     * @param options defines further options to be sent to the getContext() function\r\n     * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    constructor(\r\n        canvasOrContext: Nullable<HTMLCanvasElement | OffscreenCanvas | WebGLRenderingContext | WebGL2RenderingContext>,\r\n        antialias?: boolean,\r\n        options?: EngineOptions,\r\n        adaptToDeviceRatio?: boolean\r\n    ) {\r\n        this.startTime = PrecisionDate.Now;\r\n\r\n        let canvas: Nullable<HTMLCanvasElement> = null;\r\n\r\n        options = options || {};\r\n\r\n        this._creationOptions = options;\r\n\r\n        // Save this off for use in resize().\r\n        this.adaptToDeviceRatio = adaptToDeviceRatio ?? false;\r\n\r\n        this._stencilStateComposer.stencilGlobal = this._stencilState;\r\n\r\n        PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\r\n\r\n        options.antialias = antialias ?? options.antialias;\r\n        options.deterministicLockstep = options.deterministicLockstep ?? false;\r\n        options.lockstepMaxSteps = options.lockstepMaxSteps ?? 4;\r\n        options.timeStep = options.timeStep ?? 1 / 60;\r\n        options.audioEngine = options.audioEngine ?? true;\r\n        options.stencil = options.stencil ?? true;\r\n\r\n        this._audioContext = options.audioEngineOptions?.audioContext ?? null;\r\n        this._audioDestination = options.audioEngineOptions?.audioDestination ?? null;\r\n        this.premultipliedAlpha = options.premultipliedAlpha ?? true;\r\n        this.useExactSrgbConversions = options.useExactSrgbConversions ?? false;\r\n        this._doNotHandleContextLost = !!options.doNotHandleContextLost;\r\n        this._isStencilEnable = options.stencil ? true : false;\r\n\r\n        // Viewport\r\n        adaptToDeviceRatio = adaptToDeviceRatio || options.adaptToDeviceRatio || false;\r\n\r\n        const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\r\n\r\n        const limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\r\n        this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\r\n        this._lastDevicePixelRatio = devicePixelRatio;\r\n\r\n        if (!canvasOrContext) {\r\n            return;\r\n        }\r\n\r\n        if ((canvasOrContext as any).getContext) {\r\n            canvas = <HTMLCanvasElement>canvasOrContext;\r\n            this._renderingCanvas = canvas;\r\n\r\n            if (options.preserveDrawingBuffer === undefined) {\r\n                options.preserveDrawingBuffer = false;\r\n            }\r\n\r\n            if (options.xrCompatible === undefined) {\r\n                options.xrCompatible = true;\r\n            }\r\n\r\n            // Exceptions\r\n            if (navigator && navigator.userAgent) {\r\n                this._setupMobileChecks();\r\n\r\n                const ua = navigator.userAgent;\r\n                for (const exception of ThinEngine.ExceptionList) {\r\n                    const key = exception.key;\r\n                    const targets = exception.targets;\r\n                    const check = new RegExp(key);\r\n\r\n                    if (check.test(ua)) {\r\n                        if (exception.capture && exception.captureConstraint) {\r\n                            const capture = exception.capture;\r\n                            const constraint = exception.captureConstraint;\r\n\r\n                            const regex = new RegExp(capture);\r\n                            const matches = regex.exec(ua);\r\n\r\n                            if (matches && matches.length > 0) {\r\n                                const capturedValue = parseInt(matches[matches.length - 1]);\r\n                                if (capturedValue >= constraint) {\r\n                                    continue;\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        for (const target of targets) {\r\n                            switch (target) {\r\n                                case \"uniformBuffer\":\r\n                                    this.disableUniformBuffers = true;\r\n                                    break;\r\n                                case \"vao\":\r\n                                    this.disableVertexArrayObjects = true;\r\n                                    break;\r\n                                case \"antialias\":\r\n                                    options.antialias = false;\r\n                                    break;\r\n                                case \"maxMSAASamples\":\r\n                                    this._maxMSAASamplesOverride = 1;\r\n                                    break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Context lost\r\n            if (!this._doNotHandleContextLost) {\r\n                this._onContextLost = (evt: Event) => {\r\n                    evt.preventDefault();\r\n                    this._contextWasLost = true;\r\n                    Logger.Warn(\"WebGL context lost.\");\r\n\r\n                    this.onContextLostObservable.notifyObservers(this);\r\n                };\r\n\r\n                this._onContextRestored = () => {\r\n                    this._restoreEngineAfterContextLost(() => this._initGLContext());\r\n                };\r\n\r\n                canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\r\n                canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\r\n\r\n                options.powerPreference = options.powerPreference || \"high-performance\";\r\n            }\r\n\r\n            // Detect if we are running on a faulty buggy desktop OS.\r\n            this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\r\n            if (this._badDesktopOS) {\r\n                options.xrCompatible = false;\r\n            }\r\n\r\n            // GL\r\n            if (!options.disableWebGL2Support) {\r\n                try {\r\n                    this._gl = <any>(canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options));\r\n                    if (this._gl) {\r\n                        this._webGLVersion = 2.0;\r\n                        this._shaderPlatformName = \"WEBGL2\";\r\n\r\n                        // Prevent weird browsers to lie (yeah that happens!)\r\n                        if (!this._gl.deleteQuery) {\r\n                            this._webGLVersion = 1.0;\r\n                            this._shaderPlatformName = \"WEBGL1\";\r\n                        }\r\n                    }\r\n                } catch (e) {\r\n                    // Do nothing\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                if (!canvas) {\r\n                    throw new Error(\"The provided canvas is null or undefined.\");\r\n                }\r\n                try {\r\n                    this._gl = <WebGL2RenderingContext>(canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options));\r\n                } catch (e) {\r\n                    throw new Error(\"WebGL not supported\");\r\n                }\r\n            }\r\n\r\n            if (!this._gl) {\r\n                throw new Error(\"WebGL not supported\");\r\n            }\r\n        } else {\r\n            this._gl = <WebGL2RenderingContext>canvasOrContext;\r\n            this._renderingCanvas = this._gl.canvas as HTMLCanvasElement;\r\n\r\n            if ((this._gl as any).renderbufferStorageMultisample) {\r\n                this._webGLVersion = 2.0;\r\n                this._shaderPlatformName = \"WEBGL2\";\r\n            } else {\r\n                this._shaderPlatformName = \"WEBGL1\";\r\n            }\r\n\r\n            const attributes = this._gl.getContextAttributes();\r\n            if (attributes) {\r\n                options.stencil = attributes.stencil;\r\n            }\r\n        }\r\n\r\n        // Ensures a consistent color space unpacking of textures cross browser.\r\n        this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n\r\n        if (options.useHighPrecisionFloats !== undefined) {\r\n            this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\r\n        }\r\n\r\n        this.resize();\r\n\r\n        this._initGLContext();\r\n        this._initFeatures();\r\n\r\n        // Prepare buffer pointers\r\n        for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n            this._currentBufferPointers[i] = new BufferPointer();\r\n        }\r\n\r\n        // Shader processor\r\n        this._shaderProcessor = this.webGLVersion > 1 ? new WebGL2ShaderProcessor() : new WebGLShaderProcessor();\r\n\r\n        // Detect if we are running on a faulty buggy OS.\r\n        this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent);\r\n\r\n        // Starting with iOS 14, we can trust the browser\r\n        // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\r\n\r\n        // if (matches && matches.length === 2) {\r\n        //     if (parseInt(matches[1]) >= 14) {\r\n        //         this._badOS = false;\r\n        //     }\r\n        // }\r\n\r\n        const versionToLog = `Babylon.js v${ThinEngine.Version}`;\r\n        console.log(versionToLog + ` - ${this.description}`);\r\n\r\n        // Check setAttribute in case of workers\r\n        if (this._renderingCanvas && this._renderingCanvas.setAttribute) {\r\n            this._renderingCanvas.setAttribute(\"data-engine\", versionToLog);\r\n        }\r\n    }\r\n\r\n    protected _setupMobileChecks(): void {\r\n        if (!(navigator && navigator.userAgent)) {\r\n            return;\r\n        }\r\n\r\n        // Function to check if running on mobile device\r\n        this._checkForMobile = () => {\r\n            const currentUA = navigator.userAgent;\r\n            this.hostInformation.isMobile =\r\n                currentUA.indexOf(\"Mobile\") !== -1 ||\r\n                // Needed for iOS 13+ detection on iPad (inspired by solution from https://stackoverflow.com/questions/9038625/detect-if-device-is-ios)\r\n                (currentUA.indexOf(\"Mac\") !== -1 && IsDocumentAvailable() && \"ontouchend\" in document);\r\n        };\r\n\r\n        // Set initial isMobile value\r\n        this._checkForMobile();\r\n\r\n        // Set up event listener to check when window is resized (used to get emulator activation to work properly)\r\n        if (IsWindowObjectExist()) {\r\n            window.addEventListener(\"resize\", this._checkForMobile);\r\n        }\r\n    }\r\n\r\n    protected _restoreEngineAfterContextLost(initEngine: () => void): void {\r\n        // Adding a timeout to avoid race condition at browser level\r\n        setTimeout(async () => {\r\n            this._dummyFramebuffer = null;\r\n\r\n            const depthTest = this._depthCullingState.depthTest; // backup those values because the call to initEngine / wipeCaches will reset them\r\n            const depthFunc = this._depthCullingState.depthFunc;\r\n            const depthMask = this._depthCullingState.depthMask;\r\n            const stencilTest = this._stencilState.stencilTest;\r\n\r\n            // Rebuild context\r\n            await initEngine();\r\n\r\n            // Ensure webgl and engine states are matching\r\n            this.wipeCaches(true);\r\n\r\n            // Rebuild effects\r\n            this._rebuildEffects();\r\n            this._rebuildComputeEffects?.();\r\n\r\n            // Note:\r\n            //  The call to _rebuildBuffers must be made before the call to _rebuildInternalTextures because in the process of _rebuildBuffers the buffers used by the post process managers will be rebuilt\r\n            //  and we may need to use the post process manager of the scene during _rebuildInternalTextures (in WebGL1, non-POT textures are rescaled using a post process + post process manager of the scene)\r\n\r\n            // Rebuild buffers\r\n            this._rebuildBuffers();\r\n            // Rebuild textures\r\n            this._rebuildInternalTextures();\r\n            // Rebuild textures\r\n            this._rebuildRenderTargetWrappers();\r\n\r\n            // Reset engine states after all the buffer/textures/... have been rebuilt\r\n            this.wipeCaches(true);\r\n\r\n            this._depthCullingState.depthTest = depthTest;\r\n            this._depthCullingState.depthFunc = depthFunc;\r\n            this._depthCullingState.depthMask = depthMask;\r\n            this._stencilState.stencilTest = stencilTest;\r\n\r\n            Logger.Warn(this.name + \" context successfully restored.\");\r\n            this.onContextRestoredObservable.notifyObservers(this);\r\n            this._contextWasLost = false;\r\n        }, 0);\r\n    }\r\n\r\n    /**\r\n     * Shared initialization across engines types.\r\n     * @param canvas The canvas associated with this instance of the engine.\r\n     */\r\n    protected _sharedInit(canvas: HTMLCanvasElement) {\r\n        this._renderingCanvas = canvas;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getShaderProcessingContext(shaderLanguage: ShaderLanguage): Nullable<ShaderProcessingContext> {\r\n        return null;\r\n    }\r\n\r\n    private _rebuildInternalTextures(): void {\r\n        const currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\r\n\r\n        for (const internalTexture of currentState) {\r\n            internalTexture._rebuild();\r\n        }\r\n    }\r\n\r\n    private _rebuildRenderTargetWrappers(): void {\r\n        const currentState = this._renderTargetWrapperCache.slice(); // Do a copy because the rebuild will add proxies\r\n\r\n        for (const renderTargetWrapper of currentState) {\r\n            renderTargetWrapper._rebuild();\r\n        }\r\n    }\r\n\r\n    private _rebuildEffects(): void {\r\n        for (const key in this._compiledEffects) {\r\n            const effect = <Effect>this._compiledEffects[key];\r\n\r\n            effect._pipelineContext = null; // because _prepareEffect will try to dispose this pipeline before recreating it and that would lead to webgl errors\r\n            effect._wasPreviouslyReady = false;\r\n            effect._prepareEffect();\r\n        }\r\n\r\n        Effect.ResetCache();\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if all created effects are ready\r\n     * @returns true if all effects are ready\r\n     */\r\n    public areAllEffectsReady(): boolean {\r\n        for (const key in this._compiledEffects) {\r\n            const effect = <Effect>this._compiledEffects[key];\r\n\r\n            if (!effect.isReady()) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    protected _rebuildBuffers(): void {\r\n        // Uniforms\r\n        for (const uniformBuffer of this._uniformBuffers) {\r\n            uniformBuffer._rebuild();\r\n        }\r\n        // Storage buffers\r\n        for (const storageBuffer of this._storageBuffers) {\r\n            storageBuffer._rebuild();\r\n        }\r\n    }\r\n\r\n    protected _initGLContext(): void {\r\n        // Caps\r\n        this._caps = {\r\n            maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\r\n            maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\r\n            maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\r\n            maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\r\n            maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\r\n            maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\r\n            maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\r\n            maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\r\n            maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\r\n            maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\r\n            maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\r\n            parallelShaderCompile: this._gl.getExtension(\"KHR_parallel_shader_compile\") || undefined,\r\n            standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension(\"OES_standard_derivatives\") !== null,\r\n            maxAnisotropy: 1,\r\n            astc: this._gl.getExtension(\"WEBGL_compressed_texture_astc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_astc\"),\r\n            bptc: this._gl.getExtension(\"EXT_texture_compression_bptc\") || this._gl.getExtension(\"WEBKIT_EXT_texture_compression_bptc\"),\r\n            s3tc: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc\"),\r\n            // eslint-disable-next-line @typescript-eslint/naming-convention\r\n            s3tc_srgb: this._gl.getExtension(\"WEBGL_compressed_texture_s3tc_srgb\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_s3tc_srgb\"),\r\n            pvrtc: this._gl.getExtension(\"WEBGL_compressed_texture_pvrtc\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_pvrtc\"),\r\n            etc1: this._gl.getExtension(\"WEBGL_compressed_texture_etc1\") || this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc1\"),\r\n            etc2:\r\n                this._gl.getExtension(\"WEBGL_compressed_texture_etc\") ||\r\n                this._gl.getExtension(\"WEBKIT_WEBGL_compressed_texture_etc\") ||\r\n                this._gl.getExtension(\"WEBGL_compressed_texture_es3_0\"), // also a requirement of OpenGL ES 3\r\n            textureAnisotropicFilterExtension:\r\n                this._gl.getExtension(\"EXT_texture_filter_anisotropic\") ||\r\n                this._gl.getExtension(\"WEBKIT_EXT_texture_filter_anisotropic\") ||\r\n                this._gl.getExtension(\"MOZ_EXT_texture_filter_anisotropic\"),\r\n            uintIndices: this._webGLVersion > 1 || this._gl.getExtension(\"OES_element_index_uint\") !== null,\r\n            fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_frag_depth\") !== null,\r\n            highPrecisionShaderSupported: false,\r\n            timerQuery: this._gl.getExtension(\"EXT_disjoint_timer_query_webgl2\") || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\r\n            supportOcclusionQuery: this._webGLVersion > 1,\r\n            canUseTimestampForTimerQuery: false,\r\n            drawBuffersExtension: false,\r\n            maxMSAASamples: 1,\r\n            colorBufferFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_float\")),\r\n            colorBufferHalfFloat: !!(this._webGLVersion > 1 && this._gl.getExtension(\"EXT_color_buffer_half_float\")),\r\n            textureFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_float\") ? true : false,\r\n            textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension(\"OES_texture_half_float\") ? true : false,\r\n            textureHalfFloatRender: false,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            vertexArrayObject: false,\r\n            instancedArrays: false,\r\n            textureLOD: this._webGLVersion > 1 || this._gl.getExtension(\"EXT_shader_texture_lod\") ? true : false,\r\n            texelFetch: this._webGLVersion !== 1,\r\n            blendMinMax: false,\r\n            multiview: this._gl.getExtension(\"OVR_multiview2\"),\r\n            oculusMultiview: this._gl.getExtension(\"OCULUS_multiview\"),\r\n            depthTextureExtension: false,\r\n            canUseGLInstanceID: this._webGLVersion > 1,\r\n            canUseGLVertexID: this._webGLVersion > 1,\r\n            supportComputeShaders: false,\r\n            supportSRGBBuffers: false,\r\n            supportTransformFeedbacks: this._webGLVersion > 1,\r\n            textureMaxLevel: this._webGLVersion > 1,\r\n            texture2DArrayMaxLayerCount: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS) : 128,\r\n            disableMorphTargetTexture: false,\r\n        };\r\n\r\n        // Infos\r\n        this._glVersion = this._gl.getParameter(this._gl.VERSION);\r\n\r\n        const rendererInfo: any = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\r\n        if (rendererInfo != null) {\r\n            this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\r\n            this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\r\n        }\r\n\r\n        if (!this._glVendor) {\r\n            this._glVendor = this._gl.getParameter(this._gl.VENDOR) || \"Unknown vendor\";\r\n        }\r\n\r\n        if (!this._glRenderer) {\r\n            this._glRenderer = this._gl.getParameter(this._gl.RENDERER) || \"Unknown renderer\";\r\n        }\r\n\r\n        // Constants\r\n        if (this._gl.HALF_FLOAT_OES !== 0x8d61) {\r\n            this._gl.HALF_FLOAT_OES = 0x8d61; // Half floating-point type (16-bit).\r\n        }\r\n        if (this._gl.RGBA16F !== 0x881a) {\r\n            this._gl.RGBA16F = 0x881a; // RGBA 16-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.RGBA32F !== 0x8814) {\r\n            this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.DEPTH24_STENCIL8 !== 35056) {\r\n            this._gl.DEPTH24_STENCIL8 = 35056;\r\n        }\r\n\r\n        // Extensions\r\n        if (this._caps.timerQuery) {\r\n            if (this._webGLVersion === 1) {\r\n                this._gl.getQuery = (<any>this._caps.timerQuery).getQueryEXT.bind(this._caps.timerQuery);\r\n            }\r\n            // WebGLQuery casted to number to avoid TS error\r\n            this._caps.canUseTimestampForTimerQuery = ((this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) as number) ?? 0) > 0;\r\n        }\r\n\r\n        this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension\r\n            ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT)\r\n            : 0;\r\n        this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension(\"OES_texture_float_linear\") ? true : false;\r\n        this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\r\n        this._caps.textureHalfFloatLinearFiltering =\r\n            this._webGLVersion > 1 || (this._caps.textureHalfFloat && this._gl.getExtension(\"OES_texture_half_float_linear\")) ? true : false;\r\n\r\n        // Compressed formats\r\n        if (this._caps.astc) {\r\n            this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR = this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\r\n        }\r\n        if (this._caps.bptc) {\r\n            this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT = this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\r\n        }\r\n        if (this._caps.s3tc_srgb) {\r\n            this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT;\r\n            this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\r\n            this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT = this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\r\n        }\r\n        if (this._caps.etc2) {\r\n            this._gl.COMPRESSED_SRGB8_ETC2 = this._caps.etc2.COMPRESSED_SRGB8_ETC2;\r\n            this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC = this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;\r\n        }\r\n\r\n        // Checks if some of the format renders first to allow the use of webgl inspector.\r\n        if (this._webGLVersion > 1) {\r\n            if (this._gl.HALF_FLOAT_OES !== 0x140b) {\r\n                this._gl.HALF_FLOAT_OES = 0x140b;\r\n            }\r\n        }\r\n        this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer();\r\n        // Draw buffers\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.drawBuffersExtension = true;\r\n            this._caps.maxMSAASamples = this._maxMSAASamplesOverride !== null ? this._maxMSAASamplesOverride : this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n        } else {\r\n            const drawBuffersExtension = this._gl.getExtension(\"WEBGL_draw_buffers\");\r\n\r\n            if (drawBuffersExtension !== null) {\r\n                this._caps.drawBuffersExtension = true;\r\n                this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\r\n                (this._gl.DRAW_FRAMEBUFFER as any) = this._gl.FRAMEBUFFER;\r\n\r\n                for (let i = 0; i < 16; i++) {\r\n                    (<any>this._gl)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = (<any>drawBuffersExtension)[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\r\n                }\r\n            }\r\n        }\r\n\r\n        // Depth Texture\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.depthTextureExtension = true;\r\n        } else {\r\n            const depthTextureExtension = this._gl.getExtension(\"WEBGL_depth_texture\");\r\n\r\n            if (depthTextureExtension != null) {\r\n                this._caps.depthTextureExtension = true;\r\n                this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\r\n            }\r\n        }\r\n\r\n        // Vertex array object\r\n        if (this.disableVertexArrayObjects) {\r\n            this._caps.vertexArrayObject = false;\r\n        } else if (this._webGLVersion > 1) {\r\n            this._caps.vertexArrayObject = true;\r\n        } else {\r\n            const vertexArrayObjectExtension = this._gl.getExtension(\"OES_vertex_array_object\");\r\n\r\n            if (vertexArrayObjectExtension != null) {\r\n                this._caps.vertexArrayObject = true;\r\n                this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\r\n            }\r\n        }\r\n\r\n        // Instances count\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.instancedArrays = true;\r\n        } else {\r\n            const instanceExtension = <ANGLE_instanced_arrays>this._gl.getExtension(\"ANGLE_instanced_arrays\");\r\n\r\n            if (instanceExtension != null) {\r\n                this._caps.instancedArrays = true;\r\n                this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\r\n                this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\r\n                this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\r\n            } else {\r\n                this._caps.instancedArrays = false;\r\n            }\r\n        }\r\n\r\n        if (this._gl.getShaderPrecisionFormat) {\r\n            const vertexhighp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\r\n            const fragmenthighp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\r\n\r\n            if (vertexhighp && fragmenthighp) {\r\n                this._caps.highPrecisionShaderSupported = vertexhighp.precision !== 0 && fragmenthighp.precision !== 0;\r\n            }\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.blendMinMax = true;\r\n        } else {\r\n            const blendMinMaxExtension = this._gl.getExtension(\"EXT_blend_minmax\");\r\n            if (blendMinMaxExtension != null) {\r\n                this._caps.blendMinMax = true;\r\n                this._gl.MAX = blendMinMaxExtension.MAX_EXT as typeof WebGL2RenderingContext.MAX;\r\n                this._gl.MIN = blendMinMaxExtension.MIN_EXT as typeof WebGL2RenderingContext.MIN;\r\n            }\r\n        }\r\n\r\n        // sRGB buffers\r\n        // only run this if not already set to true (in the constructor, for example)\r\n        if (!this._caps.supportSRGBBuffers) {\r\n            if (this._webGLVersion > 1) {\r\n                this._caps.supportSRGBBuffers = true;\r\n                this._glSRGBExtensionValues = {\r\n                    SRGB: WebGL2RenderingContext.SRGB,\r\n                    SRGB8: WebGL2RenderingContext.SRGB8,\r\n                    SRGB8_ALPHA8: WebGL2RenderingContext.SRGB8_ALPHA8,\r\n                };\r\n            } else {\r\n                const sRGBExtension = this._gl.getExtension(\"EXT_sRGB\");\r\n\r\n                if (sRGBExtension != null) {\r\n                    this._caps.supportSRGBBuffers = true;\r\n                    this._glSRGBExtensionValues = {\r\n                        SRGB: sRGBExtension.SRGB_EXT as typeof WebGL2RenderingContext.SRGB | EXT_sRGB[\"SRGB_EXT\"],\r\n                        SRGB8: sRGBExtension.SRGB_ALPHA_EXT as typeof WebGL2RenderingContext.SRGB8 | EXT_sRGB[\"SRGB_ALPHA_EXT\"],\r\n                        SRGB8_ALPHA8: sRGBExtension.SRGB_ALPHA_EXT as typeof WebGL2RenderingContext.SRGB8_ALPHA8 | EXT_sRGB[\"SRGB8_ALPHA8_EXT\"],\r\n                    };\r\n                }\r\n            }\r\n            // take into account the forced state that was provided in options\r\n            // When the issue in angle/chrome is fixed the flag should be taken into account only when it is explicitly defined\r\n            this._caps.supportSRGBBuffers = this._caps.supportSRGBBuffers && !!(this._creationOptions && this._creationOptions.forceSRGBBufferSupportState);\r\n        }\r\n\r\n        // Depth buffer\r\n        this._depthCullingState.depthTest = true;\r\n        this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n        this._depthCullingState.depthMask = true;\r\n\r\n        // Texture maps\r\n        this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\r\n        for (let slot = 0; slot < this._maxSimultaneousTextures; slot++) {\r\n            this._nextFreeTextureSlots.push(slot);\r\n        }\r\n\r\n        if (this._glRenderer === \"Mali-G72\") {\r\n            // Overcome a bug when using a texture to store morph targets on Mali-G72\r\n            this._caps.disableMorphTargetTexture = true;\r\n        }\r\n    }\r\n\r\n    protected _initFeatures(): void {\r\n        this._features = {\r\n            forceBitmapOverHTMLImageElement: false,\r\n            supportRenderAndCopyToLodForFloatTextures: this._webGLVersion !== 1,\r\n            supportDepthStencilTexture: this._webGLVersion !== 1,\r\n            supportShadowSamplers: this._webGLVersion !== 1,\r\n            uniformBufferHardCheckMatrix: false,\r\n            allowTexturePrefiltering: this._webGLVersion !== 1,\r\n            trackUbosInFrame: false,\r\n            checkUbosContentBeforeUpload: false,\r\n            supportCSM: this._webGLVersion !== 1,\r\n            basisNeedsPOT: this._webGLVersion === 1,\r\n            support3DTextures: this._webGLVersion !== 1,\r\n            needTypeSuffixInShaderConstants: this._webGLVersion !== 1,\r\n            supportMSAA: this._webGLVersion !== 1,\r\n            supportSSAO2: this._webGLVersion !== 1,\r\n            supportExtendedTextureFormats: this._webGLVersion !== 1,\r\n            supportSwitchCaseInShader: this._webGLVersion !== 1,\r\n            supportSyncTextureRead: true,\r\n            needsInvertingBitmap: true,\r\n            useUBOBindingCache: true,\r\n            needShaderCodeInlining: false,\r\n            needToAlwaysBindUniformBuffers: false,\r\n            supportRenderPasses: false,\r\n            supportSpriteInstancing: true,\r\n            forceVertexBufferStrideMultiple4Bytes: false,\r\n            _collectUbosUpdatedInFrame: false,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Gets version of the current webGL context\r\n     * Keep it for back compat - use version instead\r\n     */\r\n    public get webGLVersion(): number {\r\n        return this._webGLVersion;\r\n    }\r\n\r\n    /**\r\n     * Gets a string identifying the name of the class\r\n     * @returns \"Engine\" string\r\n     */\r\n    public getClassName(): string {\r\n        return \"ThinEngine\";\r\n    }\r\n\r\n    /**\r\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n     */\r\n    public get isStencilEnable(): boolean {\r\n        return this._isStencilEnable;\r\n    }\r\n\r\n    /** @internal */\r\n    public _prepareWorkingCanvas(): void {\r\n        if (this._workingCanvas) {\r\n            return;\r\n        }\r\n\r\n        this._workingCanvas = this.createCanvas(1, 1);\r\n        const context = this._workingCanvas.getContext(\"2d\");\r\n\r\n        if (context) {\r\n            this._workingContext = context;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset the texture cache to empty state\r\n     */\r\n    public resetTextureCache() {\r\n        for (const key in this._boundTexturesCache) {\r\n            if (!Object.prototype.hasOwnProperty.call(this._boundTexturesCache, key)) {\r\n                continue;\r\n            }\r\n            this._boundTexturesCache[key] = null;\r\n        }\r\n\r\n        this._currentTextureChannel = -1;\r\n    }\r\n\r\n    /**\r\n     * Gets an object containing information about the current engine context\r\n     * @returns an object containing the vendor, the renderer and the version of the current engine context\r\n     */\r\n    public getInfo() {\r\n        return this.getGlInfo();\r\n    }\r\n\r\n    /**\r\n     * Gets an object containing information about the current webGL context\r\n     * @returns an object containing the vendor, the renderer and the version of the current webGL context\r\n     */\r\n    public getGlInfo() {\r\n        return {\r\n            vendor: this._glVendor,\r\n            renderer: this._glRenderer,\r\n            version: this._glVersion,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Defines the hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @param level defines the level to use\r\n     */\r\n    public setHardwareScalingLevel(level: number): void {\r\n        this._hardwareScalingLevel = level;\r\n        this.resize();\r\n    }\r\n\r\n    /**\r\n     * Gets the current hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @returns a number indicating the current hardware scaling level\r\n     */\r\n    public getHardwareScalingLevel(): number {\r\n        return this._hardwareScalingLevel;\r\n    }\r\n\r\n    /**\r\n     * Gets the list of loaded textures\r\n     * @returns an array containing all loaded textures\r\n     */\r\n    public getLoadedTexturesCache(): InternalTexture[] {\r\n        return this._internalTexturesCache;\r\n    }\r\n\r\n    /**\r\n     * Gets the object containing all engine capabilities\r\n     * @returns the EngineCapabilities object\r\n     */\r\n    public getCaps(): EngineCapabilities {\r\n        return this._caps;\r\n    }\r\n\r\n    /**\r\n     * stop executing a render loop function and remove it from the execution array\r\n     * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n     */\r\n    public stopRenderLoop(renderFunction?: () => void): void {\r\n        if (!renderFunction) {\r\n            this._activeRenderLoops.length = 0;\r\n            this._cancelFrame();\r\n            return;\r\n        }\r\n\r\n        const index = this._activeRenderLoops.indexOf(renderFunction);\r\n\r\n        if (index >= 0) {\r\n            this._activeRenderLoops.splice(index, 1);\r\n            if (this._activeRenderLoops.length == 0) {\r\n                this._cancelFrame();\r\n            }\r\n        }\r\n    }\r\n\r\n    protected _cancelFrame() {\r\n        if (this._renderingQueueLaunched && this._frameHandler) {\r\n            this._renderingQueueLaunched = false;\r\n            if (!IsWindowObjectExist()) {\r\n                if (typeof cancelAnimationFrame === \"function\") {\r\n                    return cancelAnimationFrame(this._frameHandler);\r\n                }\r\n            } else {\r\n                const { cancelAnimationFrame } = this.getHostWindow() || window;\r\n                if (typeof cancelAnimationFrame === \"function\") {\r\n                    return cancelAnimationFrame(this._frameHandler);\r\n                }\r\n            }\r\n            return clearTimeout(this._frameHandler);\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    public _renderLoop(): void {\r\n        if (!this._contextWasLost) {\r\n            let shouldRender = true;\r\n            if (this._isDisposed || (!this.renderEvenInBackground && this._windowIsBackground)) {\r\n                shouldRender = false;\r\n            }\r\n\r\n            if (shouldRender) {\r\n                // Start new frame\r\n                this.beginFrame();\r\n\r\n                for (let index = 0; index < this._activeRenderLoops.length; index++) {\r\n                    const renderFunction = this._activeRenderLoops[index];\r\n\r\n                    renderFunction();\r\n                }\r\n\r\n                // Present\r\n                this.endFrame();\r\n            }\r\n        }\r\n\r\n        if (this._activeRenderLoops.length > 0) {\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        } else {\r\n            this._renderingQueueLaunched = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the HTML canvas attached with the current webGL context\r\n     * @returns a HTML canvas\r\n     */\r\n    public getRenderingCanvas(): Nullable<HTMLCanvasElement> {\r\n        return this._renderingCanvas;\r\n    }\r\n\r\n    /**\r\n     * Gets the audio context specified in engine initialization options\r\n     * @returns an Audio Context\r\n     */\r\n    public getAudioContext(): Nullable<AudioContext> {\r\n        return this._audioContext;\r\n    }\r\n\r\n    /**\r\n     * Gets the audio destination specified in engine initialization options\r\n     * @returns an audio destination node\r\n     */\r\n    public getAudioDestination(): Nullable<AudioDestinationNode | MediaStreamAudioDestinationNode> {\r\n        return this._audioDestination;\r\n    }\r\n\r\n    /**\r\n     * Gets host window\r\n     * @returns the host window object\r\n     */\r\n    public getHostWindow(): Nullable<Window> {\r\n        if (!IsWindowObjectExist()) {\r\n            return null;\r\n        }\r\n\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\r\n            return this._renderingCanvas.ownerDocument.defaultView;\r\n        }\r\n\r\n        return window;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render width\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render width\r\n     */\r\n    public getRenderWidth(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\r\n    }\r\n\r\n    /**\r\n     * Gets the current render height\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render height\r\n     */\r\n    public getRenderHeight(useScreen = false): number {\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\r\n    }\r\n\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @internal\r\n     */\r\n    protected _queueNewFrame(bindedRenderFunction: any, requester?: any): number {\r\n        return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\r\n    }\r\n\r\n    /**\r\n     * Register and execute a render loop. The engine can have more than one render function\r\n     * @param renderFunction defines the function to continuously execute\r\n     */\r\n    public runRenderLoop(renderFunction: () => void): void {\r\n        if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\r\n            return;\r\n        }\r\n\r\n        this._activeRenderLoops.push(renderFunction);\r\n\r\n        if (!this._renderingQueueLaunched) {\r\n            this._renderingQueueLaunched = true;\r\n            this._boundRenderFunction = () => this._renderLoop();\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clear the current render buffer or the current render target (if any is set up)\r\n     * @param color defines the color to use\r\n     * @param backBuffer defines if the back buffer must be cleared\r\n     * @param depth defines if the depth buffer must be cleared\r\n     * @param stencil defines if the stencil buffer must be cleared\r\n     */\r\n    public clear(color: Nullable<IColor4Like>, backBuffer: boolean, depth: boolean, stencil: boolean = false): void {\r\n        const useStencilGlobalOnly = this.stencilStateComposer.useStencilGlobalOnly;\r\n        this.stencilStateComposer.useStencilGlobalOnly = true; // make sure the stencil mask is coming from the global stencil and not from a material (effect) which would currently be in effect\r\n\r\n        this.applyStates();\r\n\r\n        this.stencilStateComposer.useStencilGlobalOnly = useStencilGlobalOnly;\r\n\r\n        let mode = 0;\r\n        if (backBuffer && color) {\r\n            let setBackBufferColor = true;\r\n            if (this._currentRenderTarget) {\r\n                const textureFormat = this._currentRenderTarget.texture?.format;\r\n                if (\r\n                    textureFormat === Constants.TEXTUREFORMAT_RED_INTEGER ||\r\n                    textureFormat === Constants.TEXTUREFORMAT_RG_INTEGER ||\r\n                    textureFormat === Constants.TEXTUREFORMAT_RGB_INTEGER ||\r\n                    textureFormat === Constants.TEXTUREFORMAT_RGBA_INTEGER\r\n                ) {\r\n                    const textureType = this._currentRenderTarget.texture?.type;\r\n                    if (textureType === Constants.TEXTURETYPE_UNSIGNED_INTEGER || textureType === Constants.TEXTURETYPE_UNSIGNED_SHORT) {\r\n                        ThinEngine._TempClearColorUint32[0] = color.r * 255;\r\n                        ThinEngine._TempClearColorUint32[1] = color.g * 255;\r\n                        ThinEngine._TempClearColorUint32[2] = color.b * 255;\r\n                        ThinEngine._TempClearColorUint32[3] = color.a * 255;\r\n                        this._gl.clearBufferuiv(this._gl.COLOR, 0, ThinEngine._TempClearColorUint32);\r\n                        setBackBufferColor = false;\r\n                    } else {\r\n                        ThinEngine._TempClearColorInt32[0] = color.r * 255;\r\n                        ThinEngine._TempClearColorInt32[1] = color.g * 255;\r\n                        ThinEngine._TempClearColorInt32[2] = color.b * 255;\r\n                        ThinEngine._TempClearColorInt32[3] = color.a * 255;\r\n                        this._gl.clearBufferiv(this._gl.COLOR, 0, ThinEngine._TempClearColorInt32);\r\n                        setBackBufferColor = false;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (setBackBufferColor) {\r\n                this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\r\n                mode |= this._gl.COLOR_BUFFER_BIT;\r\n            }\r\n        }\r\n\r\n        if (depth) {\r\n            if (this.useReverseDepthBuffer) {\r\n                this._depthCullingState.depthFunc = this._gl.GEQUAL;\r\n                this._gl.clearDepth(0.0);\r\n            } else {\r\n                this._gl.clearDepth(1.0);\r\n            }\r\n            mode |= this._gl.DEPTH_BUFFER_BIT;\r\n        }\r\n        if (stencil) {\r\n            this._gl.clearStencil(0);\r\n            mode |= this._gl.STENCIL_BUFFER_BIT;\r\n        }\r\n        this._gl.clear(mode);\r\n    }\r\n\r\n    protected _viewportCached = { x: 0, y: 0, z: 0, w: 0 };\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _viewport(x: number, y: number, width: number, height: number): void {\r\n        if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\r\n            this._viewportCached.x = x;\r\n            this._viewportCached.y = y;\r\n            this._viewportCached.z = width;\r\n            this._viewportCached.w = height;\r\n\r\n            this._gl.viewport(x, y, width, height);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the WebGL's viewport\r\n     * @param viewport defines the viewport element to be used\r\n     * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n     * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n     */\r\n    public setViewport(viewport: IViewportLike, requiredWidth?: number, requiredHeight?: number): void {\r\n        const width = requiredWidth || this.getRenderWidth();\r\n        const height = requiredHeight || this.getRenderHeight();\r\n        const x = viewport.x || 0;\r\n        const y = viewport.y || 0;\r\n\r\n        this._cachedViewport = viewport;\r\n\r\n        this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\r\n    }\r\n\r\n    /**\r\n     * Begin a new frame\r\n     */\r\n    public beginFrame(): void {}\r\n\r\n    /**\r\n     * Enf the current frame\r\n     */\r\n    public endFrame(): void {\r\n        // Force a flush in case we are using a bad OS.\r\n        if (this._badOS) {\r\n            this.flushFramebuffer();\r\n        }\r\n        this._frameId++;\r\n    }\r\n\r\n    /**\r\n     * Resize the view according to the canvas' size\r\n     * @param forceSetSize true to force setting the sizes of the underlying canvas\r\n     */\r\n    public resize(forceSetSize = false): void {\r\n        let width: number;\r\n        let height: number;\r\n\r\n        // Re-query hardware scaling level to handle zoomed-in resizing.\r\n        if (this.adaptToDeviceRatio) {\r\n            const devicePixelRatio = IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\r\n            const changeRatio = this._lastDevicePixelRatio / devicePixelRatio;\r\n            this._lastDevicePixelRatio = devicePixelRatio;\r\n            this._hardwareScalingLevel *= changeRatio;\r\n        }\r\n\r\n        if (IsWindowObjectExist() && IsDocumentAvailable()) {\r\n            // make sure it is a Node object, and is a part of the document.\r\n            if (this._renderingCanvas) {\r\n                const boundingRect = this._renderingCanvas.getBoundingClientRect\r\n                    ? this._renderingCanvas.getBoundingClientRect()\r\n                    : {\r\n                          // fallback to last solution in case the function doesn't exist\r\n                          width: this._renderingCanvas.width * this._hardwareScalingLevel,\r\n                          height: this._renderingCanvas.height * this._hardwareScalingLevel,\r\n                      };\r\n                width = this._renderingCanvas.clientWidth || boundingRect.width || this._renderingCanvas.width || 100;\r\n                height = this._renderingCanvas.clientHeight || boundingRect.height || this._renderingCanvas.height || 100;\r\n            } else {\r\n                width = window.innerWidth;\r\n                height = window.innerHeight;\r\n            }\r\n        } else {\r\n            width = this._renderingCanvas ? this._renderingCanvas.width : 100;\r\n            height = this._renderingCanvas ? this._renderingCanvas.height : 100;\r\n        }\r\n\r\n        this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel, forceSetSize);\r\n    }\r\n\r\n    /**\r\n     * Force a specific size of the canvas\r\n     * @param width defines the new canvas' width\r\n     * @param height defines the new canvas' height\r\n     * @param forceSetSize true to force setting the sizes of the underlying canvas\r\n     * @returns true if the size was changed\r\n     */\r\n    public setSize(width: number, height: number, forceSetSize = false): boolean {\r\n        if (!this._renderingCanvas) {\r\n            return false;\r\n        }\r\n\r\n        width = width | 0;\r\n        height = height | 0;\r\n\r\n        if (!forceSetSize && this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\r\n            return false;\r\n        }\r\n\r\n        this._renderingCanvas.width = width;\r\n        this._renderingCanvas.height = height;\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Binds the frame buffer to the specified texture.\r\n     * @param rtWrapper The render target wrapper to render to\r\n     * @param faceIndex The face of the texture to render to in case of cube texture and if the render target wrapper is not a multi render target\r\n     * @param requiredWidth The width of the target to render to\r\n     * @param requiredHeight The height of the target to render to\r\n     * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n     * @param lodLevel Defines the lod level to bind to the frame buffer\r\n     * @param layer Defines the 2d array index to bind to the frame buffer if the render target wrapper is not a multi render target\r\n     */\r\n    public bindFramebuffer(\r\n        rtWrapper: RenderTargetWrapper,\r\n        faceIndex: number = 0,\r\n        requiredWidth?: number,\r\n        requiredHeight?: number,\r\n        forceFullscreenViewport?: boolean,\r\n        lodLevel = 0,\r\n        layer = 0\r\n    ): void {\r\n        const webglRTWrapper = rtWrapper as WebGLRenderTargetWrapper;\r\n\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        }\r\n        this._currentRenderTarget = rtWrapper;\r\n        this._bindUnboundFramebuffer(webglRTWrapper._MSAAFramebuffer ? webglRTWrapper._MSAAFramebuffer : webglRTWrapper._framebuffer);\r\n\r\n        const gl = this._gl;\r\n        if (!rtWrapper.isMulti) {\r\n            if (rtWrapper.is2DArray) {\r\n                gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, rtWrapper.texture!._hardwareTexture?.underlyingResource, lodLevel, layer);\r\n            } else if (rtWrapper.isCube) {\r\n                gl.framebufferTexture2D(\r\n                    gl.FRAMEBUFFER,\r\n                    gl.COLOR_ATTACHMENT0,\r\n                    gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex,\r\n                    rtWrapper.texture!._hardwareTexture?.underlyingResource,\r\n                    lodLevel\r\n                );\r\n            } else if (webglRTWrapper._currentLOD !== lodLevel) {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rtWrapper.texture!._hardwareTexture?.underlyingResource, lodLevel);\r\n                webglRTWrapper._currentLOD = lodLevel;\r\n            }\r\n        }\r\n\r\n        const depthStencilTexture = rtWrapper._depthStencilTexture;\r\n        if (depthStencilTexture) {\r\n            const attachment = rtWrapper._depthStencilTextureWithStencil ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\r\n            if (rtWrapper.is2DArray) {\r\n                gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel, layer);\r\n            } else if (rtWrapper.isCube) {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel);\r\n            } else {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._hardwareTexture?.underlyingResource, lodLevel);\r\n            }\r\n        }\r\n\r\n        if (this._cachedViewport && !forceFullscreenViewport) {\r\n            this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\r\n        } else {\r\n            if (!requiredWidth) {\r\n                requiredWidth = rtWrapper.width;\r\n                if (lodLevel) {\r\n                    requiredWidth = requiredWidth / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n            if (!requiredHeight) {\r\n                requiredHeight = rtWrapper.height;\r\n                if (lodLevel) {\r\n                    requiredHeight = requiredHeight / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n\r\n            this._viewport(0, 0, requiredWidth, requiredHeight);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    /**\r\n     * Set various states to the webGL context\r\n     * @param culling defines culling state: true to enable culling, false to disable it\r\n     * @param zOffset defines the value to apply to zOffset (0 by default)\r\n     * @param force defines if states must be applied even if cache is up to date\r\n     * @param reverseSide defines if culling must be reversed (CCW if false, CW if true)\r\n     * @param cullBackFaces true to cull back faces, false to cull front faces (if culling is enabled)\r\n     * @param stencil stencil states to set\r\n     * @param zOffsetUnits defines the value to apply to zOffsetUnits (0 by default)\r\n     */\r\n    public setState(culling: boolean, zOffset: number = 0, force?: boolean, reverseSide = false, cullBackFaces?: boolean, stencil?: IStencilState, zOffsetUnits: number = 0): void {\r\n        // Culling\r\n        if (this._depthCullingState.cull !== culling || force) {\r\n            this._depthCullingState.cull = culling;\r\n        }\r\n\r\n        // Cull face\r\n        const cullFace = this.cullBackFaces ?? cullBackFaces ?? true ? this._gl.BACK : this._gl.FRONT;\r\n        if (this._depthCullingState.cullFace !== cullFace || force) {\r\n            this._depthCullingState.cullFace = cullFace;\r\n        }\r\n\r\n        // Z offset\r\n        this.setZOffset(zOffset);\r\n        this.setZOffsetUnits(zOffsetUnits);\r\n\r\n        // Front face\r\n        const frontFace = reverseSide ? this._gl.CW : this._gl.CCW;\r\n        if (this._depthCullingState.frontFace !== frontFace || force) {\r\n            this._depthCullingState.frontFace = frontFace;\r\n        }\r\n\r\n        this._stencilStateComposer.stencilMaterial = stencil;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if depth testing is enabled\r\n     * @returns the current state\r\n     */\r\n    public getDepthBuffer(): boolean {\r\n        return this._depthCullingState.depthTest;\r\n    }\r\n\r\n    /**\r\n     * Enable or disable depth buffering\r\n     * @param enable defines the state to set\r\n     */\r\n    public setDepthBuffer(enable: boolean): void {\r\n        this._depthCullingState.depthTest = enable;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Factor to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffset(value: number): void {\r\n        this._depthCullingState.zOffset = this.useReverseDepthBuffer ? -value : value;\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Factor\r\n     * @returns the current zOffset Factor state\r\n     */\r\n    public getZOffset(): number {\r\n        const zOffset = this._depthCullingState.zOffset;\r\n        return this.useReverseDepthBuffer ? -zOffset : zOffset;\r\n    }\r\n\r\n    /**\r\n     * Set the z offset Units to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    public setZOffsetUnits(value: number): void {\r\n        this._depthCullingState.zOffsetUnits = this.useReverseDepthBuffer ? -value : value;\r\n    }\r\n\r\n    /**\r\n     * Gets the current value of the zOffset Units\r\n     * @returns the current zOffset Units state\r\n     */\r\n    public getZOffsetUnits(): number {\r\n        const zOffsetUnits = this._depthCullingState.zOffsetUnits;\r\n        return this.useReverseDepthBuffer ? -zOffsetUnits : zOffsetUnits;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _bindUnboundFramebuffer(framebuffer: Nullable<WebGLFramebuffer>) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    public _currentFrameBufferIsDefaultFrameBuffer() {\r\n        return this._currentFramebuffer === null;\r\n    }\r\n\r\n    /**\r\n     * Generates the mipmaps for a texture\r\n     * @param texture texture to generate the mipmaps for\r\n     */\r\n    public generateMipmaps(texture: InternalTexture): void {\r\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, texture, true);\r\n        this._gl.generateMipmap(this._gl.TEXTURE_2D);\r\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target texture from the webGL context\r\n     * @param texture defines the render target wrapper to unbind\r\n     * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n     * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n     */\r\n    public unBindFramebuffer(texture: RenderTargetWrapper, disableGenerateMipMaps = false, onBeforeUnbind?: () => void): void {\r\n        const webglRTWrapper = texture as WebGLRenderTargetWrapper;\r\n\r\n        this._currentRenderTarget = null;\r\n\r\n        // If MSAA, we need to bitblt back to main texture\r\n        const gl = this._gl;\r\n        if (webglRTWrapper._MSAAFramebuffer) {\r\n            if (texture.isMulti) {\r\n                // This texture is part of a MRT texture, we need to treat all attachments\r\n                this.unBindMultiColorAttachmentFramebuffer(texture, disableGenerateMipMaps, onBeforeUnbind);\r\n                return;\r\n            }\r\n            gl.bindFramebuffer(gl.READ_FRAMEBUFFER, webglRTWrapper._MSAAFramebuffer);\r\n            gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, webglRTWrapper._framebuffer);\r\n            gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\r\n        }\r\n\r\n        if (texture.texture?.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\r\n            this.generateMipmaps(texture.texture);\r\n        }\r\n\r\n        if (onBeforeUnbind) {\r\n            if (webglRTWrapper._MSAAFramebuffer) {\r\n                // Bind the correct framebuffer\r\n                this._bindUnboundFramebuffer(webglRTWrapper._framebuffer);\r\n            }\r\n            onBeforeUnbind();\r\n        }\r\n\r\n        this._bindUnboundFramebuffer(null);\r\n    }\r\n\r\n    /**\r\n     * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n     */\r\n    public flushFramebuffer(): void {\r\n        this._gl.flush();\r\n    }\r\n\r\n    /**\r\n     * Unbind the current render target and bind the default framebuffer\r\n     */\r\n    public restoreDefaultFramebuffer(): void {\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        } else {\r\n            this._bindUnboundFramebuffer(null);\r\n        }\r\n        if (this._cachedViewport) {\r\n            this.setViewport(this._cachedViewport);\r\n        }\r\n\r\n        this.wipeCaches();\r\n    }\r\n\r\n    // VBOs\r\n\r\n    /** @internal */\r\n    protected _resetVertexBufferBinding(): void {\r\n        this.bindArrayBuffer(null);\r\n        this._cachedVertexBuffers = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a vertex buffer\r\n     * @param data the data for the vertex buffer\r\n     * @param _updatable whether the buffer should be created as updatable\r\n     * @param _label defines the label of the buffer (for debug purpose)\r\n     * @returns the new WebGL static buffer\r\n     */\r\n    public createVertexBuffer(data: DataArray, _updatable?: boolean, _label?: string): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\r\n    }\r\n\r\n    private _createVertexBuffer(data: DataArray, usage: number): DataBuffer {\r\n        const vbo = this._gl.createBuffer();\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create vertex buffer\");\r\n        }\r\n\r\n        const dataBuffer = new WebGLDataBuffer(vbo);\r\n        this.bindArrayBuffer(dataBuffer);\r\n\r\n        if (data instanceof Array) {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), usage);\r\n        } else {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, <ArrayBuffer>data, usage);\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n\r\n        dataBuffer.references = 1;\r\n        return dataBuffer;\r\n    }\r\n\r\n    /**\r\n     * Creates a dynamic vertex buffer\r\n     * @param data the data for the dynamic vertex buffer\r\n     * @param _label defines the label of the buffer (for debug purpose)\r\n     * @returns the new WebGL dynamic buffer\r\n     */\r\n    public createDynamicVertexBuffer(data: DataArray, _label?: string): DataBuffer {\r\n        return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\r\n    }\r\n\r\n    protected _resetIndexBufferBinding(): void {\r\n        this.bindIndexBuffer(null);\r\n        this._cachedIndexBuffer = null;\r\n    }\r\n\r\n    /**\r\n     * Creates a new index buffer\r\n     * @param indices defines the content of the index buffer\r\n     * @param updatable defines if the index buffer must be updatable\r\n     * @param _label defines the label of the buffer (for debug purpose)\r\n     * @returns a new webGL buffer\r\n     */\r\n    public createIndexBuffer(indices: IndicesArray, updatable?: boolean, _label?: string): DataBuffer {\r\n        const vbo = this._gl.createBuffer();\r\n        const dataBuffer = new WebGLDataBuffer(vbo!);\r\n\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create index buffer\");\r\n        }\r\n\r\n        this.bindIndexBuffer(dataBuffer);\r\n\r\n        const data = this._normalizeIndexData(indices);\r\n        this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\r\n        this._resetIndexBufferBinding();\r\n        dataBuffer.references = 1;\r\n        dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\r\n        return dataBuffer;\r\n    }\r\n\r\n    protected _normalizeIndexData(indices: IndicesArray): Uint16Array | Uint32Array {\r\n        const bytesPerElement = (indices as Exclude<IndicesArray, number[]>).BYTES_PER_ELEMENT;\r\n        if (bytesPerElement === 2) {\r\n            return indices as Uint16Array;\r\n        }\r\n\r\n        // Check 32 bit support\r\n        if (this._caps.uintIndices) {\r\n            if (indices instanceof Uint32Array) {\r\n                return indices;\r\n            } else {\r\n                // number[] or Int32Array, check if 32 bit is necessary\r\n                for (let index = 0; index < indices.length; index++) {\r\n                    if (indices[index] >= 65535) {\r\n                        return new Uint32Array(indices);\r\n                    }\r\n                }\r\n\r\n                return new Uint16Array(indices);\r\n            }\r\n        }\r\n\r\n        // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\r\n        return new Uint16Array(indices);\r\n    }\r\n\r\n    /**\r\n     * Bind a webGL buffer to the webGL context\r\n     * @param buffer defines the buffer to bind\r\n     */\r\n    public bindArrayBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this._bindBuffer(buffer, this._gl.ARRAY_BUFFER);\r\n    }\r\n\r\n    /**\r\n     * Bind a specific block at a given index in a specific shader program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param blockName defines the block name\r\n     * @param index defines the index where to bind the block\r\n     */\r\n    public bindUniformBlock(pipelineContext: IPipelineContext, blockName: string, index: number): void {\r\n        const program = (pipelineContext as WebGLPipelineContext).program!;\r\n\r\n        const uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\r\n\r\n        this._gl.uniformBlockBinding(program, uniformLocation, index);\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    protected bindIndexBuffer(buffer: Nullable<DataBuffer>): void {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this._bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\r\n    }\r\n\r\n    private _bindBuffer(buffer: Nullable<DataBuffer>, target: number): void {\r\n        if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\r\n            this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\r\n            this._currentBoundBuffer[target] = buffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * update the bound buffer with the given data\r\n     * @param data defines the data to update\r\n     */\r\n    public updateArrayBuffer(data: Float32Array): void {\r\n        this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n    }\r\n\r\n    private _vertexAttribPointer(buffer: DataBuffer, indx: number, size: number, type: number, normalized: boolean, stride: number, offset: number): void {\r\n        const pointer = this._currentBufferPointers[indx];\r\n        if (!pointer) {\r\n            return;\r\n        }\r\n\r\n        let changed = false;\r\n        if (!pointer.active) {\r\n            changed = true;\r\n            pointer.active = true;\r\n            pointer.index = indx;\r\n            pointer.size = size;\r\n            pointer.type = type;\r\n            pointer.normalized = normalized;\r\n            pointer.stride = stride;\r\n            pointer.offset = offset;\r\n            pointer.buffer = buffer;\r\n        } else {\r\n            if (pointer.buffer !== buffer) {\r\n                pointer.buffer = buffer;\r\n                changed = true;\r\n            }\r\n            if (pointer.size !== size) {\r\n                pointer.size = size;\r\n                changed = true;\r\n            }\r\n            if (pointer.type !== type) {\r\n                pointer.type = type;\r\n                changed = true;\r\n            }\r\n            if (pointer.normalized !== normalized) {\r\n                pointer.normalized = normalized;\r\n                changed = true;\r\n            }\r\n            if (pointer.stride !== stride) {\r\n                pointer.stride = stride;\r\n                changed = true;\r\n            }\r\n            if (pointer.offset !== offset) {\r\n                pointer.offset = offset;\r\n                changed = true;\r\n            }\r\n        }\r\n\r\n        if (changed || this._vaoRecordInProgress) {\r\n            this.bindArrayBuffer(buffer);\r\n            if (type === this._gl.UNSIGNED_INT || type === this._gl.INT) {\r\n                this._gl.vertexAttribIPointer(indx, size, type, stride, offset);\r\n            } else {\r\n                this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _bindIndexBufferWithCache(indexBuffer: Nullable<DataBuffer>): void {\r\n        if (indexBuffer == null) {\r\n            return;\r\n        }\r\n        if (this._cachedIndexBuffer !== indexBuffer) {\r\n            this._cachedIndexBuffer = indexBuffer;\r\n            this.bindIndexBuffer(indexBuffer);\r\n            this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\r\n        }\r\n    }\r\n\r\n    private _bindVertexBuffersAttributes(\r\n        vertexBuffers: { [key: string]: Nullable<VertexBuffer> },\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): void {\r\n        const attributes = effect.getAttributesNames();\r\n\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n\r\n        this.unbindAllAttributes();\r\n\r\n        for (let index = 0; index < attributes.length; index++) {\r\n            const order = effect.getAttributeLocation(index);\r\n\r\n            if (order >= 0) {\r\n                const ai = attributes[index];\r\n                let vertexBuffer: Nullable<VertexBuffer> = null;\r\n\r\n                if (overrideVertexBuffers) {\r\n                    vertexBuffer = overrideVertexBuffers[ai];\r\n                }\r\n\r\n                if (!vertexBuffer) {\r\n                    vertexBuffer = vertexBuffers[ai];\r\n                }\r\n\r\n                if (!vertexBuffer) {\r\n                    continue;\r\n                }\r\n\r\n                this._gl.enableVertexAttribArray(order);\r\n                if (!this._vaoRecordInProgress) {\r\n                    this._vertexAttribArraysEnabled[order] = true;\r\n                }\r\n\r\n                const buffer = vertexBuffer.getBuffer();\r\n                if (buffer) {\r\n                    this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\r\n\r\n                    if (vertexBuffer.getIsInstanced()) {\r\n                        this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\r\n                        if (!this._vaoRecordInProgress) {\r\n                            this._currentInstanceLocations.push(order);\r\n                            this._currentInstanceBuffers.push(buffer);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Records a vertex array object\r\n     * @see https://doc.babylonjs.com/setup/support/webGL2#vertex-array-objects\r\n     * @param vertexBuffers defines the list of vertex buffers to store\r\n     * @param indexBuffer defines the index buffer to store\r\n     * @param effect defines the effect to store\r\n     * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\r\n     * @returns the new vertex array object\r\n     */\r\n    public recordVertexArrayObject(\r\n        vertexBuffers: { [key: string]: VertexBuffer },\r\n        indexBuffer: Nullable<DataBuffer>,\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): WebGLVertexArrayObject {\r\n        const vao = this._gl.createVertexArray();\r\n\r\n        if (!vao) {\r\n            throw new Error(\"Unable to create VAO\");\r\n        }\r\n\r\n        this._vaoRecordInProgress = true;\r\n\r\n        this._gl.bindVertexArray(vao);\r\n\r\n        this._mustWipeVertexAttributes = true;\r\n        this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\r\n\r\n        this.bindIndexBuffer(indexBuffer);\r\n\r\n        this._vaoRecordInProgress = false;\r\n        this._gl.bindVertexArray(null);\r\n\r\n        return vao;\r\n    }\r\n\r\n    /**\r\n     * Bind a specific vertex array object\r\n     * @see https://doc.babylonjs.com/setup/support/webGL2#vertex-array-objects\r\n     * @param vertexArrayObject defines the vertex array object to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     */\r\n    public bindVertexArrayObject(vertexArrayObject: WebGLVertexArrayObject, indexBuffer: Nullable<DataBuffer>): void {\r\n        if (this._cachedVertexArrayObject !== vertexArrayObject) {\r\n            this._cachedVertexArrayObject = vertexArrayObject;\r\n\r\n            this._gl.bindVertexArray(vertexArrayObject);\r\n            this._cachedVertexBuffers = null;\r\n            this._cachedIndexBuffer = null;\r\n\r\n            this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\r\n            this._mustWipeVertexAttributes = true;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind webGl buffers directly to the webGL context\r\n     * @param vertexBuffer defines the vertex buffer to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n     * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n     * @param effect defines the effect associated with the vertex buffer\r\n     */\r\n    public bindBuffersDirectly(vertexBuffer: DataBuffer, indexBuffer: DataBuffer, vertexDeclaration: number[], vertexStrideSize: number, effect: Effect): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffer;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            const attributesCount = effect.getAttributesCount();\r\n\r\n            this._unbindVertexArrayObject();\r\n            this.unbindAllAttributes();\r\n\r\n            let offset = 0;\r\n            for (let index = 0; index < attributesCount; index++) {\r\n                if (index < vertexDeclaration.length) {\r\n                    const order = effect.getAttributeLocation(index);\r\n\r\n                    if (order >= 0) {\r\n                        this._gl.enableVertexAttribArray(order);\r\n                        this._vertexAttribArraysEnabled[order] = true;\r\n                        this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\r\n                    }\r\n\r\n                    offset += vertexDeclaration[index] * 4;\r\n                }\r\n            }\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    private _unbindVertexArrayObject(): void {\r\n        if (!this._cachedVertexArrayObject) {\r\n            return;\r\n        }\r\n\r\n        this._cachedVertexArrayObject = null;\r\n        this._gl.bindVertexArray(null);\r\n    }\r\n\r\n    /**\r\n     * Bind a list of vertex buffers to the webGL context\r\n     * @param vertexBuffers defines the list of vertex buffers to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param effect defines the effect associated with the vertex buffers\r\n     * @param overrideVertexBuffers defines optional list of avertex buffers that overrides the entries in vertexBuffers\r\n     */\r\n    public bindBuffers(\r\n        vertexBuffers: { [key: string]: Nullable<VertexBuffer> },\r\n        indexBuffer: Nullable<DataBuffer>,\r\n        effect: Effect,\r\n        overrideVertexBuffers?: { [kind: string]: Nullable<VertexBuffer> }\r\n    ): void {\r\n        if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffers;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n\r\n            this._bindVertexBuffersAttributes(vertexBuffers, effect, overrideVertexBuffers);\r\n        }\r\n\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    }\r\n\r\n    /**\r\n     * Unbind all instance attributes\r\n     */\r\n    public unbindInstanceAttributes() {\r\n        let boundBuffer;\r\n        for (let i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\r\n            const instancesBuffer = this._currentInstanceBuffers[i];\r\n            if (boundBuffer != instancesBuffer && instancesBuffer.references) {\r\n                boundBuffer = instancesBuffer;\r\n                this.bindArrayBuffer(instancesBuffer);\r\n            }\r\n            const offsetLocation = this._currentInstanceLocations[i];\r\n            this._gl.vertexAttribDivisor(offsetLocation, 0);\r\n        }\r\n        this._currentInstanceBuffers.length = 0;\r\n        this._currentInstanceLocations.length = 0;\r\n    }\r\n\r\n    /**\r\n     * Release and free the memory of a vertex array object\r\n     * @param vao defines the vertex array object to delete\r\n     */\r\n    public releaseVertexArrayObject(vao: WebGLVertexArrayObject) {\r\n        this._gl.deleteVertexArray(vao);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _releaseBuffer(buffer: DataBuffer): boolean {\r\n        buffer.references--;\r\n\r\n        if (buffer.references === 0) {\r\n            this._deleteBuffer(buffer);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    protected _deleteBuffer(buffer: DataBuffer): void {\r\n        this._gl.deleteBuffer(buffer.underlyingResource);\r\n    }\r\n\r\n    /**\r\n     * Update the content of a webGL buffer used with instantiation and bind it to the webGL context\r\n     * @param instancesBuffer defines the webGL buffer to update and bind\r\n     * @param data defines the data to store in the buffer\r\n     * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     */\r\n    public updateAndBindInstancesBuffer(instancesBuffer: DataBuffer, data: Float32Array, offsetLocations: number[] | InstancingAttributeInfo[]): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n        if (data) {\r\n            this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n        }\r\n\r\n        if ((<any>offsetLocations[0]).index !== undefined) {\r\n            this.bindInstancesBuffer(instancesBuffer, offsetLocations as any, true);\r\n        } else {\r\n            for (let index = 0; index < 4; index++) {\r\n                const offsetLocation = <number>offsetLocations[index];\r\n\r\n                if (!this._vertexAttribArraysEnabled[offsetLocation]) {\r\n                    this._gl.enableVertexAttribArray(offsetLocation);\r\n                    this._vertexAttribArraysEnabled[offsetLocation] = true;\r\n                }\r\n\r\n                this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\r\n                this._gl.vertexAttribDivisor(offsetLocation, 1);\r\n                this._currentInstanceLocations.push(offsetLocation);\r\n                this._currentInstanceBuffers.push(instancesBuffer);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bind the content of a webGL buffer used with instantiation\r\n     * @param instancesBuffer defines the webGL buffer to bind\r\n     * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n     */\r\n    public bindInstancesBuffer(instancesBuffer: DataBuffer, attributesInfo: InstancingAttributeInfo[], computeStride = true): void {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n\r\n        let stride = 0;\r\n        if (computeStride) {\r\n            for (let i = 0; i < attributesInfo.length; i++) {\r\n                const ai = attributesInfo[i];\r\n                stride += ai.attributeSize * 4;\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < attributesInfo.length; i++) {\r\n            const ai = attributesInfo[i];\r\n            if (ai.index === undefined) {\r\n                ai.index = this._currentEffect!.getAttributeLocationByName(ai.attributeName);\r\n            }\r\n\r\n            if (ai.index < 0) {\r\n                continue;\r\n            }\r\n\r\n            if (!this._vertexAttribArraysEnabled[ai.index]) {\r\n                this._gl.enableVertexAttribArray(ai.index);\r\n                this._vertexAttribArraysEnabled[ai.index] = true;\r\n            }\r\n\r\n            this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\r\n            this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\r\n            this._currentInstanceLocations.push(ai.index);\r\n            this._currentInstanceBuffers.push(instancesBuffer);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the name in parameter\r\n     * @param name defines the name of the attribute to disable\r\n     */\r\n    public disableInstanceAttributeByName(name: string) {\r\n        if (!this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        const attributeLocation = this._currentEffect.getAttributeLocationByName(name);\r\n        this.disableInstanceAttribute(attributeLocation);\r\n    }\r\n\r\n    /**\r\n     * Disable the instance attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableInstanceAttribute(attributeLocation: number) {\r\n        let shouldClean = false;\r\n        let index: number;\r\n        while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\r\n            this._currentInstanceLocations.splice(index, 1);\r\n            this._currentInstanceBuffers.splice(index, 1);\r\n\r\n            shouldClean = true;\r\n            index = this._currentInstanceLocations.indexOf(attributeLocation);\r\n        }\r\n\r\n        if (shouldClean) {\r\n            this._gl.vertexAttribDivisor(attributeLocation, 0);\r\n            this.disableAttributeByIndex(attributeLocation);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disable the attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    public disableAttributeByIndex(attributeLocation: number) {\r\n        this._gl.disableVertexAttribArray(attributeLocation);\r\n        this._vertexAttribArraysEnabled[attributeLocation] = false;\r\n        this._currentBufferPointers[attributeLocation].active = false;\r\n    }\r\n\r\n    /**\r\n     * Send a draw order\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public draw(useTriangles: boolean, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        this.drawElementsType(useTriangles ? Constants.MATERIAL_TriangleFillMode : Constants.MATERIAL_WireFrameFillMode, indexStart, indexCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of points\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawPointClouds(verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(Constants.MATERIAL_PointFillMode, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawUnIndexed(useTriangles: boolean, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        this.drawArraysType(useTriangles ? Constants.MATERIAL_TriangleFillMode : Constants.MATERIAL_WireFrameFillMode, verticesStart, verticesCount, instancesCount);\r\n    }\r\n\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawElementsType(fillMode: number, indexStart: number, indexCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        // Render\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        const indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n        const mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        if (instancesCount) {\r\n            this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        } else {\r\n            this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instantiation is enabled)\r\n     */\r\n    public drawArraysType(fillMode: number, verticesStart: number, verticesCount: number, instancesCount?: number): void {\r\n        // Apply states\r\n        this.applyStates();\r\n\r\n        this._reportDrawCall();\r\n\r\n        const drawMode = this._drawMode(fillMode);\r\n        if (instancesCount) {\r\n            this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        } else {\r\n            this._gl.drawArrays(drawMode, verticesStart, verticesCount);\r\n        }\r\n    }\r\n\r\n    private _drawMode(fillMode: number): number {\r\n        switch (fillMode) {\r\n            // Triangle views\r\n            case Constants.MATERIAL_TriangleFillMode:\r\n                return this._gl.TRIANGLES;\r\n            case Constants.MATERIAL_PointFillMode:\r\n                return this._gl.POINTS;\r\n            case Constants.MATERIAL_WireFrameFillMode:\r\n                return this._gl.LINES;\r\n            // Draw modes\r\n            case Constants.MATERIAL_PointListDrawMode:\r\n                return this._gl.POINTS;\r\n            case Constants.MATERIAL_LineListDrawMode:\r\n                return this._gl.LINES;\r\n            case Constants.MATERIAL_LineLoopDrawMode:\r\n                return this._gl.LINE_LOOP;\r\n            case Constants.MATERIAL_LineStripDrawMode:\r\n                return this._gl.LINE_STRIP;\r\n            case Constants.MATERIAL_TriangleStripDrawMode:\r\n                return this._gl.TRIANGLE_STRIP;\r\n            case Constants.MATERIAL_TriangleFanDrawMode:\r\n                return this._gl.TRIANGLE_FAN;\r\n            default:\r\n                return this._gl.TRIANGLES;\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    protected _reportDrawCall() {\r\n        // Will be implemented by children\r\n    }\r\n\r\n    // Shaders\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _releaseEffect(effect: Effect): void {\r\n        if (this._compiledEffects[effect._key]) {\r\n            delete this._compiledEffects[effect._key];\r\n        }\r\n        const pipelineContext = effect.getPipelineContext();\r\n        if (pipelineContext) {\r\n            this._deletePipelineContext(pipelineContext);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _deletePipelineContext(pipelineContext: IPipelineContext): void {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (webGLPipelineContext && webGLPipelineContext.program) {\r\n            webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\r\n\r\n            this._gl.deleteProgram(webGLPipelineContext.program);\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    public _getGlobalDefines(defines?: { [key: string]: string }): string | undefined {\r\n        if (defines) {\r\n            if (this.isNDCHalfZRange) {\r\n                defines[\"IS_NDC_HALF_ZRANGE\"] = \"\";\r\n            } else {\r\n                delete defines[\"IS_NDC_HALF_ZRANGE\"];\r\n            }\r\n            if (this.useReverseDepthBuffer) {\r\n                defines[\"USE_REVERSE_DEPTHBUFFER\"] = \"\";\r\n            } else {\r\n                delete defines[\"USE_REVERSE_DEPTHBUFFER\"];\r\n            }\r\n            if (this.useExactSrgbConversions) {\r\n                defines[\"USE_EXACT_SRGB_CONVERSIONS\"] = \"\";\r\n            } else {\r\n                delete defines[\"USE_EXACT_SRGB_CONVERSIONS\"];\r\n            }\r\n            return;\r\n        } else {\r\n            let s = \"\";\r\n            if (this.isNDCHalfZRange) {\r\n                s += \"#define IS_NDC_HALF_ZRANGE\";\r\n            }\r\n            if (this.useReverseDepthBuffer) {\r\n                if (s) {\r\n                    s += \"\\n\";\r\n                }\r\n                s += \"#define USE_REVERSE_DEPTHBUFFER\";\r\n            }\r\n            if (this.useExactSrgbConversions) {\r\n                if (s) {\r\n                    s += \"\\n\";\r\n                }\r\n                s += \"#define USE_EXACT_SRGB_CONVERSIONS\";\r\n            }\r\n            return s;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Create a new effect (used to store vertex/fragment shaders)\r\n     * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n     * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n     * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n     * @param samplers defines an array of string used to represent textures\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param fallbacks defines the list of potential fallbacks to use if shader compilation fails\r\n     * @param onCompiled defines a function to call when the effect creation is successful\r\n     * @param onError defines a function to call when the effect creation has failed\r\n     * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n     * @param shaderLanguage the language the shader is written in (default: GLSL)\r\n     * @returns the new Effect\r\n     */\r\n    public createEffect(\r\n        baseName: any,\r\n        attributesNamesOrOptions: string[] | IEffectCreationOptions,\r\n        uniformsNamesOrEngine: string[] | ThinEngine,\r\n        samplers?: string[],\r\n        defines?: string,\r\n        fallbacks?: IEffectFallbacks,\r\n        onCompiled?: Nullable<(effect: Effect) => void>,\r\n        onError?: Nullable<(effect: Effect, errors: string) => void>,\r\n        indexParameters?: any,\r\n        shaderLanguage = ShaderLanguage.GLSL\r\n    ): Effect {\r\n        const vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\r\n        const fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\r\n        const globalDefines = this._getGlobalDefines()!;\r\n\r\n        let fullDefines = defines ?? (<IEffectCreationOptions>attributesNamesOrOptions).defines ?? \"\";\r\n\r\n        if (globalDefines) {\r\n            fullDefines += globalDefines;\r\n        }\r\n\r\n        const name = vertex + \"+\" + fragment + \"@\" + fullDefines;\r\n        if (this._compiledEffects[name]) {\r\n            const compiledEffect = <Effect>this._compiledEffects[name];\r\n            if (onCompiled && compiledEffect.isReady()) {\r\n                onCompiled(compiledEffect);\r\n            }\r\n\r\n            return compiledEffect;\r\n        }\r\n        const effect = new Effect(\r\n            baseName,\r\n            attributesNamesOrOptions,\r\n            uniformsNamesOrEngine,\r\n            samplers,\r\n            this,\r\n            defines,\r\n            fallbacks,\r\n            onCompiled,\r\n            onError,\r\n            indexParameters,\r\n            name,\r\n            shaderLanguage\r\n        );\r\n        this._compiledEffects[name] = effect;\r\n\r\n        return effect;\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    protected static _ConcatenateShader(source: string, defines: Nullable<string>, shaderVersion: string = \"\"): string {\r\n        return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\r\n    }\r\n\r\n    private _compileShader(source: string, type: string, defines: Nullable<string>, shaderVersion: string): WebGLShader {\r\n        return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\r\n    }\r\n\r\n    private _compileRawShader(source: string, type: string): WebGLShader {\r\n        const gl = this._gl;\r\n\r\n        const shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\r\n\r\n        if (!shader) {\r\n            let error: GLenum = gl.NO_ERROR;\r\n            let tempError: GLenum = gl.NO_ERROR;\r\n            while ((tempError = gl.getError()) !== gl.NO_ERROR) {\r\n                error = tempError;\r\n            }\r\n\r\n            throw new Error(\r\n                `Something went wrong while creating a gl ${type} shader object. gl error=${error}, gl isContextLost=${gl.isContextLost()}, _contextWasLost=${this._contextWasLost}`\r\n            );\r\n        }\r\n\r\n        gl.shaderSource(shader, source);\r\n        gl.compileShader(shader);\r\n\r\n        return shader;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getShaderSource(shader: WebGLShader): Nullable<string> {\r\n        return this._gl.getShaderSource(shader);\r\n    }\r\n\r\n    /**\r\n     * Directly creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createRawShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        const vertexShader = this._compileRawShader(vertexCode, \"vertex\");\r\n        const fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode  defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    public createShaderProgram(\r\n        pipelineContext: IPipelineContext,\r\n        vertexCode: string,\r\n        fragmentCode: string,\r\n        defines: Nullable<string>,\r\n        context?: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        context = context || this._gl;\r\n\r\n        const shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\r\n        const vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\r\n        const fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\r\n\r\n        return this._createShaderProgram(pipelineContext as WebGLPipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    }\r\n\r\n    /**\r\n     * Inline functions in shader code that are marked to be inlined\r\n     * @param code code to inline\r\n     * @returns inlined code\r\n     */\r\n    public inlineShaderCode(code: string): string {\r\n        // no inlining needed in the WebGL engine\r\n        return code;\r\n    }\r\n\r\n    /**\r\n     * Creates a new pipeline context\r\n     * @param shaderProcessingContext defines the shader processing context used during the processing if available\r\n     * @returns the new pipeline\r\n     */\r\n    public createPipelineContext(shaderProcessingContext: Nullable<ShaderProcessingContext>): IPipelineContext {\r\n        const pipelineContext = new WebGLPipelineContext();\r\n        pipelineContext.engine = this;\r\n\r\n        if (this._caps.parallelShaderCompile) {\r\n            pipelineContext.isParallelCompiled = true;\r\n        }\r\n\r\n        return pipelineContext;\r\n    }\r\n\r\n    /**\r\n     * Creates a new material context\r\n     * @returns the new context\r\n     */\r\n    public createMaterialContext(): IMaterialContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    /**\r\n     * Creates a new draw context\r\n     * @returns the new context\r\n     */\r\n    public createDrawContext(): IDrawContext | undefined {\r\n        return undefined;\r\n    }\r\n\r\n    protected _createShaderProgram(\r\n        pipelineContext: WebGLPipelineContext,\r\n        vertexShader: WebGLShader,\r\n        fragmentShader: WebGLShader,\r\n        context: WebGLRenderingContext,\r\n        transformFeedbackVaryings: Nullable<string[]> = null\r\n    ): WebGLProgram {\r\n        const shaderProgram = context.createProgram();\r\n        pipelineContext.program = shaderProgram;\r\n\r\n        if (!shaderProgram) {\r\n            throw new Error(\"Unable to create program\");\r\n        }\r\n\r\n        context.attachShader(shaderProgram, vertexShader);\r\n        context.attachShader(shaderProgram, fragmentShader);\r\n\r\n        context.linkProgram(shaderProgram);\r\n\r\n        pipelineContext.context = context;\r\n        pipelineContext.vertexShader = vertexShader;\r\n        pipelineContext.fragmentShader = fragmentShader;\r\n\r\n        if (!pipelineContext.isParallelCompiled) {\r\n            this._finalizePipelineContext(pipelineContext);\r\n        }\r\n\r\n        return shaderProgram;\r\n    }\r\n\r\n    protected _finalizePipelineContext(pipelineContext: WebGLPipelineContext) {\r\n        const context = pipelineContext.context!;\r\n        const vertexShader = pipelineContext.vertexShader!;\r\n        const fragmentShader = pipelineContext.fragmentShader!;\r\n        const program = pipelineContext.program!;\r\n\r\n        const linked = context.getProgramParameter(program, context.LINK_STATUS);\r\n        if (!linked) {\r\n            // Get more info\r\n            // Vertex\r\n            if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(vertexShader);\r\n                if (log) {\r\n                    pipelineContext.vertexCompilationError = log;\r\n                    throw new Error(\"VERTEX SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            // Fragment\r\n            if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\r\n                const log = this._gl.getShaderInfoLog(fragmentShader);\r\n                if (log) {\r\n                    pipelineContext.fragmentCompilationError = log;\r\n                    throw new Error(\"FRAGMENT SHADER \" + log);\r\n                }\r\n            }\r\n\r\n            const error = context.getProgramInfoLog(program);\r\n            if (error) {\r\n                pipelineContext.programLinkError = error;\r\n                throw new Error(error);\r\n            }\r\n        }\r\n\r\n        if (this.validateShaderPrograms) {\r\n            context.validateProgram(program);\r\n            const validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\r\n\r\n            if (!validated) {\r\n                const error = context.getProgramInfoLog(program);\r\n                if (error) {\r\n                    pipelineContext.programValidationError = error;\r\n                    throw new Error(error);\r\n                }\r\n            }\r\n        }\r\n\r\n        context.deleteShader(vertexShader);\r\n        context.deleteShader(fragmentShader);\r\n\r\n        pipelineContext.vertexShader = undefined;\r\n        pipelineContext.fragmentShader = undefined;\r\n\r\n        if (pipelineContext.onCompiled) {\r\n            pipelineContext.onCompiled();\r\n            pipelineContext.onCompiled = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _preparePipelineContext(\r\n        pipelineContext: IPipelineContext,\r\n        vertexSourceCode: string,\r\n        fragmentSourceCode: string,\r\n        createAsRaw: boolean,\r\n        rawVertexSourceCode: string,\r\n        rawFragmentSourceCode: string,\r\n        rebuildRebind: any,\r\n        defines: Nullable<string>,\r\n        transformFeedbackVaryings: Nullable<string[]>,\r\n        key: string\r\n    ) {\r\n        const webGLRenderingState = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (createAsRaw) {\r\n            webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        } else {\r\n            webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n        webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _isRenderingStateCompiled(pipelineContext: IPipelineContext): boolean {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n        if (this._isDisposed || webGLPipelineContext._isDisposed) {\r\n            return false;\r\n        }\r\n        if (this._gl.getProgramParameter(webGLPipelineContext.program!, this._caps.parallelShaderCompile!.COMPLETION_STATUS_KHR)) {\r\n            this._finalizePipelineContext(webGLPipelineContext);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _executeWhenRenderingStateIsCompiled(pipelineContext: IPipelineContext, action: () => void) {\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        if (!webGLPipelineContext.isParallelCompiled) {\r\n            action();\r\n            return;\r\n        }\r\n\r\n        const oldHandler = webGLPipelineContext.onCompiled;\r\n\r\n        if (oldHandler) {\r\n            webGLPipelineContext.onCompiled = () => {\r\n                oldHandler!();\r\n                action();\r\n            };\r\n        } else {\r\n            webGLPipelineContext.onCompiled = action;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param uniformsNames defines the list of uniform names\r\n     * @returns an array of webGL uniform locations\r\n     */\r\n    public getUniforms(pipelineContext: IPipelineContext, uniformsNames: string[]): Nullable<WebGLUniformLocation>[] {\r\n        const results = new Array<Nullable<WebGLUniformLocation>>();\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (let index = 0; index < uniformsNames.length; index++) {\r\n            results.push(this._gl.getUniformLocation(webGLPipelineContext.program!, uniformsNames[index]));\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Gets the list of active attributes for a given webGL program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param attributesNames defines the list of attribute names to get\r\n     * @returns an array of indices indicating the offset of each attribute\r\n     */\r\n    public getAttributes(pipelineContext: IPipelineContext, attributesNames: string[]): number[] {\r\n        const results = [];\r\n        const webGLPipelineContext = pipelineContext as WebGLPipelineContext;\r\n\r\n        for (let index = 0; index < attributesNames.length; index++) {\r\n            try {\r\n                results.push(this._gl.getAttribLocation(webGLPipelineContext.program!, attributesNames[index]));\r\n            } catch (e) {\r\n                results.push(-1);\r\n            }\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /**\r\n     * Activates an effect, making it the current one (ie. the one used for rendering)\r\n     * @param effect defines the effect to activate\r\n     */\r\n    public enableEffect(effect: Nullable<Effect | DrawWrapper>): void {\r\n        effect = effect !== null && DrawWrapper.IsWrapper(effect) ? effect.effect : effect; // get only the effect, we don't need a Wrapper in the WebGL engine\r\n\r\n        if (!effect || effect === this._currentEffect) {\r\n            return;\r\n        }\r\n\r\n        this._stencilStateComposer.stencilMaterial = undefined;\r\n\r\n        effect = effect as Effect;\r\n\r\n        // Use program\r\n        this.bindSamplers(effect);\r\n\r\n        this._currentEffect = effect;\r\n\r\n        if (effect.onBind) {\r\n            effect.onBind(effect);\r\n        }\r\n        if (effect._onBindObservable) {\r\n            effect._onBindObservable.notifyObservers(effect);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (int)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the int number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1i(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2i(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3i(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a int4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setInt4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4i(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1iv(uniform, array);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray2(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray3(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setIntArray4(uniform: Nullable<WebGLUniformLocation>, array: Int32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4iv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (unsigned int)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the unsigned int number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setUInt(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1ui(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a unsigned int2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setUInt2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2ui(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a unsigned int3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setUInt3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3ui(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a unsigned int4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setUInt4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4ui(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of unsigned int32\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of unsigned int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setUIntArray(uniform: Nullable<WebGLUniformLocation>, array: Uint32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1uiv(uniform, array);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of unsigned int32 (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of unsigned int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setUIntArray2(uniform: Nullable<WebGLUniformLocation>, array: Uint32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2uiv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of unsigned int32 (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of unsigned int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setUIntArray3(uniform: Nullable<WebGLUniformLocation>, array: Uint32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3uiv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of unsigned int32 (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of unsigned int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setUIntArray4(uniform: Nullable<WebGLUniformLocation>, array: Uint32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4uiv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        if (array.length < 1) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1fv(uniform, array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray2(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray3(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setArray4(uniform: Nullable<WebGLUniformLocation>, array: number[] | Float32Array): boolean {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4fv(uniform, <any>array);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to an array of float32 (stored as matrices)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrices defines the array of float32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrices(uniform: Nullable<WebGLUniformLocation>, matrices: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix4fv(uniform, false, matrices);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (3x3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix3x3(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix3fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a matrix (2x2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    public setMatrix2x2(uniform: Nullable<WebGLUniformLocation>, matrix: Float32Array): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniformMatrix2fv(uniform, false, matrix);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a number (float)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the float number to store\r\n     * @returns true if the value was transferred\r\n     */\r\n    public setFloat(uniform: Nullable<WebGLUniformLocation>, value: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform1f(uniform, value);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat2(uniform: Nullable<WebGLUniformLocation>, x: number, y: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform2f(uniform, x, y);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat3(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform3f(uniform, x, y, z);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Set the value of an uniform to a vec4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    public setFloat4(uniform: Nullable<WebGLUniformLocation>, x: number, y: number, z: number, w: number): boolean {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n\r\n        this._gl.uniform4f(uniform, x, y, z, w);\r\n\r\n        return true;\r\n    }\r\n\r\n    // States\r\n\r\n    /**\r\n     * Apply all cached states (depth, culling, stencil and alpha)\r\n     */\r\n    public applyStates() {\r\n        this._depthCullingState.apply(this._gl);\r\n        this._stencilStateComposer.apply(this._gl);\r\n        this._alphaState.apply(this._gl);\r\n\r\n        if (this._colorWriteChanged) {\r\n            this._colorWriteChanged = false;\r\n            const enable = this._colorWrite;\r\n            this._gl.colorMask(enable, enable, enable, enable);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    public setColorWrite(enable: boolean): void {\r\n        if (enable !== this._colorWrite) {\r\n            this._colorWriteChanged = true;\r\n            this._colorWrite = enable;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    public getColorWrite(): boolean {\r\n        return this._colorWrite;\r\n    }\r\n\r\n    /**\r\n     * Gets the depth culling state manager\r\n     */\r\n    public get depthCullingState(): DepthCullingState {\r\n        return this._depthCullingState;\r\n    }\r\n\r\n    /**\r\n     * Gets the alpha state manager\r\n     */\r\n    public get alphaState(): AlphaState {\r\n        return this._alphaState;\r\n    }\r\n\r\n    /**\r\n     * Gets the stencil state manager\r\n     */\r\n    public get stencilState(): StencilState {\r\n        return this._stencilState;\r\n    }\r\n\r\n    /**\r\n     * Gets the stencil state composer\r\n     */\r\n    public get stencilStateComposer(): StencilStateComposer {\r\n        return this._stencilStateComposer;\r\n    }\r\n\r\n    // Textures\r\n\r\n    /**\r\n     * Clears the list of texture accessible through engine.\r\n     * This can help preventing texture load conflict due to name collision.\r\n     */\r\n    public clearInternalTexturesCache() {\r\n        this._internalTexturesCache.length = 0;\r\n    }\r\n\r\n    /**\r\n     * Force the entire cache to be cleared\r\n     * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n     * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n     */\r\n    public wipeCaches(bruteForce?: boolean): void {\r\n        if (this.preventCacheWipeBetweenFrames && !bruteForce) {\r\n            return;\r\n        }\r\n        this._currentEffect = null;\r\n        this._viewportCached.x = 0;\r\n        this._viewportCached.y = 0;\r\n        this._viewportCached.z = 0;\r\n        this._viewportCached.w = 0;\r\n\r\n        // Done before in case we clean the attributes\r\n        this._unbindVertexArrayObject();\r\n\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n            this.resetTextureCache();\r\n\r\n            this._stencilStateComposer.reset();\r\n\r\n            this._depthCullingState.reset();\r\n            this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n\r\n            this._alphaState.reset();\r\n            this._alphaMode = Constants.ALPHA_ADD;\r\n            this._alphaEquation = Constants.ALPHA_DISABLE;\r\n\r\n            this._colorWrite = true;\r\n            this._colorWriteChanged = true;\r\n\r\n            this._unpackFlipYCached = null;\r\n\r\n            this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n            this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\r\n\r\n            this._mustWipeVertexAttributes = true;\r\n            this.unbindAllAttributes();\r\n        }\r\n\r\n        this._resetVertexBufferBinding();\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n        this.bindIndexBuffer(null);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getSamplingParameters(samplingMode: number, generateMipMaps: boolean): { min: number; mag: number } {\r\n        const gl = this._gl;\r\n        let magFilter: GLenum = gl.NEAREST;\r\n        let minFilter: GLenum = gl.NEAREST;\r\n\r\n        switch (samplingMode) {\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPLINEAR:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST_MIPNEAREST:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPNEAREST:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR_MIPLINEAR:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_LINEAR:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case Constants.TEXTURE_NEAREST_NEAREST:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPNEAREST:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST_MIPLINEAR:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                } else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_LINEAR:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case Constants.TEXTURE_LINEAR_NEAREST:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n        }\r\n\r\n        return {\r\n            min: minFilter,\r\n            mag: magFilter,\r\n        };\r\n    }\r\n\r\n    /** @internal */\r\n    protected _createTexture(): WebGLTexture {\r\n        const texture = this._gl.createTexture();\r\n\r\n        if (!texture) {\r\n            throw new Error(\"Unable to create texture\");\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /** @internal */\r\n    public _createHardwareTexture(): HardwareTextureWrapper {\r\n        return new WebGLHardwareTexture(this._createTexture(), this._gl);\r\n    }\r\n\r\n    /**\r\n     * Creates an internal texture without binding it to a framebuffer\r\n     * @internal\r\n     * @param size defines the size of the texture\r\n     * @param options defines the options used to create the texture\r\n     * @param delayGPUTextureCreation true to delay the texture creation the first time it is really needed. false to create it right away\r\n     * @param source source type of the texture\r\n     * @returns a new internal texture\r\n     */\r\n    public _createInternalTexture(\r\n        size: TextureSize,\r\n        options: boolean | InternalTextureCreationOptions,\r\n        delayGPUTextureCreation = true,\r\n        source = InternalTextureSource.Unknown\r\n    ): InternalTexture {\r\n        let generateMipMaps = false;\r\n        let type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n        let samplingMode = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE;\r\n        let format = Constants.TEXTUREFORMAT_RGBA;\r\n        let useSRGBBuffer = false;\r\n        let samples = 1;\r\n        let label: string | undefined;\r\n        if (options !== undefined && typeof options === \"object\") {\r\n            generateMipMaps = !!options.generateMipMaps;\r\n            type = options.type === undefined ? Constants.TEXTURETYPE_UNSIGNED_INT : options.type;\r\n            samplingMode = options.samplingMode === undefined ? Constants.TEXTURE_TRILINEAR_SAMPLINGMODE : options.samplingMode;\r\n            format = options.format === undefined ? Constants.TEXTUREFORMAT_RGBA : options.format;\r\n            useSRGBBuffer = options.useSRGBBuffer === undefined ? false : options.useSRGBBuffer;\r\n            samples = options.samples ?? 1;\r\n            label = options.label;\r\n        } else {\r\n            generateMipMaps = !!options;\r\n        }\r\n\r\n        useSRGBBuffer &&= this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU);\r\n\r\n        if (type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloatLinearFiltering) {\r\n            // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        } else if (type === Constants.TEXTURETYPE_HALF_FLOAT && !this._caps.textureHalfFloatLinearFiltering) {\r\n            // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            samplingMode = Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        }\r\n        if (type === Constants.TEXTURETYPE_FLOAT && !this._caps.textureFloat) {\r\n            type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n            Logger.Warn(\"Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE\");\r\n        }\r\n\r\n        const gl = this._gl;\r\n        const texture = new InternalTexture(this, source);\r\n        const width = (<{ width: number; height: number; layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number; layers?: number }>size).height || <number>size;\r\n        const layers = (<{ width: number; height: number; layers?: number }>size).layers || 0;\r\n        const filters = this._getSamplingParameters(samplingMode, generateMipMaps);\r\n        const target = layers !== 0 ? gl.TEXTURE_2D_ARRAY : gl.TEXTURE_2D;\r\n        const sizedFormat = this._getRGBABufferInternalSizedFormat(type, format, useSRGBBuffer);\r\n        const internalFormat = this._getInternalFormat(format);\r\n        const textureType = this._getWebGLTextureType(type);\r\n\r\n        // Bind\r\n        this._bindTextureDirectly(target, texture);\r\n\r\n        if (layers !== 0) {\r\n            texture.is2DArray = true;\r\n            gl.texImage3D(target, 0, sizedFormat, width, height, layers, 0, internalFormat, textureType, null);\r\n        } else {\r\n            gl.texImage2D(target, 0, sizedFormat, width, height, 0, internalFormat, textureType, null);\r\n        }\r\n\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, filters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        // MipMaps\r\n        if (generateMipMaps) {\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n\r\n        texture._useSRGBBuffer = useSRGBBuffer;\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = width;\r\n        texture.height = height;\r\n        texture.depth = layers;\r\n        texture.isReady = true;\r\n        texture.samples = samples;\r\n        texture.generateMipMaps = generateMipMaps;\r\n        texture.samplingMode = samplingMode;\r\n        texture.type = type;\r\n        texture.format = format;\r\n        texture.label = label;\r\n\r\n        this._internalTexturesCache.push(texture);\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getUseSRGBBuffer(useSRGBBuffer: boolean, noMipmap: boolean): boolean {\r\n        // Generating mipmaps for sRGB textures is not supported in WebGL1 so we must disable the support if mipmaps is enabled\r\n        return useSRGBBuffer && this._caps.supportSRGBBuffers && (this.webGLVersion > 1 || this.isWebGPU || noMipmap);\r\n    }\r\n\r\n    protected _createTextureBase(\r\n        url: Nullable<string>,\r\n        noMipmap: boolean,\r\n        invertY: boolean,\r\n        scene: Nullable<ISceneLike>,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,\r\n        onLoad: Nullable<(texture: InternalTexture) => void> = null,\r\n        onError: Nullable<(message: string, exception: any) => void> = null,\r\n        prepareTexture: (\r\n            texture: InternalTexture,\r\n            extension: string,\r\n            scene: Nullable<ISceneLike>,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            invertY: boolean,\r\n            noMipmap: boolean,\r\n            isCompressed: boolean,\r\n            processFunction: (\r\n                width: number,\r\n                height: number,\r\n                img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n                extension: string,\r\n                texture: InternalTexture,\r\n                continuationCallback: () => void\r\n            ) => boolean,\r\n            samplingMode: number\r\n        ) => void,\r\n        prepareTextureProcessFunction: (\r\n            width: number,\r\n            height: number,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            extension: string,\r\n            texture: InternalTexture,\r\n            continuationCallback: () => void\r\n        ) => boolean,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null,\r\n        mimeType?: string,\r\n        loaderOptions?: any,\r\n        useSRGBBuffer?: boolean\r\n    ): InternalTexture {\r\n        url = url || \"\";\r\n        const fromData = url.substr(0, 5) === \"data:\";\r\n        const fromBlob = url.substr(0, 5) === \"blob:\";\r\n        const isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n\r\n        const texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n\r\n        if (texture !== fallback) {\r\n            texture.label = url.substring(0, 60); // default label, can be overriden by the caller\r\n        }\r\n\r\n        const originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n\r\n        if (originalUrl !== url) {\r\n            texture._originalUrl = originalUrl;\r\n        }\r\n\r\n        // establish the file extension, if possible\r\n        const lastDot = url.lastIndexOf(\".\");\r\n        let extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\r\n        let loader: Nullable<IInternalTextureLoader> = null;\r\n\r\n        // Remove query string\r\n        const queryStringIndex = extension.indexOf(\"?\");\r\n\r\n        if (queryStringIndex > -1) {\r\n            extension = extension.split(\"?\")[0];\r\n        }\r\n\r\n        for (const availableLoader of ThinEngine._TextureLoaders) {\r\n            if (availableLoader.canLoad(extension, mimeType)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (scene) {\r\n            scene.addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        texture._useSRGBBuffer = this._getUseSRGBBuffer(!!useSRGBBuffer, noMipmap);\r\n\r\n        if (!this._doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n\r\n        let onLoadObserver: Nullable<Observer<InternalTexture>> = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n\r\n        if (!fallback) {\r\n            this._internalTexturesCache.push(texture);\r\n        }\r\n\r\n        const onInternalError = (message?: string, exception?: any) => {\r\n            if (scene) {\r\n                scene.removePendingData(texture);\r\n            }\r\n\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    this._createTextureBase(\r\n                        EngineStore.FallbackTexture,\r\n                        noMipmap,\r\n                        texture.invertY,\r\n                        scene,\r\n                        samplingMode,\r\n                        null,\r\n                        onError,\r\n                        prepareTexture,\r\n                        prepareTextureProcessFunction,\r\n                        buffer,\r\n                        texture\r\n                    );\r\n                }\r\n\r\n                message = (message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\");\r\n                texture.onErrorObservable.notifyObservers({ message, exception });\r\n                if (onError) {\r\n                    onError(message, exception);\r\n                }\r\n            } else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`);\r\n                this._createTextureBase(\r\n                    originalUrl,\r\n                    noMipmap,\r\n                    texture.invertY,\r\n                    scene,\r\n                    samplingMode,\r\n                    onLoad,\r\n                    onError,\r\n                    prepareTexture,\r\n                    prepareTextureProcessFunction,\r\n                    buffer,\r\n                    texture,\r\n                    format,\r\n                    forcedExtension,\r\n                    mimeType,\r\n                    loaderOptions,\r\n                    useSRGBBuffer\r\n                );\r\n            }\r\n        };\r\n\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            const callback = (data: ArrayBufferView) => {\r\n                loader!.loadData(\r\n                    data,\r\n                    texture,\r\n                    (width: number, height: number, loadMipmap: boolean, isCompressed: boolean, done: () => void, loadFailed) => {\r\n                        if (loadFailed) {\r\n                            onInternalError(\"TextureLoader failed to load data\");\r\n                        } else {\r\n                            prepareTexture(\r\n                                texture,\r\n                                extension,\r\n                                scene,\r\n                                { width, height },\r\n                                texture.invertY,\r\n                                !loadMipmap,\r\n                                isCompressed,\r\n                                () => {\r\n                                    done();\r\n                                    return false;\r\n                                },\r\n                                samplingMode\r\n                            );\r\n                        }\r\n                    },\r\n                    loaderOptions\r\n                );\r\n            };\r\n\r\n            if (!buffer) {\r\n                this._loadFile(\r\n                    url,\r\n                    (data) => callback(new Uint8Array(data as ArrayBuffer)),\r\n                    undefined,\r\n                    scene ? scene.offlineProvider : undefined,\r\n                    true,\r\n                    (request?: IWebRequest, exception?: any) => {\r\n                        onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                    }\r\n                );\r\n            } else {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    callback(new Uint8Array(buffer));\r\n                } else if (ArrayBuffer.isView(buffer)) {\r\n                    callback(buffer);\r\n                } else {\r\n                    if (onError) {\r\n                        onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            const onload = (img: HTMLImageElement | ImageBitmap) => {\r\n                if (fromBlob && !this._doNotHandleContextLost) {\r\n                    // We need to store the image if we need to rebuild the texture\r\n                    // in case of a webgl context lost\r\n                    texture._buffer = img;\r\n                }\r\n\r\n                prepareTexture(texture, extension, scene, img, texture.invertY, noMipmap, false, prepareTextureProcessFunction, samplingMode);\r\n            };\r\n            // According to the WebGL spec section 6.10, ImageBitmaps must be inverted on creation.\r\n            // So, we pass imageOrientation to _FileToolsLoadImage() as it may create an ImageBitmap.\r\n\r\n            if (!fromData || isBase64) {\r\n                if (buffer && (typeof (<HTMLImageElement>buffer).decoding === \"string\" || (<ImageBitmap>buffer).close)) {\r\n                    onload(<HTMLImageElement>buffer);\r\n                } else {\r\n                    ThinEngine._FileToolsLoadImage(\r\n                        url,\r\n                        onload,\r\n                        onInternalError,\r\n                        scene ? scene.offlineProvider : null,\r\n                        mimeType,\r\n                        texture.invertY && this._features.needsInvertingBitmap ? { imageOrientation: \"flipY\" } : undefined\r\n                    );\r\n                }\r\n            } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\r\n                ThinEngine._FileToolsLoadImage(\r\n                    buffer,\r\n                    onload,\r\n                    onInternalError,\r\n                    scene ? scene.offlineProvider : null,\r\n                    mimeType,\r\n                    texture.invertY && this._features.needsInvertingBitmap ? { imageOrientation: \"flipY\" } : undefined\r\n                );\r\n            } else if (buffer) {\r\n                onload(buffer);\r\n            }\r\n        }\r\n\r\n        return texture;\r\n    }\r\n\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @param creationFlags specific flags to use when creating the texture (Constants.TEXTURE_CREATIONFLAG_STORAGE for storage textures, for eg)\r\n     * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    public createTexture(\r\n        url: Nullable<string>,\r\n        noMipmap: boolean,\r\n        invertY: boolean,\r\n        scene: Nullable<ISceneLike>,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE,\r\n        onLoad: Nullable<(texture: InternalTexture) => void> = null,\r\n        onError: Nullable<(message: string, exception: any) => void> = null,\r\n        buffer: Nullable<string | ArrayBuffer | ArrayBufferView | HTMLImageElement | Blob | ImageBitmap> = null,\r\n        fallback: Nullable<InternalTexture> = null,\r\n        format: Nullable<number> = null,\r\n        forcedExtension: Nullable<string> = null,\r\n        mimeType?: string,\r\n        loaderOptions?: any,\r\n        creationFlags?: number,\r\n        useSRGBBuffer?: boolean\r\n    ): InternalTexture {\r\n        return this._createTextureBase(\r\n            url,\r\n            noMipmap,\r\n            invertY,\r\n            scene,\r\n            samplingMode,\r\n            onLoad,\r\n            onError,\r\n            this._prepareWebGLTexture.bind(this),\r\n            (potWidth, potHeight, img, extension, texture, continuationCallback) => {\r\n                const gl = this._gl;\r\n                const isPot = img.width === potWidth && img.height === potHeight;\r\n\r\n                const tip = this._getTexImageParametersForCreateTexture(format, extension, texture._useSRGBBuffer);\r\n                if (isPot) {\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, img as any);\r\n                    return false;\r\n                }\r\n\r\n                const maxTextureSize = this._caps.maxTextureSize;\r\n\r\n                if (img.width > maxTextureSize || img.height > maxTextureSize || !this._supportsHardwareTextureRescaling) {\r\n                    this._prepareWorkingCanvas();\r\n                    if (!this._workingCanvas || !this._workingContext) {\r\n                        return false;\r\n                    }\r\n\r\n                    this._workingCanvas.width = potWidth;\r\n                    this._workingCanvas.height = potHeight;\r\n\r\n                    this._workingContext.drawImage(img as any, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, this._workingCanvas as TexImageSource);\r\n\r\n                    texture.width = potWidth;\r\n                    texture.height = potHeight;\r\n\r\n                    return false;\r\n                } else {\r\n                    // Using shaders when possible to rescale because canvas.drawImage is lossy\r\n                    const source = new InternalTexture(this, InternalTextureSource.Temp);\r\n                    this._bindTextureDirectly(gl.TEXTURE_2D, source, true);\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, tip.internalFormat, tip.format, tip.type, img as any);\r\n\r\n                    this._rescaleTexture(source, texture, scene, tip.format, () => {\r\n                        this._releaseTexture(source);\r\n                        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n\r\n                        continuationCallback();\r\n                    });\r\n                }\r\n\r\n                return true;\r\n            },\r\n            buffer,\r\n            fallback,\r\n            format,\r\n            forcedExtension,\r\n            mimeType,\r\n            loaderOptions,\r\n            useSRGBBuffer\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Calls to the GL texImage2D and texImage3D functions require three arguments describing the pixel format of the texture.\r\n     * createTexture derives these from the babylonFormat and useSRGBBuffer arguments and also the file extension of the URL it's working with.\r\n     * This function encapsulates that derivation for easy unit testing.\r\n     * @param babylonFormat Babylon's format enum, as specified in ITextureCreationOptions.\r\n     * @param fileExtension The file extension including the dot, e.g. .jpg.\r\n     * @param useSRGBBuffer Use SRGB not linear.\r\n     * @returns The options to pass to texImage2D or texImage3D calls.\r\n     * @internal\r\n     */\r\n    public _getTexImageParametersForCreateTexture(babylonFormat: Nullable<number>, fileExtension: string, useSRGBBuffer: boolean): TexImageParameters {\r\n        if (babylonFormat === undefined || babylonFormat === null) {\r\n            babylonFormat = fileExtension === \".jpg\" && !useSRGBBuffer ? Constants.TEXTUREFORMAT_RGB : Constants.TEXTUREFORMAT_RGBA;\r\n        }\r\n\r\n        let format: number, internalFormat: number;\r\n        if (this.webGLVersion === 1) {\r\n            // In WebGL 1, format and internalFormat must be the same and taken from a limited set of values, see https://docs.gl/es2/glTexImage2D.\r\n            // The SRGB extension (https://developer.mozilla.org/en-US/docs/Web/API/EXT_sRGB) adds some extra values, hence passing useSRGBBuffer\r\n            // to getInternalFormat.\r\n            format = this._getInternalFormat(babylonFormat, useSRGBBuffer);\r\n            internalFormat = format;\r\n        } else {\r\n            // In WebGL 2, format has a wider range of values and internal format can be one of the sized formats, see\r\n            // https://registry.khronos.org/OpenGL-Refpages/es3.0/html/glTexImage2D.xhtml.\r\n            // SRGB is included in the sized format and should not be passed in \"format\", hence always passing useSRGBBuffer as false.\r\n            format = this._getInternalFormat(babylonFormat, false);\r\n            internalFormat = this._getRGBABufferInternalSizedFormat(Constants.TEXTURETYPE_UNSIGNED_BYTE, babylonFormat, useSRGBBuffer);\r\n        }\r\n\r\n        return {\r\n            internalFormat,\r\n            format,\r\n            type: this._gl.UNSIGNED_BYTE,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Loads an image as an HTMLImageElement.\r\n     * @param input url string, ArrayBuffer, or Blob to load\r\n     * @param onLoad callback called when the image successfully loads\r\n     * @param onError callback called when the image fails to load\r\n     * @param offlineProvider offline provider for caching\r\n     * @param mimeType optional mime type\r\n     * @param imageBitmapOptions optional the options to use when creating an ImageBitmap\r\n     * @returns the HTMLImageElement of the loaded image\r\n     * @internal\r\n     */\r\n    public static _FileToolsLoadImage(\r\n        input: string | ArrayBuffer | ArrayBufferView | Blob,\r\n        onLoad: (img: HTMLImageElement | ImageBitmap) => void,\r\n        onError: (message?: string, exception?: any) => void,\r\n        offlineProvider: Nullable<IOfflineProvider>,\r\n        mimeType?: string,\r\n        imageBitmapOptions?: ImageBitmapOptions\r\n    ): Nullable<HTMLImageElement> {\r\n        throw _WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _rescaleTexture(source: InternalTexture, destination: InternalTexture, scene: Nullable<any>, internalFormat: number, onComplete: () => void): void {}\r\n\r\n    /**\r\n     * Creates a raw texture\r\n     * @param data defines the data to store in the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param format defines the format of the data\r\n     * @param generateMipMaps defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n     * @param compression defines the compression used (null by default)\r\n     * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n     * @param creationFlags specific flags to use when creating the texture (Constants.TEXTURE_CREATIONFLAG_STORAGE for storage textures, for eg)\r\n     * @param useSRGBBuffer defines if the texture must be loaded in a sRGB GPU buffer (if supported by the GPU).\r\n     * @returns the raw texture inside an InternalTexture\r\n     */\r\n    public createRawTexture(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        type: number = Constants.TEXTURETYPE_UNSIGNED_INT,\r\n        creationFlags = 0,\r\n        useSRGBBuffer: boolean = false\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw cube texture\r\n     * @param data defines the array of data to use to create each face\r\n     * @param size defines the size of the textures\r\n     * @param format defines the format of the data\r\n     * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n     * @param generateMipMaps  defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compression used (null by default)\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    public createRawCubeTexture(\r\n        data: Nullable<ArrayBufferView[]>,\r\n        size: number,\r\n        format: number,\r\n        type: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 3D texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the depth of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 3D texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture3D(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        depth: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        textureType = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    /**\r\n     * Creates a new raw 2D array texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the number of layers of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n     */\r\n    public createRawTexture2DArray(\r\n        data: Nullable<ArrayBufferView>,\r\n        width: number,\r\n        height: number,\r\n        depth: number,\r\n        format: number,\r\n        generateMipMaps: boolean,\r\n        invertY: boolean,\r\n        samplingMode: number,\r\n        compression: Nullable<string> = null,\r\n        textureType = Constants.TEXTURETYPE_UNSIGNED_INT\r\n    ): InternalTexture {\r\n        throw _WarnImport(\"Engine.RawTexture\");\r\n    }\r\n\r\n    private _unpackFlipYCached: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * In case you are sharing the context with other applications, it might\r\n     * be interested to not cache the unpack flip y state to ensure a consistent\r\n     * value would be set.\r\n     */\r\n    public enableUnpackFlipYCached = true;\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _unpackFlipY(value: boolean): void {\r\n        if (this._unpackFlipYCached !== value) {\r\n            this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\r\n\r\n            if (this.enableUnpackFlipYCached) {\r\n                this._unpackFlipYCached = value;\r\n            }\r\n        }\r\n    }\r\n\r\n    /** @internal */\r\n    public _getUnpackAlignement(): number {\r\n        return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\r\n    }\r\n\r\n    private _getTextureTarget(texture: InternalTexture): number {\r\n        if (texture.isCube) {\r\n            return this._gl.TEXTURE_CUBE_MAP;\r\n        } else if (texture.is3D) {\r\n            return this._gl.TEXTURE_3D;\r\n        } else if (texture.is2DArray || texture.isMultiview) {\r\n            return this._gl.TEXTURE_2D_ARRAY;\r\n        }\r\n        return this._gl.TEXTURE_2D;\r\n    }\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param samplingMode defines the required sampling mode\r\n     * @param texture defines the texture to update\r\n     * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n     */\r\n    public updateTextureSamplingMode(samplingMode: number, texture: InternalTexture, generateMipMaps: boolean = false): void {\r\n        const target = this._getTextureTarget(texture);\r\n        const filters = this._getSamplingParameters(samplingMode, texture.useMipMaps || generateMipMaps);\r\n\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (generateMipMaps) {\r\n            texture.generateMipMaps = true;\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n\r\n        texture.samplingMode = samplingMode;\r\n    }\r\n\r\n    /**\r\n     * Update the dimensions of a texture\r\n     * @param texture texture to update\r\n     * @param width new width of the texture\r\n     * @param height new height of the texture\r\n     * @param depth new depth of the texture\r\n     */\r\n    public updateTextureDimensions(texture: InternalTexture, width: number, height: number, depth: number = 1): void {}\r\n\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param texture defines the texture to update\r\n     * @param wrapU defines the texture wrap mode of the u coordinates\r\n     * @param wrapV defines the texture wrap mode of the v coordinates\r\n     * @param wrapR defines the texture wrap mode of the r coordinates\r\n     */\r\n    public updateTextureWrappingMode(texture: InternalTexture, wrapU: Nullable<number>, wrapV: Nullable<number> = null, wrapR: Nullable<number> = null): void {\r\n        const target = this._getTextureTarget(texture);\r\n\r\n        if (wrapU !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\r\n            texture._cachedWrapU = wrapU;\r\n        }\r\n        if (wrapV !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\r\n            texture._cachedWrapV = wrapV;\r\n        }\r\n        if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\r\n            texture._cachedWrapR = wrapR;\r\n        }\r\n\r\n        this._bindTextureDirectly(target, null);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _setupDepthStencilTexture(\r\n        internalTexture: InternalTexture,\r\n        size: number | { width: number; height: number; layers?: number },\r\n        generateStencil: boolean,\r\n        bilinearFiltering: boolean,\r\n        comparisonFunction: number,\r\n        samples = 1\r\n    ): void {\r\n        const width = (<{ width: number; height: number; layers?: number }>size).width || <number>size;\r\n        const height = (<{ width: number; height: number; layers?: number }>size).height || <number>size;\r\n        const layers = (<{ width: number; height: number; layers?: number }>size).layers || 0;\r\n\r\n        internalTexture.baseWidth = width;\r\n        internalTexture.baseHeight = height;\r\n        internalTexture.width = width;\r\n        internalTexture.height = height;\r\n        internalTexture.is2DArray = layers > 0;\r\n        internalTexture.depth = layers;\r\n        internalTexture.isReady = true;\r\n        internalTexture.samples = samples;\r\n        internalTexture.generateMipMaps = false;\r\n        internalTexture.samplingMode = bilinearFiltering ? Constants.TEXTURE_BILINEAR_SAMPLINGMODE : Constants.TEXTURE_NEAREST_SAMPLINGMODE;\r\n        internalTexture.type = Constants.TEXTURETYPE_UNSIGNED_INT;\r\n        internalTexture._comparisonFunction = comparisonFunction;\r\n\r\n        const gl = this._gl;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        const samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n        // TEXTURE_COMPARE_FUNC/MODE are only availble in WebGL2.\r\n        if (this.webGLVersion > 1) {\r\n            if (comparisonFunction === 0) {\r\n                gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, Constants.LEQUAL);\r\n                gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\r\n            } else {\r\n                gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\r\n                gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _uploadCompressedDataToTextureDirectly(\r\n        texture: InternalTexture,\r\n        internalFormat: number,\r\n        width: number,\r\n        height: number,\r\n        data: ArrayBufferView,\r\n        faceIndex: number = 0,\r\n        lod: number = 0\r\n    ) {\r\n        const gl = this._gl;\r\n\r\n        let target: GLenum = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        if (texture._useSRGBBuffer) {\r\n            switch (internalFormat) {\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2:\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL:\r\n                    // Note, if using ETC1 and sRGB is requested, this will use ETC2 if available.\r\n                    if (this._caps.etc2) {\r\n                        internalFormat = gl.COMPRESSED_SRGB8_ETC2;\r\n                    } else {\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC:\r\n                    if (this._caps.etc2) {\r\n                        internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;\r\n                    } else {\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:\r\n                    internalFormat = gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:\r\n                    internalFormat = gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:\r\n                    if (this._caps.s3tc_srgb) {\r\n                        internalFormat = gl.COMPRESSED_SRGB_S3TC_DXT1_EXT;\r\n                    } else {\r\n                        // S3TC sRGB extension not supported\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1:\r\n                    if (this._caps.s3tc_srgb) {\r\n                        internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;\r\n                    } else {\r\n                        // S3TC sRGB extension not supported\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:\r\n                    if (this._caps.s3tc_srgb) {\r\n                        internalFormat = gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;\r\n                    } else {\r\n                        // S3TC sRGB extension not supported\r\n                        texture._useSRGBBuffer = false;\r\n                    }\r\n                    break;\r\n                default:\r\n                    // We don't support a sRGB format corresponding to internalFormat, so revert to non sRGB format\r\n                    texture._useSRGBBuffer = false;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, <DataView>data);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _uploadDataToTextureDirectly(\r\n        texture: InternalTexture,\r\n        imageData: ArrayBufferView,\r\n        faceIndex: number = 0,\r\n        lod: number = 0,\r\n        babylonInternalFormat?: number,\r\n        useTextureWidthAndHeight = false\r\n    ): void {\r\n        const gl = this._gl;\r\n\r\n        const textureType = this._getWebGLTextureType(texture.type);\r\n        const format = this._getInternalFormat(texture.format);\r\n        const internalFormat =\r\n            babylonInternalFormat === undefined\r\n                ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format, texture._useSRGBBuffer)\r\n                : this._getInternalFormat(babylonInternalFormat, texture._useSRGBBuffer);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        let target: GLenum = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n\r\n        const lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\r\n        const lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\r\n        const width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\r\n        const height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\r\n\r\n        gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\r\n    }\r\n\r\n    /**\r\n     * Update a portion of an internal texture\r\n     * @param texture defines the texture to update\r\n     * @param imageData defines the data to store into the texture\r\n     * @param xOffset defines the x coordinates of the update rectangle\r\n     * @param yOffset defines the y coordinates of the update rectangle\r\n     * @param width defines the width of the update rectangle\r\n     * @param height defines the height of the update rectangle\r\n     * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n     * @param lod defines the lod level to update (0 by default)\r\n     * @param generateMipMaps defines whether to generate mipmaps or not\r\n     */\r\n    public updateTextureData(\r\n        texture: InternalTexture,\r\n        imageData: ArrayBufferView,\r\n        xOffset: number,\r\n        yOffset: number,\r\n        width: number,\r\n        height: number,\r\n        faceIndex: number = 0,\r\n        lod: number = 0,\r\n        generateMipMaps = false\r\n    ): void {\r\n        const gl = this._gl;\r\n\r\n        const textureType = this._getWebGLTextureType(texture.type);\r\n        const format = this._getInternalFormat(texture.format);\r\n\r\n        this._unpackFlipY(texture.invertY);\r\n\r\n        let targetForBinding: GLenum = gl.TEXTURE_2D;\r\n        let target: GLenum = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n            targetForBinding = gl.TEXTURE_CUBE_MAP;\r\n        }\r\n\r\n        this._bindTextureDirectly(targetForBinding, texture, true);\r\n\r\n        gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\r\n\r\n        if (generateMipMaps) {\r\n            this._gl.generateMipmap(target);\r\n        }\r\n\r\n        this._bindTextureDirectly(targetForBinding, null);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _uploadArrayBufferViewToTexture(texture: InternalTexture, imageData: ArrayBufferView, faceIndex: number = 0, lod: number = 0): void {\r\n        const gl = this._gl;\r\n        const bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\r\n\r\n        this._bindTextureDirectly(bindTarget, texture, true);\r\n\r\n        this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\r\n\r\n        this._bindTextureDirectly(bindTarget, null, true);\r\n    }\r\n\r\n    protected _prepareWebGLTextureContinuation(texture: InternalTexture, scene: Nullable<ISceneLike>, noMipmap: boolean, isCompressed: boolean, samplingMode: number): void {\r\n        const gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        const filters = this._getSamplingParameters(samplingMode, !noMipmap);\r\n\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\r\n\r\n        if (!noMipmap && !isCompressed) {\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n\r\n        // this.resetTextureCache();\r\n        if (scene) {\r\n            scene.removePendingData(texture);\r\n        }\r\n\r\n        texture.onLoadedObservable.notifyObservers(texture);\r\n        texture.onLoadedObservable.clear();\r\n    }\r\n\r\n    private _prepareWebGLTexture(\r\n        texture: InternalTexture,\r\n        extension: string,\r\n        scene: Nullable<ISceneLike>,\r\n        img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n        invertY: boolean,\r\n        noMipmap: boolean,\r\n        isCompressed: boolean,\r\n        processFunction: (\r\n            width: number,\r\n            height: number,\r\n            img: HTMLImageElement | ImageBitmap | { width: number; height: number },\r\n            extension: string,\r\n            texture: InternalTexture,\r\n            continuationCallback: () => void\r\n        ) => boolean,\r\n        samplingMode: number = Constants.TEXTURE_TRILINEAR_SAMPLINGMODE\r\n    ): void {\r\n        const maxTextureSize = this.getCaps().maxTextureSize;\r\n        const potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.width, maxTextureSize) : img.width);\r\n        const potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(img.height, maxTextureSize) : img.height);\r\n\r\n        const gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n\r\n        if (!texture._hardwareTexture) {\r\n            //  this.resetTextureCache();\r\n            if (scene) {\r\n                scene.removePendingData(texture);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n        this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\r\n\r\n        texture.baseWidth = img.width;\r\n        texture.baseHeight = img.height;\r\n        texture.width = potWidth;\r\n        texture.height = potHeight;\r\n        texture.isReady = true;\r\n        texture.type = texture.type !== -1 ? texture.type : Constants.TEXTURETYPE_UNSIGNED_BYTE;\r\n        texture.format = texture.format !== -1 ? texture.format : extension === \".jpg\" && !texture._useSRGBBuffer ? Constants.TEXTUREFORMAT_RGB : Constants.TEXTUREFORMAT_RGBA;\r\n\r\n        if (\r\n            processFunction(potWidth, potHeight, img, extension, texture, () => {\r\n                this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n            })\r\n        ) {\r\n            // Returning as texture needs extra async steps\r\n            return;\r\n        }\r\n\r\n        this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _setupFramebufferDepthAttachments(\r\n        generateStencilBuffer: boolean,\r\n        generateDepthBuffer: boolean,\r\n        width: number,\r\n        height: number,\r\n        samples = 1\r\n    ): Nullable<WebGLRenderbuffer> {\r\n        const gl = this._gl;\r\n\r\n        // Create the depth/stencil buffer\r\n        if (generateStencilBuffer && generateDepthBuffer) {\r\n            return this._createRenderBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\r\n        }\r\n        if (generateDepthBuffer) {\r\n            let depthFormat: GLenum = gl.DEPTH_COMPONENT16;\r\n            if (this._webGLVersion > 1) {\r\n                depthFormat = gl.DEPTH_COMPONENT32F;\r\n            }\r\n\r\n            return this._createRenderBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\r\n        }\r\n        if (generateStencilBuffer) {\r\n            return this._createRenderBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _createRenderBuffer(\r\n        width: number,\r\n        height: number,\r\n        samples: number,\r\n        internalFormat: number,\r\n        msInternalFormat: number,\r\n        attachment: number,\r\n        unbindBuffer = true\r\n    ): Nullable<WebGLRenderbuffer> {\r\n        const gl = this._gl;\r\n        const renderBuffer = gl.createRenderbuffer();\r\n        return this._updateRenderBuffer(renderBuffer, width, height, samples, internalFormat, msInternalFormat, attachment, unbindBuffer);\r\n    }\r\n\r\n    public _updateRenderBuffer(\r\n        renderBuffer: Nullable<WebGLRenderbuffer>,\r\n        width: number,\r\n        height: number,\r\n        samples: number,\r\n        internalFormat: number,\r\n        msInternalFormat: number,\r\n        attachment: number,\r\n        unbindBuffer = true\r\n    ): Nullable<WebGLRenderbuffer> {\r\n        const gl = this._gl;\r\n\r\n        gl.bindRenderbuffer(gl.RENDERBUFFER, renderBuffer);\r\n\r\n        if (samples > 1 && gl.renderbufferStorageMultisample) {\r\n            gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\r\n        } else {\r\n            gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\r\n        }\r\n\r\n        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, renderBuffer);\r\n\r\n        if (unbindBuffer) {\r\n            gl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n        }\r\n\r\n        return renderBuffer;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _releaseTexture(texture: InternalTexture): void {\r\n        this._deleteTexture(texture._hardwareTexture?.underlyingResource);\r\n\r\n        // Unbind channels\r\n        this.unbindAllTextures();\r\n\r\n        const index = this._internalTexturesCache.indexOf(texture);\r\n        if (index !== -1) {\r\n            this._internalTexturesCache.splice(index, 1);\r\n        }\r\n\r\n        // Integrated fixed lod samplers.\r\n        if (texture._lodTextureHigh) {\r\n            texture._lodTextureHigh.dispose();\r\n        }\r\n        if (texture._lodTextureMid) {\r\n            texture._lodTextureMid.dispose();\r\n        }\r\n        if (texture._lodTextureLow) {\r\n            texture._lodTextureLow.dispose();\r\n        }\r\n\r\n        // Integrated irradiance map.\r\n        if (texture._irradianceTexture) {\r\n            texture._irradianceTexture.dispose();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _releaseRenderTargetWrapper(rtWrapper: RenderTargetWrapper): void {\r\n        const index = this._renderTargetWrapperCache.indexOf(rtWrapper);\r\n        if (index !== -1) {\r\n            this._renderTargetWrapperCache.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    protected _deleteTexture(texture: Nullable<WebGLTexture>): void {\r\n        if (texture) {\r\n            this._gl.deleteTexture(texture);\r\n        }\r\n    }\r\n\r\n    protected _setProgram(program: WebGLProgram): void {\r\n        if (this._currentProgram !== program) {\r\n            this._gl.useProgram(program);\r\n            this._currentProgram = program;\r\n        }\r\n    }\r\n\r\n    protected _boundUniforms: { [key: number]: WebGLUniformLocation } = {};\r\n\r\n    /**\r\n     * Binds an effect to the webGL context\r\n     * @param effect defines the effect to bind\r\n     */\r\n    public bindSamplers(effect: Effect): void {\r\n        const webGLPipelineContext = effect.getPipelineContext() as WebGLPipelineContext;\r\n        this._setProgram(webGLPipelineContext.program!);\r\n        const samplers = effect.getSamplers();\r\n        for (let index = 0; index < samplers.length; index++) {\r\n            const uniform = effect.getUniform(samplers[index]);\r\n\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    }\r\n\r\n    private _activateCurrentTexture() {\r\n        if (this._currentTextureChannel !== this._activeChannel) {\r\n            this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\r\n            this._currentTextureChannel = this._activeChannel;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _bindTextureDirectly(target: number, texture: Nullable<InternalTexture>, forTextureDataUpdate = false, force = false): boolean {\r\n        let wasPreviouslyBound = false;\r\n        const isTextureForRendering = texture && texture._associatedChannel > -1;\r\n        if (forTextureDataUpdate && isTextureForRendering) {\r\n            this._activeChannel = texture!._associatedChannel;\r\n        }\r\n\r\n        const currentTextureBound = this._boundTexturesCache[this._activeChannel];\r\n\r\n        if (currentTextureBound !== texture || force) {\r\n            this._activateCurrentTexture();\r\n\r\n            if (texture && texture.isMultiview) {\r\n                //this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\r\n                console.error(target, texture);\r\n                throw \"_bindTextureDirectly called with a multiview texture!\";\r\n            } else {\r\n                this._gl.bindTexture(target, texture?._hardwareTexture?.underlyingResource ?? null);\r\n            }\r\n\r\n            this._boundTexturesCache[this._activeChannel] = texture;\r\n\r\n            if (texture) {\r\n                texture._associatedChannel = this._activeChannel;\r\n            }\r\n        } else if (forTextureDataUpdate) {\r\n            wasPreviouslyBound = true;\r\n            this._activateCurrentTexture();\r\n        }\r\n\r\n        if (isTextureForRendering && !forTextureDataUpdate) {\r\n            this._bindSamplerUniformToChannel(texture!._associatedChannel, this._activeChannel);\r\n        }\r\n\r\n        return wasPreviouslyBound;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _bindTexture(channel: number, texture: Nullable<InternalTexture>, name: string): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (texture) {\r\n            texture._associatedChannel = channel;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\r\n        this._bindTextureDirectly(target, texture);\r\n    }\r\n\r\n    /**\r\n     * Unbind all textures from the webGL context\r\n     */\r\n    public unbindAllTextures(): void {\r\n        for (let channel = 0; channel < this._maxSimultaneousTextures; channel++) {\r\n            this._activeChannel = channel;\r\n            this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n            this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n            if (this.webGLVersion > 1) {\r\n                this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a texture to the according uniform.\r\n     * @param channel The texture channel\r\n     * @param uniform The uniform to set\r\n     * @param texture The texture to apply\r\n     * @param name The name of the uniform in the effect\r\n     */\r\n    public setTexture(channel: number, uniform: Nullable<WebGLUniformLocation>, texture: Nullable<ThinTexture>, name: string): void {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n\r\n        if (uniform) {\r\n            this._boundUniforms[channel] = uniform;\r\n        }\r\n\r\n        this._setTexture(channel, texture);\r\n    }\r\n\r\n    private _bindSamplerUniformToChannel(sourceSlot: number, destination: number) {\r\n        const uniform = this._boundUniforms[sourceSlot];\r\n        if (!uniform || uniform._currentState === destination) {\r\n            return;\r\n        }\r\n        this._gl.uniform1i(uniform, destination);\r\n        uniform._currentState = destination;\r\n    }\r\n\r\n    private _getTextureWrapMode(mode: number): number {\r\n        switch (mode) {\r\n            case Constants.TEXTURE_WRAP_ADDRESSMODE:\r\n                return this._gl.REPEAT;\r\n            case Constants.TEXTURE_CLAMP_ADDRESSMODE:\r\n                return this._gl.CLAMP_TO_EDGE;\r\n            case Constants.TEXTURE_MIRROR_ADDRESSMODE:\r\n                return this._gl.MIRRORED_REPEAT;\r\n        }\r\n        return this._gl.REPEAT;\r\n    }\r\n\r\n    protected _setTexture(channel: number, texture: Nullable<ThinTexture>, isPartOfTextureArray = false, depthStencilTexture = false, name = \"\"): boolean {\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n                if (this.webGLVersion > 1) {\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n                }\r\n            }\r\n            return false;\r\n        }\r\n\r\n        // Video\r\n        if ((<VideoTexture>texture).video) {\r\n            this._activeChannel = channel;\r\n            const videoInternalTexture = (<VideoTexture>texture).getInternalTexture();\r\n            if (videoInternalTexture) {\r\n                videoInternalTexture._associatedChannel = channel;\r\n            }\r\n            (<VideoTexture>texture).update();\r\n        } else if (texture.delayLoadState === Constants.DELAYLOADSTATE_NOTLOADED) {\r\n            // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n\r\n        let internalTexture: InternalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = (<RenderTargetTexture>texture).depthStencilTexture!;\r\n        } else if (texture.isReady()) {\r\n            internalTexture = <InternalTexture>texture.getInternalTexture();\r\n        } else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        } else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        } else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        } else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n\r\n        if (!isPartOfTextureArray && internalTexture) {\r\n            internalTexture._associatedChannel = channel;\r\n        }\r\n\r\n        let needToBind = true;\r\n        if (this._boundTexturesCache[channel] === internalTexture) {\r\n            if (!isPartOfTextureArray) {\r\n                this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\r\n            }\r\n\r\n            needToBind = false;\r\n        }\r\n\r\n        this._activeChannel = channel;\r\n        const target = this._getTextureTarget(internalTexture);\r\n        if (needToBind) {\r\n            this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\r\n        }\r\n\r\n        if (internalTexture && !internalTexture.isMultiview) {\r\n            // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\r\n            if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\r\n                internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\r\n\r\n                const textureWrapMode =\r\n                    texture.coordinatesMode !== Constants.TEXTURE_CUBIC_MODE && texture.coordinatesMode !== Constants.TEXTURE_SKYBOX_MODE\r\n                        ? Constants.TEXTURE_WRAP_ADDRESSMODE\r\n                        : Constants.TEXTURE_CLAMP_ADDRESSMODE;\r\n                texture.wrapU = textureWrapMode;\r\n                texture.wrapV = textureWrapMode;\r\n            }\r\n\r\n            if (internalTexture._cachedWrapU !== texture.wrapU) {\r\n                internalTexture._cachedWrapU = texture.wrapU;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\r\n            }\r\n\r\n            if (internalTexture._cachedWrapV !== texture.wrapV) {\r\n                internalTexture._cachedWrapV = texture.wrapV;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\r\n            }\r\n\r\n            if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\r\n                internalTexture._cachedWrapR = texture.wrapR;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\r\n            }\r\n\r\n            this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Sets an array of texture to the webGL context\r\n     * @param channel defines the channel where the texture array must be set\r\n     * @param uniform defines the associated uniform location\r\n     * @param textures defines the array of textures to bind\r\n     * @param name name of the channel\r\n     */\r\n    public setTextureArray(channel: number, uniform: Nullable<WebGLUniformLocation>, textures: ThinTexture[], name: string): void {\r\n        if (channel === undefined || !uniform) {\r\n            return;\r\n        }\r\n\r\n        if (!this._textureUnits || this._textureUnits.length !== textures.length) {\r\n            this._textureUnits = new Int32Array(textures.length);\r\n        }\r\n        for (let i = 0; i < textures.length; i++) {\r\n            const texture = textures[i].getInternalTexture();\r\n\r\n            if (texture) {\r\n                this._textureUnits[i] = channel + i;\r\n                texture._associatedChannel = channel + i;\r\n            } else {\r\n                this._textureUnits[i] = -1;\r\n            }\r\n        }\r\n        this._gl.uniform1iv(uniform, this._textureUnits);\r\n\r\n        for (let index = 0; index < textures.length; index++) {\r\n            this._setTexture(this._textureUnits[index], textures[index], true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _setAnisotropicLevel(target: number, internalTexture: InternalTexture, anisotropicFilteringLevel: number) {\r\n        const anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\r\n        if (\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR_MIPNEAREST &&\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR_MIPLINEAR &&\r\n            internalTexture.samplingMode !== Constants.TEXTURE_LINEAR_LINEAR\r\n        ) {\r\n            anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\r\n        }\r\n\r\n        if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\r\n            this._setTextureParameterFloat(\r\n                target,\r\n                anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT,\r\n                Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy),\r\n                internalTexture\r\n            );\r\n            internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\r\n        }\r\n    }\r\n\r\n    private _setTextureParameterFloat(target: number, parameter: number, value: number, texture: InternalTexture): void {\r\n        this._bindTextureDirectly(target, texture, true, true);\r\n        this._gl.texParameterf(target, parameter, value);\r\n    }\r\n\r\n    private _setTextureParameterInteger(target: number, parameter: number, value: number, texture?: InternalTexture) {\r\n        if (texture) {\r\n            this._bindTextureDirectly(target, texture, true, true);\r\n        }\r\n        this._gl.texParameteri(target, parameter, value);\r\n    }\r\n\r\n    /**\r\n     * Unbind all vertex attributes from the webGL context\r\n     */\r\n    public unbindAllAttributes() {\r\n        if (this._mustWipeVertexAttributes) {\r\n            this._mustWipeVertexAttributes = false;\r\n\r\n            for (let i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n                this.disableAttributeByIndex(i);\r\n            }\r\n            return;\r\n        }\r\n\r\n        for (let i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\r\n            if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\r\n                continue;\r\n            }\r\n\r\n            this.disableAttributeByIndex(i);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n     */\r\n    public releaseEffects() {\r\n        for (const name in this._compiledEffects) {\r\n            const webGLPipelineContext = this._compiledEffects[name].getPipelineContext() as WebGLPipelineContext;\r\n            this._deletePipelineContext(webGLPipelineContext);\r\n        }\r\n\r\n        this._compiledEffects = {};\r\n    }\r\n\r\n    /**\r\n     * Dispose and release all associated resources\r\n     */\r\n    public dispose(): void {\r\n        this._isDisposed = true;\r\n        this.stopRenderLoop();\r\n\r\n        // Clear observables\r\n        if (this.onBeforeTextureInitObservable) {\r\n            this.onBeforeTextureInitObservable.clear();\r\n        }\r\n\r\n        // Empty texture\r\n        if (this._emptyTexture) {\r\n            this._releaseTexture(this._emptyTexture);\r\n            this._emptyTexture = null;\r\n        }\r\n        if (this._emptyCubeTexture) {\r\n            this._releaseTexture(this._emptyCubeTexture);\r\n            this._emptyCubeTexture = null;\r\n        }\r\n\r\n        if (this._dummyFramebuffer) {\r\n            this._gl.deleteFramebuffer(this._dummyFramebuffer);\r\n        }\r\n\r\n        // Release effects\r\n        this.releaseEffects();\r\n        this.releaseComputeEffects?.();\r\n\r\n        // Unbind\r\n        this.unbindAllAttributes();\r\n        this._boundUniforms = {};\r\n\r\n        // Events\r\n        if (IsWindowObjectExist()) {\r\n            if (this._renderingCanvas) {\r\n                if (!this._doNotHandleContextLost) {\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\r\n                }\r\n\r\n                window.removeEventListener(\"resize\", this._checkForMobile);\r\n            }\r\n        }\r\n\r\n        this._workingCanvas = null;\r\n        this._workingContext = null;\r\n        this._currentBufferPointers.length = 0;\r\n        this._renderingCanvas = null;\r\n        this._currentProgram = null;\r\n        this._boundRenderFunction = null;\r\n\r\n        Effect.ResetCache();\r\n\r\n        // Abort active requests\r\n        for (const request of this._activeRequests) {\r\n            request.abort();\r\n        }\r\n\r\n        this.onDisposeObservable.notifyObservers(this);\r\n        this.onDisposeObservable.clear();\r\n\r\n        if (this._creationOptions.loseContextOnDispose) {\r\n            this._gl.getExtension(\"WEBGL_lose_context\")?.loseContext();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context lost event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextLostEvent(callback: (event: WebGLContextEvent) => void): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextlost\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach a new callback raised when context restored event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    public attachContextRestoredEvent(callback: (event: WebGLContextEvent) => void): void {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextrestored\", <any>callback, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the current error code of the webGL context\r\n     * @returns the error code\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n     */\r\n    public getError(): number {\r\n        return this._gl.getError();\r\n    }\r\n\r\n    private _canRenderToFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(Constants.TEXTURETYPE_FLOAT);\r\n    }\r\n\r\n    private _canRenderToHalfFloatFramebuffer(): boolean {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(Constants.TEXTURETYPE_HALF_FLOAT);\r\n    }\r\n\r\n    // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\r\n    private _canRenderToFramebuffer(type: number): boolean {\r\n        const gl = this._gl;\r\n\r\n        //clear existing errors\r\n        // eslint-disable-next-line no-empty\r\n        while (gl.getError() !== gl.NO_ERROR) {}\r\n\r\n        let successful = true;\r\n\r\n        const texture = gl.createTexture();\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n\r\n        const fb = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\r\n        const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n\r\n        successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\r\n        successful = successful && gl.getError() === gl.NO_ERROR;\r\n\r\n        //try render by clearing frame buffer's color buffer\r\n        if (successful) {\r\n            gl.clear(gl.COLOR_BUFFER_BIT);\r\n            successful = successful && gl.getError() === gl.NO_ERROR;\r\n        }\r\n\r\n        //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\r\n        if (successful) {\r\n            //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            const readFormat = gl.RGBA;\r\n            const readType = gl.UNSIGNED_BYTE;\r\n            const buffer = new Uint8Array(4);\r\n            gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\r\n            successful = successful && gl.getError() === gl.NO_ERROR;\r\n        }\r\n\r\n        //clean up\r\n        gl.deleteTexture(texture);\r\n        gl.deleteFramebuffer(fb);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n        //clear accumulated errors\r\n        // eslint-disable-next-line no-empty\r\n        while (!successful && gl.getError() !== gl.NO_ERROR) {}\r\n\r\n        return successful;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getWebGLTextureType(type: number): number {\r\n        if (this._webGLVersion === 1) {\r\n            switch (type) {\r\n                case Constants.TEXTURETYPE_FLOAT:\r\n                    return this._gl.FLOAT;\r\n                case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                    return this._gl.HALF_FLOAT_OES;\r\n                case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                    return this._gl.UNSIGNED_BYTE;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                    return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                    return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n                case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                    return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            }\r\n            return this._gl.UNSIGNED_BYTE;\r\n        }\r\n\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_BYTE:\r\n                return this._gl.BYTE;\r\n            case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                return this._gl.UNSIGNED_BYTE;\r\n            case Constants.TEXTURETYPE_SHORT:\r\n                return this._gl.SHORT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT:\r\n                return this._gl.UNSIGNED_SHORT;\r\n            case Constants.TEXTURETYPE_INT:\r\n                return this._gl.INT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INTEGER: // Refers to UNSIGNED_INT\r\n                return this._gl.UNSIGNED_INT;\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                return this._gl.FLOAT;\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                return this._gl.HALF_FLOAT;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:\r\n                return this._gl.UNSIGNED_INT_2_10_10_10_REV;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_24_8:\r\n                return this._gl.UNSIGNED_INT_24_8;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:\r\n                return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:\r\n                return this._gl.UNSIGNED_INT_5_9_9_9_REV;\r\n            case Constants.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV:\r\n                return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\r\n        }\r\n\r\n        return this._gl.UNSIGNED_BYTE;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getInternalFormat(format: number, useSRGBBuffer = false): number {\r\n        let internalFormat: GLenum = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA;\r\n\r\n        switch (format) {\r\n            case Constants.TEXTUREFORMAT_ALPHA:\r\n                internalFormat = this._gl.ALPHA;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                internalFormat = this._gl.LUMINANCE;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                internalFormat = this._gl.LUMINANCE_ALPHA;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RED:\r\n                internalFormat = this._gl.RED;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RG:\r\n                internalFormat = this._gl.RG;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RGB:\r\n                internalFormat = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB : this._gl.RGB;\r\n                break;\r\n            case Constants.TEXTUREFORMAT_RGBA:\r\n                internalFormat = useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA;\r\n                break;\r\n        }\r\n\r\n        if (this._webGLVersion > 1) {\r\n            switch (format) {\r\n                case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                    internalFormat = this._gl.RED_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                    internalFormat = this._gl.RG_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                    internalFormat = this._gl.RGB_INTEGER;\r\n                    break;\r\n                case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                    internalFormat = this._gl.RGBA_INTEGER;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        return internalFormat;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getRGBABufferInternalSizedFormat(type: number, format?: number, useSRGBBuffer = false): number {\r\n        if (this._webGLVersion === 1) {\r\n            if (format !== undefined) {\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_ALPHA:\r\n                        return this._gl.ALPHA;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                        return this._gl.LUMINANCE;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB : this._gl.RGB;\r\n                }\r\n            }\r\n            return this._gl.RGBA;\r\n        }\r\n\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB8_SNORM;\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R8I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG8I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB8I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA8I;\r\n                    default:\r\n                        return this._gl.RGBA8_SNORM;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R8;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG8;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8 : this._gl.RGB8; // By default. Other possibilities are RGB565, SRGB8.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA8; // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R8UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG8UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB8UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA8UI;\r\n                    case Constants.TEXTUREFORMAT_ALPHA:\r\n                        return this._gl.ALPHA;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                        return this._gl.LUMINANCE;\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    default:\r\n                        return this._gl.RGBA8;\r\n                }\r\n            case Constants.TEXTURETYPE_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R16I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG16I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB16I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA16I;\r\n                    default:\r\n                        return this._gl.RGBA16I;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R16UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG16UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB16UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA16UI;\r\n                    default:\r\n                        return this._gl.RGBA16UI;\r\n                }\r\n            case Constants.TEXTURETYPE_INT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R32I;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG32I;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB32I;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA32I;\r\n                    default:\r\n                        return this._gl.RGBA32I;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_INTEGER: // Refers to UNSIGNED_INT\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return this._gl.R32UI;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return this._gl.RG32UI;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        return this._gl.RGB32UI;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGBA32UI;\r\n                    default:\r\n                        return this._gl.RGBA32UI;\r\n                }\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R32F; // By default. Other possibility is R16F.\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG32F; // By default. Other possibility is RG16F.\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB32F; // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGBA32F; // By default. Other possibility is RGBA16F.\r\n                    default:\r\n                        return this._gl.RGBA32F;\r\n                }\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return this._gl.R16F;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return this._gl.RG16F;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        return this._gl.RGB16F; // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGBA16F;\r\n                    default:\r\n                        return this._gl.RGBA16F;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                return this._gl.RGB565;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:\r\n                return this._gl.R11F_G11F_B10F;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:\r\n                return this._gl.RGB9_E5;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                return this._gl.RGBA4;\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                return this._gl.RGB5_A1;\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return this._gl.RGB10_A2; // By default. Other possibility is RGB5_A1.\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return this._gl.RGB10_A2UI;\r\n                    default:\r\n                        return this._gl.RGB10_A2;\r\n                }\r\n        }\r\n\r\n        return useSRGBBuffer ? this._glSRGBExtensionValues.SRGB8_ALPHA8 : this._gl.RGBA8;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _getRGBAMultiSampleBufferFormat(type: number, format = Constants.TEXTUREFORMAT_RGBA): number {\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_R:\r\n                        return this._gl.R32F;\r\n                    default:\r\n                        return this._gl.RGBA32F;\r\n                }\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_R:\r\n                        return this._gl.R16F;\r\n                    default:\r\n                        return this._gl.RGBA16F;\r\n                }\r\n        }\r\n\r\n        return this._gl.RGBA8;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    public _loadFile(\r\n        url: string,\r\n        onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void,\r\n        onProgress?: (data: any) => void,\r\n        offlineProvider?: IOfflineProvider,\r\n        useArrayBuffer?: boolean,\r\n        onError?: (request?: IWebRequest, exception?: any) => void\r\n    ): IFileRequest {\r\n        const request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\r\n        this._activeRequests.push(request);\r\n        request.onCompleteObservable.add((request) => {\r\n            this._activeRequests.splice(this._activeRequests.indexOf(request), 1);\r\n        });\r\n        return request;\r\n    }\r\n\r\n    /**\r\n     * Loads a file from a url\r\n     * @param url url to load\r\n     * @param onSuccess callback called when the file successfully loads\r\n     * @param onProgress callback called while file is loading (if the server supports this mode)\r\n     * @param offlineProvider defines the offline provider for caching\r\n     * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n     * @param onError callback called when the file fails to load\r\n     * @returns a file request object\r\n     * @internal\r\n     */\r\n    public static _FileToolsLoadFile(\r\n        url: string,\r\n        onSuccess: (data: string | ArrayBuffer, responseURL?: string) => void,\r\n        onProgress?: (ev: ProgressEvent) => void,\r\n        offlineProvider?: IOfflineProvider,\r\n        useArrayBuffer?: boolean,\r\n        onError?: (request?: WebRequest, exception?: LoadFileError) => void\r\n    ): IFileRequest {\r\n        throw _WarnImport(\"FileTools\");\r\n    }\r\n\r\n    /**\r\n     * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n     * @param x defines the x coordinate of the rectangle where pixels must be read\r\n     * @param y defines the y coordinate of the rectangle where pixels must be read\r\n     * @param width defines the width of the rectangle where pixels must be read\r\n     * @param height defines the height of the rectangle where pixels must be read\r\n     * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n     * @param flushRenderer true to flush the renderer from the pending commands before reading the pixels\r\n     * @returns a ArrayBufferView promise (Uint8Array) containing RGBA colors\r\n     */\r\n    public readPixels(x: number, y: number, width: number, height: number, hasAlpha = true, flushRenderer = true): Promise<ArrayBufferView> {\r\n        const numChannels = hasAlpha ? 4 : 3;\r\n        const format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\r\n        const data = new Uint8Array(height * width * numChannels);\r\n        if (flushRenderer) {\r\n            this.flushFramebuffer();\r\n        }\r\n        this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\r\n        return Promise.resolve(data);\r\n    }\r\n\r\n    // Statics\r\n\r\n    private static _IsSupported: Nullable<boolean> = null;\r\n    private static _HasMajorPerformanceCaveat: Nullable<boolean> = null;\r\n\r\n    /**\r\n     * Gets a Promise<boolean> indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     */\r\n    public static get IsSupportedAsync(): Promise<boolean> {\r\n        return Promise.resolve(this.isSupported());\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     */\r\n    public static get IsSupported(): boolean {\r\n        return this.isSupported(); // Backward compat\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated (ie. if a webGL context can be found)\r\n     * @returns true if the engine can be created\r\n     * @ignorenaming\r\n     */\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    public static isSupported(): boolean {\r\n        if (this._HasMajorPerformanceCaveat !== null) {\r\n            return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\r\n        }\r\n\r\n        if (this._IsSupported === null) {\r\n            try {\r\n                const tempcanvas = this._CreateCanvas(1, 1);\r\n                const gl = tempcanvas.getContext(\"webgl\") || (tempcanvas as any).getContext(\"experimental-webgl\");\r\n\r\n                this._IsSupported = gl != null && !!window.WebGLRenderingContext;\r\n            } catch (e) {\r\n                this._IsSupported = false;\r\n            }\r\n        }\r\n\r\n        return this._IsSupported;\r\n    }\r\n\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instantiated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n     */\r\n    public static get HasMajorPerformanceCaveat(): boolean {\r\n        if (this._HasMajorPerformanceCaveat === null) {\r\n            try {\r\n                const tempcanvas = this._CreateCanvas(1, 1);\r\n                const gl =\r\n                    tempcanvas.getContext(\"webgl\", { failIfMajorPerformanceCaveat: true }) ||\r\n                    (tempcanvas as any).getContext(\"experimental-webgl\", { failIfMajorPerformanceCaveat: true });\r\n\r\n                this._HasMajorPerformanceCaveat = !gl;\r\n            } catch (e) {\r\n                this._HasMajorPerformanceCaveat = false;\r\n            }\r\n        }\r\n\r\n        return this._HasMajorPerformanceCaveat;\r\n    }\r\n\r\n    /**\r\n     * Find the next highest power of two.\r\n     * @param x Number to start search from.\r\n     * @returns Next highest power of two.\r\n     */\r\n    public static CeilingPOT(x: number): number {\r\n        x--;\r\n        x |= x >> 1;\r\n        x |= x >> 2;\r\n        x |= x >> 4;\r\n        x |= x >> 8;\r\n        x |= x >> 16;\r\n        x++;\r\n        return x;\r\n    }\r\n\r\n    /**\r\n     * Find the next lowest power of two.\r\n     * @param x Number to start search from.\r\n     * @returns Next lowest power of two.\r\n     */\r\n    public static FloorPOT(x: number): number {\r\n        x = x | (x >> 1);\r\n        x = x | (x >> 2);\r\n        x = x | (x >> 4);\r\n        x = x | (x >> 8);\r\n        x = x | (x >> 16);\r\n        return x - (x >> 1);\r\n    }\r\n\r\n    /**\r\n     * Find the nearest power of two.\r\n     * @param x Number to start search from.\r\n     * @returns Next nearest power of two.\r\n     */\r\n    public static NearestPOT(x: number): number {\r\n        const c = ThinEngine.CeilingPOT(x);\r\n        const f = ThinEngine.FloorPOT(x);\r\n        return c - x > x - f ? f : c;\r\n    }\r\n\r\n    /**\r\n     * Get the closest exponent of two\r\n     * @param value defines the value to approximate\r\n     * @param max defines the maximum value to return\r\n     * @param mode defines how to define the closest value\r\n     * @returns closest exponent of two of the given value\r\n     */\r\n    public static GetExponentOfTwo(value: number, max: number, mode = Constants.SCALEMODE_NEAREST): number {\r\n        let pot;\r\n\r\n        switch (mode) {\r\n            case Constants.SCALEMODE_FLOOR:\r\n                pot = ThinEngine.FloorPOT(value);\r\n                break;\r\n            case Constants.SCALEMODE_NEAREST:\r\n                pot = ThinEngine.NearestPOT(value);\r\n                break;\r\n            case Constants.SCALEMODE_CEILING:\r\n            default:\r\n                pot = ThinEngine.CeilingPOT(value);\r\n                break;\r\n        }\r\n\r\n        return Math.min(pot, max);\r\n    }\r\n\r\n    /**\r\n     * Queue a new function into the requested animation frame pool (ie. this function will be executed by the browser (or the javascript engine) for the next frame)\r\n     * @param func - the function to be called\r\n     * @param requester - the object that will request the next frame. Falls back to window.\r\n     * @returns frame number\r\n     */\r\n    public static QueueNewFrame(func: () => void, requester?: any): number {\r\n        // Note that there is kind of a typing issue here, as `setTimeout` might return something else than a number (NodeJs returns a NodeJS.Timeout object).\r\n        // Also if the global `requestAnimationFrame`'s returnType is number, `requester.requestPostAnimationFrame` and `requester.requestAnimationFrame` types\r\n        // are `any`.\r\n\r\n        if (!IsWindowObjectExist()) {\r\n            if (typeof requestAnimationFrame === \"function\") {\r\n                return requestAnimationFrame(func);\r\n            }\r\n        } else {\r\n            const { requestAnimationFrame } = requester || window;\r\n            if (typeof requestAnimationFrame === \"function\") {\r\n                return requestAnimationFrame(func);\r\n            }\r\n        }\r\n\r\n        // fallback to the global `setTimeout`.\r\n        // In most cases (aka in the browser), `window` is the global object, so instead of calling `window.setTimeout` we could call the global `setTimeout`.\r\n        return setTimeout(func, 16) as unknown as number;\r\n    }\r\n\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    public getHostDocument(): Nullable<Document> {\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\r\n            return this._renderingCanvas.ownerDocument;\r\n        }\r\n\r\n        return IsDocumentAvailable() ? document : null;\r\n    }\r\n}\r\n\r\ninterface TexImageParameters {\r\n    internalFormat: number;\r\n    format: number;\r\n    type: number;\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}