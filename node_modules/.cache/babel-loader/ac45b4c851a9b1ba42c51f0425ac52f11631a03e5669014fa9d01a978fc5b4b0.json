{"ast":null,"code":"import { __decorate } from \"../tslib.es6.js\";\nimport { serialize, expandToProperty, serializeAsTexture, SerializationHelper } from \"../Misc/decorators.js\";\nimport { Vector4 } from \"../Maths/math.vector.js\";\nimport { EngineStore } from \"../Engines/engineStore.js\";\n/**\n * This class is used to animate meshes using a baked vertex animation texture\n * @see https://doc.babylonjs.com/features/featuresDeepDive/animation/baked_texture_animations\n * @since 5.0\n */\nexport class BakedVertexAnimationManager {\n  /**\n   * Creates a new BakedVertexAnimationManager\n   * @param scene defines the current scene\n   */\n  constructor(scene) {\n    this._texture = null;\n    this._isEnabled = true;\n    /**\n     * Enable or disable the vertex animation manager\n     */\n    this.isEnabled = true;\n    /**\n     * The time counter, to pick the correct animation frame.\n     */\n    this.time = 0;\n    scene = scene || EngineStore.LastCreatedScene;\n    if (!scene) {\n      return;\n    }\n    this._scene = scene;\n    this.animationParameters = new Vector4(0, 0, 0, 30);\n  }\n  /** @internal */\n  _markSubMeshesAsAttributesDirty() {\n    for (const mesh of this._scene.meshes) {\n      if (mesh.bakedVertexAnimationManager === this) {\n        mesh._markSubMeshesAsAttributesDirty();\n      }\n    }\n  }\n  /**\n   * Binds to the effect.\n   * @param effect The effect to bind to.\n   * @param useInstances True when it's an instance.\n   */\n  bind(effect, useInstances = false) {\n    if (!this._texture || !this._isEnabled) {\n      return;\n    }\n    const size = this._texture.getSize();\n    effect.setFloat2(\"bakedVertexAnimationTextureSizeInverted\", 1.0 / size.width, 1.0 / size.height);\n    effect.setFloat(\"bakedVertexAnimationTime\", this.time);\n    if (!useInstances) {\n      effect.setVector4(\"bakedVertexAnimationSettings\", this.animationParameters);\n    }\n    effect.setTexture(\"bakedVertexAnimationTexture\", this._texture);\n  }\n  /**\n   * Clone the current manager\n   * @returns a new BakedVertexAnimationManager\n   */\n  clone() {\n    const copy = new BakedVertexAnimationManager(this._scene);\n    this.copyTo(copy);\n    return copy;\n  }\n  /**\n   * Sets animation parameters.\n   * @param startFrame The first frame of the animation.\n   * @param endFrame The last frame of the animation.\n   * @param offset The offset when starting the animation.\n   * @param speedFramesPerSecond The frame rate.\n   */\n  setAnimationParameters(startFrame, endFrame, offset = 0, speedFramesPerSecond = 30) {\n    this.animationParameters = new Vector4(startFrame, endFrame, offset, speedFramesPerSecond);\n  }\n  /**\n   * Disposes the resources of the manager.\n   * @param forceDisposeTextures - Forces the disposal of all textures.\n   */\n  dispose(forceDisposeTextures) {\n    var _a;\n    if (forceDisposeTextures) {\n      (_a = this._texture) === null || _a === void 0 ? void 0 : _a.dispose();\n    }\n  }\n  /**\n   * Get the current class name useful for serialization or dynamic coding.\n   * @returns \"BakedVertexAnimationManager\"\n   */\n  getClassName() {\n    return \"BakedVertexAnimationManager\";\n  }\n  /**\n   * Makes a duplicate of the current instance into another one.\n   * @param vatMap define the instance where to copy the info\n   */\n  copyTo(vatMap) {\n    SerializationHelper.Clone(() => vatMap, this);\n  }\n  /**\n   * Serializes this vertex animation instance\n   * @returns - An object with the serialized instance.\n   */\n  serialize() {\n    return SerializationHelper.Serialize(this);\n  }\n  /**\n   * Parses a vertex animation setting from a serialized object.\n   * @param source - Serialized object.\n   * @param scene Defines the scene we are parsing for\n   * @param rootUrl Defines the rootUrl to load from\n   */\n  parse(source, scene, rootUrl) {\n    SerializationHelper.Parse(() => this, source, scene, rootUrl);\n  }\n}\n__decorate([serializeAsTexture(), expandToProperty(\"_markSubMeshesAsAttributesDirty\")], BakedVertexAnimationManager.prototype, \"texture\", void 0);\n__decorate([serialize(), expandToProperty(\"_markSubMeshesAsAttributesDirty\")], BakedVertexAnimationManager.prototype, \"isEnabled\", void 0);\n__decorate([serialize()], BakedVertexAnimationManager.prototype, \"animationParameters\", void 0);\n__decorate([serialize()], BakedVertexAnimationManager.prototype, \"time\", void 0);","map":{"version":3,"names":["serialize","expandToProperty","serializeAsTexture","SerializationHelper","Vector4","EngineStore","BakedVertexAnimationManager","constructor","scene","_texture","_isEnabled","isEnabled","time","LastCreatedScene","_scene","animationParameters","_markSubMeshesAsAttributesDirty","mesh","meshes","bakedVertexAnimationManager","bind","effect","useInstances","size","getSize","setFloat2","width","height","setFloat","setVector4","setTexture","clone","copy","copyTo","setAnimationParameters","startFrame","endFrame","offset","speedFramesPerSecond","dispose","forceDisposeTextures","_a","getClassName","vatMap","Clone","Serialize","parse","source","rootUrl","Parse","__decorate"],"sources":["../../../../dev/core/src/BakedVertexAnimation/bakedVertexAnimationManager.ts"],"sourcesContent":["import type { Nullable } from \"../types\";\r\nimport type { Scene } from \"../scene\";\r\nimport { serialize, expandToProperty, serializeAsTexture, SerializationHelper } from \"../Misc/decorators\";\r\nimport type { BaseTexture } from \"../Materials/Textures/baseTexture\";\r\nimport { Vector4 } from \"../Maths/math.vector\";\r\nimport type { Effect } from \"../Materials/effect\";\r\nimport { EngineStore } from \"../Engines/engineStore\";\r\n\r\n/**\r\n * Interface for baked vertex animation texture, see BakedVertexAnimationManager\r\n * @since 5.0\r\n */\r\nexport interface IBakedVertexAnimationManager {\r\n    /**\r\n     * The vertex animation texture\r\n     */\r\n    texture: Nullable<BaseTexture>;\r\n\r\n    /**\r\n     * Gets or sets a boolean indicating if the edgesRenderer is active\r\n     */\r\n    isEnabled: boolean;\r\n\r\n    /**\r\n     * The animation parameters for the mesh. See setAnimationParameters()\r\n     */\r\n    animationParameters: Vector4;\r\n\r\n    /**\r\n     * The time counter, to pick the correct animation frame.\r\n     */\r\n    time: number;\r\n\r\n    /**\r\n     * Binds to the effect.\r\n     * @param effect The effect to bind to.\r\n     * @param useInstances True when it's an instance.\r\n     */\r\n    bind(effect: Effect, useInstances: boolean): void;\r\n\r\n    /**\r\n     * Sets animation parameters.\r\n     * @param startFrame The first frame of the animation.\r\n     * @param endFrame The last frame of the animation.\r\n     * @param offset The offset when starting the animation.\r\n     * @param speedFramesPerSecond The frame rate.\r\n     */\r\n    setAnimationParameters(startFrame: number, endFrame: number, offset: number, speedFramesPerSecond: number): void;\r\n\r\n    /**\r\n     * Disposes the resources of the manager.\r\n     * @param forceDisposeTextures - Forces the disposal of all textures.\r\n     */\r\n    dispose(forceDisposeTextures?: boolean): void;\r\n\r\n    /**\r\n     * Get the current class name useful for serialization or dynamic coding.\r\n     * @returns \"BakedVertexAnimationManager\"\r\n     */\r\n    getClassName(): string;\r\n}\r\n\r\n/**\r\n * This class is used to animate meshes using a baked vertex animation texture\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/animation/baked_texture_animations\r\n * @since 5.0\r\n */\r\nexport class BakedVertexAnimationManager implements IBakedVertexAnimationManager {\r\n    private _scene: Scene;\r\n\r\n    private _texture: Nullable<BaseTexture> = null;\r\n    /**\r\n     * The vertex animation texture\r\n     */\r\n    @serializeAsTexture()\r\n    @expandToProperty(\"_markSubMeshesAsAttributesDirty\")\r\n    public texture: Nullable<BaseTexture>;\r\n\r\n    private _isEnabled = true;\r\n    /**\r\n     * Enable or disable the vertex animation manager\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markSubMeshesAsAttributesDirty\")\r\n    public isEnabled = true;\r\n\r\n    /**\r\n     * The animation parameters for the mesh. See setAnimationParameters()\r\n     */\r\n    @serialize()\r\n    public animationParameters: Vector4;\r\n\r\n    /**\r\n     * The time counter, to pick the correct animation frame.\r\n     */\r\n    @serialize()\r\n    public time = 0;\r\n\r\n    /**\r\n     * Creates a new BakedVertexAnimationManager\r\n     * @param scene defines the current scene\r\n     */\r\n    constructor(scene?: Nullable<Scene>) {\r\n        scene = scene || EngineStore.LastCreatedScene;\r\n        if (!scene) {\r\n            return;\r\n        }\r\n        this._scene = scene;\r\n        this.animationParameters = new Vector4(0, 0, 0, 30);\r\n    }\r\n\r\n    /** @internal */\r\n    public _markSubMeshesAsAttributesDirty(): void {\r\n        for (const mesh of this._scene.meshes) {\r\n            if ((<any>mesh).bakedVertexAnimationManager === this) {\r\n                mesh._markSubMeshesAsAttributesDirty();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Binds to the effect.\r\n     * @param effect The effect to bind to.\r\n     * @param useInstances True when it's an instance.\r\n     */\r\n    public bind(effect: Effect, useInstances = false): void {\r\n        if (!this._texture || !this._isEnabled) {\r\n            return;\r\n        }\r\n\r\n        const size = this._texture.getSize();\r\n        effect.setFloat2(\"bakedVertexAnimationTextureSizeInverted\", 1.0 / size.width, 1.0 / size.height);\r\n        effect.setFloat(\"bakedVertexAnimationTime\", this.time);\r\n\r\n        if (!useInstances) {\r\n            effect.setVector4(\"bakedVertexAnimationSettings\", this.animationParameters);\r\n        }\r\n\r\n        effect.setTexture(\"bakedVertexAnimationTexture\", this._texture);\r\n    }\r\n\r\n    /**\r\n     * Clone the current manager\r\n     * @returns a new BakedVertexAnimationManager\r\n     */\r\n    public clone(): BakedVertexAnimationManager {\r\n        const copy = new BakedVertexAnimationManager(this._scene);\r\n        this.copyTo(copy);\r\n        return copy;\r\n    }\r\n\r\n    /**\r\n     * Sets animation parameters.\r\n     * @param startFrame The first frame of the animation.\r\n     * @param endFrame The last frame of the animation.\r\n     * @param offset The offset when starting the animation.\r\n     * @param speedFramesPerSecond The frame rate.\r\n     */\r\n    public setAnimationParameters(startFrame: number, endFrame: number, offset: number = 0, speedFramesPerSecond: number = 30): void {\r\n        this.animationParameters = new Vector4(startFrame, endFrame, offset, speedFramesPerSecond);\r\n    }\r\n\r\n    /**\r\n     * Disposes the resources of the manager.\r\n     * @param forceDisposeTextures - Forces the disposal of all textures.\r\n     */\r\n    public dispose(forceDisposeTextures?: boolean): void {\r\n        if (forceDisposeTextures) {\r\n            this._texture?.dispose();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the current class name useful for serialization or dynamic coding.\r\n     * @returns \"BakedVertexAnimationManager\"\r\n     */\r\n    public getClassName(): string {\r\n        return \"BakedVertexAnimationManager\";\r\n    }\r\n\r\n    /**\r\n     * Makes a duplicate of the current instance into another one.\r\n     * @param vatMap define the instance where to copy the info\r\n     */\r\n    public copyTo(vatMap: BakedVertexAnimationManager): void {\r\n        SerializationHelper.Clone(() => vatMap, this);\r\n    }\r\n\r\n    /**\r\n     * Serializes this vertex animation instance\r\n     * @returns - An object with the serialized instance.\r\n     */\r\n    public serialize(): any {\r\n        return SerializationHelper.Serialize(this);\r\n    }\r\n\r\n    /**\r\n     * Parses a vertex animation setting from a serialized object.\r\n     * @param source - Serialized object.\r\n     * @param scene Defines the scene we are parsing for\r\n     * @param rootUrl Defines the rootUrl to load from\r\n     */\r\n    public parse(source: any, scene: Scene, rootUrl: string): void {\r\n        SerializationHelper.Parse(() => this, source, scene, rootUrl);\r\n    }\r\n}\r\n"],"mappings":";AAEA,SAASA,SAAS,EAAEC,gBAAgB,EAAEC,kBAAkB,EAAEC,mBAAmB,QAAQ,uBAAqB;AAE1G,SAASC,OAAO,QAAQ,yBAAuB;AAE/C,SAASC,WAAW,QAAQ,2BAAyB;AAwDrD;;;;;AAKA,OAAM,MAAOC,2BAA2B;EA+BpC;;;;EAIAC,YAAYC,KAAuB;IAhC3B,KAAAC,QAAQ,GAA0B,IAAI;IAQtC,KAAAC,UAAU,GAAG,IAAI;IACzB;;;IAKO,KAAAC,SAAS,GAAG,IAAI;IAQvB;;;IAIO,KAAAC,IAAI,GAAG,CAAC;IAOXJ,KAAK,GAAGA,KAAK,IAAIH,WAAW,CAACQ,gBAAgB;IAC7C,IAAI,CAACL,KAAK,EAAE;MACR;;IAEJ,IAAI,CAACM,MAAM,GAAGN,KAAK;IACnB,IAAI,CAACO,mBAAmB,GAAG,IAAIX,OAAO,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;EACvD;EAEA;EACOY,+BAA+BA,CAAA;IAClC,KAAK,MAAMC,IAAI,IAAI,IAAI,CAACH,MAAM,CAACI,MAAM,EAAE;MACnC,IAAUD,IAAK,CAACE,2BAA2B,KAAK,IAAI,EAAE;QAClDF,IAAI,CAACD,+BAA+B,EAAE;;;EAGlD;EAEA;;;;;EAKOI,IAAIA,CAACC,MAAc,EAAEC,YAAY,GAAG,KAAK;IAC5C,IAAI,CAAC,IAAI,CAACb,QAAQ,IAAI,CAAC,IAAI,CAACC,UAAU,EAAE;MACpC;;IAGJ,MAAMa,IAAI,GAAG,IAAI,CAACd,QAAQ,CAACe,OAAO,EAAE;IACpCH,MAAM,CAACI,SAAS,CAAC,yCAAyC,EAAE,GAAG,GAAGF,IAAI,CAACG,KAAK,EAAE,GAAG,GAAGH,IAAI,CAACI,MAAM,CAAC;IAChGN,MAAM,CAACO,QAAQ,CAAC,0BAA0B,EAAE,IAAI,CAAChB,IAAI,CAAC;IAEtD,IAAI,CAACU,YAAY,EAAE;MACfD,MAAM,CAACQ,UAAU,CAAC,8BAA8B,EAAE,IAAI,CAACd,mBAAmB,CAAC;;IAG/EM,MAAM,CAACS,UAAU,CAAC,6BAA6B,EAAE,IAAI,CAACrB,QAAQ,CAAC;EACnE;EAEA;;;;EAIOsB,KAAKA,CAAA;IACR,MAAMC,IAAI,GAAG,IAAI1B,2BAA2B,CAAC,IAAI,CAACQ,MAAM,CAAC;IACzD,IAAI,CAACmB,MAAM,CAACD,IAAI,CAAC;IACjB,OAAOA,IAAI;EACf;EAEA;;;;;;;EAOOE,sBAAsBA,CAACC,UAAkB,EAAEC,QAAgB,EAAEC,MAAA,GAAiB,CAAC,EAAEC,oBAAA,GAA+B,EAAE;IACrH,IAAI,CAACvB,mBAAmB,GAAG,IAAIX,OAAO,CAAC+B,UAAU,EAAEC,QAAQ,EAAEC,MAAM,EAAEC,oBAAoB,CAAC;EAC9F;EAEA;;;;EAIOC,OAAOA,CAACC,oBAA8B;;IACzC,IAAIA,oBAAoB,EAAE;MACtB,CAAAC,EAAA,OAAI,CAAChC,QAAQ,cAAAgC,EAAA,uBAAAA,EAAA,CAAEF,OAAO,EAAE;;EAEhC;EAEA;;;;EAIOG,YAAYA,CAAA;IACf,OAAO,6BAA6B;EACxC;EAEA;;;;EAIOT,MAAMA,CAACU,MAAmC;IAC7CxC,mBAAmB,CAACyC,KAAK,CAAC,MAAMD,MAAM,EAAE,IAAI,CAAC;EACjD;EAEA;;;;EAIO3C,SAASA,CAAA;IACZ,OAAOG,mBAAmB,CAAC0C,SAAS,CAAC,IAAI,CAAC;EAC9C;EAEA;;;;;;EAMOC,KAAKA,CAACC,MAAW,EAAEvC,KAAY,EAAEwC,OAAe;IACnD7C,mBAAmB,CAAC8C,KAAK,CAAC,MAAM,IAAI,EAAEF,MAAM,EAAEvC,KAAK,EAAEwC,OAAO,CAAC;EACjE;;AAhIOE,UAAA,EAFNhD,kBAAkB,EAAE,EACpBD,gBAAgB,CAAC,iCAAiC,CAAC,C,2DACd;AAQ/BiD,UAAA,EAFNlD,SAAS,EAAE,EACXC,gBAAgB,CAAC,iCAAiC,CAAC,C,6DAC5B;AAMjBiD,UAAA,EADNlD,SAAS,EAAE,C,uEACwB;AAM7BkD,UAAA,EADNlD,SAAS,EAAE,C,wDACI"},"metadata":{},"sourceType":"module","externalDependencies":[]}