{"ast":null,"code":"import \"core-js/modules/es.typed-array.to-reversed.js\";\nimport \"core-js/modules/es.typed-array.to-sorted.js\";\nimport \"core-js/modules/es.typed-array.with.js\";\nimport \"core-js/modules/es.array.push.js\";\n/* eslint-disable @typescript-eslint/naming-convention */\n/* eslint-disable babylonjs/available */\n/* eslint-disable jsdoc/require-jsdoc */\n// License for the mipmap generation code:\n//\n// Copyright 2020 Brandon Jones\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\nimport * as WebGPUConstants from \"./webgpuConstants.js\";\nimport { Scalar } from \"../../Maths/math.scalar.js\";\nimport { InternalTextureSource } from \"../../Materials/Textures/internalTexture.js\";\nimport { WebGPUHardwareTexture } from \"./webgpuHardwareTexture.js\";\n// TODO WEBGPU improve mipmap generation by using compute shaders\n// TODO WEBGPU use WGSL instead of GLSL\nconst mipmapVertexSource = `\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(location = 0) out vec2 vTex;\n\n    void main() {\n        vTex = tex[gl_VertexIndex];\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    `;\nconst mipmapFragmentSource = `\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\n    layout(set = 0, binding = 1) uniform texture2D img;\n\n    layout(location = 0) in vec2 vTex;\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = texture(sampler2D(img, imgSampler), vTex);\n    }\n    `;\nconst invertYPreMultiplyAlphaVertexSource = `\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) out flat ivec2 vTextureSize;\n    #endif\n\n    void main() {\n        #ifdef INVERTY\n            vTextureSize = textureSize(img, 0);\n        #endif\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    `;\nconst invertYPreMultiplyAlphaFragmentSource = `\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    `;\nconst invertYPreMultiplyAlphaWithOfstVertexSource = invertYPreMultiplyAlphaVertexSource;\nconst invertYPreMultiplyAlphaWithOfstFragmentSource = `\n    #extension GL_EXT_samplerless_texture_functions : enable\n\n    layout(set = 0, binding = 0) uniform texture2D img;\n    layout(set = 0, binding = 1) uniform Params {\n        float ofstX;\n        float ofstY;\n        float width;\n        float height;\n    };\n\n    #ifdef INVERTY\n        layout(location = 0) in flat ivec2 vTextureSize;\n    #endif\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\n            discard;\n        }\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\n            discard;\n        }\n    #ifdef INVERTY\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\n    #else\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\n    #endif\n    #ifdef PREMULTIPLYALPHA\n        color.rgb *= color.a;\n    #endif\n        outColor = color;\n    }\n    `;\nconst clearVertexSource = `\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n\n    void main() {\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n    }\n    `;\nconst clearFragmentSource = `\n    layout(set = 0, binding = 0) uniform Uniforms {\n        uniform vec4 color;\n    };\n\n    layout(location = 0) out vec4 outColor;\n\n    void main() {\n        outColor = color;\n    }\n    `;\nconst copyVideoToTextureVertexSource = `\n    struct VertexOutput {\n        @builtin(position) Position : vec4<f32>,\n        @location(0) fragUV : vec2<f32>\n    }\n  \n    @vertex\n    fn main(\n        @builtin(vertex_index) VertexIndex : u32\n    ) -> VertexOutput {\n        var pos = array<vec2<f32>, 4>(\n            vec2(-1.0,  1.0),\n            vec2( 1.0,  1.0),\n            vec2(-1.0, -1.0),\n            vec2( 1.0, -1.0)\n        );\n        var tex = array<vec2<f32>, 4>(\n            vec2(0.0, 0.0),\n            vec2(1.0, 0.0),\n            vec2(0.0, 1.0),\n            vec2(1.0, 1.0)\n        );\n\n        var output: VertexOutput;\n\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.fragUV = tex[VertexIndex];\n\n        return output;\n    }\n    `;\nconst copyVideoToTextureFragmentSource = `\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\n    }\n    `;\nconst copyVideoToTextureInvertYFragmentSource = `\n    @group(0) @binding(0) var videoSampler: sampler;\n    @group(0) @binding(1) var videoTexture: texture_external;\n\n    @fragment\n    fn main(\n        @location(0) fragUV: vec2<f32>\n    ) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\n    }\n    `;\nvar PipelineType;\n(function (PipelineType) {\n  PipelineType[PipelineType[\"MipMap\"] = 0] = \"MipMap\";\n  PipelineType[PipelineType[\"InvertYPremultiplyAlpha\"] = 1] = \"InvertYPremultiplyAlpha\";\n  PipelineType[PipelineType[\"Clear\"] = 2] = \"Clear\";\n  PipelineType[PipelineType[\"InvertYPremultiplyAlphaWithOfst\"] = 3] = \"InvertYPremultiplyAlphaWithOfst\";\n})(PipelineType || (PipelineType = {}));\nvar VideoPipelineType;\n(function (VideoPipelineType) {\n  VideoPipelineType[VideoPipelineType[\"DontInvertY\"] = 0] = \"DontInvertY\";\n  VideoPipelineType[VideoPipelineType[\"InvertY\"] = 1] = \"InvertY\";\n})(VideoPipelineType || (VideoPipelineType = {}));\nconst shadersForPipelineType = [{\n  vertex: mipmapVertexSource,\n  fragment: mipmapFragmentSource\n}, {\n  vertex: invertYPreMultiplyAlphaVertexSource,\n  fragment: invertYPreMultiplyAlphaFragmentSource\n}, {\n  vertex: clearVertexSource,\n  fragment: clearFragmentSource\n}, {\n  vertex: invertYPreMultiplyAlphaWithOfstVertexSource,\n  fragment: invertYPreMultiplyAlphaWithOfstFragmentSource\n}];\n/**\n * Map a (renderable) texture format (GPUTextureFormat) to an index for fast lookup (in caches for eg)\n * The number of entries should not go over 64! Else, the code in WebGPUCacheRenderPipeline.setMRT should be updated\n */\nexport const renderableTextureFormatToIndex = {\n  \"\": 0,\n  r8unorm: 1,\n  r8uint: 2,\n  r8sint: 3,\n  r16uint: 4,\n  r16sint: 5,\n  r16float: 6,\n  rg8unorm: 7,\n  rg8uint: 8,\n  rg8sint: 9,\n  r32uint: 10,\n  r32sint: 11,\n  r32float: 12,\n  rg16uint: 13,\n  rg16sint: 14,\n  rg16float: 15,\n  rgba8unorm: 16,\n  \"rgba8unorm-srgb\": 17,\n  rgba8uint: 18,\n  rgba8sint: 19,\n  bgra8unorm: 20,\n  \"bgra8unorm-srgb\": 21,\n  rgb10a2uint: 22,\n  rgb10a2unorm: 23,\n  /* rg11b10ufloat: this entry is dynamically added if the \"RG11B10UFloatRenderable\" extension is supported */\n  rg32uint: 24,\n  rg32sint: 25,\n  rg32float: 26,\n  rgba16uint: 27,\n  rgba16sint: 28,\n  rgba16float: 29,\n  rgba32uint: 30,\n  rgba32sint: 31,\n  rgba32float: 32,\n  stencil8: 33,\n  depth16unorm: 34,\n  depth24plus: 35,\n  \"depth24plus-stencil8\": 36,\n  depth32float: 37,\n  \"depth32float-stencil8\": 38\n};\n/** @internal */\nexport class WebGPUTextureHelper {\n  static ComputeNumMipmapLevels(width, height) {\n    return Scalar.ILog2(Math.max(width, height)) + 1;\n  }\n  //------------------------------------------------------------------------------\n  //                         Initialization / Helpers\n  //------------------------------------------------------------------------------\n  constructor(device, glslang, tintWASM, bufferManager, enabledExtensions) {\n    this._pipelines = {};\n    this._compiledShaders = [];\n    this._videoPipelines = {};\n    this._videoCompiledShaders = [];\n    this._deferredReleaseTextures = [];\n    this._device = device;\n    this._glslang = glslang;\n    this._tintWASM = tintWASM;\n    this._bufferManager = bufferManager;\n    if (enabledExtensions.indexOf(WebGPUConstants.FeatureName.RG11B10UFloatRenderable) !== -1) {\n      const keys = Object.keys(renderableTextureFormatToIndex);\n      renderableTextureFormatToIndex[WebGPUConstants.TextureFormat.RG11B10UFloat] = renderableTextureFormatToIndex[keys[keys.length - 1]] + 1;\n    }\n    this._mipmapSampler = device.createSampler({\n      minFilter: WebGPUConstants.FilterMode.Linear\n    });\n    this._videoSampler = device.createSampler({\n      minFilter: WebGPUConstants.FilterMode.Linear\n    });\n    this._ubCopyWithOfst = this._bufferManager.createBuffer(4 * 4, WebGPUConstants.BufferUsage.Uniform | WebGPUConstants.BufferUsage.CopyDst, \"UBCopyWithOffset\").underlyingResource;\n    this._getPipeline(WebGPUConstants.TextureFormat.RGBA8Unorm);\n    this._getVideoPipeline(WebGPUConstants.TextureFormat.RGBA8Unorm);\n  }\n  _getPipeline(format, type = PipelineType.MipMap, params) {\n    const index = type === PipelineType.MipMap ? 1 << 0 : type === PipelineType.InvertYPremultiplyAlpha ? ((params.invertY ? 1 : 0) << 1) + ((params.premultiplyAlpha ? 1 : 0) << 2) : type === PipelineType.Clear ? 1 << 3 : type === PipelineType.InvertYPremultiplyAlphaWithOfst ? ((params.invertY ? 1 : 0) << 4) + ((params.premultiplyAlpha ? 1 : 0) << 5) : 0;\n    if (!this._pipelines[format]) {\n      this._pipelines[format] = [];\n    }\n    let pipelineAndBGL = this._pipelines[format][index];\n    if (!pipelineAndBGL) {\n      let defines = \"#version 450\\n\";\n      if (type === PipelineType.InvertYPremultiplyAlpha || type === PipelineType.InvertYPremultiplyAlphaWithOfst) {\n        if (params.invertY) {\n          defines += \"#define INVERTY\\n\";\n        }\n        if (params.premultiplyAlpha) {\n          defines += \"#define PREMULTIPLYALPHA\\n\";\n        }\n      }\n      let modules = this._compiledShaders[index];\n      if (!modules) {\n        let vertexCode = this._glslang.compileGLSL(defines + shadersForPipelineType[type].vertex, \"vertex\");\n        let fragmentCode = this._glslang.compileGLSL(defines + shadersForPipelineType[type].fragment, \"fragment\");\n        if (this._tintWASM) {\n          vertexCode = this._tintWASM.convertSpirV2WGSL(vertexCode);\n          fragmentCode = this._tintWASM.convertSpirV2WGSL(fragmentCode);\n        }\n        const vertexModule = this._device.createShaderModule({\n          code: vertexCode\n        });\n        const fragmentModule = this._device.createShaderModule({\n          code: fragmentCode\n        });\n        modules = this._compiledShaders[index] = [vertexModule, fragmentModule];\n      }\n      const pipeline = this._device.createRenderPipeline({\n        layout: WebGPUConstants.AutoLayoutMode.Auto,\n        vertex: {\n          module: modules[0],\n          entryPoint: \"main\"\n        },\n        fragment: {\n          module: modules[1],\n          entryPoint: \"main\",\n          targets: [{\n            format\n          }]\n        },\n        primitive: {\n          topology: WebGPUConstants.PrimitiveTopology.TriangleStrip,\n          stripIndexFormat: WebGPUConstants.IndexFormat.Uint16\n        }\n      });\n      pipelineAndBGL = this._pipelines[format][index] = [pipeline, pipeline.getBindGroupLayout(0)];\n    }\n    return pipelineAndBGL;\n  }\n  _getVideoPipeline(format, type = VideoPipelineType.DontInvertY) {\n    const index = type === VideoPipelineType.InvertY ? 1 << 0 : 0;\n    if (!this._videoPipelines[format]) {\n      this._videoPipelines[format] = [];\n    }\n    let pipelineAndBGL = this._videoPipelines[format][index];\n    if (!pipelineAndBGL) {\n      let modules = this._videoCompiledShaders[index];\n      if (!modules) {\n        const vertexModule = this._device.createShaderModule({\n          code: copyVideoToTextureVertexSource\n        });\n        const fragmentModule = this._device.createShaderModule({\n          code: index === 0 ? copyVideoToTextureFragmentSource : copyVideoToTextureInvertYFragmentSource\n        });\n        modules = this._videoCompiledShaders[index] = [vertexModule, fragmentModule];\n      }\n      const pipeline = this._device.createRenderPipeline({\n        label: `CopyVideoToTexture_${format}_${index === 0 ? \"DontInvertY\" : \"InvertY\"}`,\n        layout: WebGPUConstants.AutoLayoutMode.Auto,\n        vertex: {\n          module: modules[0],\n          entryPoint: \"main\"\n        },\n        fragment: {\n          module: modules[1],\n          entryPoint: \"main\",\n          targets: [{\n            format\n          }]\n        },\n        primitive: {\n          topology: WebGPUConstants.PrimitiveTopology.TriangleStrip,\n          stripIndexFormat: WebGPUConstants.IndexFormat.Uint16\n        }\n      });\n      pipelineAndBGL = this._videoPipelines[format][index] = [pipeline, pipeline.getBindGroupLayout(0)];\n    }\n    return pipelineAndBGL;\n  }\n  static _GetTextureTypeFromFormat(format) {\n    switch (format) {\n      // One Component = 8 bits\n      case WebGPUConstants.TextureFormat.R8Unorm:\n      case WebGPUConstants.TextureFormat.R8Snorm:\n      case WebGPUConstants.TextureFormat.R8Uint:\n      case WebGPUConstants.TextureFormat.R8Sint:\n      case WebGPUConstants.TextureFormat.RG8Unorm:\n      case WebGPUConstants.TextureFormat.RG8Snorm:\n      case WebGPUConstants.TextureFormat.RG8Uint:\n      case WebGPUConstants.TextureFormat.RG8Sint:\n      case WebGPUConstants.TextureFormat.RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGBA8Snorm:\n      case WebGPUConstants.TextureFormat.RGBA8Uint:\n      case WebGPUConstants.TextureFormat.RGBA8Sint:\n      case WebGPUConstants.TextureFormat.BGRA8Unorm:\n      case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGB10A2UINT: // composite format - let's say it's byte...\n      case WebGPUConstants.TextureFormat.RGB10A2Unorm: // composite format - let's say it's byte...\n      case WebGPUConstants.TextureFormat.RGB9E5UFloat: // composite format - let's say it's byte...\n      case WebGPUConstants.TextureFormat.RG11B10UFloat: // composite format - let's say it's byte...\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8: // composite format - let's say it's byte...\n      case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\n      case WebGPUConstants.TextureFormat.BC6HRGBFloat:\n      case WebGPUConstants.TextureFormat.BC5RGUnorm:\n      case WebGPUConstants.TextureFormat.BC5RGSnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC4RUnorm:\n      case WebGPUConstants.TextureFormat.BC4RSnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.EACR11Unorm:\n      case WebGPUConstants.TextureFormat.EACR11Snorm:\n      case WebGPUConstants.TextureFormat.EACRG11Unorm:\n      case WebGPUConstants.TextureFormat.EACRG11Snorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\n        return 0;\n      // One component = 16 bits\n      case WebGPUConstants.TextureFormat.R16Uint:\n      case WebGPUConstants.TextureFormat.R16Sint:\n      case WebGPUConstants.TextureFormat.RG16Uint:\n      case WebGPUConstants.TextureFormat.RG16Sint:\n      case WebGPUConstants.TextureFormat.RGBA16Uint:\n      case WebGPUConstants.TextureFormat.RGBA16Sint:\n      case WebGPUConstants.TextureFormat.Depth16Unorm:\n        return 5;\n      case WebGPUConstants.TextureFormat.R16Float:\n      case WebGPUConstants.TextureFormat.RG16Float:\n      case WebGPUConstants.TextureFormat.RGBA16Float:\n        return 2;\n      // One component = 32 bits\n      case WebGPUConstants.TextureFormat.R32Uint:\n      case WebGPUConstants.TextureFormat.R32Sint:\n      case WebGPUConstants.TextureFormat.RG32Uint:\n      case WebGPUConstants.TextureFormat.RG32Sint:\n      case WebGPUConstants.TextureFormat.RGBA32Uint:\n      case WebGPUConstants.TextureFormat.RGBA32Sint:\n        return 7;\n      case WebGPUConstants.TextureFormat.R32Float:\n      case WebGPUConstants.TextureFormat.RG32Float:\n      case WebGPUConstants.TextureFormat.RGBA32Float:\n      case WebGPUConstants.TextureFormat.Depth32Float:\n        return 1;\n      case WebGPUConstants.TextureFormat.Stencil8:\n        throw \"No fixed size for Stencil8 format!\";\n      case WebGPUConstants.TextureFormat.Depth24Plus:\n        throw \"No fixed size for Depth24Plus format!\";\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n        throw \"No fixed size for Depth24PlusStencil8 format!\";\n    }\n    return 0;\n  }\n  static _GetBlockInformationFromFormat(format) {\n    switch (format) {\n      // 8 bits formats\n      case WebGPUConstants.TextureFormat.R8Unorm:\n      case WebGPUConstants.TextureFormat.R8Snorm:\n      case WebGPUConstants.TextureFormat.R8Uint:\n      case WebGPUConstants.TextureFormat.R8Sint:\n        return {\n          width: 1,\n          height: 1,\n          length: 1\n        };\n      // 16 bits formats\n      case WebGPUConstants.TextureFormat.R16Uint:\n      case WebGPUConstants.TextureFormat.R16Sint:\n      case WebGPUConstants.TextureFormat.R16Float:\n      case WebGPUConstants.TextureFormat.RG8Unorm:\n      case WebGPUConstants.TextureFormat.RG8Snorm:\n      case WebGPUConstants.TextureFormat.RG8Uint:\n      case WebGPUConstants.TextureFormat.RG8Sint:\n        return {\n          width: 1,\n          height: 1,\n          length: 2\n        };\n      // 32 bits formats\n      case WebGPUConstants.TextureFormat.R32Uint:\n      case WebGPUConstants.TextureFormat.R32Sint:\n      case WebGPUConstants.TextureFormat.R32Float:\n      case WebGPUConstants.TextureFormat.RG16Uint:\n      case WebGPUConstants.TextureFormat.RG16Sint:\n      case WebGPUConstants.TextureFormat.RG16Float:\n      case WebGPUConstants.TextureFormat.RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGBA8Snorm:\n      case WebGPUConstants.TextureFormat.RGBA8Uint:\n      case WebGPUConstants.TextureFormat.RGBA8Sint:\n      case WebGPUConstants.TextureFormat.BGRA8Unorm:\n      case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGB9E5UFloat:\n      case WebGPUConstants.TextureFormat.RGB10A2UINT:\n      case WebGPUConstants.TextureFormat.RGB10A2Unorm:\n      case WebGPUConstants.TextureFormat.RG11B10UFloat:\n        return {\n          width: 1,\n          height: 1,\n          length: 4\n        };\n      // 64 bits formats\n      case WebGPUConstants.TextureFormat.RG32Uint:\n      case WebGPUConstants.TextureFormat.RG32Sint:\n      case WebGPUConstants.TextureFormat.RG32Float:\n      case WebGPUConstants.TextureFormat.RGBA16Uint:\n      case WebGPUConstants.TextureFormat.RGBA16Sint:\n      case WebGPUConstants.TextureFormat.RGBA16Float:\n        return {\n          width: 1,\n          height: 1,\n          length: 8\n        };\n      // 128 bits formats\n      case WebGPUConstants.TextureFormat.RGBA32Uint:\n      case WebGPUConstants.TextureFormat.RGBA32Sint:\n      case WebGPUConstants.TextureFormat.RGBA32Float:\n        return {\n          width: 1,\n          height: 1,\n          length: 16\n        };\n      // Depth and stencil formats\n      case WebGPUConstants.TextureFormat.Stencil8:\n        throw \"No fixed size for Stencil8 format!\";\n      case WebGPUConstants.TextureFormat.Depth16Unorm:\n        return {\n          width: 1,\n          height: 1,\n          length: 2\n        };\n      case WebGPUConstants.TextureFormat.Depth24Plus:\n        throw \"No fixed size for Depth24Plus format!\";\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n        throw \"No fixed size for Depth24PlusStencil8 format!\";\n      case WebGPUConstants.TextureFormat.Depth32Float:\n        return {\n          width: 1,\n          height: 1,\n          length: 4\n        };\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\n        return {\n          width: 1,\n          height: 1,\n          length: 5\n        };\n      // BC compressed formats usable if \"texture-compression-bc\" is both\n      // supported by the device/user agent and enabled in requestDevice.\n      case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\n      case WebGPUConstants.TextureFormat.BC6HRGBFloat:\n      case WebGPUConstants.TextureFormat.BC5RGUnorm:\n      case WebGPUConstants.TextureFormat.BC5RGSnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\n        return {\n          width: 4,\n          height: 4,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.BC4RUnorm:\n      case WebGPUConstants.TextureFormat.BC4RSnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\n        return {\n          width: 4,\n          height: 4,\n          length: 8\n        };\n      // ETC2 compressed formats usable if \"texture-compression-etc2\" is both\n      // supported by the device/user agent and enabled in requestDevice.\n      case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\n      case WebGPUConstants.TextureFormat.EACR11Unorm:\n      case WebGPUConstants.TextureFormat.EACR11Snorm:\n        return {\n          width: 4,\n          height: 4,\n          length: 8\n        };\n      case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.EACRG11Unorm:\n      case WebGPUConstants.TextureFormat.EACRG11Snorm:\n        return {\n          width: 4,\n          height: 4,\n          length: 16\n        };\n      // ASTC compressed formats usable if \"texture-compression-astc\" is both\n      // supported by the device/user agent and enabled in requestDevice.\n      case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\n        return {\n          width: 4,\n          height: 4,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\n        return {\n          width: 5,\n          height: 4,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\n        return {\n          width: 5,\n          height: 5,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\n        return {\n          width: 6,\n          height: 5,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\n        return {\n          width: 6,\n          height: 6,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\n        return {\n          width: 8,\n          height: 5,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\n        return {\n          width: 8,\n          height: 6,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\n        return {\n          width: 8,\n          height: 8,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\n        return {\n          width: 10,\n          height: 5,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\n        return {\n          width: 10,\n          height: 6,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\n        return {\n          width: 10,\n          height: 8,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\n        return {\n          width: 10,\n          height: 10,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\n        return {\n          width: 12,\n          height: 10,\n          length: 16\n        };\n      case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\n        return {\n          width: 12,\n          height: 12,\n          length: 16\n        };\n    }\n    return {\n      width: 1,\n      height: 1,\n      length: 4\n    };\n  }\n  static _IsHardwareTexture(texture) {\n    return !!texture.release;\n  }\n  static _IsInternalTexture(texture) {\n    return !!texture.dispose;\n  }\n  static IsImageBitmap(imageBitmap) {\n    return imageBitmap.close !== undefined;\n  }\n  static IsImageBitmapArray(imageBitmap) {\n    return Array.isArray(imageBitmap) && imageBitmap[0].close !== undefined;\n  }\n  setCommandEncoder(encoder) {\n    this._commandEncoderForCreation = encoder;\n  }\n  static IsCompressedFormat(format) {\n    switch (format) {\n      case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC6HRGBFloat:\n      case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\n      case WebGPUConstants.TextureFormat.BC5RGSnorm:\n      case WebGPUConstants.TextureFormat.BC5RGUnorm:\n      case WebGPUConstants.TextureFormat.BC4RSnorm:\n      case WebGPUConstants.TextureFormat.BC4RUnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.EACR11Unorm:\n      case WebGPUConstants.TextureFormat.EACR11Snorm:\n      case WebGPUConstants.TextureFormat.EACRG11Unorm:\n      case WebGPUConstants.TextureFormat.EACRG11Snorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\n        return true;\n    }\n    return false;\n  }\n  static GetWebGPUTextureFormat(type, format, useSRGBBuffer = false) {\n    switch (format) {\n      case 15:\n        return WebGPUConstants.TextureFormat.Depth16Unorm;\n      case 16:\n        return WebGPUConstants.TextureFormat.Depth24Plus;\n      case 13:\n        return WebGPUConstants.TextureFormat.Depth24PlusStencil8;\n      case 14:\n        return WebGPUConstants.TextureFormat.Depth32Float;\n      case 18:\n        return WebGPUConstants.TextureFormat.Depth32FloatStencil8;\n      case 19:\n        return WebGPUConstants.TextureFormat.Stencil8;\n      case 36492:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC7RGBAUnorm;\n      case 36495:\n        return WebGPUConstants.TextureFormat.BC6HRGBUFloat;\n      case 36494:\n        return WebGPUConstants.TextureFormat.BC6HRGBFloat;\n      case 33779:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC3RGBAUnorm;\n      case 33778:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC2RGBAUnorm;\n      case 33777:\n      case 33776:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC1RGBAUnorm;\n      case 37808:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB : WebGPUConstants.TextureFormat.ASTC4x4Unorm;\n      case 36196:\n      case 37492:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB : WebGPUConstants.TextureFormat.ETC2RGB8Unorm;\n      case 37496:\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB : WebGPUConstants.TextureFormat.ETC2RGBA8Unorm;\n    }\n    switch (type) {\n      case 3:\n        switch (format) {\n          case 6:\n            return WebGPUConstants.TextureFormat.R8Snorm;\n          case 7:\n            return WebGPUConstants.TextureFormat.RG8Snorm;\n          case 4:\n            throw \"RGB format not supported in WebGPU\";\n          case 8:\n            return WebGPUConstants.TextureFormat.R8Sint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG8Sint;\n          case 10:\n            throw \"RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA8Sint;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA8Snorm;\n        }\n      case 0:\n        switch (format) {\n          case 6:\n            return WebGPUConstants.TextureFormat.R8Unorm;\n          case 7:\n            return WebGPUConstants.TextureFormat.RG8Unorm;\n          case 4:\n            throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\n          case 5:\n            return useSRGBBuffer ? WebGPUConstants.TextureFormat.RGBA8UnormSRGB : WebGPUConstants.TextureFormat.RGBA8Unorm;\n          case 12:\n            return useSRGBBuffer ? WebGPUConstants.TextureFormat.BGRA8UnormSRGB : WebGPUConstants.TextureFormat.BGRA8Unorm;\n          case 8:\n            return WebGPUConstants.TextureFormat.R8Uint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG8Uint;\n          case 10:\n            throw \"RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA8Uint;\n          case 0:\n            throw \"TEXTUREFORMAT_ALPHA format not supported in WebGPU\";\n          case 1:\n            throw \"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU\";\n          case 2:\n            throw \"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU\";\n          default:\n            return WebGPUConstants.TextureFormat.RGBA8Unorm;\n        }\n      case 4:\n        switch (format) {\n          case 8:\n            return WebGPUConstants.TextureFormat.R16Sint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG16Sint;\n          case 10:\n            throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA16Sint;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA16Sint;\n        }\n      case 5:\n        switch (format) {\n          case 8:\n            return WebGPUConstants.TextureFormat.R16Uint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG16Uint;\n          case 10:\n            throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA16Uint;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA16Uint;\n        }\n      case 6:\n        switch (format) {\n          case 8:\n            return WebGPUConstants.TextureFormat.R32Sint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG32Sint;\n          case 10:\n            throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA32Sint;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA32Sint;\n        }\n      case 7:\n        // Refers to UNSIGNED_INT\n        switch (format) {\n          case 8:\n            return WebGPUConstants.TextureFormat.R32Uint;\n          case 9:\n            return WebGPUConstants.TextureFormat.RG32Uint;\n          case 10:\n            throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\n          case 11:\n            return WebGPUConstants.TextureFormat.RGBA32Uint;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA32Uint;\n        }\n      case 1:\n        switch (format) {\n          case 6:\n            return WebGPUConstants.TextureFormat.R32Float;\n          // By default. Other possibility is R16Float.\n          case 7:\n            return WebGPUConstants.TextureFormat.RG32Float;\n          // By default. Other possibility is RG16Float.\n          case 4:\n            throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\n          case 5:\n            return WebGPUConstants.TextureFormat.RGBA32Float;\n          // By default. Other possibility is RGBA16Float.\n          default:\n            return WebGPUConstants.TextureFormat.RGBA32Float;\n        }\n      case 2:\n        switch (format) {\n          case 6:\n            return WebGPUConstants.TextureFormat.R16Float;\n          case 7:\n            return WebGPUConstants.TextureFormat.RG16Float;\n          case 4:\n            throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\n          case 5:\n            return WebGPUConstants.TextureFormat.RGBA16Float;\n          default:\n            return WebGPUConstants.TextureFormat.RGBA16Float;\n        }\n      case 10:\n        throw \"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU\";\n      case 13:\n        switch (format) {\n          case 5:\n            return WebGPUConstants.TextureFormat.RG11B10UFloat;\n          case 11:\n            throw \"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV\";\n          default:\n            return WebGPUConstants.TextureFormat.RG11B10UFloat;\n        }\n      case 14:\n        switch (format) {\n          case 5:\n            return WebGPUConstants.TextureFormat.RGB9E5UFloat;\n          case 11:\n            throw \"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV\";\n          default:\n            return WebGPUConstants.TextureFormat.RGB9E5UFloat;\n        }\n      case 8:\n        throw \"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU\";\n      case 9:\n        throw \"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU\";\n      case 11:\n        switch (format) {\n          case 5:\n            return WebGPUConstants.TextureFormat.RGB10A2Unorm;\n          case 11:\n            return WebGPUConstants.TextureFormat.RGB10A2UINT;\n          default:\n            return WebGPUConstants.TextureFormat.RGB10A2Unorm;\n        }\n    }\n    return useSRGBBuffer ? WebGPUConstants.TextureFormat.RGBA8UnormSRGB : WebGPUConstants.TextureFormat.RGBA8Unorm;\n  }\n  static GetNumChannelsFromWebGPUTextureFormat(format) {\n    switch (format) {\n      case WebGPUConstants.TextureFormat.R8Unorm:\n      case WebGPUConstants.TextureFormat.R8Snorm:\n      case WebGPUConstants.TextureFormat.R8Uint:\n      case WebGPUConstants.TextureFormat.R8Sint:\n      case WebGPUConstants.TextureFormat.BC4RUnorm:\n      case WebGPUConstants.TextureFormat.BC4RSnorm:\n      case WebGPUConstants.TextureFormat.R16Uint:\n      case WebGPUConstants.TextureFormat.R16Sint:\n      case WebGPUConstants.TextureFormat.Depth16Unorm:\n      case WebGPUConstants.TextureFormat.R16Float:\n      case WebGPUConstants.TextureFormat.R32Uint:\n      case WebGPUConstants.TextureFormat.R32Sint:\n      case WebGPUConstants.TextureFormat.R32Float:\n      case WebGPUConstants.TextureFormat.Depth32Float:\n      case WebGPUConstants.TextureFormat.Stencil8:\n      case WebGPUConstants.TextureFormat.Depth24Plus:\n      case WebGPUConstants.TextureFormat.EACR11Unorm:\n      case WebGPUConstants.TextureFormat.EACR11Snorm:\n        return 1;\n      case WebGPUConstants.TextureFormat.RG8Unorm:\n      case WebGPUConstants.TextureFormat.RG8Snorm:\n      case WebGPUConstants.TextureFormat.RG8Uint:\n      case WebGPUConstants.TextureFormat.RG8Sint:\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\n      case WebGPUConstants.TextureFormat.BC5RGUnorm:\n      case WebGPUConstants.TextureFormat.BC5RGSnorm:\n      case WebGPUConstants.TextureFormat.RG16Uint:\n      case WebGPUConstants.TextureFormat.RG16Sint:\n      case WebGPUConstants.TextureFormat.RG16Float:\n      case WebGPUConstants.TextureFormat.RG32Uint:\n      case WebGPUConstants.TextureFormat.RG32Sint:\n      case WebGPUConstants.TextureFormat.RG32Float:\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n      case WebGPUConstants.TextureFormat.EACRG11Unorm:\n      case WebGPUConstants.TextureFormat.EACRG11Snorm:\n        return 2;\n      case WebGPUConstants.TextureFormat.RGB9E5UFloat:\n      case WebGPUConstants.TextureFormat.RG11B10UFloat:\n      case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\n      case WebGPUConstants.TextureFormat.BC6HRGBFloat:\n      case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\n        return 3;\n      case WebGPUConstants.TextureFormat.RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGBA8Snorm:\n      case WebGPUConstants.TextureFormat.RGBA8Uint:\n      case WebGPUConstants.TextureFormat.RGBA8Sint:\n      case WebGPUConstants.TextureFormat.BGRA8Unorm:\n      case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.RGB10A2UINT:\n      case WebGPUConstants.TextureFormat.RGB10A2Unorm:\n      case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\n      case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\n      case WebGPUConstants.TextureFormat.RGBA16Uint:\n      case WebGPUConstants.TextureFormat.RGBA16Sint:\n      case WebGPUConstants.TextureFormat.RGBA16Float:\n      case WebGPUConstants.TextureFormat.RGBA32Uint:\n      case WebGPUConstants.TextureFormat.RGBA32Sint:\n      case WebGPUConstants.TextureFormat.RGBA32Float:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\n      case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\n      case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\n      case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\n        return 4;\n    }\n    throw `Unknown format ${format}!`;\n  }\n  static HasStencilAspect(format) {\n    switch (format) {\n      case WebGPUConstants.TextureFormat.Stencil8:\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n        return true;\n    }\n    return false;\n  }\n  static HasDepthAndStencilAspects(format) {\n    switch (format) {\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n        return true;\n    }\n    return false;\n  }\n  static GetDepthFormatOnly(format) {\n    switch (format) {\n      case WebGPUConstants.TextureFormat.Depth16Unorm:\n        return WebGPUConstants.TextureFormat.Depth16Unorm;\n      case WebGPUConstants.TextureFormat.Depth24Plus:\n        return WebGPUConstants.TextureFormat.Depth24Plus;\n      case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\n        return WebGPUConstants.TextureFormat.Depth24Plus;\n      case WebGPUConstants.TextureFormat.Depth32Float:\n        return WebGPUConstants.TextureFormat.Depth32Float;\n      case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\n        return WebGPUConstants.TextureFormat.Depth32Float;\n    }\n    return format;\n  }\n  copyVideoToTexture(video, texture, format, invertY = false, commandEncoder) {\n    var _a, _b, _c, _d;\n    const useOwnCommandEncoder = commandEncoder === undefined;\n    const [pipeline, bindGroupLayout] = this._getVideoPipeline(format, invertY ? VideoPipelineType.InvertY : VideoPipelineType.DontInvertY);\n    if (useOwnCommandEncoder) {\n      commandEncoder = this._device.createCommandEncoder({});\n    }\n    (_b = (_a = commandEncoder).pushDebugGroup) === null || _b === void 0 ? void 0 : _b.call(_a, `copy video to texture - invertY=${invertY}`);\n    const webgpuHardwareTexture = texture._hardwareTexture;\n    const renderPassDescriptor = {\n      colorAttachments: [{\n        view: webgpuHardwareTexture.underlyingResource.createView({\n          format,\n          dimension: WebGPUConstants.TextureViewDimension.E2d,\n          mipLevelCount: 1,\n          baseArrayLayer: 0,\n          baseMipLevel: 0,\n          arrayLayerCount: 1,\n          aspect: WebGPUConstants.TextureAspect.All\n        }),\n        loadOp: WebGPUConstants.LoadOp.Load,\n        storeOp: WebGPUConstants.StoreOp.Store\n      }]\n    };\n    const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n    const descriptor = {\n      layout: bindGroupLayout,\n      entries: [{\n        binding: 0,\n        resource: this._videoSampler\n      }, {\n        binding: 1,\n        resource: this._device.importExternalTexture({\n          source: video.underlyingResource\n        })\n      }]\n    };\n    const bindGroup = this._device.createBindGroup(descriptor);\n    passEncoder.setPipeline(pipeline);\n    passEncoder.setBindGroup(0, bindGroup);\n    passEncoder.draw(4, 1, 0, 0);\n    passEncoder.end();\n    (_d = (_c = commandEncoder).popDebugGroup) === null || _d === void 0 ? void 0 : _d.call(_c);\n    if (useOwnCommandEncoder) {\n      this._device.queue.submit([commandEncoder.finish()]);\n      commandEncoder = null;\n    }\n  }\n  invertYPreMultiplyAlpha(gpuOrHdwTexture, width, height, format, invertY = false, premultiplyAlpha = false, faceIndex = 0, mipLevel = 0, layers = 1, ofstX = 0, ofstY = 0, rectWidth = 0, rectHeight = 0, commandEncoder,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  allowGPUOptimization) {\n    var _a, _b, _c, _d, _e, _f;\n    const useRect = rectWidth !== 0;\n    const useOwnCommandEncoder = commandEncoder === undefined;\n    const [pipeline, bindGroupLayout] = this._getPipeline(format, useRect ? PipelineType.InvertYPremultiplyAlphaWithOfst : PipelineType.InvertYPremultiplyAlpha, {\n      invertY,\n      premultiplyAlpha\n    });\n    faceIndex = Math.max(faceIndex, 0);\n    if (useOwnCommandEncoder) {\n      commandEncoder = this._device.createCommandEncoder({});\n    }\n    (_b = (_a = commandEncoder).pushDebugGroup) === null || _b === void 0 ? void 0 : _b.call(_a, `internal process texture - invertY=${invertY} premultiplyAlpha=${premultiplyAlpha}`);\n    let gpuTexture;\n    if (WebGPUTextureHelper._IsHardwareTexture(gpuOrHdwTexture)) {\n      gpuTexture = gpuOrHdwTexture.underlyingResource;\n      if (!(invertY && !premultiplyAlpha && layers === 1 && faceIndex === 0)) {\n        // we optimize only for the most likely case (invertY=true, premultiplyAlpha=false, layers=1, faceIndex=0) to avoid dealing with big caches\n        gpuOrHdwTexture = undefined;\n      }\n    } else {\n      gpuTexture = gpuOrHdwTexture;\n      gpuOrHdwTexture = undefined;\n    }\n    if (!gpuTexture) {\n      return;\n    }\n    if (useRect) {\n      this._bufferManager.setRawData(this._ubCopyWithOfst, 0, new Float32Array([ofstX, ofstY, rectWidth, rectHeight]), 0, 4 * 4);\n    }\n    const webgpuHardwareTexture = gpuOrHdwTexture;\n    const outputTexture = (_c = webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._copyInvertYTempTexture) !== null && _c !== void 0 ? _c : this.createTexture({\n      width,\n      height,\n      layers: 1\n    }, false, false, false, false, false, format, 1, commandEncoder, WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.RenderAttachment | WebGPUConstants.TextureUsage.TextureBinding, undefined, \"TempTextureForCopyWithInvertY\");\n    const renderPassDescriptor = (_d = webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._copyInvertYRenderPassDescr) !== null && _d !== void 0 ? _d : {\n      colorAttachments: [{\n        view: outputTexture.createView({\n          format,\n          dimension: WebGPUConstants.TextureViewDimension.E2d,\n          baseMipLevel: 0,\n          mipLevelCount: 1,\n          arrayLayerCount: 1,\n          baseArrayLayer: 0\n        }),\n        loadOp: WebGPUConstants.LoadOp.Load,\n        storeOp: WebGPUConstants.StoreOp.Store\n      }]\n    };\n    const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n    let bindGroup = useRect ? webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._copyInvertYBindGroupWithOfst : webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._copyInvertYBindGroup;\n    if (!bindGroup) {\n      const descriptor = {\n        layout: bindGroupLayout,\n        entries: [{\n          binding: 0,\n          resource: gpuTexture.createView({\n            format,\n            dimension: WebGPUConstants.TextureViewDimension.E2d,\n            baseMipLevel: mipLevel,\n            mipLevelCount: 1,\n            arrayLayerCount: layers,\n            baseArrayLayer: faceIndex\n          })\n        }]\n      };\n      if (useRect) {\n        descriptor.entries.push({\n          binding: 1,\n          resource: {\n            buffer: this._ubCopyWithOfst\n          }\n        });\n      }\n      bindGroup = this._device.createBindGroup(descriptor);\n    }\n    passEncoder.setPipeline(pipeline);\n    passEncoder.setBindGroup(0, bindGroup);\n    passEncoder.draw(4, 1, 0, 0);\n    passEncoder.end();\n    commandEncoder.copyTextureToTexture({\n      texture: outputTexture\n    }, {\n      texture: gpuTexture,\n      mipLevel,\n      origin: {\n        x: 0,\n        y: 0,\n        z: faceIndex\n      }\n    }, {\n      width,\n      height,\n      depthOrArrayLayers: 1\n    });\n    if (webgpuHardwareTexture) {\n      webgpuHardwareTexture._copyInvertYTempTexture = outputTexture;\n      webgpuHardwareTexture._copyInvertYRenderPassDescr = renderPassDescriptor;\n      if (useRect) {\n        webgpuHardwareTexture._copyInvertYBindGroupWithOfst = bindGroup;\n      } else {\n        webgpuHardwareTexture._copyInvertYBindGroup = bindGroup;\n      }\n    } else {\n      this._deferredReleaseTextures.push([outputTexture, null]);\n    }\n    (_f = (_e = commandEncoder).popDebugGroup) === null || _f === void 0 ? void 0 : _f.call(_e);\n    if (useOwnCommandEncoder) {\n      this._device.queue.submit([commandEncoder.finish()]);\n      commandEncoder = null;\n    }\n  }\n  copyWithInvertY(srcTextureView, format, renderPassDescriptor, commandEncoder) {\n    var _a, _b, _c, _d;\n    const useOwnCommandEncoder = commandEncoder === undefined;\n    const [pipeline, bindGroupLayout] = this._getPipeline(format, PipelineType.InvertYPremultiplyAlpha, {\n      invertY: true,\n      premultiplyAlpha: false\n    });\n    if (useOwnCommandEncoder) {\n      commandEncoder = this._device.createCommandEncoder({});\n    }\n    (_b = (_a = commandEncoder).pushDebugGroup) === null || _b === void 0 ? void 0 : _b.call(_a, `internal copy texture with invertY`);\n    const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n    const bindGroup = this._device.createBindGroup({\n      layout: bindGroupLayout,\n      entries: [{\n        binding: 0,\n        resource: srcTextureView\n      }]\n    });\n    passEncoder.setPipeline(pipeline);\n    passEncoder.setBindGroup(0, bindGroup);\n    passEncoder.draw(4, 1, 0, 0);\n    passEncoder.end();\n    (_d = (_c = commandEncoder).popDebugGroup) === null || _d === void 0 ? void 0 : _d.call(_c);\n    if (useOwnCommandEncoder) {\n      this._device.queue.submit([commandEncoder.finish()]);\n      commandEncoder = null;\n    }\n  }\n  //------------------------------------------------------------------------------\n  //                               Creation\n  //------------------------------------------------------------------------------\n  createTexture(imageBitmap, hasMipmaps = false, generateMipmaps = false, invertY = false, premultiplyAlpha = false, is3D = false, format = WebGPUConstants.TextureFormat.RGBA8Unorm, sampleCount = 1, commandEncoder, usage = -1, additionalUsages = 0, label) {\n    if (sampleCount > 1) {\n      // WebGPU only supports 1 or 4\n      sampleCount = 4;\n    }\n    const layerCount = imageBitmap.layers || 1;\n    const textureSize = {\n      width: imageBitmap.width,\n      height: imageBitmap.height,\n      depthOrArrayLayers: layerCount\n    };\n    const renderAttachmentFlag = renderableTextureFormatToIndex[format] ? WebGPUConstants.TextureUsage.RenderAttachment : 0;\n    const isCompressedFormat = WebGPUTextureHelper.IsCompressedFormat(format);\n    const mipLevelCount = hasMipmaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(imageBitmap.width, imageBitmap.height) : 1;\n    const usages = usage >= 0 ? usage : WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.CopyDst | WebGPUConstants.TextureUsage.TextureBinding;\n    additionalUsages |= hasMipmaps && !isCompressedFormat ? WebGPUConstants.TextureUsage.CopySrc | renderAttachmentFlag : 0;\n    if (!isCompressedFormat && !is3D) {\n      // we don't know in advance if the texture will be updated with copyExternalImageToTexture (which requires to have those flags), so we need to force the flags all the times\n      additionalUsages |= renderAttachmentFlag | WebGPUConstants.TextureUsage.CopyDst;\n    }\n    const gpuTexture = this._device.createTexture({\n      label: `Texture${is3D ? \"3D\" : \"2D\"}_${label ? label + \"_\" : \"\"}${textureSize.width}x${textureSize.height}x${textureSize.depthOrArrayLayers}_${hasMipmaps ? \"wmips\" : \"womips\"}_${format}_samples${sampleCount}`,\n      size: textureSize,\n      dimension: is3D ? WebGPUConstants.TextureDimension.E3d : WebGPUConstants.TextureDimension.E2d,\n      format,\n      usage: usages | additionalUsages,\n      sampleCount,\n      mipLevelCount\n    });\n    if (WebGPUTextureHelper.IsImageBitmap(imageBitmap)) {\n      this.updateTexture(imageBitmap, gpuTexture, imageBitmap.width, imageBitmap.height, layerCount, format, 0, 0, invertY, premultiplyAlpha, 0, 0);\n      if (hasMipmaps && generateMipmaps) {\n        this.generateMipmaps(gpuTexture, format, mipLevelCount, 0, commandEncoder);\n      }\n    }\n    return gpuTexture;\n  }\n  createCubeTexture(imageBitmaps, hasMipmaps = false, generateMipmaps = false, invertY = false, premultiplyAlpha = false, format = WebGPUConstants.TextureFormat.RGBA8Unorm, sampleCount = 1, commandEncoder, usage = -1, additionalUsages = 0, label) {\n    if (sampleCount > 1) {\n      // WebGPU only supports 1 or 4\n      sampleCount = 4;\n    }\n    const width = WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps) ? imageBitmaps[0].width : imageBitmaps.width;\n    const height = WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps) ? imageBitmaps[0].height : imageBitmaps.height;\n    const renderAttachmentFlag = renderableTextureFormatToIndex[format] ? WebGPUConstants.TextureUsage.RenderAttachment : 0;\n    const isCompressedFormat = WebGPUTextureHelper.IsCompressedFormat(format);\n    const mipLevelCount = hasMipmaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(width, height) : 1;\n    const usages = usage >= 0 ? usage : WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.CopyDst | WebGPUConstants.TextureUsage.TextureBinding;\n    additionalUsages |= hasMipmaps && !isCompressedFormat ? WebGPUConstants.TextureUsage.CopySrc | renderAttachmentFlag : 0;\n    if (!isCompressedFormat) {\n      // we don't know in advance if the texture will be updated with copyExternalImageToTexture (which requires to have those flags), so we need to force the flags all the times\n      additionalUsages |= renderAttachmentFlag | WebGPUConstants.TextureUsage.CopyDst;\n    }\n    const gpuTexture = this._device.createTexture({\n      label: `TextureCube_${label ? label + \"_\" : \"\"}${width}x${height}x6_${hasMipmaps ? \"wmips\" : \"womips\"}_${format}_samples${sampleCount}`,\n      size: {\n        width,\n        height,\n        depthOrArrayLayers: 6\n      },\n      dimension: WebGPUConstants.TextureDimension.E2d,\n      format,\n      usage: usages | additionalUsages,\n      sampleCount,\n      mipLevelCount\n    });\n    if (WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps)) {\n      this.updateCubeTextures(imageBitmaps, gpuTexture, width, height, format, invertY, premultiplyAlpha, 0, 0);\n      if (hasMipmaps && generateMipmaps) {\n        this.generateCubeMipmaps(gpuTexture, format, mipLevelCount, commandEncoder);\n      }\n    }\n    return gpuTexture;\n  }\n  generateCubeMipmaps(gpuTexture, format, mipLevelCount, commandEncoder) {\n    var _a, _b, _c, _d;\n    const useOwnCommandEncoder = commandEncoder === undefined;\n    if (useOwnCommandEncoder) {\n      commandEncoder = this._device.createCommandEncoder({});\n    }\n    (_b = (_a = commandEncoder).pushDebugGroup) === null || _b === void 0 ? void 0 : _b.call(_a, `create cube mipmaps - ${mipLevelCount} levels`);\n    for (let f = 0; f < 6; ++f) {\n      this.generateMipmaps(gpuTexture, format, mipLevelCount, f, commandEncoder);\n    }\n    (_d = (_c = commandEncoder).popDebugGroup) === null || _d === void 0 ? void 0 : _d.call(_c);\n    if (useOwnCommandEncoder) {\n      this._device.queue.submit([commandEncoder.finish()]);\n      commandEncoder = null;\n    }\n  }\n  generateMipmaps(gpuOrHdwTexture, format, mipLevelCount, faceIndex = 0, commandEncoder) {\n    var _a, _b, _c, _d, _e, _f, _g, _h;\n    const useOwnCommandEncoder = commandEncoder === undefined;\n    const [pipeline, bindGroupLayout] = this._getPipeline(format);\n    faceIndex = Math.max(faceIndex, 0);\n    if (useOwnCommandEncoder) {\n      commandEncoder = this._device.createCommandEncoder({});\n    }\n    (_b = (_a = commandEncoder).pushDebugGroup) === null || _b === void 0 ? void 0 : _b.call(_a, `create mipmaps for face #${faceIndex} - ${mipLevelCount} levels`);\n    let gpuTexture;\n    if (WebGPUTextureHelper._IsHardwareTexture(gpuOrHdwTexture)) {\n      gpuTexture = gpuOrHdwTexture.underlyingResource;\n      gpuOrHdwTexture._mipmapGenRenderPassDescr = gpuOrHdwTexture._mipmapGenRenderPassDescr || [];\n      gpuOrHdwTexture._mipmapGenBindGroup = gpuOrHdwTexture._mipmapGenBindGroup || [];\n    } else {\n      gpuTexture = gpuOrHdwTexture;\n      gpuOrHdwTexture = undefined;\n    }\n    if (!gpuTexture) {\n      return;\n    }\n    const webgpuHardwareTexture = gpuOrHdwTexture;\n    for (let i = 1; i < mipLevelCount; ++i) {\n      const renderPassDescriptor = (_d = (_c = webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex]) === null || _c === void 0 ? void 0 : _c[i - 1]) !== null && _d !== void 0 ? _d : {\n        colorAttachments: [{\n          view: gpuTexture.createView({\n            format,\n            dimension: WebGPUConstants.TextureViewDimension.E2d,\n            baseMipLevel: i,\n            mipLevelCount: 1,\n            arrayLayerCount: 1,\n            baseArrayLayer: faceIndex\n          }),\n          loadOp: WebGPUConstants.LoadOp.Load,\n          storeOp: WebGPUConstants.StoreOp.Store\n        }]\n      };\n      if (webgpuHardwareTexture) {\n        webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex] = webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex] || [];\n        webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex][i - 1] = renderPassDescriptor;\n      }\n      const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n      const bindGroup = (_f = (_e = webgpuHardwareTexture === null || webgpuHardwareTexture === void 0 ? void 0 : webgpuHardwareTexture._mipmapGenBindGroup[faceIndex]) === null || _e === void 0 ? void 0 : _e[i - 1]) !== null && _f !== void 0 ? _f : this._device.createBindGroup({\n        layout: bindGroupLayout,\n        entries: [{\n          binding: 0,\n          resource: this._mipmapSampler\n        }, {\n          binding: 1,\n          resource: gpuTexture.createView({\n            format,\n            dimension: WebGPUConstants.TextureViewDimension.E2d,\n            baseMipLevel: i - 1,\n            mipLevelCount: 1,\n            arrayLayerCount: 1,\n            baseArrayLayer: faceIndex\n          })\n        }]\n      });\n      if (webgpuHardwareTexture) {\n        webgpuHardwareTexture._mipmapGenBindGroup[faceIndex] = webgpuHardwareTexture._mipmapGenBindGroup[faceIndex] || [];\n        webgpuHardwareTexture._mipmapGenBindGroup[faceIndex][i - 1] = bindGroup;\n      }\n      passEncoder.setPipeline(pipeline);\n      passEncoder.setBindGroup(0, bindGroup);\n      passEncoder.draw(4, 1, 0, 0);\n      passEncoder.end();\n    }\n    (_h = (_g = commandEncoder).popDebugGroup) === null || _h === void 0 ? void 0 : _h.call(_g);\n    if (useOwnCommandEncoder) {\n      this._device.queue.submit([commandEncoder.finish()]);\n      commandEncoder = null;\n    }\n  }\n  createGPUTextureForInternalTexture(texture, width, height, depth, creationFlags) {\n    if (!texture._hardwareTexture) {\n      texture._hardwareTexture = new WebGPUHardwareTexture();\n    }\n    if (width === undefined) {\n      width = texture.width;\n    }\n    if (height === undefined) {\n      height = texture.height;\n    }\n    if (depth === undefined) {\n      depth = texture.depth;\n    }\n    const gpuTextureWrapper = texture._hardwareTexture;\n    const isStorageTexture = ((creationFlags !== null && creationFlags !== void 0 ? creationFlags : 0) & 1) !== 0;\n    gpuTextureWrapper.format = WebGPUTextureHelper.GetWebGPUTextureFormat(texture.type, texture.format, texture._useSRGBBuffer);\n    gpuTextureWrapper.textureUsages = texture._source === InternalTextureSource.RenderTarget || texture.source === InternalTextureSource.MultiRenderTarget ? WebGPUConstants.TextureUsage.TextureBinding | WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.RenderAttachment : texture._source === InternalTextureSource.DepthStencil ? WebGPUConstants.TextureUsage.TextureBinding | WebGPUConstants.TextureUsage.RenderAttachment : -1;\n    gpuTextureWrapper.textureAdditionalUsages = isStorageTexture ? WebGPUConstants.TextureUsage.StorageBinding : 0;\n    const hasMipMaps = texture.generateMipMaps;\n    const layerCount = depth || 1;\n    let mipmapCount;\n    if (texture._maxLodLevel !== null) {\n      mipmapCount = texture._maxLodLevel;\n    } else {\n      mipmapCount = hasMipMaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(width, height) : 1;\n    }\n    if (texture.isCube) {\n      const gpuTexture = this.createCubeTexture({\n        width,\n        height\n      }, texture.generateMipMaps, texture.generateMipMaps, texture.invertY, false, gpuTextureWrapper.format, 1, this._commandEncoderForCreation, gpuTextureWrapper.textureUsages, gpuTextureWrapper.textureAdditionalUsages, texture.label);\n      gpuTextureWrapper.set(gpuTexture);\n      gpuTextureWrapper.createView({\n        format: WebGPUTextureHelper.GetDepthFormatOnly(gpuTextureWrapper.format),\n        dimension: WebGPUConstants.TextureViewDimension.Cube,\n        mipLevelCount: mipmapCount,\n        baseArrayLayer: 0,\n        baseMipLevel: 0,\n        arrayLayerCount: 6,\n        aspect: WebGPUTextureHelper.HasDepthAndStencilAspects(gpuTextureWrapper.format) ? WebGPUConstants.TextureAspect.DepthOnly : WebGPUConstants.TextureAspect.All\n      }, isStorageTexture);\n    } else {\n      const gpuTexture = this.createTexture({\n        width,\n        height,\n        layers: layerCount\n      }, texture.generateMipMaps, texture.generateMipMaps, texture.invertY, false, texture.is3D, gpuTextureWrapper.format, 1, this._commandEncoderForCreation, gpuTextureWrapper.textureUsages, gpuTextureWrapper.textureAdditionalUsages, texture.label);\n      gpuTextureWrapper.set(gpuTexture);\n      gpuTextureWrapper.createView({\n        format: WebGPUTextureHelper.GetDepthFormatOnly(gpuTextureWrapper.format),\n        dimension: texture.is2DArray ? WebGPUConstants.TextureViewDimension.E2dArray : texture.is3D ? WebGPUConstants.TextureDimension.E3d : WebGPUConstants.TextureViewDimension.E2d,\n        mipLevelCount: mipmapCount,\n        baseArrayLayer: 0,\n        baseMipLevel: 0,\n        arrayLayerCount: texture.is3D ? 1 : layerCount,\n        aspect: WebGPUTextureHelper.HasDepthAndStencilAspects(gpuTextureWrapper.format) ? WebGPUConstants.TextureAspect.DepthOnly : WebGPUConstants.TextureAspect.All\n      }, isStorageTexture);\n    }\n    texture.width = texture.baseWidth = width;\n    texture.height = texture.baseHeight = height;\n    texture.depth = texture.baseDepth = depth;\n    this.createMSAATexture(texture, texture.samples);\n    return gpuTextureWrapper;\n  }\n  createMSAATexture(texture, samples, releaseExisting = true, index = -1) {\n    const gpuTextureWrapper = texture._hardwareTexture;\n    if (releaseExisting) {\n      gpuTextureWrapper === null || gpuTextureWrapper === void 0 ? void 0 : gpuTextureWrapper.releaseMSAATexture();\n    }\n    if (!gpuTextureWrapper || (samples !== null && samples !== void 0 ? samples : 1) <= 1) {\n      return;\n    }\n    const width = texture.width;\n    const height = texture.height;\n    const gpuMSAATexture = this.createTexture({\n      width,\n      height,\n      layers: 1\n    }, false, false, false, false, false, gpuTextureWrapper.format, samples, this._commandEncoderForCreation, WebGPUConstants.TextureUsage.RenderAttachment, 0, texture.label ? \"MSAA\" + texture.label : undefined);\n    gpuTextureWrapper.setMSAATexture(gpuMSAATexture, index);\n  }\n  //------------------------------------------------------------------------------\n  //                                  Update\n  //------------------------------------------------------------------------------\n  updateCubeTextures(imageBitmaps, gpuTexture, width, height, format, invertY = false, premultiplyAlpha = false, offsetX = 0, offsetY = 0) {\n    const faces = [0, 3, 1, 4, 2, 5];\n    for (let f = 0; f < faces.length; ++f) {\n      const imageBitmap = imageBitmaps[faces[f]];\n      this.updateTexture(imageBitmap, gpuTexture, width, height, 1, format, f, 0, invertY, premultiplyAlpha, offsetX, offsetY);\n    }\n  }\n  // TODO WEBGPU handle data source not being in the same format than the destination texture?\n  updateTexture(imageBitmap, texture, width, height, layers, format, faceIndex = 0, mipLevel = 0, invertY = false, premultiplyAlpha = false, offsetX = 0, offsetY = 0, allowGPUOptimization) {\n    const gpuTexture = WebGPUTextureHelper._IsInternalTexture(texture) ? texture._hardwareTexture.underlyingResource : texture;\n    const blockInformation = WebGPUTextureHelper._GetBlockInformationFromFormat(format);\n    const gpuOrHdwTexture = WebGPUTextureHelper._IsInternalTexture(texture) ? texture._hardwareTexture : texture;\n    const textureCopyView = {\n      texture: gpuTexture,\n      origin: {\n        x: offsetX,\n        y: offsetY,\n        z: Math.max(faceIndex, 0)\n      },\n      mipLevel: mipLevel,\n      premultipliedAlpha: premultiplyAlpha\n    };\n    const textureExtent = {\n      width: Math.ceil(width / blockInformation.width) * blockInformation.width,\n      height: Math.ceil(height / blockInformation.height) * blockInformation.height,\n      depthOrArrayLayers: layers || 1\n    };\n    if (imageBitmap.byteLength !== undefined) {\n      imageBitmap = imageBitmap;\n      const bytesPerRow = Math.ceil(width / blockInformation.width) * blockInformation.length;\n      const aligned = Math.ceil(bytesPerRow / 256) * 256 === bytesPerRow;\n      if (aligned) {\n        const commandEncoder = this._device.createCommandEncoder({});\n        const buffer = this._bufferManager.createRawBuffer(imageBitmap.byteLength, WebGPUConstants.BufferUsage.MapWrite | WebGPUConstants.BufferUsage.CopySrc, true, \"TempBufferForUpdateTexture\" + (gpuTexture ? \"_\" + gpuTexture.label : \"\"));\n        const arrayBuffer = buffer.getMappedRange();\n        new Uint8Array(arrayBuffer).set(imageBitmap);\n        buffer.unmap();\n        commandEncoder.copyBufferToTexture({\n          buffer: buffer,\n          offset: 0,\n          bytesPerRow,\n          rowsPerImage: height\n        }, textureCopyView, textureExtent);\n        this._device.queue.submit([commandEncoder.finish()]);\n        this._bufferManager.releaseBuffer(buffer);\n      } else {\n        this._device.queue.writeTexture(textureCopyView, imageBitmap, {\n          offset: 0,\n          bytesPerRow,\n          rowsPerImage: height\n        }, textureExtent);\n      }\n      if (invertY || premultiplyAlpha) {\n        if (WebGPUTextureHelper._IsInternalTexture(texture)) {\n          const dontUseRect = offsetX === 0 && offsetY === 0 && width === texture.width && height === texture.height;\n          this.invertYPreMultiplyAlpha(gpuOrHdwTexture, texture.width, texture.height, format, invertY, premultiplyAlpha, faceIndex, mipLevel, layers || 1, offsetX, offsetY, dontUseRect ? 0 : width, dontUseRect ? 0 : height, undefined, allowGPUOptimization);\n        } else {\n          // we should never take this code path\n          throw \"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!\";\n        }\n      }\n    } else {\n      imageBitmap = imageBitmap;\n      if (invertY) {\n        textureCopyView.premultipliedAlpha = false; // we are going to handle premultiplyAlpha ourselves\n        // we must preprocess the image\n        if (WebGPUTextureHelper._IsInternalTexture(texture) && offsetX === 0 && offsetY === 0 && width === texture.width && height === texture.height) {\n          // optimization when the source image is the same size than the destination texture and offsets X/Y == 0:\n          // we simply copy the source to the destination and we apply the preprocessing on the destination\n          this._device.queue.copyExternalImageToTexture({\n            source: imageBitmap\n          }, textureCopyView, textureExtent);\n          this.invertYPreMultiplyAlpha(gpuOrHdwTexture, width, height, format, invertY, premultiplyAlpha, faceIndex, mipLevel, layers || 1, 0, 0, 0, 0, undefined, allowGPUOptimization);\n        } else {\n          // we must apply the preprocessing on the source image before copying it into the destination texture\n          const commandEncoder = this._device.createCommandEncoder({});\n          // create a temp texture and copy the image to it\n          const srcTexture = this.createTexture({\n            width,\n            height,\n            layers: 1\n          }, false, false, false, false, false, format, 1, commandEncoder, WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.TextureBinding, undefined, \"TempTextureForUpdateTexture\");\n          this._deferredReleaseTextures.push([srcTexture, null]);\n          textureExtent.depthOrArrayLayers = 1;\n          this._device.queue.copyExternalImageToTexture({\n            source: imageBitmap\n          }, {\n            texture: srcTexture\n          }, textureExtent);\n          textureExtent.depthOrArrayLayers = layers || 1;\n          // apply the preprocessing to this temp texture\n          this.invertYPreMultiplyAlpha(srcTexture, width, height, format, invertY, premultiplyAlpha, faceIndex, mipLevel, layers || 1, 0, 0, 0, 0, commandEncoder, allowGPUOptimization);\n          // copy the temp texture to the destination texture\n          commandEncoder.copyTextureToTexture({\n            texture: srcTexture\n          }, textureCopyView, textureExtent);\n          this._device.queue.submit([commandEncoder.finish()]);\n        }\n      } else {\n        // no preprocessing: direct copy to destination texture\n        this._device.queue.copyExternalImageToTexture({\n          source: imageBitmap\n        }, textureCopyView, textureExtent);\n      }\n    }\n  }\n  readPixels(texture, x, y, width, height, format, faceIndex = 0, mipLevel = 0, buffer = null, noDataConversion = false) {\n    const blockInformation = WebGPUTextureHelper._GetBlockInformationFromFormat(format);\n    const bytesPerRow = Math.ceil(width / blockInformation.width) * blockInformation.length;\n    const bytesPerRowAligned = Math.ceil(bytesPerRow / 256) * 256;\n    const size = bytesPerRowAligned * height;\n    const gpuBuffer = this._bufferManager.createRawBuffer(size, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst, undefined, \"TempBufferForReadPixels\" + (texture.label ? \"_\" + texture.label : \"\"));\n    const commandEncoder = this._device.createCommandEncoder({});\n    commandEncoder.copyTextureToBuffer({\n      texture,\n      mipLevel,\n      origin: {\n        x,\n        y,\n        z: Math.max(faceIndex, 0)\n      }\n    }, {\n      buffer: gpuBuffer,\n      offset: 0,\n      bytesPerRow: bytesPerRowAligned\n    }, {\n      width,\n      height,\n      depthOrArrayLayers: 1\n    });\n    this._device.queue.submit([commandEncoder.finish()]);\n    return this._bufferManager.readDataFromBuffer(gpuBuffer, size, width, height, bytesPerRow, bytesPerRowAligned, WebGPUTextureHelper._GetTextureTypeFromFormat(format), 0, buffer, true, noDataConversion);\n  }\n  //------------------------------------------------------------------------------\n  //                              Dispose\n  //------------------------------------------------------------------------------\n  releaseTexture(texture) {\n    if (WebGPUTextureHelper._IsInternalTexture(texture)) {\n      const hardwareTexture = texture._hardwareTexture;\n      const irradianceTexture = texture._irradianceTexture;\n      // We can't destroy the objects just now because they could be used in the current frame - we delay the destroying after the end of the frame\n      this._deferredReleaseTextures.push([hardwareTexture, irradianceTexture]);\n    } else {\n      this._deferredReleaseTextures.push([texture, null]);\n    }\n  }\n  destroyDeferredTextures() {\n    for (let i = 0; i < this._deferredReleaseTextures.length; ++i) {\n      const [hardwareTexture, irradianceTexture] = this._deferredReleaseTextures[i];\n      if (hardwareTexture) {\n        if (WebGPUTextureHelper._IsHardwareTexture(hardwareTexture)) {\n          hardwareTexture.release();\n        } else {\n          hardwareTexture.destroy();\n        }\n      }\n      irradianceTexture === null || irradianceTexture === void 0 ? void 0 : irradianceTexture.dispose();\n    }\n    this._deferredReleaseTextures.length = 0;\n  }\n}","map":{"version":3,"names":["WebGPUConstants","Scalar","InternalTextureSource","WebGPUHardwareTexture","mipmapVertexSource","mipmapFragmentSource","invertYPreMultiplyAlphaVertexSource","invertYPreMultiplyAlphaFragmentSource","invertYPreMultiplyAlphaWithOfstVertexSource","invertYPreMultiplyAlphaWithOfstFragmentSource","clearVertexSource","clearFragmentSource","copyVideoToTextureVertexSource","copyVideoToTextureFragmentSource","copyVideoToTextureInvertYFragmentSource","PipelineType","VideoPipelineType","shadersForPipelineType","vertex","fragment","renderableTextureFormatToIndex","r8unorm","r8uint","r8sint","r16uint","r16sint","r16float","rg8unorm","rg8uint","rg8sint","r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8uint","rgba8sint","bgra8unorm","rgb10a2uint","rgb10a2unorm","rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float","rgba32uint","rgba32sint","rgba32float","stencil8","depth16unorm","depth24plus","depth32float","WebGPUTextureHelper","ComputeNumMipmapLevels","width","height","ILog2","Math","max","constructor","device","glslang","tintWASM","bufferManager","enabledExtensions","_pipelines","_compiledShaders","_videoPipelines","_videoCompiledShaders","_deferredReleaseTextures","_device","_glslang","_tintWASM","_bufferManager","indexOf","FeatureName","RG11B10UFloatRenderable","keys","Object","TextureFormat","RG11B10UFloat","length","_mipmapSampler","createSampler","minFilter","FilterMode","Linear","_videoSampler","_ubCopyWithOfst","createBuffer","BufferUsage","Uniform","CopyDst","underlyingResource","_getPipeline","RGBA8Unorm","_getVideoPipeline","format","type","MipMap","params","index","InvertYPremultiplyAlpha","invertY","premultiplyAlpha","Clear","InvertYPremultiplyAlphaWithOfst","pipelineAndBGL","defines","modules","vertexCode","compileGLSL","fragmentCode","convertSpirV2WGSL","vertexModule","createShaderModule","code","fragmentModule","pipeline","createRenderPipeline","layout","AutoLayoutMode","Auto","module","entryPoint","targets","primitive","topology","PrimitiveTopology","TriangleStrip","stripIndexFormat","IndexFormat","Uint16","getBindGroupLayout","DontInvertY","InvertY","label","_GetTextureTypeFromFormat","R8Unorm","R8Snorm","R8Uint","R8Sint","RG8Unorm","RG8Snorm","RG8Uint","RG8Sint","RGBA8UnormSRGB","RGBA8Snorm","RGBA8Uint","RGBA8Sint","BGRA8Unorm","BGRA8UnormSRGB","RGB10A2UINT","RGB10A2Unorm","RGB9E5UFloat","Depth32FloatStencil8","BC7RGBAUnorm","BC7RGBAUnormSRGB","BC6HRGBUFloat","BC6HRGBFloat","BC5RGUnorm","BC5RGSnorm","BC3RGBAUnorm","BC3RGBAUnormSRGB","BC2RGBAUnorm","BC2RGBAUnormSRGB","BC4RUnorm","BC4RSnorm","BC1RGBAUnorm","BC1RGBAUnormSRGB","ETC2RGB8Unorm","ETC2RGB8UnormSRGB","ETC2RGB8A1Unorm","ETC2RGB8A1UnormSRGB","ETC2RGBA8Unorm","ETC2RGBA8UnormSRGB","EACR11Unorm","EACR11Snorm","EACRG11Unorm","EACRG11Snorm","ASTC4x4Unorm","ASTC4x4UnormSRGB","ASTC5x4Unorm","ASTC5x4UnormSRGB","ASTC5x5Unorm","ASTC5x5UnormSRGB","ASTC6x5Unorm","ASTC6x5UnormSRGB","ASTC6x6Unorm","ASTC6x6UnormSRGB","ASTC8x5Unorm","ASTC8x5UnormSRGB","ASTC8x6Unorm","ASTC8x6UnormSRGB","ASTC8x8Unorm","ASTC8x8UnormSRGB","ASTC10x5Unorm","ASTC10x5UnormSRGB","ASTC10x6Unorm","ASTC10x6UnormSRGB","ASTC10x8Unorm","ASTC10x8UnormSRGB","ASTC10x10Unorm","ASTC10x10UnormSRGB","ASTC12x10Unorm","ASTC12x10UnormSRGB","ASTC12x12Unorm","ASTC12x12UnormSRGB","R16Uint","R16Sint","RG16Uint","RG16Sint","RGBA16Uint","RGBA16Sint","Depth16Unorm","R16Float","RG16Float","RGBA16Float","R32Uint","R32Sint","RG32Uint","RG32Sint","RGBA32Uint","RGBA32Sint","R32Float","RG32Float","RGBA32Float","Depth32Float","Stencil8","Depth24Plus","Depth24PlusStencil8","_GetBlockInformationFromFormat","_IsHardwareTexture","texture","release","_IsInternalTexture","dispose","IsImageBitmap","imageBitmap","close","undefined","IsImageBitmapArray","Array","isArray","setCommandEncoder","encoder","_commandEncoderForCreation","IsCompressedFormat","GetWebGPUTextureFormat","useSRGBBuffer","GetNumChannelsFromWebGPUTextureFormat","HasStencilAspect","HasDepthAndStencilAspects","GetDepthFormatOnly","copyVideoToTexture","video","commandEncoder","useOwnCommandEncoder","bindGroupLayout","createCommandEncoder","_b","_a","pushDebugGroup","call","webgpuHardwareTexture","_hardwareTexture","renderPassDescriptor","colorAttachments","view","createView","dimension","TextureViewDimension","E2d","mipLevelCount","baseArrayLayer","baseMipLevel","arrayLayerCount","aspect","TextureAspect","All","loadOp","LoadOp","Load","storeOp","StoreOp","Store","passEncoder","beginRenderPass","descriptor","entries","binding","resource","importExternalTexture","source","bindGroup","createBindGroup","setPipeline","setBindGroup","draw","end","_d","_c","popDebugGroup","queue","submit","finish","invertYPreMultiplyAlpha","gpuOrHdwTexture","faceIndex","mipLevel","layers","ofstX","ofstY","rectWidth","rectHeight","allowGPUOptimization","useRect","gpuTexture","setRawData","Float32Array","outputTexture","_copyInvertYTempTexture","createTexture","TextureUsage","CopySrc","RenderAttachment","TextureBinding","_copyInvertYRenderPassDescr","_copyInvertYBindGroupWithOfst","_copyInvertYBindGroup","push","buffer","copyTextureToTexture","origin","x","y","z","depthOrArrayLayers","_f","_e","copyWithInvertY","srcTextureView","hasMipmaps","generateMipmaps","is3D","sampleCount","usage","additionalUsages","layerCount","textureSize","renderAttachmentFlag","isCompressedFormat","usages","size","TextureDimension","E3d","updateTexture","createCubeTexture","imageBitmaps","updateCubeTextures","generateCubeMipmaps","f","_mipmapGenRenderPassDescr","_mipmapGenBindGroup","i","_h","_g","createGPUTextureForInternalTexture","depth","creationFlags","gpuTextureWrapper","isStorageTexture","_useSRGBBuffer","textureUsages","_source","RenderTarget","MultiRenderTarget","DepthStencil","textureAdditionalUsages","StorageBinding","hasMipMaps","generateMipMaps","mipmapCount","_maxLodLevel","isCube","set","Cube","DepthOnly","is2DArray","E2dArray","baseWidth","baseHeight","baseDepth","createMSAATexture","samples","releaseExisting","releaseMSAATexture","gpuMSAATexture","setMSAATexture","offsetX","offsetY","faces","blockInformation","textureCopyView","premultipliedAlpha","textureExtent","ceil","byteLength","bytesPerRow","aligned","createRawBuffer","MapWrite","arrayBuffer","getMappedRange","Uint8Array","unmap","copyBufferToTexture","offset","rowsPerImage","releaseBuffer","writeTexture","dontUseRect","copyExternalImageToTexture","srcTexture","readPixels","noDataConversion","bytesPerRowAligned","gpuBuffer","MapRead","copyTextureToBuffer","readDataFromBuffer","releaseTexture","hardwareTexture","irradianceTexture","_irradianceTexture","destroyDeferredTextures","destroy"],"sources":["../../../../../dev/core/src/Engines/WebGPU/webgpuTextureHelper.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\r\n/* eslint-disable babylonjs/available */\r\n/* eslint-disable jsdoc/require-jsdoc */\r\n// License for the mipmap generation code:\r\n//\r\n// Copyright 2020 Brandon Jones\r\n//\r\n// Permission is hereby granted, free of charge, to any person obtaining a copy\r\n// of this software and associated documentation files (the \"Software\"), to deal\r\n// in the Software without restriction, including without limitation the rights\r\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n// copies of the Software, and to permit persons to whom the Software is\r\n// furnished to do so, subject to the following conditions:\r\n\r\n// The above copyright notice and this permission notice shall be included in\r\n// all copies or substantial portions of the Software.\r\n\r\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n// SOFTWARE.\r\nimport * as WebGPUConstants from \"./webgpuConstants\";\r\nimport { Scalar } from \"../../Maths/math.scalar\";\r\nimport type { WebGPUBufferManager } from \"./webgpuBufferManager\";\r\nimport { Constants } from \"../constants\";\r\nimport type { Nullable } from \"../../types\";\r\nimport type { InternalTexture } from \"../../Materials/Textures/internalTexture\";\r\nimport { InternalTextureSource } from \"../../Materials/Textures/internalTexture\";\r\nimport type { HardwareTextureWrapper } from \"../../Materials/Textures/hardwareTextureWrapper\";\r\nimport type { BaseTexture } from \"../../Materials/Textures/baseTexture\";\r\nimport { WebGPUHardwareTexture } from \"./webgpuHardwareTexture\";\r\nimport type { WebGPUTintWASM } from \"./webgpuTintWASM\";\r\nimport type { ExternalTexture } from \"../../Materials/Textures/externalTexture\";\r\n\r\n// TODO WEBGPU improve mipmap generation by using compute shaders\r\n\r\n// TODO WEBGPU use WGSL instead of GLSL\r\nconst mipmapVertexSource = `\r\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\r\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\r\n\r\n    layout(location = 0) out vec2 vTex;\r\n\r\n    void main() {\r\n        vTex = tex[gl_VertexIndex];\r\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\r\n    }\r\n    `;\r\n\r\nconst mipmapFragmentSource = `\r\n    layout(set = 0, binding = 0) uniform sampler imgSampler;\r\n    layout(set = 0, binding = 1) uniform texture2D img;\r\n\r\n    layout(location = 0) in vec2 vTex;\r\n    layout(location = 0) out vec4 outColor;\r\n\r\n    void main() {\r\n        outColor = texture(sampler2D(img, imgSampler), vTex);\r\n    }\r\n    `;\r\n\r\nconst invertYPreMultiplyAlphaVertexSource = `\r\n    #extension GL_EXT_samplerless_texture_functions : enable\r\n\r\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\r\n    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\r\n\r\n    layout(set = 0, binding = 0) uniform texture2D img;\r\n\r\n    #ifdef INVERTY\r\n        layout(location = 0) out flat ivec2 vTextureSize;\r\n    #endif\r\n\r\n    void main() {\r\n        #ifdef INVERTY\r\n            vTextureSize = textureSize(img, 0);\r\n        #endif\r\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\r\n    }\r\n    `;\r\n\r\nconst invertYPreMultiplyAlphaFragmentSource = `\r\n    #extension GL_EXT_samplerless_texture_functions : enable\r\n\r\n    layout(set = 0, binding = 0) uniform texture2D img;\r\n\r\n    #ifdef INVERTY\r\n        layout(location = 0) in flat ivec2 vTextureSize;\r\n    #endif\r\n    layout(location = 0) out vec4 outColor;\r\n\r\n    void main() {\r\n    #ifdef INVERTY\r\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);\r\n    #else\r\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\r\n    #endif\r\n    #ifdef PREMULTIPLYALPHA\r\n        color.rgb *= color.a;\r\n    #endif\r\n        outColor = color;\r\n    }\r\n    `;\r\n\r\nconst invertYPreMultiplyAlphaWithOfstVertexSource = invertYPreMultiplyAlphaVertexSource;\r\n\r\nconst invertYPreMultiplyAlphaWithOfstFragmentSource = `\r\n    #extension GL_EXT_samplerless_texture_functions : enable\r\n\r\n    layout(set = 0, binding = 0) uniform texture2D img;\r\n    layout(set = 0, binding = 1) uniform Params {\r\n        float ofstX;\r\n        float ofstY;\r\n        float width;\r\n        float height;\r\n    };\r\n\r\n    #ifdef INVERTY\r\n        layout(location = 0) in flat ivec2 vTextureSize;\r\n    #endif\r\n    layout(location = 0) out vec4 outColor;\r\n\r\n    void main() {\r\n        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {\r\n            discard;\r\n        }\r\n        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {\r\n            discard;\r\n        }\r\n    #ifdef INVERTY\r\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);\r\n    #else\r\n        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);\r\n    #endif\r\n    #ifdef PREMULTIPLYALPHA\r\n        color.rgb *= color.a;\r\n    #endif\r\n        outColor = color;\r\n    }\r\n    `;\r\n\r\nconst clearVertexSource = `\r\n    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\r\n\r\n    void main() {\r\n        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\r\n    }\r\n    `;\r\n\r\nconst clearFragmentSource = `\r\n    layout(set = 0, binding = 0) uniform Uniforms {\r\n        uniform vec4 color;\r\n    };\r\n\r\n    layout(location = 0) out vec4 outColor;\r\n\r\n    void main() {\r\n        outColor = color;\r\n    }\r\n    `;\r\n\r\nconst copyVideoToTextureVertexSource = `\r\n    struct VertexOutput {\r\n        @builtin(position) Position : vec4<f32>,\r\n        @location(0) fragUV : vec2<f32>\r\n    }\r\n  \r\n    @vertex\r\n    fn main(\r\n        @builtin(vertex_index) VertexIndex : u32\r\n    ) -> VertexOutput {\r\n        var pos = array<vec2<f32>, 4>(\r\n            vec2(-1.0,  1.0),\r\n            vec2( 1.0,  1.0),\r\n            vec2(-1.0, -1.0),\r\n            vec2( 1.0, -1.0)\r\n        );\r\n        var tex = array<vec2<f32>, 4>(\r\n            vec2(0.0, 0.0),\r\n            vec2(1.0, 0.0),\r\n            vec2(0.0, 1.0),\r\n            vec2(1.0, 1.0)\r\n        );\r\n\r\n        var output: VertexOutput;\r\n\r\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\r\n        output.fragUV = tex[VertexIndex];\r\n\r\n        return output;\r\n    }\r\n    `;\r\n\r\nconst copyVideoToTextureFragmentSource = `\r\n    @group(0) @binding(0) var videoSampler: sampler;\r\n    @group(0) @binding(1) var videoTexture: texture_external;\r\n\r\n    @fragment\r\n    fn main(\r\n        @location(0) fragUV: vec2<f32>\r\n    ) -> @location(0) vec4<f32> {\r\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);\r\n    }\r\n    `;\r\n\r\nconst copyVideoToTextureInvertYFragmentSource = `\r\n    @group(0) @binding(0) var videoSampler: sampler;\r\n    @group(0) @binding(1) var videoTexture: texture_external;\r\n\r\n    @fragment\r\n    fn main(\r\n        @location(0) fragUV: vec2<f32>\r\n    ) -> @location(0) vec4<f32> {\r\n        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));\r\n    }\r\n    `;\r\n\r\nenum PipelineType {\r\n    MipMap = 0,\r\n    InvertYPremultiplyAlpha = 1,\r\n    Clear = 2,\r\n    InvertYPremultiplyAlphaWithOfst = 3,\r\n}\r\n\r\nenum VideoPipelineType {\r\n    DontInvertY = 0,\r\n    InvertY = 1,\r\n}\r\n\r\ninterface IPipelineParameters {\r\n    invertY?: boolean;\r\n    premultiplyAlpha?: boolean;\r\n}\r\n\r\nconst shadersForPipelineType = [\r\n    { vertex: mipmapVertexSource, fragment: mipmapFragmentSource },\r\n    { vertex: invertYPreMultiplyAlphaVertexSource, fragment: invertYPreMultiplyAlphaFragmentSource },\r\n    { vertex: clearVertexSource, fragment: clearFragmentSource },\r\n    { vertex: invertYPreMultiplyAlphaWithOfstVertexSource, fragment: invertYPreMultiplyAlphaWithOfstFragmentSource },\r\n];\r\n\r\n/**\r\n * Map a (renderable) texture format (GPUTextureFormat) to an index for fast lookup (in caches for eg)\r\n * The number of entries should not go over 64! Else, the code in WebGPUCacheRenderPipeline.setMRT should be updated\r\n */\r\nexport const renderableTextureFormatToIndex: { [name: string]: number } = {\r\n    \"\": 0,\r\n    r8unorm: 1,\r\n    r8uint: 2,\r\n    r8sint: 3,\r\n\r\n    r16uint: 4,\r\n    r16sint: 5,\r\n    r16float: 6,\r\n    rg8unorm: 7,\r\n    rg8uint: 8,\r\n    rg8sint: 9,\r\n\r\n    r32uint: 10,\r\n    r32sint: 11,\r\n    r32float: 12,\r\n    rg16uint: 13,\r\n    rg16sint: 14,\r\n    rg16float: 15,\r\n    rgba8unorm: 16,\r\n    \"rgba8unorm-srgb\": 17,\r\n    rgba8uint: 18,\r\n    rgba8sint: 19,\r\n    bgra8unorm: 20,\r\n    \"bgra8unorm-srgb\": 21,\r\n\r\n    rgb10a2uint: 22,\r\n    rgb10a2unorm: 23,\r\n    /* rg11b10ufloat: this entry is dynamically added if the \"RG11B10UFloatRenderable\" extension is supported */\r\n\r\n    rg32uint: 24,\r\n    rg32sint: 25,\r\n    rg32float: 26,\r\n    rgba16uint: 27,\r\n    rgba16sint: 28,\r\n    rgba16float: 29,\r\n\r\n    rgba32uint: 30,\r\n    rgba32sint: 31,\r\n    rgba32float: 32,\r\n\r\n    stencil8: 33,\r\n    depth16unorm: 34,\r\n    depth24plus: 35,\r\n    \"depth24plus-stencil8\": 36,\r\n    depth32float: 37,\r\n\r\n    \"depth32float-stencil8\": 38,\r\n};\r\n\r\n/** @internal */\r\nexport class WebGPUTextureHelper {\r\n    private _device: GPUDevice;\r\n    private _glslang: any;\r\n    private _tintWASM: Nullable<WebGPUTintWASM>;\r\n    private _bufferManager: WebGPUBufferManager;\r\n    private _mipmapSampler: GPUSampler;\r\n    private _videoSampler: GPUSampler;\r\n    private _ubCopyWithOfst: GPUBuffer;\r\n    private _pipelines: { [format: string]: Array<[GPURenderPipeline, GPUBindGroupLayout]> } = {};\r\n    private _compiledShaders: GPUShaderModule[][] = [];\r\n    private _videoPipelines: { [format: string]: Array<[GPURenderPipeline, GPUBindGroupLayout]> } = {};\r\n    private _videoCompiledShaders: GPUShaderModule[][] = [];\r\n    private _deferredReleaseTextures: Array<[Nullable<HardwareTextureWrapper | GPUTexture>, Nullable<BaseTexture>]> = [];\r\n    private _commandEncoderForCreation: GPUCommandEncoder;\r\n\r\n    public static ComputeNumMipmapLevels(width: number, height: number) {\r\n        return Scalar.ILog2(Math.max(width, height)) + 1;\r\n    }\r\n\r\n    //------------------------------------------------------------------------------\r\n    //                         Initialization / Helpers\r\n    //------------------------------------------------------------------------------\r\n\r\n    constructor(device: GPUDevice, glslang: any, tintWASM: Nullable<WebGPUTintWASM>, bufferManager: WebGPUBufferManager, enabledExtensions: GPUFeatureName[]) {\r\n        this._device = device;\r\n        this._glslang = glslang;\r\n        this._tintWASM = tintWASM;\r\n        this._bufferManager = bufferManager;\r\n\r\n        if (enabledExtensions.indexOf(WebGPUConstants.FeatureName.RG11B10UFloatRenderable) !== -1) {\r\n            const keys = Object.keys(renderableTextureFormatToIndex);\r\n            renderableTextureFormatToIndex[WebGPUConstants.TextureFormat.RG11B10UFloat] = renderableTextureFormatToIndex[keys[keys.length - 1]] + 1;\r\n        }\r\n\r\n        this._mipmapSampler = device.createSampler({ minFilter: WebGPUConstants.FilterMode.Linear });\r\n        this._videoSampler = device.createSampler({ minFilter: WebGPUConstants.FilterMode.Linear });\r\n        this._ubCopyWithOfst = this._bufferManager.createBuffer(\r\n            4 * 4,\r\n            WebGPUConstants.BufferUsage.Uniform | WebGPUConstants.BufferUsage.CopyDst,\r\n            \"UBCopyWithOffset\"\r\n        ).underlyingResource;\r\n\r\n        this._getPipeline(WebGPUConstants.TextureFormat.RGBA8Unorm);\r\n        this._getVideoPipeline(WebGPUConstants.TextureFormat.RGBA8Unorm);\r\n    }\r\n\r\n    private _getPipeline(format: GPUTextureFormat, type: PipelineType = PipelineType.MipMap, params?: IPipelineParameters): [GPURenderPipeline, GPUBindGroupLayout] {\r\n        const index =\r\n            type === PipelineType.MipMap\r\n                ? 1 << 0\r\n                : type === PipelineType.InvertYPremultiplyAlpha\r\n                ? ((params!.invertY ? 1 : 0) << 1) + ((params!.premultiplyAlpha ? 1 : 0) << 2)\r\n                : type === PipelineType.Clear\r\n                ? 1 << 3\r\n                : type === PipelineType.InvertYPremultiplyAlphaWithOfst\r\n                ? ((params!.invertY ? 1 : 0) << 4) + ((params!.premultiplyAlpha ? 1 : 0) << 5)\r\n                : 0;\r\n\r\n        if (!this._pipelines[format]) {\r\n            this._pipelines[format] = [];\r\n        }\r\n\r\n        let pipelineAndBGL = this._pipelines[format][index];\r\n        if (!pipelineAndBGL) {\r\n            let defines = \"#version 450\\n\";\r\n            if (type === PipelineType.InvertYPremultiplyAlpha || type === PipelineType.InvertYPremultiplyAlphaWithOfst) {\r\n                if (params!.invertY) {\r\n                    defines += \"#define INVERTY\\n\";\r\n                }\r\n                if (params!.premultiplyAlpha) {\r\n                    defines += \"#define PREMULTIPLYALPHA\\n\";\r\n                }\r\n            }\r\n\r\n            let modules = this._compiledShaders[index];\r\n            if (!modules) {\r\n                let vertexCode = this._glslang.compileGLSL(defines + shadersForPipelineType[type].vertex, \"vertex\");\r\n                let fragmentCode = this._glslang.compileGLSL(defines + shadersForPipelineType[type].fragment, \"fragment\");\r\n\r\n                if (this._tintWASM) {\r\n                    vertexCode = this._tintWASM.convertSpirV2WGSL(vertexCode);\r\n                    fragmentCode = this._tintWASM.convertSpirV2WGSL(fragmentCode);\r\n                }\r\n\r\n                const vertexModule = this._device.createShaderModule({\r\n                    code: vertexCode,\r\n                });\r\n                const fragmentModule = this._device.createShaderModule({\r\n                    code: fragmentCode,\r\n                });\r\n                modules = this._compiledShaders[index] = [vertexModule, fragmentModule];\r\n            }\r\n\r\n            const pipeline = this._device.createRenderPipeline({\r\n                layout: WebGPUConstants.AutoLayoutMode.Auto,\r\n                vertex: {\r\n                    module: modules[0],\r\n                    entryPoint: \"main\",\r\n                },\r\n                fragment: {\r\n                    module: modules[1],\r\n                    entryPoint: \"main\",\r\n                    targets: [\r\n                        {\r\n                            format,\r\n                        },\r\n                    ],\r\n                },\r\n                primitive: {\r\n                    topology: WebGPUConstants.PrimitiveTopology.TriangleStrip,\r\n                    stripIndexFormat: WebGPUConstants.IndexFormat.Uint16,\r\n                },\r\n            });\r\n\r\n            pipelineAndBGL = this._pipelines[format][index] = [pipeline, pipeline.getBindGroupLayout(0)];\r\n        }\r\n\r\n        return pipelineAndBGL;\r\n    }\r\n\r\n    private _getVideoPipeline(format: GPUTextureFormat, type: VideoPipelineType = VideoPipelineType.DontInvertY): [GPURenderPipeline, GPUBindGroupLayout] {\r\n        const index = type === VideoPipelineType.InvertY ? 1 << 0 : 0;\r\n\r\n        if (!this._videoPipelines[format]) {\r\n            this._videoPipelines[format] = [];\r\n        }\r\n\r\n        let pipelineAndBGL = this._videoPipelines[format][index];\r\n        if (!pipelineAndBGL) {\r\n            let modules = this._videoCompiledShaders[index];\r\n            if (!modules) {\r\n                const vertexModule = this._device.createShaderModule({\r\n                    code: copyVideoToTextureVertexSource,\r\n                });\r\n                const fragmentModule = this._device.createShaderModule({\r\n                    code: index === 0 ? copyVideoToTextureFragmentSource : copyVideoToTextureInvertYFragmentSource,\r\n                });\r\n                modules = this._videoCompiledShaders[index] = [vertexModule, fragmentModule];\r\n            }\r\n\r\n            const pipeline = this._device.createRenderPipeline({\r\n                label: `CopyVideoToTexture_${format}_${index === 0 ? \"DontInvertY\" : \"InvertY\"}`,\r\n                layout: WebGPUConstants.AutoLayoutMode.Auto,\r\n                vertex: {\r\n                    module: modules[0],\r\n                    entryPoint: \"main\",\r\n                },\r\n                fragment: {\r\n                    module: modules[1],\r\n                    entryPoint: \"main\",\r\n                    targets: [\r\n                        {\r\n                            format,\r\n                        },\r\n                    ],\r\n                },\r\n                primitive: {\r\n                    topology: WebGPUConstants.PrimitiveTopology.TriangleStrip,\r\n                    stripIndexFormat: WebGPUConstants.IndexFormat.Uint16,\r\n                },\r\n            });\r\n\r\n            pipelineAndBGL = this._videoPipelines[format][index] = [pipeline, pipeline.getBindGroupLayout(0)];\r\n        }\r\n\r\n        return pipelineAndBGL;\r\n    }\r\n\r\n    private static _GetTextureTypeFromFormat(format: GPUTextureFormat): number {\r\n        switch (format) {\r\n            // One Component = 8 bits\r\n            case WebGPUConstants.TextureFormat.R8Unorm:\r\n            case WebGPUConstants.TextureFormat.R8Snorm:\r\n            case WebGPUConstants.TextureFormat.R8Uint:\r\n            case WebGPUConstants.TextureFormat.R8Sint:\r\n            case WebGPUConstants.TextureFormat.RG8Unorm:\r\n            case WebGPUConstants.TextureFormat.RG8Snorm:\r\n            case WebGPUConstants.TextureFormat.RG8Uint:\r\n            case WebGPUConstants.TextureFormat.RG8Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGBA8Snorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA8Sint:\r\n            case WebGPUConstants.TextureFormat.BGRA8Unorm:\r\n            case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGB10A2UINT: // composite format - let's say it's byte...\r\n            case WebGPUConstants.TextureFormat.RGB10A2Unorm: // composite format - let's say it's byte...\r\n            case WebGPUConstants.TextureFormat.RGB9E5UFloat: // composite format - let's say it's byte...\r\n            case WebGPUConstants.TextureFormat.RG11B10UFloat: // composite format - let's say it's byte...\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8: // composite format - let's say it's byte...\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBFloat:\r\n            case WebGPUConstants.TextureFormat.BC5RGUnorm:\r\n            case WebGPUConstants.TextureFormat.BC5RGSnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC4RUnorm:\r\n            case WebGPUConstants.TextureFormat.BC4RSnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.EACR11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACR11Snorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Snorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\r\n                return Constants.TEXTURETYPE_UNSIGNED_BYTE;\r\n\r\n            // One component = 16 bits\r\n            case WebGPUConstants.TextureFormat.R16Uint:\r\n            case WebGPUConstants.TextureFormat.R16Sint:\r\n            case WebGPUConstants.TextureFormat.RG16Uint:\r\n            case WebGPUConstants.TextureFormat.RG16Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Sint:\r\n            case WebGPUConstants.TextureFormat.Depth16Unorm:\r\n                return Constants.TEXTURETYPE_UNSIGNED_SHORT;\r\n\r\n            case WebGPUConstants.TextureFormat.R16Float:\r\n            case WebGPUConstants.TextureFormat.RG16Float:\r\n            case WebGPUConstants.TextureFormat.RGBA16Float:\r\n                return Constants.TEXTURETYPE_HALF_FLOAT;\r\n\r\n            // One component = 32 bits\r\n            case WebGPUConstants.TextureFormat.R32Uint:\r\n            case WebGPUConstants.TextureFormat.R32Sint:\r\n            case WebGPUConstants.TextureFormat.RG32Uint:\r\n            case WebGPUConstants.TextureFormat.RG32Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Sint:\r\n                return Constants.TEXTURETYPE_UNSIGNED_INTEGER;\r\n\r\n            case WebGPUConstants.TextureFormat.R32Float:\r\n            case WebGPUConstants.TextureFormat.RG32Float:\r\n            case WebGPUConstants.TextureFormat.RGBA32Float:\r\n            case WebGPUConstants.TextureFormat.Depth32Float:\r\n                return Constants.TEXTURETYPE_FLOAT;\r\n\r\n            case WebGPUConstants.TextureFormat.Stencil8:\r\n                throw \"No fixed size for Stencil8 format!\";\r\n            case WebGPUConstants.TextureFormat.Depth24Plus:\r\n                throw \"No fixed size for Depth24Plus format!\";\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n                throw \"No fixed size for Depth24PlusStencil8 format!\";\r\n        }\r\n\r\n        return Constants.TEXTURETYPE_UNSIGNED_BYTE;\r\n    }\r\n\r\n    private static _GetBlockInformationFromFormat(format: GPUTextureFormat): { width: number; height: number; length: number } {\r\n        switch (format) {\r\n            // 8 bits formats\r\n            case WebGPUConstants.TextureFormat.R8Unorm:\r\n            case WebGPUConstants.TextureFormat.R8Snorm:\r\n            case WebGPUConstants.TextureFormat.R8Uint:\r\n            case WebGPUConstants.TextureFormat.R8Sint:\r\n                return { width: 1, height: 1, length: 1 };\r\n\r\n            // 16 bits formats\r\n            case WebGPUConstants.TextureFormat.R16Uint:\r\n            case WebGPUConstants.TextureFormat.R16Sint:\r\n            case WebGPUConstants.TextureFormat.R16Float:\r\n            case WebGPUConstants.TextureFormat.RG8Unorm:\r\n            case WebGPUConstants.TextureFormat.RG8Snorm:\r\n            case WebGPUConstants.TextureFormat.RG8Uint:\r\n            case WebGPUConstants.TextureFormat.RG8Sint:\r\n                return { width: 1, height: 1, length: 2 };\r\n\r\n            // 32 bits formats\r\n            case WebGPUConstants.TextureFormat.R32Uint:\r\n            case WebGPUConstants.TextureFormat.R32Sint:\r\n            case WebGPUConstants.TextureFormat.R32Float:\r\n            case WebGPUConstants.TextureFormat.RG16Uint:\r\n            case WebGPUConstants.TextureFormat.RG16Sint:\r\n            case WebGPUConstants.TextureFormat.RG16Float:\r\n            case WebGPUConstants.TextureFormat.RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGBA8Snorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA8Sint:\r\n            case WebGPUConstants.TextureFormat.BGRA8Unorm:\r\n            case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGB9E5UFloat:\r\n            case WebGPUConstants.TextureFormat.RGB10A2UINT:\r\n            case WebGPUConstants.TextureFormat.RGB10A2Unorm:\r\n            case WebGPUConstants.TextureFormat.RG11B10UFloat:\r\n                return { width: 1, height: 1, length: 4 };\r\n\r\n            // 64 bits formats\r\n            case WebGPUConstants.TextureFormat.RG32Uint:\r\n            case WebGPUConstants.TextureFormat.RG32Sint:\r\n            case WebGPUConstants.TextureFormat.RG32Float:\r\n            case WebGPUConstants.TextureFormat.RGBA16Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Float:\r\n                return { width: 1, height: 1, length: 8 };\r\n\r\n            // 128 bits formats\r\n            case WebGPUConstants.TextureFormat.RGBA32Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Float:\r\n                return { width: 1, height: 1, length: 16 };\r\n\r\n            // Depth and stencil formats\r\n            case WebGPUConstants.TextureFormat.Stencil8:\r\n                throw \"No fixed size for Stencil8 format!\";\r\n            case WebGPUConstants.TextureFormat.Depth16Unorm:\r\n                return { width: 1, height: 1, length: 2 };\r\n            case WebGPUConstants.TextureFormat.Depth24Plus:\r\n                throw \"No fixed size for Depth24Plus format!\";\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n                throw \"No fixed size for Depth24PlusStencil8 format!\";\r\n            case WebGPUConstants.TextureFormat.Depth32Float:\r\n                return { width: 1, height: 1, length: 4 };\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\r\n                return { width: 1, height: 1, length: 5 };\r\n\r\n            // BC compressed formats usable if \"texture-compression-bc\" is both\r\n            // supported by the device/user agent and enabled in requestDevice.\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBFloat:\r\n            case WebGPUConstants.TextureFormat.BC5RGUnorm:\r\n            case WebGPUConstants.TextureFormat.BC5RGSnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\r\n                return { width: 4, height: 4, length: 16 };\r\n\r\n            case WebGPUConstants.TextureFormat.BC4RUnorm:\r\n            case WebGPUConstants.TextureFormat.BC4RSnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\r\n                return { width: 4, height: 4, length: 8 };\r\n\r\n            // ETC2 compressed formats usable if \"texture-compression-etc2\" is both\r\n            // supported by the device/user agent and enabled in requestDevice.\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.EACR11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACR11Snorm:\r\n                return { width: 4, height: 4, length: 8 };\r\n\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.EACRG11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Snorm:\r\n                return { width: 4, height: 4, length: 16 };\r\n\r\n            // ASTC compressed formats usable if \"texture-compression-astc\" is both\r\n            // supported by the device/user agent and enabled in requestDevice.\r\n            case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\r\n                return { width: 4, height: 4, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\r\n                return { width: 5, height: 4, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\r\n                return { width: 5, height: 5, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\r\n                return { width: 6, height: 5, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\r\n                return { width: 6, height: 6, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\r\n                return { width: 8, height: 5, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\r\n                return { width: 8, height: 6, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\r\n                return { width: 8, height: 8, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\r\n                return { width: 10, height: 5, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\r\n                return { width: 10, height: 6, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\r\n                return { width: 10, height: 8, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\r\n                return { width: 10, height: 10, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\r\n                return { width: 12, height: 10, length: 16 };\r\n            case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\r\n                return { width: 12, height: 12, length: 16 };\r\n        }\r\n\r\n        return { width: 1, height: 1, length: 4 };\r\n    }\r\n\r\n    private static _IsHardwareTexture(texture: HardwareTextureWrapper | GPUTexture): texture is HardwareTextureWrapper {\r\n        return !!(texture as HardwareTextureWrapper).release;\r\n    }\r\n\r\n    private static _IsInternalTexture(texture: InternalTexture | GPUTexture): texture is InternalTexture {\r\n        return !!(texture as InternalTexture).dispose;\r\n    }\r\n\r\n    public static IsImageBitmap(imageBitmap: ImageBitmap | { width: number; height: number }): imageBitmap is ImageBitmap {\r\n        return (imageBitmap as ImageBitmap).close !== undefined;\r\n    }\r\n\r\n    public static IsImageBitmapArray(imageBitmap: ImageBitmap[] | { width: number; height: number }): imageBitmap is ImageBitmap[] {\r\n        return Array.isArray(imageBitmap as ImageBitmap[]) && (imageBitmap as ImageBitmap[])[0].close !== undefined;\r\n    }\r\n\r\n    public setCommandEncoder(encoder: GPUCommandEncoder): void {\r\n        this._commandEncoderForCreation = encoder;\r\n    }\r\n\r\n    public static IsCompressedFormat(format: GPUTextureFormat): boolean {\r\n        switch (format) {\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBFloat:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\r\n            case WebGPUConstants.TextureFormat.BC5RGSnorm:\r\n            case WebGPUConstants.TextureFormat.BC5RGUnorm:\r\n            case WebGPUConstants.TextureFormat.BC4RSnorm:\r\n            case WebGPUConstants.TextureFormat.BC4RUnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.EACR11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACR11Snorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Snorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\r\n                return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    public static GetWebGPUTextureFormat(type: number, format: number, useSRGBBuffer = false): GPUTextureFormat {\r\n        switch (format) {\r\n            case Constants.TEXTUREFORMAT_DEPTH16:\r\n                return WebGPUConstants.TextureFormat.Depth16Unorm;\r\n            case Constants.TEXTUREFORMAT_DEPTH24:\r\n                return WebGPUConstants.TextureFormat.Depth24Plus;\r\n            case Constants.TEXTUREFORMAT_DEPTH24_STENCIL8:\r\n                return WebGPUConstants.TextureFormat.Depth24PlusStencil8;\r\n            case Constants.TEXTUREFORMAT_DEPTH32_FLOAT:\r\n                return WebGPUConstants.TextureFormat.Depth32Float;\r\n            case Constants.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8:\r\n                return WebGPUConstants.TextureFormat.Depth32FloatStencil8;\r\n            case Constants.TEXTUREFORMAT_STENCIL8:\r\n                return WebGPUConstants.TextureFormat.Stencil8;\r\n\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC7RGBAUnorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT:\r\n                return WebGPUConstants.TextureFormat.BC6HRGBUFloat;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT:\r\n                return WebGPUConstants.TextureFormat.BC6HRGBFloat;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC3RGBAUnorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC2RGBAUnorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1:\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB : WebGPUConstants.TextureFormat.BC1RGBAUnorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB : WebGPUConstants.TextureFormat.ASTC4x4Unorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL:\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB : WebGPUConstants.TextureFormat.ETC2RGB8Unorm;\r\n            case Constants.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC:\r\n                return useSRGBBuffer ? WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB : WebGPUConstants.TextureFormat.ETC2RGBA8Unorm;\r\n        }\r\n\r\n        switch (type) {\r\n            case Constants.TEXTURETYPE_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return WebGPUConstants.TextureFormat.R8Snorm;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return WebGPUConstants.TextureFormat.RG8Snorm;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        throw \"RGB format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R8Sint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG8Sint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA8Sint;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA8Snorm;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_BYTE:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return WebGPUConstants.TextureFormat.R8Unorm;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return WebGPUConstants.TextureFormat.RG8Unorm;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return useSRGBBuffer ? WebGPUConstants.TextureFormat.RGBA8UnormSRGB : WebGPUConstants.TextureFormat.RGBA8Unorm;\r\n                    case Constants.TEXTUREFORMAT_BGRA:\r\n                        return useSRGBBuffer ? WebGPUConstants.TextureFormat.BGRA8UnormSRGB : WebGPUConstants.TextureFormat.BGRA8Unorm;\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R8Uint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG8Uint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA8Uint;\r\n                    case Constants.TEXTUREFORMAT_ALPHA:\r\n                        throw \"TEXTUREFORMAT_ALPHA format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE:\r\n                        throw \"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_LUMINANCE_ALPHA:\r\n                        throw \"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU\";\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA8Unorm;\r\n                }\r\n            case Constants.TEXTURETYPE_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R16Sint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG16Sint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Sint;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Sint;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R16Uint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG16Uint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Uint;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Uint;\r\n                }\r\n            case Constants.TEXTURETYPE_INT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R32Sint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG32Sint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Sint;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Sint;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_INTEGER: // Refers to UNSIGNED_INT\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.R32Uint;\r\n                    case Constants.TEXTUREFORMAT_RG_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RG32Uint;\r\n                    case Constants.TEXTUREFORMAT_RGB_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Uint;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Uint;\r\n                }\r\n            case Constants.TEXTURETYPE_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return WebGPUConstants.TextureFormat.R32Float; // By default. Other possibility is R16Float.\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return WebGPUConstants.TextureFormat.RG32Float; // By default. Other possibility is RG16Float.\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Float; // By default. Other possibility is RGBA16Float.\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA32Float;\r\n                }\r\n            case Constants.TEXTURETYPE_HALF_FLOAT:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RED:\r\n                        return WebGPUConstants.TextureFormat.R16Float;\r\n                    case Constants.TEXTUREFORMAT_RG:\r\n                        return WebGPUConstants.TextureFormat.RG16Float;\r\n                    case Constants.TEXTUREFORMAT_RGB:\r\n                        throw \"TEXTUREFORMAT_RGB format not supported in WebGPU\";\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Float;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGBA16Float;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_6_5:\r\n                throw \"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU\";\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return WebGPUConstants.TextureFormat.RG11B10UFloat;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV\";\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RG11B10UFloat;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return WebGPUConstants.TextureFormat.RGB9E5UFloat;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        throw \"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV\";\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGB9E5UFloat;\r\n                }\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4:\r\n                throw \"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU\";\r\n            case Constants.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1:\r\n                throw \"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU\";\r\n            case Constants.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV:\r\n                switch (format) {\r\n                    case Constants.TEXTUREFORMAT_RGBA:\r\n                        return WebGPUConstants.TextureFormat.RGB10A2Unorm;\r\n                    case Constants.TEXTUREFORMAT_RGBA_INTEGER:\r\n                        return WebGPUConstants.TextureFormat.RGB10A2UINT;\r\n                    default:\r\n                        return WebGPUConstants.TextureFormat.RGB10A2Unorm;\r\n                }\r\n        }\r\n\r\n        return useSRGBBuffer ? WebGPUConstants.TextureFormat.RGBA8UnormSRGB : WebGPUConstants.TextureFormat.RGBA8Unorm;\r\n    }\r\n\r\n    public static GetNumChannelsFromWebGPUTextureFormat(format: GPUTextureFormat): number {\r\n        switch (format) {\r\n            case WebGPUConstants.TextureFormat.R8Unorm:\r\n            case WebGPUConstants.TextureFormat.R8Snorm:\r\n            case WebGPUConstants.TextureFormat.R8Uint:\r\n            case WebGPUConstants.TextureFormat.R8Sint:\r\n            case WebGPUConstants.TextureFormat.BC4RUnorm:\r\n            case WebGPUConstants.TextureFormat.BC4RSnorm:\r\n            case WebGPUConstants.TextureFormat.R16Uint:\r\n            case WebGPUConstants.TextureFormat.R16Sint:\r\n            case WebGPUConstants.TextureFormat.Depth16Unorm:\r\n            case WebGPUConstants.TextureFormat.R16Float:\r\n            case WebGPUConstants.TextureFormat.R32Uint:\r\n            case WebGPUConstants.TextureFormat.R32Sint:\r\n            case WebGPUConstants.TextureFormat.R32Float:\r\n            case WebGPUConstants.TextureFormat.Depth32Float:\r\n            case WebGPUConstants.TextureFormat.Stencil8:\r\n            case WebGPUConstants.TextureFormat.Depth24Plus:\r\n            case WebGPUConstants.TextureFormat.EACR11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACR11Snorm:\r\n                return 1;\r\n\r\n            case WebGPUConstants.TextureFormat.RG8Unorm:\r\n            case WebGPUConstants.TextureFormat.RG8Snorm:\r\n            case WebGPUConstants.TextureFormat.RG8Uint:\r\n            case WebGPUConstants.TextureFormat.RG8Sint:\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\r\n            case WebGPUConstants.TextureFormat.BC5RGUnorm:\r\n            case WebGPUConstants.TextureFormat.BC5RGSnorm:\r\n            case WebGPUConstants.TextureFormat.RG16Uint:\r\n            case WebGPUConstants.TextureFormat.RG16Sint:\r\n            case WebGPUConstants.TextureFormat.RG16Float:\r\n            case WebGPUConstants.TextureFormat.RG32Uint:\r\n            case WebGPUConstants.TextureFormat.RG32Sint:\r\n            case WebGPUConstants.TextureFormat.RG32Float:\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n            case WebGPUConstants.TextureFormat.EACRG11Unorm:\r\n            case WebGPUConstants.TextureFormat.EACRG11Snorm:\r\n                return 2;\r\n\r\n            case WebGPUConstants.TextureFormat.RGB9E5UFloat:\r\n            case WebGPUConstants.TextureFormat.RG11B10UFloat:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBUFloat:\r\n            case WebGPUConstants.TextureFormat.BC6HRGBFloat:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8UnormSRGB:\r\n                return 3;\r\n\r\n            case WebGPUConstants.TextureFormat.RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGBA8Snorm:\r\n            case WebGPUConstants.TextureFormat.RGBA8Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA8Sint:\r\n            case WebGPUConstants.TextureFormat.BGRA8Unorm:\r\n            case WebGPUConstants.TextureFormat.BGRA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGB10A2UINT:\r\n            case WebGPUConstants.TextureFormat.RGB10A2Unorm:\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC7RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC3RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC2RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnorm:\r\n            case WebGPUConstants.TextureFormat.BC1RGBAUnormSRGB:\r\n            case WebGPUConstants.TextureFormat.RGBA16Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA16Float:\r\n            case WebGPUConstants.TextureFormat.RGBA32Uint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Sint:\r\n            case WebGPUConstants.TextureFormat.RGBA32Float:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGB8A1UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8Unorm:\r\n            case WebGPUConstants.TextureFormat.ETC2RGBA8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC4x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x4UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC5x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC6x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC8x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x5UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x6UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x8UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC10x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x10UnormSRGB:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12Unorm:\r\n            case WebGPUConstants.TextureFormat.ASTC12x12UnormSRGB:\r\n                return 4;\r\n        }\r\n\r\n        throw `Unknown format ${format}!`;\r\n    }\r\n\r\n    public static HasStencilAspect(format: GPUTextureFormat): boolean {\r\n        switch (format) {\r\n            case WebGPUConstants.TextureFormat.Stencil8:\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n                return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    public static HasDepthAndStencilAspects(format: GPUTextureFormat): boolean {\r\n        switch (format) {\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n                return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    public static GetDepthFormatOnly(format: GPUTextureFormat): GPUTextureFormat {\r\n        switch (format) {\r\n            case WebGPUConstants.TextureFormat.Depth16Unorm:\r\n                return WebGPUConstants.TextureFormat.Depth16Unorm;\r\n            case WebGPUConstants.TextureFormat.Depth24Plus:\r\n                return WebGPUConstants.TextureFormat.Depth24Plus;\r\n            case WebGPUConstants.TextureFormat.Depth24PlusStencil8:\r\n                return WebGPUConstants.TextureFormat.Depth24Plus;\r\n            case WebGPUConstants.TextureFormat.Depth32Float:\r\n                return WebGPUConstants.TextureFormat.Depth32Float;\r\n            case WebGPUConstants.TextureFormat.Depth32FloatStencil8:\r\n                return WebGPUConstants.TextureFormat.Depth32Float;\r\n        }\r\n\r\n        return format;\r\n    }\r\n\r\n    public copyVideoToTexture(video: ExternalTexture, texture: InternalTexture, format: GPUTextureFormat, invertY = false, commandEncoder?: GPUCommandEncoder): void {\r\n        const useOwnCommandEncoder = commandEncoder === undefined;\r\n        const [pipeline, bindGroupLayout] = this._getVideoPipeline(format, invertY ? VideoPipelineType.InvertY : VideoPipelineType.DontInvertY);\r\n\r\n        if (useOwnCommandEncoder) {\r\n            commandEncoder = this._device.createCommandEncoder({});\r\n        }\r\n\r\n        commandEncoder!.pushDebugGroup?.(`copy video to texture - invertY=${invertY}`);\r\n\r\n        const webgpuHardwareTexture = texture._hardwareTexture as WebGPUHardwareTexture;\r\n\r\n        const renderPassDescriptor: GPURenderPassDescriptor = {\r\n            colorAttachments: [\r\n                {\r\n                    view: webgpuHardwareTexture.underlyingResource!.createView({\r\n                        format,\r\n                        dimension: WebGPUConstants.TextureViewDimension.E2d,\r\n                        mipLevelCount: 1,\r\n                        baseArrayLayer: 0,\r\n                        baseMipLevel: 0,\r\n                        arrayLayerCount: 1,\r\n                        aspect: WebGPUConstants.TextureAspect.All,\r\n                    }),\r\n                    loadOp: WebGPUConstants.LoadOp.Load,\r\n                    storeOp: WebGPUConstants.StoreOp.Store,\r\n                },\r\n            ],\r\n        };\r\n        const passEncoder = commandEncoder!.beginRenderPass(renderPassDescriptor);\r\n\r\n        const descriptor: GPUBindGroupDescriptor = {\r\n            layout: bindGroupLayout,\r\n            entries: [\r\n                {\r\n                    binding: 0,\r\n                    resource: this._videoSampler,\r\n                },\r\n                {\r\n                    binding: 1,\r\n                    resource: this._device.importExternalTexture({\r\n                        source: video.underlyingResource,\r\n                    }),\r\n                },\r\n            ],\r\n        };\r\n\r\n        const bindGroup = this._device.createBindGroup(descriptor);\r\n\r\n        passEncoder.setPipeline(pipeline);\r\n        passEncoder.setBindGroup(0, bindGroup);\r\n        passEncoder.draw(4, 1, 0, 0);\r\n        passEncoder.end();\r\n\r\n        commandEncoder!.popDebugGroup?.();\r\n\r\n        if (useOwnCommandEncoder) {\r\n            this._device.queue.submit([commandEncoder!.finish()]);\r\n            commandEncoder = null as any;\r\n        }\r\n    }\r\n\r\n    public invertYPreMultiplyAlpha(\r\n        gpuOrHdwTexture: GPUTexture | WebGPUHardwareTexture,\r\n        width: number,\r\n        height: number,\r\n        format: GPUTextureFormat,\r\n        invertY = false,\r\n        premultiplyAlpha = false,\r\n        faceIndex = 0,\r\n        mipLevel = 0,\r\n        layers = 1,\r\n        ofstX = 0,\r\n        ofstY = 0,\r\n        rectWidth = 0,\r\n        rectHeight = 0,\r\n        commandEncoder?: GPUCommandEncoder,\r\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n        allowGPUOptimization?: boolean\r\n    ): void {\r\n        const useRect = rectWidth !== 0;\r\n        const useOwnCommandEncoder = commandEncoder === undefined;\r\n        const [pipeline, bindGroupLayout] = this._getPipeline(format, useRect ? PipelineType.InvertYPremultiplyAlphaWithOfst : PipelineType.InvertYPremultiplyAlpha, {\r\n            invertY,\r\n            premultiplyAlpha,\r\n        });\r\n\r\n        faceIndex = Math.max(faceIndex, 0);\r\n\r\n        if (useOwnCommandEncoder) {\r\n            commandEncoder = this._device.createCommandEncoder({});\r\n        }\r\n\r\n        commandEncoder!.pushDebugGroup?.(`internal process texture - invertY=${invertY} premultiplyAlpha=${premultiplyAlpha}`);\r\n\r\n        let gpuTexture: Nullable<GPUTexture>;\r\n        if (WebGPUTextureHelper._IsHardwareTexture(gpuOrHdwTexture)) {\r\n            gpuTexture = gpuOrHdwTexture.underlyingResource;\r\n            if (!(invertY && !premultiplyAlpha && layers === 1 && faceIndex === 0)) {\r\n                // we optimize only for the most likely case (invertY=true, premultiplyAlpha=false, layers=1, faceIndex=0) to avoid dealing with big caches\r\n                gpuOrHdwTexture = undefined as any;\r\n            }\r\n        } else {\r\n            gpuTexture = gpuOrHdwTexture;\r\n            gpuOrHdwTexture = undefined as any;\r\n        }\r\n        if (!gpuTexture) {\r\n            return;\r\n        }\r\n\r\n        if (useRect) {\r\n            this._bufferManager.setRawData(this._ubCopyWithOfst, 0, new Float32Array([ofstX, ofstY, rectWidth, rectHeight]), 0, 4 * 4);\r\n        }\r\n\r\n        const webgpuHardwareTexture = gpuOrHdwTexture as Nullable<WebGPUHardwareTexture>;\r\n\r\n        const outputTexture =\r\n            webgpuHardwareTexture?._copyInvertYTempTexture ??\r\n            this.createTexture(\r\n                { width, height, layers: 1 },\r\n                false,\r\n                false,\r\n                false,\r\n                false,\r\n                false,\r\n                format,\r\n                1,\r\n                commandEncoder,\r\n                WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.RenderAttachment | WebGPUConstants.TextureUsage.TextureBinding,\r\n                undefined,\r\n                \"TempTextureForCopyWithInvertY\"\r\n            );\r\n\r\n        const renderPassDescriptor = webgpuHardwareTexture?._copyInvertYRenderPassDescr ?? {\r\n            colorAttachments: [\r\n                {\r\n                    view: outputTexture.createView({\r\n                        format,\r\n                        dimension: WebGPUConstants.TextureViewDimension.E2d,\r\n                        baseMipLevel: 0,\r\n                        mipLevelCount: 1,\r\n                        arrayLayerCount: 1,\r\n                        baseArrayLayer: 0,\r\n                    }),\r\n                    loadOp: WebGPUConstants.LoadOp.Load,\r\n                    storeOp: WebGPUConstants.StoreOp.Store,\r\n                },\r\n            ],\r\n        };\r\n        const passEncoder = commandEncoder!.beginRenderPass(renderPassDescriptor);\r\n\r\n        let bindGroup = useRect ? webgpuHardwareTexture?._copyInvertYBindGroupWithOfst : webgpuHardwareTexture?._copyInvertYBindGroup;\r\n        if (!bindGroup) {\r\n            const descriptor: GPUBindGroupDescriptor = {\r\n                layout: bindGroupLayout,\r\n                entries: [\r\n                    {\r\n                        binding: 0,\r\n                        resource: gpuTexture.createView({\r\n                            format,\r\n                            dimension: WebGPUConstants.TextureViewDimension.E2d,\r\n                            baseMipLevel: mipLevel,\r\n                            mipLevelCount: 1,\r\n                            arrayLayerCount: layers,\r\n                            baseArrayLayer: faceIndex,\r\n                        }),\r\n                    },\r\n                ],\r\n            };\r\n            if (useRect) {\r\n                descriptor.entries.push({\r\n                    binding: 1,\r\n                    resource: {\r\n                        buffer: this._ubCopyWithOfst,\r\n                    },\r\n                });\r\n            }\r\n            bindGroup = this._device.createBindGroup(descriptor);\r\n        }\r\n\r\n        passEncoder.setPipeline(pipeline);\r\n        passEncoder.setBindGroup(0, bindGroup);\r\n        passEncoder.draw(4, 1, 0, 0);\r\n        passEncoder.end();\r\n\r\n        commandEncoder!.copyTextureToTexture(\r\n            {\r\n                texture: outputTexture,\r\n            },\r\n            {\r\n                texture: gpuTexture,\r\n                mipLevel,\r\n                origin: {\r\n                    x: 0,\r\n                    y: 0,\r\n                    z: faceIndex,\r\n                },\r\n            },\r\n            {\r\n                width,\r\n                height,\r\n                depthOrArrayLayers: 1,\r\n            }\r\n        );\r\n\r\n        if (webgpuHardwareTexture) {\r\n            webgpuHardwareTexture._copyInvertYTempTexture = outputTexture;\r\n            webgpuHardwareTexture._copyInvertYRenderPassDescr = renderPassDescriptor;\r\n            if (useRect) {\r\n                webgpuHardwareTexture._copyInvertYBindGroupWithOfst = bindGroup;\r\n            } else {\r\n                webgpuHardwareTexture._copyInvertYBindGroup = bindGroup;\r\n            }\r\n        } else {\r\n            this._deferredReleaseTextures.push([outputTexture, null]);\r\n        }\r\n\r\n        commandEncoder!.popDebugGroup?.();\r\n\r\n        if (useOwnCommandEncoder) {\r\n            this._device.queue.submit([commandEncoder!.finish()]);\r\n            commandEncoder = null as any;\r\n        }\r\n    }\r\n\r\n    public copyWithInvertY(srcTextureView: GPUTextureView, format: GPUTextureFormat, renderPassDescriptor: GPURenderPassDescriptor, commandEncoder?: GPUCommandEncoder): void {\r\n        const useOwnCommandEncoder = commandEncoder === undefined;\r\n        const [pipeline, bindGroupLayout] = this._getPipeline(format, PipelineType.InvertYPremultiplyAlpha, { invertY: true, premultiplyAlpha: false });\r\n\r\n        if (useOwnCommandEncoder) {\r\n            commandEncoder = this._device.createCommandEncoder({});\r\n        }\r\n\r\n        commandEncoder!.pushDebugGroup?.(`internal copy texture with invertY`);\r\n\r\n        const passEncoder = commandEncoder!.beginRenderPass(renderPassDescriptor);\r\n\r\n        const bindGroup = this._device.createBindGroup({\r\n            layout: bindGroupLayout,\r\n            entries: [\r\n                {\r\n                    binding: 0,\r\n                    resource: srcTextureView,\r\n                },\r\n            ],\r\n        });\r\n\r\n        passEncoder.setPipeline(pipeline);\r\n        passEncoder.setBindGroup(0, bindGroup);\r\n        passEncoder.draw(4, 1, 0, 0);\r\n        passEncoder.end();\r\n\r\n        commandEncoder!.popDebugGroup?.();\r\n\r\n        if (useOwnCommandEncoder) {\r\n            this._device.queue.submit([commandEncoder!.finish()]);\r\n            commandEncoder = null as any;\r\n        }\r\n    }\r\n\r\n    //------------------------------------------------------------------------------\r\n    //                               Creation\r\n    //------------------------------------------------------------------------------\r\n\r\n    public createTexture(\r\n        imageBitmap: ImageBitmap | { width: number; height: number; layers: number },\r\n        hasMipmaps = false,\r\n        generateMipmaps = false,\r\n        invertY = false,\r\n        premultiplyAlpha = false,\r\n        is3D = false,\r\n        format: GPUTextureFormat = WebGPUConstants.TextureFormat.RGBA8Unorm,\r\n        sampleCount = 1,\r\n        commandEncoder?: GPUCommandEncoder,\r\n        usage = -1,\r\n        additionalUsages = 0,\r\n        label?: string\r\n    ): GPUTexture {\r\n        if (sampleCount > 1) {\r\n            // WebGPU only supports 1 or 4\r\n            sampleCount = 4;\r\n        }\r\n\r\n        const layerCount = (imageBitmap as any).layers || 1;\r\n        const textureSize = {\r\n            width: imageBitmap.width,\r\n            height: imageBitmap.height,\r\n            depthOrArrayLayers: layerCount,\r\n        };\r\n\r\n        const renderAttachmentFlag = renderableTextureFormatToIndex[format] ? WebGPUConstants.TextureUsage.RenderAttachment : 0;\r\n        const isCompressedFormat = WebGPUTextureHelper.IsCompressedFormat(format);\r\n        const mipLevelCount = hasMipmaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(imageBitmap.width, imageBitmap.height) : 1;\r\n        const usages = usage >= 0 ? usage : WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.CopyDst | WebGPUConstants.TextureUsage.TextureBinding;\r\n\r\n        additionalUsages |= hasMipmaps && !isCompressedFormat ? WebGPUConstants.TextureUsage.CopySrc | renderAttachmentFlag : 0;\r\n\r\n        if (!isCompressedFormat && !is3D) {\r\n            // we don't know in advance if the texture will be updated with copyExternalImageToTexture (which requires to have those flags), so we need to force the flags all the times\r\n            additionalUsages |= renderAttachmentFlag | WebGPUConstants.TextureUsage.CopyDst;\r\n        }\r\n\r\n        const gpuTexture = this._device.createTexture({\r\n            label: `Texture${is3D ? \"3D\" : \"2D\"}_${label ? label + \"_\" : \"\"}${textureSize.width}x${textureSize.height}x${textureSize.depthOrArrayLayers}_${\r\n                hasMipmaps ? \"wmips\" : \"womips\"\r\n            }_${format}_samples${sampleCount}`,\r\n            size: textureSize,\r\n            dimension: is3D ? WebGPUConstants.TextureDimension.E3d : WebGPUConstants.TextureDimension.E2d,\r\n            format,\r\n            usage: usages | additionalUsages,\r\n            sampleCount,\r\n            mipLevelCount,\r\n        });\r\n\r\n        if (WebGPUTextureHelper.IsImageBitmap(imageBitmap)) {\r\n            this.updateTexture(imageBitmap, gpuTexture, imageBitmap.width, imageBitmap.height, layerCount, format, 0, 0, invertY, premultiplyAlpha, 0, 0);\r\n\r\n            if (hasMipmaps && generateMipmaps) {\r\n                this.generateMipmaps(gpuTexture, format, mipLevelCount, 0, commandEncoder);\r\n            }\r\n        }\r\n\r\n        return gpuTexture;\r\n    }\r\n\r\n    public createCubeTexture(\r\n        imageBitmaps: ImageBitmap[] | { width: number; height: number },\r\n        hasMipmaps = false,\r\n        generateMipmaps = false,\r\n        invertY = false,\r\n        premultiplyAlpha = false,\r\n        format: GPUTextureFormat = WebGPUConstants.TextureFormat.RGBA8Unorm,\r\n        sampleCount = 1,\r\n        commandEncoder?: GPUCommandEncoder,\r\n        usage = -1,\r\n        additionalUsages = 0,\r\n        label?: string\r\n    ): GPUTexture {\r\n        if (sampleCount > 1) {\r\n            // WebGPU only supports 1 or 4\r\n            sampleCount = 4;\r\n        }\r\n\r\n        const width = WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps) ? imageBitmaps[0].width : imageBitmaps.width;\r\n        const height = WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps) ? imageBitmaps[0].height : imageBitmaps.height;\r\n\r\n        const renderAttachmentFlag = renderableTextureFormatToIndex[format] ? WebGPUConstants.TextureUsage.RenderAttachment : 0;\r\n        const isCompressedFormat = WebGPUTextureHelper.IsCompressedFormat(format);\r\n        const mipLevelCount = hasMipmaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(width, height) : 1;\r\n        const usages = usage >= 0 ? usage : WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.CopyDst | WebGPUConstants.TextureUsage.TextureBinding;\r\n\r\n        additionalUsages |= hasMipmaps && !isCompressedFormat ? WebGPUConstants.TextureUsage.CopySrc | renderAttachmentFlag : 0;\r\n\r\n        if (!isCompressedFormat) {\r\n            // we don't know in advance if the texture will be updated with copyExternalImageToTexture (which requires to have those flags), so we need to force the flags all the times\r\n            additionalUsages |= renderAttachmentFlag | WebGPUConstants.TextureUsage.CopyDst;\r\n        }\r\n\r\n        const gpuTexture = this._device.createTexture({\r\n            label: `TextureCube_${label ? label + \"_\" : \"\"}${width}x${height}x6_${hasMipmaps ? \"wmips\" : \"womips\"}_${format}_samples${sampleCount}`,\r\n            size: {\r\n                width,\r\n                height,\r\n                depthOrArrayLayers: 6,\r\n            },\r\n            dimension: WebGPUConstants.TextureDimension.E2d,\r\n            format,\r\n            usage: usages | additionalUsages,\r\n            sampleCount,\r\n            mipLevelCount,\r\n        });\r\n\r\n        if (WebGPUTextureHelper.IsImageBitmapArray(imageBitmaps)) {\r\n            this.updateCubeTextures(imageBitmaps, gpuTexture, width, height, format, invertY, premultiplyAlpha, 0, 0);\r\n\r\n            if (hasMipmaps && generateMipmaps) {\r\n                this.generateCubeMipmaps(gpuTexture, format, mipLevelCount, commandEncoder);\r\n            }\r\n        }\r\n\r\n        return gpuTexture;\r\n    }\r\n\r\n    public generateCubeMipmaps(gpuTexture: GPUTexture | WebGPUHardwareTexture, format: GPUTextureFormat, mipLevelCount: number, commandEncoder?: GPUCommandEncoder): void {\r\n        const useOwnCommandEncoder = commandEncoder === undefined;\r\n\r\n        if (useOwnCommandEncoder) {\r\n            commandEncoder = this._device.createCommandEncoder({});\r\n        }\r\n\r\n        commandEncoder!.pushDebugGroup?.(`create cube mipmaps - ${mipLevelCount} levels`);\r\n\r\n        for (let f = 0; f < 6; ++f) {\r\n            this.generateMipmaps(gpuTexture, format, mipLevelCount, f, commandEncoder);\r\n        }\r\n\r\n        commandEncoder!.popDebugGroup?.();\r\n\r\n        if (useOwnCommandEncoder) {\r\n            this._device.queue.submit([commandEncoder!.finish()]);\r\n            commandEncoder = null as any;\r\n        }\r\n    }\r\n\r\n    public generateMipmaps(\r\n        gpuOrHdwTexture: GPUTexture | WebGPUHardwareTexture,\r\n        format: GPUTextureFormat,\r\n        mipLevelCount: number,\r\n        faceIndex = 0,\r\n        commandEncoder?: GPUCommandEncoder\r\n    ): void {\r\n        const useOwnCommandEncoder = commandEncoder === undefined;\r\n        const [pipeline, bindGroupLayout] = this._getPipeline(format);\r\n\r\n        faceIndex = Math.max(faceIndex, 0);\r\n\r\n        if (useOwnCommandEncoder) {\r\n            commandEncoder = this._device.createCommandEncoder({});\r\n        }\r\n\r\n        commandEncoder!.pushDebugGroup?.(`create mipmaps for face #${faceIndex} - ${mipLevelCount} levels`);\r\n\r\n        let gpuTexture: Nullable<GPUTexture>;\r\n        if (WebGPUTextureHelper._IsHardwareTexture(gpuOrHdwTexture)) {\r\n            gpuTexture = gpuOrHdwTexture.underlyingResource;\r\n            gpuOrHdwTexture._mipmapGenRenderPassDescr = gpuOrHdwTexture._mipmapGenRenderPassDescr || [];\r\n            gpuOrHdwTexture._mipmapGenBindGroup = gpuOrHdwTexture._mipmapGenBindGroup || [];\r\n        } else {\r\n            gpuTexture = gpuOrHdwTexture;\r\n            gpuOrHdwTexture = undefined as any;\r\n        }\r\n        if (!gpuTexture) {\r\n            return;\r\n        }\r\n\r\n        const webgpuHardwareTexture = gpuOrHdwTexture as Nullable<WebGPUHardwareTexture>;\r\n        for (let i = 1; i < mipLevelCount; ++i) {\r\n            const renderPassDescriptor = webgpuHardwareTexture?._mipmapGenRenderPassDescr[faceIndex]?.[i - 1] ?? {\r\n                colorAttachments: [\r\n                    {\r\n                        view: gpuTexture.createView({\r\n                            format,\r\n                            dimension: WebGPUConstants.TextureViewDimension.E2d,\r\n                            baseMipLevel: i,\r\n                            mipLevelCount: 1,\r\n                            arrayLayerCount: 1,\r\n                            baseArrayLayer: faceIndex,\r\n                        }),\r\n                        loadOp: WebGPUConstants.LoadOp.Load,\r\n                        storeOp: WebGPUConstants.StoreOp.Store,\r\n                    },\r\n                ],\r\n            };\r\n            if (webgpuHardwareTexture) {\r\n                webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex] = webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex] || [];\r\n                webgpuHardwareTexture._mipmapGenRenderPassDescr[faceIndex][i - 1] = renderPassDescriptor;\r\n            }\r\n            const passEncoder = commandEncoder!.beginRenderPass(renderPassDescriptor);\r\n\r\n            const bindGroup =\r\n                webgpuHardwareTexture?._mipmapGenBindGroup[faceIndex]?.[i - 1] ??\r\n                this._device.createBindGroup({\r\n                    layout: bindGroupLayout,\r\n                    entries: [\r\n                        {\r\n                            binding: 0,\r\n                            resource: this._mipmapSampler,\r\n                        },\r\n                        {\r\n                            binding: 1,\r\n                            resource: gpuTexture.createView({\r\n                                format,\r\n                                dimension: WebGPUConstants.TextureViewDimension.E2d,\r\n                                baseMipLevel: i - 1,\r\n                                mipLevelCount: 1,\r\n                                arrayLayerCount: 1,\r\n                                baseArrayLayer: faceIndex,\r\n                            }),\r\n                        },\r\n                    ],\r\n                });\r\n            if (webgpuHardwareTexture) {\r\n                webgpuHardwareTexture._mipmapGenBindGroup[faceIndex] = webgpuHardwareTexture._mipmapGenBindGroup[faceIndex] || [];\r\n                webgpuHardwareTexture._mipmapGenBindGroup[faceIndex][i - 1] = bindGroup;\r\n            }\r\n\r\n            passEncoder.setPipeline(pipeline);\r\n            passEncoder.setBindGroup(0, bindGroup);\r\n            passEncoder.draw(4, 1, 0, 0);\r\n            passEncoder.end();\r\n        }\r\n\r\n        commandEncoder!.popDebugGroup?.();\r\n\r\n        if (useOwnCommandEncoder) {\r\n            this._device.queue.submit([commandEncoder!.finish()]);\r\n            commandEncoder = null as any;\r\n        }\r\n    }\r\n\r\n    public createGPUTextureForInternalTexture(texture: InternalTexture, width?: number, height?: number, depth?: number, creationFlags?: number): WebGPUHardwareTexture {\r\n        if (!texture._hardwareTexture) {\r\n            texture._hardwareTexture = new WebGPUHardwareTexture();\r\n        }\r\n\r\n        if (width === undefined) {\r\n            width = texture.width;\r\n        }\r\n        if (height === undefined) {\r\n            height = texture.height;\r\n        }\r\n        if (depth === undefined) {\r\n            depth = texture.depth;\r\n        }\r\n\r\n        const gpuTextureWrapper = texture._hardwareTexture as WebGPUHardwareTexture;\r\n        const isStorageTexture = ((creationFlags ?? 0) & Constants.TEXTURE_CREATIONFLAG_STORAGE) !== 0;\r\n\r\n        gpuTextureWrapper.format = WebGPUTextureHelper.GetWebGPUTextureFormat(texture.type, texture.format, texture._useSRGBBuffer);\r\n\r\n        gpuTextureWrapper.textureUsages =\r\n            texture._source === InternalTextureSource.RenderTarget || texture.source === InternalTextureSource.MultiRenderTarget\r\n                ? WebGPUConstants.TextureUsage.TextureBinding | WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.RenderAttachment\r\n                : texture._source === InternalTextureSource.DepthStencil\r\n                ? WebGPUConstants.TextureUsage.TextureBinding | WebGPUConstants.TextureUsage.RenderAttachment\r\n                : -1;\r\n\r\n        gpuTextureWrapper.textureAdditionalUsages = isStorageTexture ? WebGPUConstants.TextureUsage.StorageBinding : 0;\r\n\r\n        const hasMipMaps = texture.generateMipMaps;\r\n        const layerCount = depth || 1;\r\n        let mipmapCount;\r\n        if (texture._maxLodLevel !== null) {\r\n            mipmapCount = texture._maxLodLevel;\r\n        } else {\r\n            mipmapCount = hasMipMaps ? WebGPUTextureHelper.ComputeNumMipmapLevels(width!, height!) : 1;\r\n        }\r\n\r\n        if (texture.isCube) {\r\n            const gpuTexture = this.createCubeTexture(\r\n                { width, height },\r\n                texture.generateMipMaps,\r\n                texture.generateMipMaps,\r\n                texture.invertY,\r\n                false,\r\n                gpuTextureWrapper.format,\r\n                1,\r\n                this._commandEncoderForCreation,\r\n                gpuTextureWrapper.textureUsages,\r\n                gpuTextureWrapper.textureAdditionalUsages,\r\n                texture.label\r\n            );\r\n\r\n            gpuTextureWrapper.set(gpuTexture);\r\n            gpuTextureWrapper.createView(\r\n                {\r\n                    format: WebGPUTextureHelper.GetDepthFormatOnly(gpuTextureWrapper.format),\r\n                    dimension: WebGPUConstants.TextureViewDimension.Cube,\r\n                    mipLevelCount: mipmapCount,\r\n                    baseArrayLayer: 0,\r\n                    baseMipLevel: 0,\r\n                    arrayLayerCount: 6,\r\n                    aspect: WebGPUTextureHelper.HasDepthAndStencilAspects(gpuTextureWrapper.format) ? WebGPUConstants.TextureAspect.DepthOnly : WebGPUConstants.TextureAspect.All,\r\n                },\r\n                isStorageTexture\r\n            );\r\n        } else {\r\n            const gpuTexture = this.createTexture(\r\n                { width, height, layers: layerCount },\r\n                texture.generateMipMaps,\r\n                texture.generateMipMaps,\r\n                texture.invertY,\r\n                false,\r\n                texture.is3D,\r\n                gpuTextureWrapper.format,\r\n                1,\r\n                this._commandEncoderForCreation,\r\n                gpuTextureWrapper.textureUsages,\r\n                gpuTextureWrapper.textureAdditionalUsages,\r\n                texture.label\r\n            );\r\n\r\n            gpuTextureWrapper.set(gpuTexture);\r\n            gpuTextureWrapper.createView(\r\n                {\r\n                    format: WebGPUTextureHelper.GetDepthFormatOnly(gpuTextureWrapper.format),\r\n                    dimension: texture.is2DArray\r\n                        ? WebGPUConstants.TextureViewDimension.E2dArray\r\n                        : texture.is3D\r\n                        ? WebGPUConstants.TextureDimension.E3d\r\n                        : WebGPUConstants.TextureViewDimension.E2d,\r\n                    mipLevelCount: mipmapCount,\r\n                    baseArrayLayer: 0,\r\n                    baseMipLevel: 0,\r\n                    arrayLayerCount: texture.is3D ? 1 : layerCount,\r\n                    aspect: WebGPUTextureHelper.HasDepthAndStencilAspects(gpuTextureWrapper.format) ? WebGPUConstants.TextureAspect.DepthOnly : WebGPUConstants.TextureAspect.All,\r\n                },\r\n                isStorageTexture\r\n            );\r\n        }\r\n\r\n        texture.width = texture.baseWidth = width;\r\n        texture.height = texture.baseHeight = height;\r\n        texture.depth = texture.baseDepth = depth;\r\n\r\n        this.createMSAATexture(texture, texture.samples);\r\n\r\n        return gpuTextureWrapper;\r\n    }\r\n\r\n    public createMSAATexture(texture: InternalTexture, samples: number, releaseExisting = true, index = -1): void {\r\n        const gpuTextureWrapper = texture._hardwareTexture as Nullable<WebGPUHardwareTexture>;\r\n\r\n        if (releaseExisting) {\r\n            gpuTextureWrapper?.releaseMSAATexture();\r\n        }\r\n\r\n        if (!gpuTextureWrapper || (samples ?? 1) <= 1) {\r\n            return;\r\n        }\r\n\r\n        const width = texture.width;\r\n        const height = texture.height;\r\n\r\n        const gpuMSAATexture = this.createTexture(\r\n            { width, height, layers: 1 },\r\n            false,\r\n            false,\r\n            false,\r\n            false,\r\n            false,\r\n            gpuTextureWrapper.format,\r\n            samples,\r\n            this._commandEncoderForCreation,\r\n            WebGPUConstants.TextureUsage.RenderAttachment,\r\n            0,\r\n            texture.label ? \"MSAA\" + texture.label : undefined\r\n        );\r\n        gpuTextureWrapper.setMSAATexture(gpuMSAATexture, index);\r\n    }\r\n\r\n    //------------------------------------------------------------------------------\r\n    //                                  Update\r\n    //------------------------------------------------------------------------------\r\n\r\n    public updateCubeTextures(\r\n        imageBitmaps: ImageBitmap[] | Uint8Array[],\r\n        gpuTexture: GPUTexture,\r\n        width: number,\r\n        height: number,\r\n        format: GPUTextureFormat,\r\n        invertY = false,\r\n        premultiplyAlpha = false,\r\n        offsetX = 0,\r\n        offsetY = 0\r\n    ): void {\r\n        const faces = [0, 3, 1, 4, 2, 5];\r\n\r\n        for (let f = 0; f < faces.length; ++f) {\r\n            const imageBitmap = imageBitmaps[faces[f]];\r\n\r\n            this.updateTexture(imageBitmap, gpuTexture, width, height, 1, format, f, 0, invertY, premultiplyAlpha, offsetX, offsetY);\r\n        }\r\n    }\r\n\r\n    // TODO WEBGPU handle data source not being in the same format than the destination texture?\r\n    public updateTexture(\r\n        imageBitmap: ImageBitmap | Uint8Array | HTMLCanvasElement | OffscreenCanvas,\r\n        texture: GPUTexture | InternalTexture,\r\n        width: number,\r\n        height: number,\r\n        layers: number,\r\n        format: GPUTextureFormat,\r\n        faceIndex: number = 0,\r\n        mipLevel: number = 0,\r\n        invertY = false,\r\n        premultiplyAlpha = false,\r\n        offsetX = 0,\r\n        offsetY = 0,\r\n        allowGPUOptimization?: boolean\r\n    ): void {\r\n        const gpuTexture = WebGPUTextureHelper._IsInternalTexture(texture) ? (texture._hardwareTexture as WebGPUHardwareTexture).underlyingResource! : texture;\r\n        const blockInformation = WebGPUTextureHelper._GetBlockInformationFromFormat(format);\r\n        const gpuOrHdwTexture = WebGPUTextureHelper._IsInternalTexture(texture) ? (texture._hardwareTexture as WebGPUHardwareTexture) : texture;\r\n\r\n        const textureCopyView: GPUImageCopyTextureTagged = {\r\n            texture: gpuTexture,\r\n            origin: {\r\n                x: offsetX,\r\n                y: offsetY,\r\n                z: Math.max(faceIndex, 0),\r\n            },\r\n            mipLevel: mipLevel,\r\n            premultipliedAlpha: premultiplyAlpha,\r\n        };\r\n\r\n        const textureExtent = {\r\n            width: Math.ceil(width / blockInformation.width) * blockInformation.width,\r\n            height: Math.ceil(height / blockInformation.height) * blockInformation.height,\r\n            depthOrArrayLayers: layers || 1,\r\n        };\r\n\r\n        if ((imageBitmap as Uint8Array).byteLength !== undefined) {\r\n            imageBitmap = imageBitmap as Uint8Array;\r\n\r\n            const bytesPerRow = Math.ceil(width / blockInformation.width) * blockInformation.length;\r\n            const aligned = Math.ceil(bytesPerRow / 256) * 256 === bytesPerRow;\r\n\r\n            if (aligned) {\r\n                const commandEncoder = this._device.createCommandEncoder({});\r\n\r\n                const buffer = this._bufferManager.createRawBuffer(\r\n                    imageBitmap.byteLength,\r\n                    WebGPUConstants.BufferUsage.MapWrite | WebGPUConstants.BufferUsage.CopySrc,\r\n                    true,\r\n                    \"TempBufferForUpdateTexture\" + (gpuTexture ? \"_\" + gpuTexture.label : \"\")\r\n                );\r\n\r\n                const arrayBuffer = buffer.getMappedRange();\r\n\r\n                new Uint8Array(arrayBuffer).set(imageBitmap);\r\n\r\n                buffer.unmap();\r\n\r\n                commandEncoder!.copyBufferToTexture(\r\n                    {\r\n                        buffer: buffer,\r\n                        offset: 0,\r\n                        bytesPerRow,\r\n                        rowsPerImage: height,\r\n                    },\r\n                    textureCopyView,\r\n                    textureExtent\r\n                );\r\n\r\n                this._device.queue.submit([commandEncoder!.finish()]);\r\n\r\n                this._bufferManager.releaseBuffer(buffer);\r\n            } else {\r\n                this._device.queue.writeTexture(\r\n                    textureCopyView,\r\n                    imageBitmap,\r\n                    {\r\n                        offset: 0,\r\n                        bytesPerRow,\r\n                        rowsPerImage: height,\r\n                    },\r\n                    textureExtent\r\n                );\r\n            }\r\n\r\n            if (invertY || premultiplyAlpha) {\r\n                if (WebGPUTextureHelper._IsInternalTexture(texture)) {\r\n                    const dontUseRect = offsetX === 0 && offsetY === 0 && width === texture.width && height === texture.height;\r\n                    this.invertYPreMultiplyAlpha(\r\n                        gpuOrHdwTexture,\r\n                        texture.width,\r\n                        texture.height,\r\n                        format,\r\n                        invertY,\r\n                        premultiplyAlpha,\r\n                        faceIndex,\r\n                        mipLevel,\r\n                        layers || 1,\r\n                        offsetX,\r\n                        offsetY,\r\n                        dontUseRect ? 0 : width,\r\n                        dontUseRect ? 0 : height,\r\n                        undefined,\r\n                        allowGPUOptimization\r\n                    );\r\n                } else {\r\n                    // we should never take this code path\r\n                    throw \"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!\";\r\n                }\r\n            }\r\n        } else {\r\n            imageBitmap = imageBitmap as ImageBitmap | HTMLCanvasElement | OffscreenCanvas;\r\n\r\n            if (invertY) {\r\n                textureCopyView.premultipliedAlpha = false; // we are going to handle premultiplyAlpha ourselves\r\n\r\n                // we must preprocess the image\r\n                if (WebGPUTextureHelper._IsInternalTexture(texture) && offsetX === 0 && offsetY === 0 && width === texture.width && height === texture.height) {\r\n                    // optimization when the source image is the same size than the destination texture and offsets X/Y == 0:\r\n                    // we simply copy the source to the destination and we apply the preprocessing on the destination\r\n                    this._device.queue.copyExternalImageToTexture({ source: imageBitmap }, textureCopyView, textureExtent);\r\n\r\n                    this.invertYPreMultiplyAlpha(\r\n                        gpuOrHdwTexture,\r\n                        width,\r\n                        height,\r\n                        format,\r\n                        invertY,\r\n                        premultiplyAlpha,\r\n                        faceIndex,\r\n                        mipLevel,\r\n                        layers || 1,\r\n                        0,\r\n                        0,\r\n                        0,\r\n                        0,\r\n                        undefined,\r\n                        allowGPUOptimization\r\n                    );\r\n                } else {\r\n                    // we must apply the preprocessing on the source image before copying it into the destination texture\r\n                    const commandEncoder = this._device.createCommandEncoder({});\r\n\r\n                    // create a temp texture and copy the image to it\r\n                    const srcTexture = this.createTexture(\r\n                        { width, height, layers: 1 },\r\n                        false,\r\n                        false,\r\n                        false,\r\n                        false,\r\n                        false,\r\n                        format,\r\n                        1,\r\n                        commandEncoder,\r\n                        WebGPUConstants.TextureUsage.CopySrc | WebGPUConstants.TextureUsage.TextureBinding,\r\n                        undefined,\r\n                        \"TempTextureForUpdateTexture\"\r\n                    );\r\n\r\n                    this._deferredReleaseTextures.push([srcTexture, null]);\r\n\r\n                    textureExtent.depthOrArrayLayers = 1;\r\n                    this._device.queue.copyExternalImageToTexture({ source: imageBitmap }, { texture: srcTexture }, textureExtent);\r\n                    textureExtent.depthOrArrayLayers = layers || 1;\r\n\r\n                    // apply the preprocessing to this temp texture\r\n                    this.invertYPreMultiplyAlpha(\r\n                        srcTexture,\r\n                        width,\r\n                        height,\r\n                        format,\r\n                        invertY,\r\n                        premultiplyAlpha,\r\n                        faceIndex,\r\n                        mipLevel,\r\n                        layers || 1,\r\n                        0,\r\n                        0,\r\n                        0,\r\n                        0,\r\n                        commandEncoder,\r\n                        allowGPUOptimization\r\n                    );\r\n\r\n                    // copy the temp texture to the destination texture\r\n                    commandEncoder.copyTextureToTexture({ texture: srcTexture }, textureCopyView, textureExtent);\r\n\r\n                    this._device.queue.submit([commandEncoder!.finish()]);\r\n                }\r\n            } else {\r\n                // no preprocessing: direct copy to destination texture\r\n                this._device.queue.copyExternalImageToTexture({ source: imageBitmap }, textureCopyView, textureExtent);\r\n            }\r\n        }\r\n    }\r\n\r\n    public readPixels(\r\n        texture: GPUTexture,\r\n        x: number,\r\n        y: number,\r\n        width: number,\r\n        height: number,\r\n        format: GPUTextureFormat,\r\n        faceIndex: number = 0,\r\n        mipLevel: number = 0,\r\n        buffer: Nullable<ArrayBufferView> = null,\r\n        noDataConversion = false\r\n    ): Promise<ArrayBufferView> {\r\n        const blockInformation = WebGPUTextureHelper._GetBlockInformationFromFormat(format);\r\n\r\n        const bytesPerRow = Math.ceil(width / blockInformation.width) * blockInformation.length;\r\n\r\n        const bytesPerRowAligned = Math.ceil(bytesPerRow / 256) * 256;\r\n\r\n        const size = bytesPerRowAligned * height;\r\n\r\n        const gpuBuffer = this._bufferManager.createRawBuffer(\r\n            size,\r\n            WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst,\r\n            undefined,\r\n            \"TempBufferForReadPixels\" + (texture.label ? \"_\" + texture.label : \"\")\r\n        );\r\n\r\n        const commandEncoder = this._device.createCommandEncoder({});\r\n\r\n        commandEncoder.copyTextureToBuffer(\r\n            {\r\n                texture,\r\n                mipLevel,\r\n                origin: {\r\n                    x,\r\n                    y,\r\n                    z: Math.max(faceIndex, 0),\r\n                },\r\n            },\r\n            {\r\n                buffer: gpuBuffer,\r\n                offset: 0,\r\n                bytesPerRow: bytesPerRowAligned,\r\n            },\r\n            {\r\n                width,\r\n                height,\r\n                depthOrArrayLayers: 1,\r\n            }\r\n        );\r\n\r\n        this._device.queue.submit([commandEncoder!.finish()]);\r\n\r\n        return this._bufferManager.readDataFromBuffer(\r\n            gpuBuffer,\r\n            size,\r\n            width,\r\n            height,\r\n            bytesPerRow,\r\n            bytesPerRowAligned,\r\n            WebGPUTextureHelper._GetTextureTypeFromFormat(format),\r\n            0,\r\n            buffer,\r\n            true,\r\n            noDataConversion\r\n        );\r\n    }\r\n\r\n    //------------------------------------------------------------------------------\r\n    //                              Dispose\r\n    //------------------------------------------------------------------------------\r\n\r\n    public releaseTexture(texture: InternalTexture | GPUTexture): void {\r\n        if (WebGPUTextureHelper._IsInternalTexture(texture)) {\r\n            const hardwareTexture = texture._hardwareTexture;\r\n            const irradianceTexture = texture._irradianceTexture;\r\n\r\n            // We can't destroy the objects just now because they could be used in the current frame - we delay the destroying after the end of the frame\r\n            this._deferredReleaseTextures.push([hardwareTexture, irradianceTexture]);\r\n        } else {\r\n            this._deferredReleaseTextures.push([texture, null]);\r\n        }\r\n    }\r\n\r\n    public destroyDeferredTextures(): void {\r\n        for (let i = 0; i < this._deferredReleaseTextures.length; ++i) {\r\n            const [hardwareTexture, irradianceTexture] = this._deferredReleaseTextures[i];\r\n\r\n            if (hardwareTexture) {\r\n                if (WebGPUTextureHelper._IsHardwareTexture(hardwareTexture)) {\r\n                    hardwareTexture.release();\r\n                } else {\r\n                    hardwareTexture.destroy();\r\n                }\r\n            }\r\n            irradianceTexture?.dispose();\r\n        }\r\n\r\n        this._deferredReleaseTextures.length = 0;\r\n    }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}