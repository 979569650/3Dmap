{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { __decorate } from \"../../tslib.es6.js\";\n/* eslint-disable @typescript-eslint/naming-convention */\nimport { serialize, expandToProperty, serializeAsColor3, serializeAsTexture } from \"../../Misc/decorators.js\";\nimport { Color3 } from \"../../Maths/math.color.js\";\nimport { MaterialFlags } from \"../../Materials/materialFlags.js\";\nimport { MaterialHelper } from \"../../Materials/materialHelper.js\";\nimport { MaterialPluginBase } from \"../materialPluginBase.js\";\nimport { MaterialDefines } from \"../materialDefines.js\";\n/**\n * @internal\n */\nexport class MaterialSheenDefines extends MaterialDefines {\n  constructor() {\n    super(...arguments);\n    this.SHEEN = false;\n    this.SHEEN_TEXTURE = false;\n    this.SHEEN_GAMMATEXTURE = false;\n    this.SHEEN_TEXTURE_ROUGHNESS = false;\n    this.SHEEN_TEXTUREDIRECTUV = 0;\n    this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV = 0;\n    this.SHEEN_LINKWITHALBEDO = false;\n    this.SHEEN_ROUGHNESS = false;\n    this.SHEEN_ALBEDOSCALING = false;\n    this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = false;\n    this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL = false;\n  }\n}\n/**\n * Plugin that implements the sheen component of the PBR material.\n */\nexport class PBRSheenConfiguration extends MaterialPluginBase {\n  /** @internal */\n  _markAllSubMeshesAsTexturesDirty() {\n    this._enable(this._isEnabled);\n    this._internalMarkAllSubMeshesAsTexturesDirty();\n  }\n  constructor(material, addToPluginList = true) {\n    super(material, \"Sheen\", 120, new MaterialSheenDefines(), addToPluginList);\n    this._isEnabled = false;\n    /**\n     * Defines if the material uses sheen.\n     */\n    this.isEnabled = false;\n    this._linkSheenWithAlbedo = false;\n    /**\n     * Defines if the sheen is linked to the sheen color.\n     */\n    this.linkSheenWithAlbedo = false;\n    /**\n     * Defines the sheen intensity.\n     */\n    this.intensity = 1;\n    /**\n     * Defines the sheen color.\n     */\n    this.color = Color3.White();\n    this._texture = null;\n    /**\n     * Stores the sheen tint values in a texture.\n     * rgb is tint\n     * a is a intensity or roughness if the roughness property has been defined and useRoughnessFromTexture is true (in that case, textureRoughness won't be used)\n     * If the roughness property has been defined and useRoughnessFromTexture is false then the alpha channel is not used to modulate roughness\n     */\n    this.texture = null;\n    this._useRoughnessFromMainTexture = true;\n    /**\n     * Indicates that the alpha channel of the texture property will be used for roughness.\n     * Has no effect if the roughness (and texture!) property is not defined\n     */\n    this.useRoughnessFromMainTexture = true;\n    this._roughness = null;\n    /**\n     * Defines the sheen roughness.\n     * It is not taken into account if linkSheenWithAlbedo is true.\n     * To stay backward compatible, material roughness is used instead if sheen roughness = null\n     */\n    this.roughness = null;\n    this._textureRoughness = null;\n    /**\n     * Stores the sheen roughness in a texture.\n     * alpha channel is the roughness. This texture won't be used if the texture property is not empty and useRoughnessFromTexture is true\n     */\n    this.textureRoughness = null;\n    this._albedoScaling = false;\n    /**\n     * If true, the sheen effect is layered above the base BRDF with the albedo-scaling technique.\n     * It allows the strength of the sheen effect to not depend on the base color of the material,\n     * making it easier to setup and tweak the effect\n     */\n    this.albedoScaling = false;\n    this._internalMarkAllSubMeshesAsTexturesDirty = material._dirtyCallbacks[1];\n  }\n  isReadyForSubMesh(defines, scene) {\n    if (!this._isEnabled) {\n      return true;\n    }\n    if (defines._areTexturesDirty) {\n      if (scene.texturesEnabled) {\n        if (this._texture && MaterialFlags.SheenTextureEnabled) {\n          if (!this._texture.isReadyOrNotBlocking()) {\n            return false;\n          }\n        }\n        if (this._textureRoughness && MaterialFlags.SheenTextureEnabled) {\n          if (!this._textureRoughness.isReadyOrNotBlocking()) {\n            return false;\n          }\n        }\n      }\n    }\n    return true;\n  }\n  prepareDefinesBeforeAttributes(defines, scene) {\n    var _a;\n    if (this._isEnabled) {\n      defines.SHEEN = true;\n      defines.SHEEN_LINKWITHALBEDO = this._linkSheenWithAlbedo;\n      defines.SHEEN_ROUGHNESS = this._roughness !== null;\n      defines.SHEEN_ALBEDOSCALING = this._albedoScaling;\n      defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = this._useRoughnessFromMainTexture;\n      defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL = this._texture !== null && this._texture._texture === ((_a = this._textureRoughness) === null || _a === void 0 ? void 0 : _a._texture) && this._texture.checkTransformsAreIdentical(this._textureRoughness);\n      if (defines._areTexturesDirty) {\n        if (scene.texturesEnabled) {\n          if (this._texture && MaterialFlags.SheenTextureEnabled) {\n            MaterialHelper.PrepareDefinesForMergedUV(this._texture, defines, \"SHEEN_TEXTURE\");\n            defines.SHEEN_GAMMATEXTURE = this._texture.gammaSpace;\n          } else {\n            defines.SHEEN_TEXTURE = false;\n          }\n          if (this._textureRoughness && MaterialFlags.SheenTextureEnabled) {\n            MaterialHelper.PrepareDefinesForMergedUV(this._textureRoughness, defines, \"SHEEN_TEXTURE_ROUGHNESS\");\n          } else {\n            defines.SHEEN_TEXTURE_ROUGHNESS = false;\n          }\n        }\n      }\n    } else {\n      defines.SHEEN = false;\n      defines.SHEEN_TEXTURE = false;\n      defines.SHEEN_TEXTURE_ROUGHNESS = false;\n      defines.SHEEN_LINKWITHALBEDO = false;\n      defines.SHEEN_ROUGHNESS = false;\n      defines.SHEEN_ALBEDOSCALING = false;\n      defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = false;\n      defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL = false;\n      defines.SHEEN_GAMMATEXTURE = false;\n      defines.SHEEN_TEXTUREDIRECTUV = 0;\n      defines.SHEEN_TEXTURE_ROUGHNESSDIRECTUV = 0;\n    }\n  }\n  bindForSubMesh(uniformBuffer, scene, engine, subMesh) {\n    var _a, _b, _c, _d, _e, _f, _g, _h;\n    if (!this._isEnabled) {\n      return;\n    }\n    const defines = subMesh.materialDefines;\n    const isFrozen = this._material.isFrozen;\n    const identicalTextures = defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;\n    if (!uniformBuffer.useUbo || !isFrozen || !uniformBuffer.isSync) {\n      if (identicalTextures && MaterialFlags.SheenTextureEnabled) {\n        uniformBuffer.updateFloat4(\"vSheenInfos\", this._texture.coordinatesIndex, this._texture.level, -1, -1);\n        MaterialHelper.BindTextureMatrix(this._texture, uniformBuffer, \"sheen\");\n      } else if ((this._texture || this._textureRoughness) && MaterialFlags.SheenTextureEnabled) {\n        uniformBuffer.updateFloat4(\"vSheenInfos\", (_b = (_a = this._texture) === null || _a === void 0 ? void 0 : _a.coordinatesIndex) !== null && _b !== void 0 ? _b : 0, (_d = (_c = this._texture) === null || _c === void 0 ? void 0 : _c.level) !== null && _d !== void 0 ? _d : 0, (_f = (_e = this._textureRoughness) === null || _e === void 0 ? void 0 : _e.coordinatesIndex) !== null && _f !== void 0 ? _f : 0, (_h = (_g = this._textureRoughness) === null || _g === void 0 ? void 0 : _g.level) !== null && _h !== void 0 ? _h : 0);\n        if (this._texture) {\n          MaterialHelper.BindTextureMatrix(this._texture, uniformBuffer, \"sheen\");\n        }\n        if (this._textureRoughness && !identicalTextures && !defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE) {\n          MaterialHelper.BindTextureMatrix(this._textureRoughness, uniformBuffer, \"sheenRoughness\");\n        }\n      }\n      // Sheen\n      uniformBuffer.updateFloat4(\"vSheenColor\", this.color.r, this.color.g, this.color.b, this.intensity);\n      if (this._roughness !== null) {\n        uniformBuffer.updateFloat(\"vSheenRoughness\", this._roughness);\n      }\n    }\n    // Textures\n    if (scene.texturesEnabled) {\n      if (this._texture && MaterialFlags.SheenTextureEnabled) {\n        uniformBuffer.setTexture(\"sheenSampler\", this._texture);\n      }\n      if (this._textureRoughness && !identicalTextures && !defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE && MaterialFlags.SheenTextureEnabled) {\n        uniformBuffer.setTexture(\"sheenRoughnessSampler\", this._textureRoughness);\n      }\n    }\n  }\n  hasTexture(texture) {\n    if (this._texture === texture) {\n      return true;\n    }\n    if (this._textureRoughness === texture) {\n      return true;\n    }\n    return false;\n  }\n  getActiveTextures(activeTextures) {\n    if (this._texture) {\n      activeTextures.push(this._texture);\n    }\n    if (this._textureRoughness) {\n      activeTextures.push(this._textureRoughness);\n    }\n  }\n  getAnimatables(animatables) {\n    if (this._texture && this._texture.animations && this._texture.animations.length > 0) {\n      animatables.push(this._texture);\n    }\n    if (this._textureRoughness && this._textureRoughness.animations && this._textureRoughness.animations.length > 0) {\n      animatables.push(this._textureRoughness);\n    }\n  }\n  dispose(forceDisposeTextures) {\n    var _a, _b;\n    if (forceDisposeTextures) {\n      (_a = this._texture) === null || _a === void 0 ? void 0 : _a.dispose();\n      (_b = this._textureRoughness) === null || _b === void 0 ? void 0 : _b.dispose();\n    }\n  }\n  getClassName() {\n    return \"PBRSheenConfiguration\";\n  }\n  addFallbacks(defines, fallbacks, currentRank) {\n    if (defines.SHEEN) {\n      fallbacks.addFallback(currentRank++, \"SHEEN\");\n    }\n    return currentRank;\n  }\n  getSamplers(samplers) {\n    samplers.push(\"sheenSampler\", \"sheenRoughnessSampler\");\n  }\n  getUniforms() {\n    return {\n      ubo: [{\n        name: \"vSheenColor\",\n        size: 4,\n        type: \"vec4\"\n      }, {\n        name: \"vSheenRoughness\",\n        size: 1,\n        type: \"float\"\n      }, {\n        name: \"vSheenInfos\",\n        size: 4,\n        type: \"vec4\"\n      }, {\n        name: \"sheenMatrix\",\n        size: 16,\n        type: \"mat4\"\n      }, {\n        name: \"sheenRoughnessMatrix\",\n        size: 16,\n        type: \"mat4\"\n      }]\n    };\n  }\n}\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"isEnabled\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"linkSheenWithAlbedo\", void 0);\n__decorate([serialize()], PBRSheenConfiguration.prototype, \"intensity\", void 0);\n__decorate([serializeAsColor3()], PBRSheenConfiguration.prototype, \"color\", void 0);\n__decorate([serializeAsTexture(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"texture\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"useRoughnessFromMainTexture\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"roughness\", void 0);\n__decorate([serializeAsTexture(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"textureRoughness\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRSheenConfiguration.prototype, \"albedoScaling\", void 0);","map":{"version":3,"names":["serialize","expandToProperty","serializeAsColor3","serializeAsTexture","Color3","MaterialFlags","MaterialHelper","MaterialPluginBase","MaterialDefines","MaterialSheenDefines","constructor","SHEEN","SHEEN_TEXTURE","SHEEN_GAMMATEXTURE","SHEEN_TEXTURE_ROUGHNESS","SHEEN_TEXTUREDIRECTUV","SHEEN_TEXTURE_ROUGHNESSDIRECTUV","SHEEN_LINKWITHALBEDO","SHEEN_ROUGHNESS","SHEEN_ALBEDOSCALING","SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE","SHEEN_TEXTURE_ROUGHNESS_IDENTICAL","PBRSheenConfiguration","_markAllSubMeshesAsTexturesDirty","_enable","_isEnabled","_internalMarkAllSubMeshesAsTexturesDirty","material","addToPluginList","isEnabled","_linkSheenWithAlbedo","linkSheenWithAlbedo","intensity","color","White","_texture","texture","_useRoughnessFromMainTexture","useRoughnessFromMainTexture","_roughness","roughness","_textureRoughness","textureRoughness","_albedoScaling","albedoScaling","_dirtyCallbacks","isReadyForSubMesh","defines","scene","_areTexturesDirty","texturesEnabled","SheenTextureEnabled","isReadyOrNotBlocking","prepareDefinesBeforeAttributes","_a","checkTransformsAreIdentical","PrepareDefinesForMergedUV","gammaSpace","bindForSubMesh","uniformBuffer","engine","subMesh","materialDefines","isFrozen","_material","identicalTextures","useUbo","isSync","updateFloat4","coordinatesIndex","level","BindTextureMatrix","_b","_d","_c","_f","_e","_h","_g","r","g","b","updateFloat","setTexture","hasTexture","getActiveTextures","activeTextures","push","getAnimatables","animatables","animations","length","dispose","forceDisposeTextures","getClassName","addFallbacks","fallbacks","currentRank","addFallback","getSamplers","samplers","getUniforms","ubo","name","size","type","__decorate"],"sources":["../../../../../dev/core/src/Materials/PBR/pbrSheenConfiguration.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\r\nimport { serialize, expandToProperty, serializeAsColor3, serializeAsTexture } from \"../../Misc/decorators\";\r\nimport type { UniformBuffer } from \"../../Materials/uniformBuffer\";\r\nimport { Color3 } from \"../../Maths/math.color\";\r\nimport { MaterialFlags } from \"../../Materials/materialFlags\";\r\nimport { MaterialHelper } from \"../../Materials/materialHelper\";\r\nimport type { BaseTexture } from \"../../Materials/Textures/baseTexture\";\r\nimport type { Nullable } from \"../../types\";\r\nimport type { IAnimatable } from \"../../Animations/animatable.interface\";\r\nimport type { EffectFallbacks } from \"../effectFallbacks\";\r\nimport type { SubMesh } from \"../../Meshes/subMesh\";\r\nimport { Constants } from \"../../Engines/constants\";\r\nimport { MaterialPluginBase } from \"../materialPluginBase\";\r\nimport { MaterialDefines } from \"../materialDefines\";\r\n\r\nimport type { Engine } from \"../../Engines/engine\";\r\nimport type { Scene } from \"../../scene\";\r\nimport type { PBRBaseMaterial } from \"./pbrBaseMaterial\";\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class MaterialSheenDefines extends MaterialDefines {\r\n    public SHEEN = false;\r\n    public SHEEN_TEXTURE = false;\r\n    public SHEEN_GAMMATEXTURE = false;\r\n    public SHEEN_TEXTURE_ROUGHNESS = false;\r\n    public SHEEN_TEXTUREDIRECTUV = 0;\r\n    public SHEEN_TEXTURE_ROUGHNESSDIRECTUV = 0;\r\n    public SHEEN_LINKWITHALBEDO = false;\r\n    public SHEEN_ROUGHNESS = false;\r\n    public SHEEN_ALBEDOSCALING = false;\r\n    public SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = false;\r\n    public SHEEN_TEXTURE_ROUGHNESS_IDENTICAL = false;\r\n}\r\n\r\n/**\r\n * Plugin that implements the sheen component of the PBR material.\r\n */\r\nexport class PBRSheenConfiguration extends MaterialPluginBase {\r\n    private _isEnabled = false;\r\n    /**\r\n     * Defines if the material uses sheen.\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public isEnabled = false;\r\n\r\n    private _linkSheenWithAlbedo = false;\r\n    /**\r\n     * Defines if the sheen is linked to the sheen color.\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public linkSheenWithAlbedo = false;\r\n\r\n    /**\r\n     * Defines the sheen intensity.\r\n     */\r\n    @serialize()\r\n    public intensity = 1;\r\n\r\n    /**\r\n     * Defines the sheen color.\r\n     */\r\n    @serializeAsColor3()\r\n    public color = Color3.White();\r\n\r\n    private _texture: Nullable<BaseTexture> = null;\r\n    /**\r\n     * Stores the sheen tint values in a texture.\r\n     * rgb is tint\r\n     * a is a intensity or roughness if the roughness property has been defined and useRoughnessFromTexture is true (in that case, textureRoughness won't be used)\r\n     * If the roughness property has been defined and useRoughnessFromTexture is false then the alpha channel is not used to modulate roughness\r\n     */\r\n    @serializeAsTexture()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public texture: Nullable<BaseTexture> = null;\r\n\r\n    private _useRoughnessFromMainTexture = true;\r\n    /**\r\n     * Indicates that the alpha channel of the texture property will be used for roughness.\r\n     * Has no effect if the roughness (and texture!) property is not defined\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public useRoughnessFromMainTexture = true;\r\n\r\n    private _roughness: Nullable<number> = null;\r\n    /**\r\n     * Defines the sheen roughness.\r\n     * It is not taken into account if linkSheenWithAlbedo is true.\r\n     * To stay backward compatible, material roughness is used instead if sheen roughness = null\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public roughness: Nullable<number> = null;\r\n\r\n    private _textureRoughness: Nullable<BaseTexture> = null;\r\n    /**\r\n     * Stores the sheen roughness in a texture.\r\n     * alpha channel is the roughness. This texture won't be used if the texture property is not empty and useRoughnessFromTexture is true\r\n     */\r\n    @serializeAsTexture()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public textureRoughness: Nullable<BaseTexture> = null;\r\n\r\n    private _albedoScaling = false;\r\n    /**\r\n     * If true, the sheen effect is layered above the base BRDF with the albedo-scaling technique.\r\n     * It allows the strength of the sheen effect to not depend on the base color of the material,\r\n     * making it easier to setup and tweak the effect\r\n     */\r\n    @serialize()\r\n    @expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")\r\n    public albedoScaling = false;\r\n\r\n    /** @internal */\r\n    private _internalMarkAllSubMeshesAsTexturesDirty: () => void;\r\n\r\n    /** @internal */\r\n    public _markAllSubMeshesAsTexturesDirty(): void {\r\n        this._enable(this._isEnabled);\r\n        this._internalMarkAllSubMeshesAsTexturesDirty();\r\n    }\r\n\r\n    constructor(material: PBRBaseMaterial, addToPluginList = true) {\r\n        super(material, \"Sheen\", 120, new MaterialSheenDefines(), addToPluginList);\r\n\r\n        this._internalMarkAllSubMeshesAsTexturesDirty = material._dirtyCallbacks[Constants.MATERIAL_TextureDirtyFlag];\r\n    }\r\n\r\n    public isReadyForSubMesh(defines: MaterialSheenDefines, scene: Scene): boolean {\r\n        if (!this._isEnabled) {\r\n            return true;\r\n        }\r\n\r\n        if (defines._areTexturesDirty) {\r\n            if (scene.texturesEnabled) {\r\n                if (this._texture && MaterialFlags.SheenTextureEnabled) {\r\n                    if (!this._texture.isReadyOrNotBlocking()) {\r\n                        return false;\r\n                    }\r\n                }\r\n\r\n                if (this._textureRoughness && MaterialFlags.SheenTextureEnabled) {\r\n                    if (!this._textureRoughness.isReadyOrNotBlocking()) {\r\n                        return false;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    public prepareDefinesBeforeAttributes(defines: MaterialSheenDefines, scene: Scene): void {\r\n        if (this._isEnabled) {\r\n            defines.SHEEN = true;\r\n            defines.SHEEN_LINKWITHALBEDO = this._linkSheenWithAlbedo;\r\n            defines.SHEEN_ROUGHNESS = this._roughness !== null;\r\n            defines.SHEEN_ALBEDOSCALING = this._albedoScaling;\r\n            defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = this._useRoughnessFromMainTexture;\r\n            defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL =\r\n                this._texture !== null && this._texture._texture === this._textureRoughness?._texture && this._texture.checkTransformsAreIdentical(this._textureRoughness);\r\n\r\n            if (defines._areTexturesDirty) {\r\n                if (scene.texturesEnabled) {\r\n                    if (this._texture && MaterialFlags.SheenTextureEnabled) {\r\n                        MaterialHelper.PrepareDefinesForMergedUV(this._texture, defines, \"SHEEN_TEXTURE\");\r\n                        defines.SHEEN_GAMMATEXTURE = this._texture.gammaSpace;\r\n                    } else {\r\n                        defines.SHEEN_TEXTURE = false;\r\n                    }\r\n\r\n                    if (this._textureRoughness && MaterialFlags.SheenTextureEnabled) {\r\n                        MaterialHelper.PrepareDefinesForMergedUV(this._textureRoughness, defines, \"SHEEN_TEXTURE_ROUGHNESS\");\r\n                    } else {\r\n                        defines.SHEEN_TEXTURE_ROUGHNESS = false;\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            defines.SHEEN = false;\r\n            defines.SHEEN_TEXTURE = false;\r\n            defines.SHEEN_TEXTURE_ROUGHNESS = false;\r\n            defines.SHEEN_LINKWITHALBEDO = false;\r\n            defines.SHEEN_ROUGHNESS = false;\r\n            defines.SHEEN_ALBEDOSCALING = false;\r\n            defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE = false;\r\n            defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL = false;\r\n            defines.SHEEN_GAMMATEXTURE = false;\r\n            defines.SHEEN_TEXTUREDIRECTUV = 0;\r\n            defines.SHEEN_TEXTURE_ROUGHNESSDIRECTUV = 0;\r\n        }\r\n    }\r\n\r\n    public bindForSubMesh(uniformBuffer: UniformBuffer, scene: Scene, engine: Engine, subMesh: SubMesh): void {\r\n        if (!this._isEnabled) {\r\n            return;\r\n        }\r\n\r\n        const defines = subMesh!.materialDefines as unknown as MaterialSheenDefines;\r\n\r\n        const isFrozen = this._material.isFrozen;\r\n\r\n        const identicalTextures = defines.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;\r\n\r\n        if (!uniformBuffer.useUbo || !isFrozen || !uniformBuffer.isSync) {\r\n            if (identicalTextures && MaterialFlags.SheenTextureEnabled) {\r\n                uniformBuffer.updateFloat4(\"vSheenInfos\", this._texture!.coordinatesIndex, this._texture!.level, -1, -1);\r\n                MaterialHelper.BindTextureMatrix(this._texture!, uniformBuffer, \"sheen\");\r\n            } else if ((this._texture || this._textureRoughness) && MaterialFlags.SheenTextureEnabled) {\r\n                uniformBuffer.updateFloat4(\r\n                    \"vSheenInfos\",\r\n                    this._texture?.coordinatesIndex ?? 0,\r\n                    this._texture?.level ?? 0,\r\n                    this._textureRoughness?.coordinatesIndex ?? 0,\r\n                    this._textureRoughness?.level ?? 0\r\n                );\r\n                if (this._texture) {\r\n                    MaterialHelper.BindTextureMatrix(this._texture, uniformBuffer, \"sheen\");\r\n                }\r\n                if (this._textureRoughness && !identicalTextures && !defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE) {\r\n                    MaterialHelper.BindTextureMatrix(this._textureRoughness, uniformBuffer, \"sheenRoughness\");\r\n                }\r\n            }\r\n\r\n            // Sheen\r\n            uniformBuffer.updateFloat4(\"vSheenColor\", this.color.r, this.color.g, this.color.b, this.intensity);\r\n\r\n            if (this._roughness !== null) {\r\n                uniformBuffer.updateFloat(\"vSheenRoughness\", this._roughness);\r\n            }\r\n        }\r\n\r\n        // Textures\r\n        if (scene.texturesEnabled) {\r\n            if (this._texture && MaterialFlags.SheenTextureEnabled) {\r\n                uniformBuffer.setTexture(\"sheenSampler\", this._texture);\r\n            }\r\n\r\n            if (this._textureRoughness && !identicalTextures && !defines.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE && MaterialFlags.SheenTextureEnabled) {\r\n                uniformBuffer.setTexture(\"sheenRoughnessSampler\", this._textureRoughness);\r\n            }\r\n        }\r\n    }\r\n\r\n    public hasTexture(texture: BaseTexture): boolean {\r\n        if (this._texture === texture) {\r\n            return true;\r\n        }\r\n\r\n        if (this._textureRoughness === texture) {\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    public getActiveTextures(activeTextures: BaseTexture[]): void {\r\n        if (this._texture) {\r\n            activeTextures.push(this._texture);\r\n        }\r\n\r\n        if (this._textureRoughness) {\r\n            activeTextures.push(this._textureRoughness);\r\n        }\r\n    }\r\n\r\n    public getAnimatables(animatables: IAnimatable[]): void {\r\n        if (this._texture && this._texture.animations && this._texture.animations.length > 0) {\r\n            animatables.push(this._texture);\r\n        }\r\n\r\n        if (this._textureRoughness && this._textureRoughness.animations && this._textureRoughness.animations.length > 0) {\r\n            animatables.push(this._textureRoughness);\r\n        }\r\n    }\r\n\r\n    public dispose(forceDisposeTextures?: boolean): void {\r\n        if (forceDisposeTextures) {\r\n            this._texture?.dispose();\r\n            this._textureRoughness?.dispose();\r\n        }\r\n    }\r\n\r\n    public getClassName(): string {\r\n        return \"PBRSheenConfiguration\";\r\n    }\r\n\r\n    public addFallbacks(defines: MaterialSheenDefines, fallbacks: EffectFallbacks, currentRank: number): number {\r\n        if (defines.SHEEN) {\r\n            fallbacks.addFallback(currentRank++, \"SHEEN\");\r\n        }\r\n        return currentRank;\r\n    }\r\n\r\n    public getSamplers(samplers: string[]): void {\r\n        samplers.push(\"sheenSampler\", \"sheenRoughnessSampler\");\r\n    }\r\n\r\n    public getUniforms(): { ubo?: Array<{ name: string; size: number; type: string }>; vertex?: string; fragment?: string } {\r\n        return {\r\n            ubo: [\r\n                { name: \"vSheenColor\", size: 4, type: \"vec4\" },\r\n                { name: \"vSheenRoughness\", size: 1, type: \"float\" },\r\n                { name: \"vSheenInfos\", size: 4, type: \"vec4\" },\r\n                { name: \"sheenMatrix\", size: 16, type: \"mat4\" },\r\n                { name: \"sheenRoughnessMatrix\", size: 16, type: \"mat4\" },\r\n            ],\r\n        };\r\n    }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}