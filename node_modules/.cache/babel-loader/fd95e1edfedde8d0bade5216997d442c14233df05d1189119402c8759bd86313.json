{"ast":null,"code":"import { DeviceType } from \"./deviceEnums.js\";\nimport { Observable } from \"../../Misc/observable.js\";\nimport { InternalDeviceSourceManager } from \"../internalDeviceSourceManager.js\";\n/**\n * Class to keep track of devices\n */\nexport class DeviceSourceManager {\n  // Public Functions\n  /**\n   * Gets a DeviceSource, given a type and slot\n   * @param deviceType - Type of Device\n   * @param deviceSlot - Slot or ID of device\n   * @returns DeviceSource\n   */\n  getDeviceSource(deviceType, deviceSlot) {\n    if (deviceSlot === undefined) {\n      if (this._firstDevice[deviceType] === undefined) {\n        return null;\n      }\n      deviceSlot = this._firstDevice[deviceType];\n    }\n    if (!this._devices[deviceType] || this._devices[deviceType][deviceSlot] === undefined) {\n      return null;\n    }\n    return this._devices[deviceType][deviceSlot];\n  }\n  /**\n   * Gets an array of DeviceSource objects for a given device type\n   * @param deviceType - Type of Device\n   * @returns All available DeviceSources of a given type\n   */\n  getDeviceSources(deviceType) {\n    // If device type hasn't had any devices connected yet, return empty array.\n    if (!this._devices[deviceType]) {\n      return [];\n    }\n    return this._devices[deviceType].filter(source => {\n      return !!source;\n    });\n  }\n  /**\n   * Default constructor\n   * @param engine - Used to get canvas (if applicable)\n   */\n  constructor(engine) {\n    const numberOfDeviceTypes = Object.keys(DeviceType).length / 2;\n    this._devices = new Array(numberOfDeviceTypes);\n    this._firstDevice = new Array(numberOfDeviceTypes);\n    this._engine = engine;\n    if (!this._engine._deviceSourceManager) {\n      this._engine._deviceSourceManager = new InternalDeviceSourceManager(engine);\n    }\n    this._engine._deviceSourceManager._refCount++;\n    // Observables\n    this.onDeviceConnectedObservable = new Observable(observer => {\n      for (const devices of this._devices) {\n        if (devices) {\n          for (const device of devices) {\n            if (device) {\n              this.onDeviceConnectedObservable.notifyObserver(observer, device);\n            }\n          }\n        }\n      }\n    });\n    this.onDeviceDisconnectedObservable = new Observable();\n    this._engine._deviceSourceManager.registerManager(this);\n    this._onDisposeObserver = engine.onDisposeObservable.add(() => {\n      this.dispose();\n    });\n  }\n  /**\n   * Dispose of DeviceSourceManager\n   */\n  dispose() {\n    // Null out observable refs\n    this.onDeviceConnectedObservable.clear();\n    this.onDeviceDisconnectedObservable.clear();\n    if (this._engine._deviceSourceManager) {\n      this._engine._deviceSourceManager.unregisterManager(this);\n      if (--this._engine._deviceSourceManager._refCount < 1) {\n        this._engine._deviceSourceManager.dispose();\n        delete this._engine._deviceSourceManager;\n      }\n    }\n    this._engine.onDisposeObservable.remove(this._onDisposeObserver);\n  }\n  // Hidden Functions\n  /**\n   * @param deviceSource - Source to add\n   * @internal\n   */\n  _addDevice(deviceSource) {\n    if (!this._devices[deviceSource.deviceType]) {\n      this._devices[deviceSource.deviceType] = new Array();\n    }\n    if (!this._devices[deviceSource.deviceType][deviceSource.deviceSlot]) {\n      this._devices[deviceSource.deviceType][deviceSource.deviceSlot] = deviceSource;\n      this._updateFirstDevices(deviceSource.deviceType);\n    }\n    this.onDeviceConnectedObservable.notifyObservers(deviceSource);\n  }\n  /**\n   * @param deviceType - DeviceType\n   * @param deviceSlot - DeviceSlot\n   * @internal\n   */\n  _removeDevice(deviceType, deviceSlot) {\n    var _a, _b;\n    const deviceSource = (_a = this._devices[deviceType]) === null || _a === void 0 ? void 0 : _a[deviceSlot]; // Grab local reference to use before removing from devices\n    this.onDeviceDisconnectedObservable.notifyObservers(deviceSource);\n    if ((_b = this._devices[deviceType]) === null || _b === void 0 ? void 0 : _b[deviceSlot]) {\n      delete this._devices[deviceType][deviceSlot];\n    }\n    // Even if we don't delete a device, we should still check for the first device as things may have gotten out of sync.\n    this._updateFirstDevices(deviceType);\n  }\n  /**\n   * @param deviceType - DeviceType\n   * @param deviceSlot - DeviceSlot\n   * @param eventData - Event\n   * @internal\n   */\n  _onInputChanged(deviceType, deviceSlot, eventData) {\n    var _a, _b;\n    (_b = (_a = this._devices[deviceType]) === null || _a === void 0 ? void 0 : _a[deviceSlot]) === null || _b === void 0 ? void 0 : _b.onInputChangedObservable.notifyObservers(eventData);\n  }\n  // Private Functions\n  _updateFirstDevices(type) {\n    switch (type) {\n      case DeviceType.Keyboard:\n      case DeviceType.Mouse:\n        this._firstDevice[type] = 0;\n        break;\n      case DeviceType.Touch:\n      case DeviceType.DualSense:\n      case DeviceType.DualShock:\n      case DeviceType.Xbox:\n      case DeviceType.Switch:\n      case DeviceType.Generic:\n        {\n          delete this._firstDevice[type];\n          // eslint-disable-next-line no-case-declarations\n          const devices = this._devices[type];\n          if (devices) {\n            for (let i = 0; i < devices.length; i++) {\n              if (devices[i]) {\n                this._firstDevice[type] = i;\n                break;\n              }\n            }\n          }\n          break;\n        }\n    }\n  }\n}","map":{"version":3,"names":["DeviceType","Observable","InternalDeviceSourceManager","DeviceSourceManager","getDeviceSource","deviceType","deviceSlot","undefined","_firstDevice","_devices","getDeviceSources","filter","source","constructor","engine","numberOfDeviceTypes","Object","keys","length","Array","_engine","_deviceSourceManager","_refCount","onDeviceConnectedObservable","observer","devices","device","notifyObserver","onDeviceDisconnectedObservable","registerManager","_onDisposeObserver","onDisposeObservable","add","dispose","clear","unregisterManager","remove","_addDevice","deviceSource","_updateFirstDevices","notifyObservers","_removeDevice","_a","_b","_onInputChanged","eventData","onInputChangedObservable","type","Keyboard","Mouse","Touch","DualSense","DualShock","Xbox","Switch","Generic","i"],"sources":["../../../../../dev/core/src/DeviceInput/InputDevices/deviceSourceManager.ts"],"sourcesContent":["import type { Engine } from \"../../Engines/engine\";\r\nimport { DeviceType } from \"./deviceEnums\";\r\nimport type { Nullable } from \"../../types\";\r\nimport type { Observer } from \"../../Misc/observable\";\r\nimport { Observable } from \"../../Misc/observable\";\r\nimport type { DeviceSource } from \"./deviceSource\";\r\nimport type { IObservableManager, DeviceSourceType } from \"../internalDeviceSourceManager\";\r\nimport { InternalDeviceSourceManager } from \"../internalDeviceSourceManager\";\r\nimport type { IDisposable } from \"../../scene\";\r\nimport type { ThinEngine } from \"../../Engines/thinEngine\";\r\nimport type { IKeyboardEvent, IPointerEvent, IUIEvent, IWheelEvent } from \"../../Events/deviceInputEvents\";\r\n\r\n/**\r\n * Class to keep track of devices\r\n */\r\nexport class DeviceSourceManager implements IDisposable, IObservableManager {\r\n    // Public Members\r\n    /**\r\n     * Observable to be triggered when after a device is connected, any new observers added will be triggered against already connected devices\r\n     */\r\n    public readonly onDeviceConnectedObservable: Observable<DeviceSourceType>;\r\n\r\n    /**\r\n     * Observable to be triggered when after a device is disconnected\r\n     */\r\n    public readonly onDeviceDisconnectedObservable: Observable<DeviceSourceType>;\r\n\r\n    // Private Members\r\n    private _engine: Engine;\r\n    private _onDisposeObserver: Nullable<Observer<ThinEngine>>;\r\n    private readonly _devices: Array<Array<DeviceSource<DeviceType>>>;\r\n    private readonly _firstDevice: Array<number>;\r\n\r\n    // Public Functions\r\n    /**\r\n     * Gets a DeviceSource, given a type and slot\r\n     * @param deviceType - Type of Device\r\n     * @param deviceSlot - Slot or ID of device\r\n     * @returns DeviceSource\r\n     */\r\n    public getDeviceSource<T extends DeviceType>(deviceType: T, deviceSlot?: number): Nullable<DeviceSource<T>> {\r\n        if (deviceSlot === undefined) {\r\n            if (this._firstDevice[deviceType] === undefined) {\r\n                return null;\r\n            }\r\n\r\n            deviceSlot = this._firstDevice[deviceType];\r\n        }\r\n\r\n        if (!this._devices[deviceType] || this._devices[deviceType][deviceSlot] === undefined) {\r\n            return null;\r\n        }\r\n\r\n        return this._devices[deviceType][deviceSlot] as DeviceSource<T>;\r\n    }\r\n    /**\r\n     * Gets an array of DeviceSource objects for a given device type\r\n     * @param deviceType - Type of Device\r\n     * @returns All available DeviceSources of a given type\r\n     */\r\n    public getDeviceSources<T extends DeviceType>(deviceType: T): ReadonlyArray<DeviceSource<T>> {\r\n        // If device type hasn't had any devices connected yet, return empty array.\r\n        if (!this._devices[deviceType]) {\r\n            return [];\r\n        }\r\n        return this._devices[deviceType].filter((source) => {\r\n            return !!source;\r\n        }) as Array<DeviceSource<T>>;\r\n    }\r\n\r\n    /**\r\n     * Default constructor\r\n     * @param engine - Used to get canvas (if applicable)\r\n     */\r\n    constructor(engine: Engine) {\r\n        const numberOfDeviceTypes = Object.keys(DeviceType).length / 2;\r\n        this._devices = new Array(numberOfDeviceTypes);\r\n        this._firstDevice = new Array(numberOfDeviceTypes);\r\n        this._engine = engine;\r\n\r\n        if (!this._engine._deviceSourceManager) {\r\n            this._engine._deviceSourceManager = new InternalDeviceSourceManager(engine);\r\n        }\r\n        this._engine._deviceSourceManager._refCount++;\r\n\r\n        // Observables\r\n        this.onDeviceConnectedObservable = new Observable((observer) => {\r\n            for (const devices of this._devices) {\r\n                if (devices) {\r\n                    for (const device of devices) {\r\n                        if (device) {\r\n                            this.onDeviceConnectedObservable.notifyObserver(observer, device as DeviceSourceType);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        this.onDeviceDisconnectedObservable = new Observable();\r\n\r\n        this._engine._deviceSourceManager.registerManager(this);\r\n\r\n        this._onDisposeObserver = engine.onDisposeObservable.add(() => {\r\n            this.dispose();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Dispose of DeviceSourceManager\r\n     */\r\n    public dispose(): void {\r\n        // Null out observable refs\r\n        this.onDeviceConnectedObservable.clear();\r\n        this.onDeviceDisconnectedObservable.clear();\r\n\r\n        if (this._engine._deviceSourceManager) {\r\n            this._engine._deviceSourceManager.unregisterManager(this);\r\n            if (--this._engine._deviceSourceManager._refCount < 1) {\r\n                this._engine._deviceSourceManager.dispose();\r\n                delete this._engine._deviceSourceManager;\r\n            }\r\n        }\r\n        this._engine.onDisposeObservable.remove(this._onDisposeObserver);\r\n    }\r\n\r\n    // Hidden Functions\r\n    /**\r\n     * @param deviceSource - Source to add\r\n     * @internal\r\n     */\r\n    public _addDevice(deviceSource: DeviceSourceType): void {\r\n        if (!this._devices[deviceSource.deviceType]) {\r\n            this._devices[deviceSource.deviceType] = new Array();\r\n        }\r\n\r\n        if (!this._devices[deviceSource.deviceType][deviceSource.deviceSlot]) {\r\n            this._devices[deviceSource.deviceType][deviceSource.deviceSlot] = deviceSource;\r\n            this._updateFirstDevices(deviceSource.deviceType);\r\n        }\r\n\r\n        this.onDeviceConnectedObservable.notifyObservers(deviceSource);\r\n    }\r\n\r\n    /**\r\n     * @param deviceType - DeviceType\r\n     * @param deviceSlot - DeviceSlot\r\n     * @internal\r\n     */\r\n    public _removeDevice(deviceType: DeviceType, deviceSlot: number): void {\r\n        const deviceSource = this._devices[deviceType]?.[deviceSlot]; // Grab local reference to use before removing from devices\r\n        this.onDeviceDisconnectedObservable.notifyObservers(deviceSource as DeviceSourceType);\r\n        if (this._devices[deviceType]?.[deviceSlot]) {\r\n            delete this._devices[deviceType][deviceSlot];\r\n        }\r\n        // Even if we don't delete a device, we should still check for the first device as things may have gotten out of sync.\r\n        this._updateFirstDevices(deviceType);\r\n    }\r\n\r\n    /**\r\n     * @param deviceType - DeviceType\r\n     * @param deviceSlot - DeviceSlot\r\n     * @param eventData - Event\r\n     * @internal\r\n     */\r\n    public _onInputChanged<T extends DeviceType>(deviceType: T, deviceSlot: number, eventData: IUIEvent): void {\r\n        this._devices[deviceType]?.[deviceSlot]?.onInputChangedObservable.notifyObservers(eventData as IKeyboardEvent | IWheelEvent | IPointerEvent);\r\n    }\r\n\r\n    // Private Functions\r\n    private _updateFirstDevices(type: DeviceType): void {\r\n        switch (type) {\r\n            case DeviceType.Keyboard:\r\n            case DeviceType.Mouse:\r\n                this._firstDevice[type] = 0;\r\n                break;\r\n            case DeviceType.Touch:\r\n            case DeviceType.DualSense:\r\n            case DeviceType.DualShock:\r\n            case DeviceType.Xbox:\r\n            case DeviceType.Switch:\r\n            case DeviceType.Generic: {\r\n                delete this._firstDevice[type];\r\n                // eslint-disable-next-line no-case-declarations\r\n                const devices = this._devices[type];\r\n                if (devices) {\r\n                    for (let i = 0; i < devices.length; i++) {\r\n                        if (devices[i]) {\r\n                            this._firstDevice[type] = i;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}